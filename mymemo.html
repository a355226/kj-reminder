<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <title>MyMemo</title>

    <!-- Icons / PWA 可自行替換 -->
    <link rel="icon" type="image/png" sizes="32x32" href="mymemo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="mymemo.png" />

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <!-- Sortable (分類拖拉用) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
      :root {
        --blue-light: #ebf5fc;
        --yellow-light: #fffbe6; /* 用 MyTask 的黃 */
        --white: #fff;
        --gray-text: #444;
        --app-bg: var(--blue-light);
      }
      * {
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }
      /* 全域輸入元件字體大小 */
      input,
      select,
      textarea,
      option {
        font-size: 16px; /* 推薦手機安全字體大小，避免 iOS 自動放大 */
        line-height: 1.4; /* 行高稍微加高一點，閱讀更舒服 */
      }
      button {
        font-size: 15px;
      }
      body {
        margin: 0;
        background: var(--app-bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 16px;
      }
      .container {
        width: 100%;
        max-width: 480px;
        position: relative;
        display: none;
      }

      /* 標題 */
      h1 {
        display: inline-flex; /* 原本是 flex */
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 24px;
        margin: 6px 0 10px;
        padding: 4px 10px;
        color: #444;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
      }

      h1:hover {
        background: rgba(0, 0, 0, 0.05);
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08) inset;
      }

      /* ⋯ */
      /* ⋯ 按鈕本身（原版） */
      /* ⋯ 浮鈕（原版尺寸/陰影） */
      .more-btn {
        position: fixed;
        top: 12px;
        left: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #fff;
        color: #555;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 100;
        line-height: 1;
      }

      /* 更多功能：小卡片寬度與緊實標題 */
      #moreModal .modal-content {
        max-width: 300px;
      }
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }
      .more-row-inline {
        justify-content: flex-start !important;
        gap: 0.75rem;
      }

      /* row 佈局：左文右鈕 */
      .more-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin: 10px 0;
      }

      /* 小淺底：調色盤按鈕 */
      button.palette-btn {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        padding: 4px 8px !important;
        font-size: 0.85rem !important;
        font-weight: normal;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9 !important;
        color: #333 !important;
        width: auto !important;
        min-width: unset !important;
        margin-top: 0; /* 保持緊貼標題 */
      }
      button.palette-btn:hover {
        background: #f1f1f1 !important;
      }
      button.palette-btn:active {
        background: #e8e8e8 !important;
      }

      /* 調色盤九宮格 */
      /* --- 調色盤按鈕（小淺底）已在你檔案內，保留即可 --- */

      /* 調色盤九宮格（你已有，這裡補足 data-color 背景與選取態） */
      .palette-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
      }
      .palette-choice {
        position: relative;
        width: 100%;
        aspect-ratio: 1/1;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        overflow: hidden;
      }
      .palette-choice[data-color="#f6fbfe"] {
        background: #f6fbfe;
      }
      .palette-choice[data-color="#f3fcf8"] {
        background: #f3fcf8;
      }
      .palette-choice[data-color="#fffcf3"] {
        background: #fffcf3;
      }
      .palette-choice[data-color="#fef6f9"] {
        background: #fef6f9;
      }
      .palette-choice[data-color="#f9f8fd"] {
        background: #f9f8fd;
      }
      .palette-choice[data-color="#ffeded"] {
        background: #ffeded;
      }
      .palette-choice[data-color="#fff8f5"] {
        background: #fff8f5;
      }
      .palette-choice[data-color="#fdfcf9"] {
        background: #fdfcf9;
      }
      .palette-choice[data-color="metal"] {
        background: #e5e5e5;
      }
      .palette-choice .metal-sheen {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.35),
            rgba(255, 255, 255, 0.1)
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.08) 0 1px,
            rgba(0, 0, 0, 0.04) 1px 2px
          );
        mix-blend-mode: screen;
        pointer-events: none;
      }
      .palette-choice.selected {
        outline: 3px solid #176dff;
        box-shadow: 0 0 0 3px rgba(23, 109, 255, 0.15) inset;
      }

      /* 調色盤底部：確認／取消（與 MyTask 風格一致） */
      .dialog-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 12px;
      }
      .btn-primary,
      .btn-secondary {
        flex: 1;
        height: 42px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        border: 0;
        margin-top: 1rem;
      }
      .btn-primary {
        background: #fc97ba;
        color: #fff;
        box-shadow: 0 6px 16px rgba(0, 170, 255, 0.28);
      }
      .btn-primary:hover {
        background: #ffa49c;
      }
      .btn-primary:active {
        transform: translateY(1px);
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .btn-secondary:hover {
        background: #eee;
      }

      /* 更多功能內的行排列：左文右鈕 */
      .more-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin: 10px 0;
      }

      /* 標題更緊實一些，像原版 */
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }

      /* 藍色大按鈕：登出 */
      .logout-btn {
        width: 100%;
        height: 46px;
        background: #00aaff; /* 主藍 */
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 170, 255, 0.28);
      }
      .logout-btn:hover {
        background: #0791e6;
      }
      .logout-btn:active {
        transform: translateY(1px);
      }

      /* 標題間距（看起來跟原版一樣緊實） */
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }

      /* 今日徽章（右上角輕量） */
      #today-badge {
        position: fixed;
        top: 14px;
        right: 12px;
        z-index: 90;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(6px);
        color: rgba(50, 50, 50, 0.85);
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.3px;
        pointer-events: none;
      }

      /* 區塊/卡片 */
      .section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .section-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--yellow-light);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
      }
      .task-content {
        flex: 1;
      }
      .task-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .task .task-preview {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* 進度條（滑動）— 只保留左側刪除 */
      .swipe-bar {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 0%;
        display: flex;
        align-items: center;
        pointer-events: none;
        transition: width 0.18s;
      }
      .swipe-bar.left {
        right: 0;
        justify-content: flex-end;
        background: #ffe4e6;
        color: #5c2020;
      }
      .swipe-bar .label {
        font-weight: 800;
        opacity: 0;
        transition: opacity 0.12s, transform 0.12s;
        transform: translateX(6px);
        margin: 0 12px;
      }

      /* FAB */
      .fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 170, 255, 0.85) !important;
        color: #fff;
        font-size: 28px;
        font-weight: 700;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        z-index: 110;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease,
          background-color 0.2s ease;
      }
      .fab:hover {
        background: rgba(0, 170, 255, 0.95) !important;
      }
      .fab:active {
        transform: scale(0.98);
      }
      .fab.open {
        transform: rotate(45deg);
      }

      /* 玻璃卡選單 */
      .menu {
        position: fixed;
        bottom: 88px;
        right: 24px;
        min-width: 100px;
        padding: 8px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(180, 210, 255, 0.35);
        box-shadow: 0 12px 28px rgba(0, 60, 130, 0.12);
        display: block; /* 用透明控制顯示 */
        opacity: 0;
        transform: translateY(8px) scale(0.98);
        pointer-events: none;
        z-index: 105;
      }
      .menu.show {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        transition: opacity 0.18s ease, transform 0.18s ease;
      }
      .menu button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        background: transparent;
        border: 0;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        color: #176dff; /* 淺藍系主色 */
        letter-spacing: 0.2px;
        cursor: pointer;
      }
      .menu button:hover {
        background: linear-gradient(0deg, #eef6ff, #f7fbff);
      }
      .menu button:active {
        transform: translateY(1px);
      }
      .menu button + button {
        margin-top: 4px;
      }
      .menu::after {
        content: "";
        position: absolute;
        right: 12px;
        bottom: -6px;
        width: 12px;
        height: 12px;
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid rgba(180, 210, 255, 0.35);
        border-top: none;
        border-left: none;
        transform: rotate(45deg);
        box-shadow: 4px 4px 10px rgba(0, 60, 130, 0.06);
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-content {
        width: 90%;
        max-width: 420px;
        background: #fff;
        border-radius: 12px;
        padding: 14px;
        position: relative;
      }
      .close-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 28px;
        height: 28px;
        border: 0;
        border-radius: 50%;
        background: #eee;
        cursor: pointer;
      }

      .modal-content label {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.95rem;
      }
      .modal-content input:not([type="checkbox"]),
      .modal-content select,
      .modal-content textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 0.25rem;
        font-size: 16px;
      }
      .inline-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.25rem;
      }
      .half {
        width: 50%;
        min-width: 160px;
      }
      .important-flag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        white-space: nowrap;
      }

      .save-btn {
        width: 100%;
        padding: 0.6rem;
        border: 0;
        border-radius: 6px;
        background: #77d4bc;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
        margin-top: 1rem;
        font-size: 16px;
      }
      .row-btns {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .btn-half {
        flex: 1;
        padding: 0.6rem;
        border: 0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-save {
        background: #e8faf3;
        color: #176d59;
        border: 1px solid #ccefe2;
      }
      .btn-del {
        background: #fff3f3;
        color: #b23b3b;
        border: 1px solid #ffd8d8;
      }

      /* Login */
      #loginPage {
        display: flex;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        background: #ebf5fc;
      }
      #loginCard {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 24px;
        width: 95%;
        max-width: 450px;
      }
      .login-input {
        width: 100%;
        height: 44px;
        padding: 0 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        margin: 0.6rem 0 1rem;
      }
      .login-btn {
        width: 100%;
        height: 46px;
        background: #00aaff;
        color: #fff;
        border: 0;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
      }
      .login-btn:hover {
        background: #0791e6;
      }

      /* 平滑霧面金屬效果（無格線感） */
      body.bg-metal::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;

        /* 柔光高亮 + 垂直刷絲紋路（超細微） */
        background-image: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.2),
            rgba(255, 255, 255, 0.12)
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.03) 0px,
            rgba(255, 255, 255, 0.03) 1px,
            rgba(0, 0, 0, 0.02) 1px,
            rgba(0, 0, 0, 0.02) 2px
          );

        background-blend-mode: screen, normal;

        /* 讓紋理極度細緻，避免網格感 */
        background-size: 100% 100%, 600px 100%;
        background-repeat: no-repeat, repeat;

        /* 輕微對比與飽和度，保留金屬感 */
        filter: contrast(103%) saturate(97%);
      }

      /* 展開閱讀面板（含復原/重做/複製） */
      #detailViewer {
        display: none;
      }
      #detailViewer.show {
        display: block;
      }
      #detailForm.hide {
        display: none;
      }
      .viewer-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
      .viewer-title {
        font-weight: 700;
      }
      .viewer-close {
        border: 1px solid #ddd;
        background: #f7f7f7;
        border-radius: 6px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
      }
      .viewer-toolbar {
        display: flex;
        gap: 0.4rem;
        margin: 0.1rem 0 0.4rem;
      }
      .vt-btn {
        border: 1px solid #ddd;
        background: #f8f8f8;
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      .viewer-body {
        width: 100%;
        min-height: 50vh;
        padding: 0.75rem;
        border: 1px solid #eee;
        border-radius: 8px;
        background: #fafafa;
        line-height: 1.6;
        font-size: 0.95rem;
        resize: vertical;
      }

      /* === 編輯模式：標題行可放把手/鉛筆/刪除，X 固定在最右 === */
      .section.edit-mode .rename-btn,
      .section.edit-mode .delete-btn {
        display: inline-flex !important;
      }

      .section-title {
        position: relative; /* 讓右上角 X 可以絕對定位 */
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* 把手 */
      .drag-handle {
        cursor: grab;
        color: #888;
      }

      /* 鉛筆：跟在文字後（不要絕對定位） */
      .rename-btn {
        position: static;
        border: 0;
        background: transparent;
        color: #999;
        cursor: pointer;
      }

      /* X 在最右上角 */
      .delete-btn {
        position: absolute;
        top: 0;
        right: 0;
        border: 0;
        background: transparent;
        color: #999;
        cursor: pointer;
        display: none; /* 只在 edit-mode 顯示 */
      }

      /* 讓分類區可被輕觸回饋 */
      #section-container {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        touch-action: pan-y; /* 允許上下捲動 */
      }

      /* 點壓中的微縮效果 */
      .section.__pressed {
        transform: scale(0.985);
        transition: transform 120ms ease;
      }

      /* 點一下的小彈跳效果 */
      @keyframes __bump {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(0.985);
        }
        100% {
          transform: scale(1);
        }
      }
      .section.__bump {
        animation: __bump 0.18s ease;
      }

      #loadingScreen {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        background: var(--app-bg);
      }
      #loadingScreen .loading-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 16px 20px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(8px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      }
      .loading-spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid rgba(0, 0, 0, 0.15);
        border-top-color: rgba(0, 0, 0, 0.5);
        animation: spin 0.9s linear infinite;
      }
      .loading-text {
        color: #444;
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 加在你的 <style> 裡 */
      #app {
        display: none;
      } /* 等驗證完再顯示 */

      /* 讓進度條內部不會因寬度變動而換行/跳動 */
      .swipe-bar {
        overflow: hidden; /* 寬度不夠時把左側超出部分裁掉 */
      }

      .swipe-bar .label {
        white-space: nowrap; /* 禁止換行（CJK 也不換） */
        flex: 0 0 auto; /* 不要被壓縮 */
        width: 72px; /* 固定一個寬度：🗑 +「移除」剛好單行 */
        text-align: right; /* 文字靠右對齊，視覺上貼近右邊 */
        letter-spacing: 0.02em; /* 可有可無：微調字距 */
      }

      /* 已移除：淺色毛玻璃卡片 */
      .task.removed {
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(8px) saturate(1.05);
        -webkit-backdrop-filter: blur(8px) saturate(1.05);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .task.removed .task-title {
        color: #555;
        font-weight: 600;
      }

      /* 在「已移除」檢視時，強制顯示分類右上角的 X */
      #app.view-removed .section .delete-btn {
        display: inline-flex !important;
      }

      /* 「已移除」檢視時，右下＋採反灰半透明（且不可點） */
      .fab.fab-disabled {
        opacity: 0.38;
        filter: grayscale(100%);
        background: rgba(200, 200, 200, 0.5) !important;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        pointer-events: none;
      }

      /* 預設不顯示備忘拖拉把手 */
      .memo-drag {
        display: none;
      }

      /* 只有編輯中才顯示把手 */
      #app.editing .memo-drag {
        display: inline-flex;
        margin-right: 6px;
        color: #888;
        cursor: grab;
      }

      /* 編輯中允許拖拉卡片（避免先前把 .task 設成 pointer-events:none） */
      #app.editing .task {
        pointer-events: auto;
        cursor: grab;
      }

      /* ===== 搜尋欄（放在 moreModal 裡） ===== */
      #moreModal .modal-content {
        position: relative;
      }
      .search-wrap {
        max-width: 200px;
        margin: 0 auto 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0 0 0.25rem 0;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(180, 210, 255, 0.35);
        box-shadow: 0 8px 20px rgba(0, 60, 130, 0.08);
        margin-bottom: 1rem;
      }
      .search-ico {
        font-size: 1rem;
        opacity: 0.7;
        transform: translateY(1px);
        pointer-events: none;
      }
      #taskSearchInput {
        flex: 1;
        height: 24px;
        border: 0;
        outline: none;
        background: transparent;
        font-size: 12px;
      }
      #taskSearchInput::placeholder {
        color: #9aa7bd;
      }
      .search-clear {
        border: 0;
        background: #eef3ff;
        color: #4a6aa8;
        width: 20px;
        height: 20px;
        font-size: 12px;
        border-radius: 50%;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
      }
      .search-clear:active {
        transform: translateY(1px);
      }

      /* 搜尋隱藏（不影響其它篩選，能疊加） */
      .task.search-hide {
        display: none !important;
      }
      
            /* 只讓 #memoContent 有最小高度；保留右下角可調整 */
#memoContent{
  min-height: 30vh;
  resize: vertical;     /* 若之前被關掉，這行可讓右下角手把回來 */
  box-sizing: border-box;
}
    </style>
  </head>
  <body>
    <!-- 放在 <body> 裡、#app 之前 -->
    <div
      id="autologin-overlay"
      aria-hidden="true"
      style="
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        z-index: 260;
      "
    >
      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.75rem;
          padding: 16px 18px;
          border-radius: 14px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(180, 210, 255, 0.35);
          box-shadow: 0 12px 28px rgba(0, 60, 130, 0.12);
        "
      >
        <div
          style="
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 3px solid #e6f4ff;
            border-top-color: #00aaff;
            animation: spin 0.8s linear infinite;
          "
        ></div>
        <div
          style="
            font-weight: 700;
            letter-spacing: 0.3px;
            color: #176dff;
            font-size: 14px;
          "
        >
          切換中…
        </div>
      </div>
    </div>

    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

    </style>

    <!-- App -->
    <div class="container" id="app">
      <div class="more-btn" onclick="openModal('moreModal')">⋯</div>
      <div id="today-badge"></div>

      <div style="text-align: center">
        <h1 onclick="location.href='index.html'" style="cursor: pointer">
          <img
            src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder@main/mymemo.png"
            alt="icon"
            width="40"
            style="transform: translateY(2px)"
          />
          MyMemo
        </h1>
      </div>

      <div id="section-container"></div>

      <div class="fab" onclick="toggleMenu()">＋</div>
      <div class="menu" id="menu">
        <button
          onclick="openMemoModal()"
          style="
            background: #e6f6fc;
            color: #0091cc;
            font-weight: 600;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            margin-bottom: 12px;
          "
        >
          新增備忘
        </button>

        <button
          onclick="openCategoryModal()"
          style="
            background: #e9f9f1;
            color: #1fa87a;
            font-weight: 500;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            margin-bottom: 12px;
          "
        >
          新增分類
        </button>

        <button
          onclick="enterEditMode()"
          style="
            background: #fff6e6;
            color: #d98a00;
            font-weight: 600;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
          "
        >
          編輯分類
        </button>
      </div>
      <!-- ✅ 編輯完成（置中懸浮） -->
      <button
        id="exitEditBtn"
        onclick="exitEditMode()"
        style="
          display: none;
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #e3ffe8;
          color: #176d59;
          border: none;
          border-radius: 8px;
          padding: 6px 14px;
          font-size: 13px;
          font-weight: bold;
          cursor: pointer;
          z-index: 120;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        "
      >
        ✅
      </button>
    </div>

    <!-- 新增備忘 -->
    <div class="modal" id="memoModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('memoModal')">✕</button>
        <h3>新增備忘</h3>

        <label>備忘分類</label>
        <div class="inline-row">
          <select id="memoSection" class="half"></select>
          <label class="important-flag"
            ><input type="checkbox" id="memoImportant" /> 重要</label
          >
        </div>

        <label>備忘標題（必填）</label>
        <input type="text" id="memoTitle" />

        <label>備忘內容</label>
        <textarea id="memoContent"></textarea>

        <button class="save-btn" onclick="addMemo()">新增</button>
      </div>
    </div>

    <!-- 詳情 -->
    <div class="modal" id="detailModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('detailModal')">✕</button>
        <h3 style="display: flex; align-items: center; gap: 0.5rem">
          <span>備忘內容</span>
          <small
            id="detailLastUpdate"
            style="font-size: 0.9rem; color: #666; white-space: nowrap"
          ></small>
        </h3>

        <!-- 表單 -->
        <div id="detailForm">
          <label>備忘分類</label>
          <div class="inline-row">
            <select id="detailSection" class="half"></select>
            <label class="important-flag"
              ><input type="checkbox" id="detailImportant" /> 重要</label
            >
          </div>

          <label>備忘標題</label>
          <input type="text" id="detailTitle" style="margin-bottom: 10px" />

          <div style="display: flex; align-items: center; gap: 0.4rem">
            <label for="detailContent" style="margin: 0">備忘內容</label>
            <button
              type="button"
              class="expand-icon"
              onclick="event.stopPropagation(); toggleDetailExpand('detailContent','備忘內容')"
              title="展開"
              style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 22px;
                height: 22px;
                margin-left: 0.4rem;
                border-radius: 4px;
                border: 1px solid #ddd;
                background: #f8f8f8;
                cursor: pointer;
                font-size: 12px;
                color: #555;
              "
            >
              ⤢
            </button>
          </div>
          <textarea id="detailContent"></textarea>

          <div class="row-btns">
            <button class="btn-half btn-save" onclick="saveMemo()">
              💾 儲存
            </button>
            <button class="btn-half btn-del" onclick="confirmDelete()">
              🗑️ 移除
            </button>
          </div>
        </div>

        <!-- 展開閱讀/編輯器 -->
        <div id="detailViewer">
          <div class="viewer-head">
            <div class="viewer-title" id="viewerTitle"></div>
            <button
              type="button"
              class="viewer-close"
              onclick="toggleDetailExpand()"
              style="margin-top: 6px"
            >
              ⤢
            </button>
          </div>
          <div class="viewer-toolbar">
            <button class="vt-btn" title="還原" onclick="viewerUndo()">
              ⤺
            </button>
            <button class="vt-btn" title="復原" onclick="viewerRedo()">
              ⤻
            </button>
            <button class="vt-btn" title="複製" onclick="viewerCopy()">
              ⧉
            </button>
          </div>
          <textarea class="viewer-body" id="viewerBody"></textarea>
        </div>
      </div>
    </div>

    <!-- 刪除確認 -->
    <div class="modal" id="confirmModal">
      <div class="modal-content">
        <h3 style="text-align: center">確定要刪除這則備忘？</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="deleteMemo()">確認</button>
          <button
            class="btn-half btn-save"
            onclick="closeModal('confirmModal')"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 刪除「分類」確認 -->
    <div class="modal" id="confirmCategoryModal">
      <div class="modal-content">
        <h3 style="text-align: center">確定要刪除此分類？</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="deleteCategoryConfirmed()">
            確認
          </button>
          <button
            class="btn-half btn-save"
            onclick="closeModal('confirmCategoryModal')"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 新增分類 -->
    <div class="modal" id="categoryModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('categoryModal')">
          ✕
        </button>
        <h3>新增分類</h3>
        <input type="text" id="newCategoryName" placeholder="請輸入分類名稱" />
        <button class="save-btn" onclick="addCategory()">新增分類</button>
      </div>
    </div>

    <!-- 更名分類 -->
    <div class="modal" id="renameModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('renameModal')">✕</button>
        <h3>重命名分類</h3>
        <input type="text" id="renameInput" placeholder="新的分類名稱" />
        <button class="save-btn" onclick="confirmRename()">確定</button>
      </div>
    </div>

    <!-- ⋯（只保留更換底色與登出） -->
    <!-- 更多功能 Modal（原版樣式） -->
    <div class="modal" id="moreModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('moreModal')">✕</button>
        <!-- 🔎 搜尋欄（只保留右側 X） -->
        <div
          id="globalSearch"
          class="search-wrap modal-search"
          role="search"
          aria-label="搜尋任務"
        >
          <span class="search-ico" aria-hidden="true">🔍</span>
          <input
            id="taskSearchInput"
            type="text"
            autocomplete="off"
            placeholder="在MyMemo中搜尋"
            aria-label="搜尋標題、任務內容、處理情形"
          />
          <button
            id="taskSearchClear"
            class="search-clear"
            aria-label="清除搜尋"
          >
            ✕
          </button>
        </div>
        <h3>備忘錄檢視</h3>
        <div class="more-row more-row-inline">
          <label style="display: flex; align-items: center; gap: 0.4rem">
            <input type="checkbox" id="viewActiveToggle" />當前</label
          >
          <label style="display: flex; align-items: center; gap: 0.4rem">
            <input type="checkbox" id="viewRemovedToggle" />已移除</label
          >
        </div>

        <h3>更換底色</h3>

        <div
          class="more-row"
          style="flex-direction: column; align-items: flex-start; gap: 0.5rem"
        >
          <button id="openPaletteBtn" class="palette-btn">🎨 調色盤</button>
        </div>

        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee" />

        <button class="logout-btn" onclick="openLogoutModal()">登出</button>
      </div>
    </div>

    <!-- 調色盤 -->
    <!-- 調色盤（原版互動：確認／取消） -->
    <div class="modal" id="paletteModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('paletteModal')">
          ✕
        </button>
        <h3>選擇底色</h3>

        <div class="palette-grid">
          <div class="palette-choice" data-color="#f6fbfe"></div>
          <div class="palette-choice" data-color="#f3fcf8"></div>
          <div class="palette-choice" data-color="#fffcf3"></div>
          <div class="palette-choice" data-color="#fef6f9"></div>
          <div class="palette-choice" data-color="#f9f8fd"></div>
          <div class="palette-choice" data-color="#ffeded"></div>
          <div class="palette-choice" data-color="#fff8f5"></div>
          <div class="palette-choice" data-color="#fdfcf9"></div>
          <div class="palette-choice" data-color="metal">
            <div class="metal-sheen"></div>
          </div>
        </div>

        <div class="dialog-actions">
          <button id="paletteConfirmBtn" class="btn-primary">確認</button>
          <button id="paletteCancelBtn" class="btn-secondary">取消</button>
        </div>
      </div>
    </div>

    <!-- 登出確認 -->
    <div class="modal" id="logoutModal">
      <div class="modal-content">
        <h3 style="text-align: center">確定要登出？</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="doLogout()">確認</button>
          <button class="btn-half btn-save" onclick="closeModal('logoutModal')">
            取消
          </button>
        </div>
      </div>
    </div>

    <script>
      /* ===== 基本設定 ===== */
      const firebaseConfig = {
        apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
        authDomain: "kjreminder-24d74.firebaseapp.com",
        projectId: "kjreminder-24d74",
        storageBucket: "kjreminder-24d74.firebasestorage.app",
        messagingSenderId: "176371952161",
        appId: "1:176371952161:web:948121be209cd2e4181160",
        databaseURL:
          "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/",
      };
      firebase.initializeApp(firebaseConfig);
      let auth = firebase.auth();
      let db = firebase.database();

      /* ===== 狀態 ===== */
      let roomPath = ""; // rooms/{user}-{pass}
      let memos = []; // 進行中的備忘
      let categories = []; // 分類
      let categoriesLoaded = false;
      let selectedMemoId = null;
      let memosRef = null,
        categoriesRef = null;
      let sectionSortable = null;
      let isEditing = false; // 是否在編輯分類模式（給長按行為判斷）
      let memoSortables = []; // 備忘條拖拉（跨分類用）

      let memoMonthFilter = "all"; // 'all' | 'recent5' | '11407'（ROC 年月）
      let memoView = "active"; // 'active' | 'removed'
      let memoMonthFilterActive = "all";
      let memoMonthFilterRemoved = "all";
      let pendingCategoryMode = "active"; // 'active' | 'removed'

      function applyViewAffordances() {
        const fab = document.querySelector(".fab");
        const menu = document.getElementById("menu");
        const appEl = document.getElementById("app");

        // 切視圖用 class，控制 X 顯示與 FAB 反灰
        appEl?.classList.toggle("view-removed", memoView === "removed");

        if (memoView === "removed") {
          fab?.classList.add("fab-disabled"); // 反灰＋不可點
          menu?.classList.remove("show");
          fab?.classList.remove("open");
        } else {
          fab?.classList.remove("fab-disabled");
        }
      }

      function buildMemoMonthMenu() {
        const menu = document.getElementById("memoMonthMenu");
        if (!menu) return;
        menu.innerHTML = "";

        const isRemovedView = memoView === "removed";
        const list = (memos || []).filter((m) =>
          isRemovedView ? !!m.removedAt : !m.removedAt
        );

        const getFilter = () =>
          isRemovedView ? memoMonthFilterRemoved : memoMonthFilterActive;
        const setFilter = (val) => {
          if (isRemovedView) memoMonthFilterRemoved = val;
          else memoMonthFilterActive = val;
          try {
            localStorage.setItem(
              isRemovedView ? "memo_filter_removed" : "memo_filter_active",
              val
            );
          } catch (_) {}
          renderAll();
        };

        const mkBtn = (label, value) => {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.style.cssText =
            "display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;" +
            (getFilter() === value ? "font-weight:700;" : "");
          btn.onclick = () => {
            setFilter(value);
            menu.style.display = "none";
          };
          return btn;
        };

        menu.appendChild(mkBtn("全部", "all"));
        menu.appendChild(mkBtn("近5日", "recent5"));
        menu.appendChild(mkBtn("近30日", "recent30"));
        menu.appendChild(mkBtn("重要 ❗", "important"));

        const monthSet = new Set();
        list.forEach((m) => {
          const ts = getMemoRefTime(m);
          const ym = toRocYMFromTs(ts);
          if (ym !== "無") monthSet.add(ym);
        });

        if (monthSet.size === 0) {
          const empty = document.createElement("div");
          empty.textContent = "無更多月份";
          empty.style.cssText = "padding:6px 8px; color:#666;";
          menu.appendChild(empty);
          return;
        }
        Array.from(monthSet)
          .sort((a, b) => b.localeCompare(a))
          .forEach((ym) => menu.appendChild(mkBtn(ym, ym)));
      }

      /* ===== 小工具 ===== */

      function openModal(id) {
        document.getElementById(id).style.display = "flex";
        if (id === "moreModal") {
          const a = document.getElementById("viewActiveToggle");
          const r = document.getElementById("viewRemovedToggle");
          if (a && r) {
            a.checked = memoView === "active";
            r.checked = memoView === "removed";
          }
        }
      }

      document
        .getElementById("viewActiveToggle")
        ?.addEventListener("change", (e) => {
          const other = document.getElementById("viewRemovedToggle");
          if (e.target.checked) {
            if (other) other.checked = false;
            setMemoView("active");
          } else if (other && !other.checked) e.target.checked = true;
        });
      document
        .getElementById("viewRemovedToggle")
        ?.addEventListener("change", (e) => {
          const other = document.getElementById("viewActiveToggle");
          if (e.target.checked) {
            if (other) other.checked = false;
            setMemoView("removed");
          } else if (other && !other.checked) e.target.checked = true;
        });

      document.addEventListener("DOMContentLoaded", () => {
        try {
          memoView = localStorage.getItem("memo_view") || "active";
          memoMonthFilterActive =
            localStorage.getItem("memo_filter_active") || "all";
          memoMonthFilterRemoved =
            localStorage.getItem("memo_filter_removed") || "all";
        } catch (_) {}
        applyViewAffordances();
        renderSections();
      });

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      function setMemoView(view) {
        memoView = view;
        try {
          localStorage.setItem("memo_view", view);
        } catch (_) {}
        applyViewAffordances();
        renderSections();
        renderAll();
      }

      function openMemoModal(prefSectionId) {
        updateSectionOptions();
        if (prefSectionId) {
          const sel = document.getElementById("memoSection");
          const opt = sel?.querySelector(`option[value="${prefSectionId}"]`);
          if (opt) sel.value = prefSectionId;
        }
        closeFabMenu(); // 關掉＋選單
        openModal("memoModal");
      }

      function toggleMenu() {
        if (memoView === "removed") return;
        const m = document.getElementById("menu");
        const fab = document.querySelector(".fab");
        const willShow = !m.classList.contains("show");
        m.classList.toggle("show", willShow);
        fab?.classList.toggle("open", willShow);
      }

      document.addEventListener("click", (e) => {
        const menu = document.getElementById("menu");
        if (!menu || !menu.classList.contains("show")) return;
        const fab = document.querySelector(".fab");
        const inside = menu.contains(e.target);
        const onFab = fab && fab.contains(e.target);
        if (!inside && !onFab) closeFabMenu(); // ← 同步關 & 還原「＋」
      });

      async function doLogout() {
        // 1) 關掉 Firebase 監聽
        try {
          if (memosRef) {
            memosRef.off();
            memosRef = null;
          }
          if (categoriesRef) {
            categoriesRef.off();
            categoriesRef = null;
          }
        } catch (_) {}

        // 2) 清空本機狀態
        memos = [];
        categories = [];
        selectedMemoId = null;

        // 3) 清掉兩個 App 共用的自動登入資訊（讓回到 index 需要重新登入）
        try {
          localStorage.removeItem("todo_room_info");
        } catch (_) {}
        roomPath = "";

        // 4) 登出 Firebase 匿名會話（若存在）
        try {
          await auth.signOut();
        } catch (_) {}

        // 5) 關掉彈窗（可有可無）
        try {
          closeModal("logoutModal");
          closeModal("moreModal");
        } catch (_) {}

        // 6) 導回 MyTask 的登入頁
        location.replace("index.html"); // 或 window.location.href = 'index.html';
      }

      /* ===== Firebase 綁定 ===== */
      function bindFirebase() {
        unbindFirebase();
        memosRef = db.ref(`${roomPath}/memos`);
        categoriesRef = db.ref(`${roomPath}/memoCategories`);

        memosRef.on("value", (snap) => {
          const data = snap.val() || {};
          memos = Object.values(data);
          renderAll();
        });

        categoriesRef.on("value", (snap) => {
          const cloud = snap.val();
          if (cloud === null) {
            categories = [];
            saveCategories();
          } else if (Array.isArray(cloud)) {
            categories = cloud.slice();
          } else if (cloud && typeof cloud === "object") {
            categories = Object.values(cloud);
          } else {
            categories = [];
          }
          categoriesLoaded = true;
          renderSections(categories);
          renderAll();
        });
      }
      function unbindFirebase() {
        try {
          memosRef && memosRef.off();
          categoriesRef && categoriesRef.off();
        } catch (_) {}
      }
      function saveMemos() {
        const obj = {};
        memos.forEach((m) => (obj[m.id] = m));
        db.ref(`${roomPath}/memos`).set(obj);
      }
      function saveCategories() {
        db.ref(`${roomPath}/memoCategories`).set(categories);
      }

      /* ===== UI：今日徽章 ===== */
      (function () {
        const el = document.getElementById("today-badge");
        const WEEK = ["日", "一", "二", "三", "四", "五", "六"];
        function draw() {
          const now = new Date();
          el.textContent = `${now.getMonth() + 1}/${now.getDate()}（${
            WEEK[now.getDay()]
          }）`;
        }
        draw();
        const t = new Date();
        const mid = new Date(t);
        mid.setHours(24, 0, 0, 0);
        setTimeout(() => {
          draw();
          setInterval(draw, 24 * 3600 * 1000);
        }, mid - t);
      })();

      /* ===== 分類區 ===== */
      function renderSections() {
        const wrap = document.getElementById("section-container");
        if (!wrap) return;

        // 上方 🗂️ + 篩選選單容器
        wrap.innerHTML = `
    <div id="memoMore" style="text-align:right; margin:0.25rem 0; position:relative;">
      <button id="memoMoreBtn"
              style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">
        🗂️
      </button>
      <div id="memoMonthMenu"
           style="display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd;
                  border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;">
      </div>
    </div>
  `;

        // 取出要顯示的分類清單
        // 取出要顯示的分類清單
        let names = [];
        if (memoView === "active") {
          names = (categories || []).slice();
        } else {
          // removed：只顯示「有被移除備忘」的分類（統一用原始分類名）
          const set = new Set();
          (memos || []).forEach((m) => {
            if (m.removedAt) set.add(stripRemovedSuffix(m.section));
          });
          names = Array.from(set);
        }

        // 畫出各分類的區塊
        names.forEach((name) => {
          if (memoView === "removed") {
            const displayName = getRemovedSectionLabel(name); // 顯示用(可能帶後綴)
            const sec = document.createElement("div");
            sec.className = "section";
            sec.id = name; // ← id 永遠用「原始分類名」
            sec.innerHTML = `
      <div class="section-title">
        <span class="section-name">${displayName}</span>
        <button class="delete-btn" title="刪除此分類">✕</button>
      </div>
    `;
            // 右上角 X：清掉該分類底下所有「已移除」備忘（不管舊資料是否帶(已移除)後綴）
            sec.querySelector(".delete-btn").onclick = () =>
              confirmDeleteCategory(name, "removed");
            wrap.appendChild(sec);
          } else {
            // active 視圖維持原樣
            const sec = document.createElement("div");
            sec.className = "section" + (isEditing ? " edit-mode" : "");
            sec.id = name;
            sec.innerHTML = `<div class="section-title">${name}</div>`;
            wrap.appendChild(sec);
          }
        });

        // 🗂️ 按鈕
        document
          .getElementById("memoMoreBtn")
          ?.addEventListener("click", () => {
            const menu = document.getElementById("memoMonthMenu");
            if (!menu) return;
            menu.style.display =
              menu.style.display === "block" ? "none" : "block";
          });

        // 依目前 memos 重建月份清單（你的 buildMemoMonthMenu 內已會參照 memoView/memoMonthFilter）
        buildMemoMonthMenu();

        // 編輯模式與拖拉（在「已移除」禁止）
        if (memoView === "active") {
          updateSectionOptions();
          if (isEditing) {
            applyEditModeUI(); // 加上把手、✎、✕ 等
          } else {
            initSectionSortable?.();
          }
        } else {
          updateSectionOptions(); // 下拉仍可看，但唯讀
        }

        // ✅ 底部「完成編輯」按鈕只在「當前」且編輯中顯示
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn)
          exitBtn.style.display =
            memoView === "active" && isEditing ? "block" : "none";
      }

      function updateSectionOptions() {
        const optsHTML = (categories || [])
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("");

        // 新增備忘用的下拉
        const s1 = document.getElementById("memoSection");
        if (s1) {
          const prev = s1.value;
          if (s1.__optsHTML !== optsHTML) {
            s1.innerHTML = optsHTML;
            s1.__optsHTML = optsHTML;
          }
          // 還原原本選取（存在才還原）
          if (prev && Array.from(s1.options).some((o) => o.value === prev)) {
            s1.value = prev;
          }
        }

        // 詳情視窗的下拉（重點：要維持目前 memo 的分類）
        const s2 = document.getElementById("detailSection");
        if (s2) {
          const prev = s2.value;
          if (s2.__optsHTML !== optsHTML) {
            s2.innerHTML = optsHTML;
            s2.__optsHTML = optsHTML;
          }

          // 以目前選中的 memo 為準
          let want = prev;
          try {
            const m = (Array.isArray(memos) ? memos : []).find(
              (x) => x.id === selectedMemoId
            );
            if (m && m.section) want = m.section;
          } catch (_) {}

          if (want && Array.from(s2.options).some((o) => o.value === want)) {
            s2.value = want;
          }
          // 否則讓瀏覽器維持現況，不強制跳第一個
        }
      }
      function initSectionSortable() {
        const el = document.getElementById("section-container");
        if (!el) return;
        if (sectionSortable && sectionSortable.destroy)
          sectionSortable.destroy();
        sectionSortable = new Sortable(el, {
          animation: 150,
          handle: ".drag-handle",
          draggable: ".section",
          ghostClass: "dragging",
          onEnd: () => {
            categories = Array.from(
              document.querySelectorAll("#section-container .section")
            ).map((sec) => sec.id);
            saveCategories();
          },
        });
      }

      function destroyMemoSortables() {
        memoSortables.forEach((s) => {
          try {
            s.destroy();
          } catch (_) {}
        });
        memoSortables = [];
      }

      // ★ 依目前 DOM 的實際位置，回填每張備忘的分類與排序序號(order)
      function commitMemoPositionsFromDOM() {
        let changed = false;
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const secId = sec.id;
            const tasks = sec.querySelectorAll(".task");
            tasks.forEach((t, idx) => {
              const id = t.dataset.id;
              if (!id) return;
              const m = (memos || []).find((x) => x.id === id);
              if (!m) return;

              let updated = false;
              // 分類變更
              if (m.section !== secId) {
                m.section = secId;
                updated = true;
              }
              // 排序序號（每 10 遞增，方便未來插入）
              const ord = (idx + 1) * 10;
              if (m.order !== ord) {
                m.order = ord;
                updated = true;
              }
              if (updated) {
                m.updatedAt = Date.now();
                changed = true;
              }
            });
          });
        if (changed) saveMemos(); // 寫回雲端
      }

      function initMemoSortables() {
        destroyMemoSortables();
        if (!(memoView === "active" && isEditing)) return;

        // 每個分類區塊都是一個可投遞的清單
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const s = new Sortable(sec, {
              animation: 150,
              handle: ".memo-drag", // 只允許抓把手拖
              draggable: ".task", // 拖的是備忘條
              group: "memos", // 跨容器移動
              ghostClass: "dragging",
              onAdd: (evt) => {
                const el = evt.item;
                const id = el?.dataset?.id;
                const targetSection = evt.to?.id; // 目標分類名 = section 的 id
                if (!id || !targetSection) return;
                const m = memos.find((x) => x.id === id);
                if (m && m.section !== targetSection) {
                  m.section = targetSection;
                  m.updatedAt = Date.now();
                }
                commitMemoPositionsFromDOM();
              },
              onUpdate: () => {
                commitMemoPositionsFromDOM();

                // 目前未儲存排序順序，保持現狀即可
              },
            });
            memoSortables.push(s);
          });
      }

      /* ===== 分類：新增/編輯/刪除/更名 ===== */
      function openCategoryModal() {
        closeFabMenu(); // 關掉＋選單
        document.getElementById("newCategoryName").value = "";
        openModal("categoryModal");
      }
      function addCategory() {
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) return;
        if (categories.includes(name)) return alert("此分類已存在");
        categories.push(name);
        saveCategories();
        renderSections(categories);
        memoMonthFilter = "all";
        renderAll();
        closeModal("categoryModal");
      }
      let pendingRenameId = null;
      let pendingCategoryId = null;

      function enterEditMode() {
        if (memoView === "removed") {
          return;
        }
        isEditing = true;
        document.getElementById("app")?.classList.add("editing");
        closeFabMenu(); // 關掉＋選單

        // 每個區塊套上編輯配件
        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.add("edit-mode");

          const bar = sec.querySelector(".section-title");
          const name = sec.id;

          // 重畫標題列：☰ 名稱 ✎（X 交給 CSS 放右上角）
          bar.innerHTML = `
                <span class="drag-handle">☰</span>
                <span class="section-name">${name}</span>
                <button class="rename-btn" title="重命名">✎</button>
                <button class="delete-btn" title="刪除此分類">✕</button>
              `;

          bar.querySelector(".rename-btn").onclick = () => {
            pendingRenameId = sec.id;
            document.getElementById("renameInput").value = sec.id;
            openModal("renameModal");
          };
          bar.querySelector(".delete-btn").onclick = () =>
            confirmDeleteCategory(sec.id);
        });

        // 重新啟用拖拉
        initSectionSortable();
        initMemoSortables(); // 啟用備忘條拖拉（跨分類）

        memoMonthFilter = "all";

        renderAll();

        // 顯示底部 ✅ 鈕
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "block";
      }

      function exitEditMode() {
        commitMemoPositionsFromDOM();
        isEditing = false;
        document.getElementById("app")?.classList.remove("editing");

        // 還原標題列成只有名稱
        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.remove("edit-mode");
          const bar = sec.querySelector(".section-title");
          bar.textContent = sec.id;
        });

        // 關閉底部 ✅ 鈕
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "none";

        // 保險：銷毀並重建拖拉
        if (sectionSortable && sectionSortable.destroy) {
          sectionSortable.destroy();
          sectionSortable = null;
        }
        initSectionSortable();
        destroyMemoSortables(); // 關閉備忘條拖拉
        renderAll();

        // 更新下拉
        updateSectionOptions();
      }

      function confirmDeleteCategory(id, mode = "active") {
        pendingCategoryId = id;
        pendingCategoryMode = mode; // 記住是在哪個視圖操作的
        openModal("confirmCategoryModal");
      }
      function deleteCategoryConfirmed() {
        if (!pendingCategoryId) {
          closeModal("confirmCategoryModal");
          return;
        }

        const id = pendingCategoryId;
        const mode = pendingCategoryMode || "active";

        if (mode === "removed") {
          // 把這個分類在「已移除」中的所有備忘都清掉
          const base = stripRemovedSuffix(id);
          memos = (memos || []).filter(
            (m) => !(m.removedAt && stripRemovedSuffix(m.section) === base)
          );
          saveMemos();

          renderSections();
          renderAll();

          pendingCategoryId = null;
          pendingCategoryMode = "active";
          closeModal("confirmCategoryModal");
          return;
        }

        // === 修正點（active 分支）===
        // 1) 準備備用分類（盡量用現有第一個非本分類的；沒有就用「其它」，也順手建立）

        // 3) 從「當前」的分類清單移除該分類
        categories = categories.filter((c) => c !== id);

        // 4) 存檔與重畫
        saveMemos();
        saveCategories();
        renderSections();
        renderAll();

        pendingCategoryId = null;
        pendingCategoryMode = "active";
        closeModal("confirmCategoryModal");
      }

      function closeFabMenu() {
        const m = document.getElementById("menu");
        const fab = document.querySelector(".fab");
        m?.classList.remove("show");
        fab?.classList.remove("open");
      }

      function confirmRename() {
        const oldId = pendingRenameId;
        const newName = document.getElementById("renameInput").value.trim();
        if (!newName || document.getElementById(newName))
          return alert("名稱不可為空或已存在！");
        memos.forEach((m) => {
          if (m.section === oldId) m.section = newName;
        });
        categories = categories.map((c) => (c === oldId ? newName : c));
        saveMemos();
        saveCategories();
        renderSections(categories);
        renderAll();
        pendingRenameId = null;
        closeModal("renameModal");
      }

      /* ===== Memo CRUD ===== */
      function memoCardHTML(m) {
        const showHandle = memoView === "active" && isEditing;
        const handle = showHandle ? '<span class="memo-drag">☰</span>' : "";
        return `
    <div class="swipe-bar left"><span class="label">🗑 移除</span></div>
    <div class="task-content">
      <div class="task-title">${handle}${m.important ? "❗ " : ""}${
          m.title || ""
        }</div>
    </div>
  `;
      }

      function renderAll() {
        // 清空每個分類的 memo 卡
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            sec.querySelectorAll(".task").forEach((t) => t.remove());
          });

        const isRemoved = memoView === "removed";
        const filterVal = isRemoved
          ? memoMonthFilterRemoved
          : memoMonthFilterActive;

        // 只取當前視圖需要的資料
        const source = (Array.isArray(memos) ? memos : []).filter((m) =>
          isRemoved ? !!m.removedAt : !m.removedAt
        );

        // 篩選（月份 / 重要 + 搜尋：只比對標題/內容）
        const filtered = source.filter((m) => {
          const passMonth = (() => {
            if (filterVal === "all") return true;
            if (filterVal === "important") return !!m.important;
            const ts = getMemoRefTime(m);
            if (!ts) return false;
            if (filterVal === "recent5")
              return (Date.now() - ts) / 86400000 <= 5;
            if (filterVal === "recent30")
              return (Date.now() - ts) / 86400000 <= 30;
            return toRocYMFromTs(ts) === filterVal;
          })();
          if (!passMonth) return false;

          // ★ 只檢索標題＋內容
          return memoMatchesSearch(m);
        });

        // ★ 依「分類 + order」排序；order 不在時用 createdAt/updatedAt 作後備，讓順序可重現
        filtered.sort((a, b) => {
          const secA = isRemoved
            ? stripRemovedSuffix(a.section || "")
            : a.section || "";
          const secB = isRemoved
            ? stripRemovedSuffix(b.section || "")
            : b.section || "";
          const sc = secA.localeCompare(secB);
          if (sc !== 0) return sc;

          const ao =
            typeof a.order === "number"
              ? a.order
              : a.createdAt || a.updatedAt || 0;
          const bo =
            typeof b.order === "number"
              ? b.order
              : b.createdAt || b.updatedAt || 0;
          if (ao !== bo) return ao - bo;

          // 最後用 updatedAt 當 tie-breaker，避免不穩定
          return (a.updatedAt || 0) - (b.updatedAt || 0);
        });

        // 建立 DOM（在「已移除」視圖，section 的 id 是原始分類名）
        filtered.forEach((m) => {
          const el = document.createElement("div");
          el.className = "task" + (isRemoved ? " removed" : "");
          el.dataset.id = m.id;
          el.innerHTML = memoCardHTML(m);

          const secId = isRemoved ? stripRemovedSuffix(m.section) : m.section;
          let sec = document.getElementById(secId);

          // 找不到就丟到第一個 section，避免 throw（極少見的防呆）
          if (!sec) sec = document.querySelector("#section-container .section");
          sec?.appendChild(el);
        });

        // 非編輯時才綁 swipe（避免與拖拉衝突）
        if (!isEditing) bindSwipeToTasks?.();

        updateSectionOptions?.();

        // === 依篩選顯示/隱藏空分類（搜尋中也視為一種篩選）===
        const searchActive = (() => {
          try {
            // 若有預先 tokenize 的陣列就用它；否則讀輸入框
            if (
              Array.isArray(window.searchTokens) &&
              window.searchTokens.length
            )
              return true;
            const q = (
              document.getElementById("taskSearchInput")?.value || ""
            ).trim();
            return q.length > 0;
          } catch (_) {
            return false;
          }
        })();

        if (filterVal === "all" && !searchActive) {
          document
            .querySelectorAll("#section-container .section")
            .forEach((sec) => {
              sec.style.display = "";
            });
        } else {
          hideEmptySectionsAfterFilter();
        }

        // 只在「當前」＋ 編輯中啟用拖拉
        if (isEditing && memoView === "active") initMemoSortables();

        // 依目前檢視重建月份選單
        buildMemoMonthMenu();
      }

      function getMemoRefTime(m) {
        return m?.updatedAt || m?.createdAt || null;
      }
      function toRocYMFromTs(ts) {
        if (!ts) return "無";
        const d = new Date(ts);
        if (isNaN(d)) return "無";
        const yy = d.getFullYear() - 1911;
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${yy}${mm}`;
      }

      function hideEmptySectionsAfterFilter() {
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const hasVisible = Array.from(sec.querySelectorAll(".task")).some(
              (el) => getComputedStyle(el).display !== "none"
            );
            sec.style.display = hasVisible ? "" : "none";
          });
      }

      function hideEmptySections() {
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const has = sec.querySelector(".task");
            sec.style.display = has ? "" : "";
          });
      }

      function addMemo() {
        const section = document.getElementById("memoSection").value;
        const title = document.getElementById("memoTitle").value.trim();
        const content = document.getElementById("memoContent").value;
        const important = document.getElementById("memoImportant").checked;
        if (!title) return;

        const id = "memo-" + Date.now();
        const now = Date.now();
        const memo = {
          id,
          section,
          title,
          content,
          important,
          createdAt: now,
          updatedAt: now,
          order: Date.now(),
        };

        memos.push(memo);
        saveMemos();
        renderAll();
        document.getElementById("memoTitle").value = "";
        document.getElementById("memoContent").value = "";
        document.getElementById("memoImportant").checked = false;
        closeModal("memoModal");
      }

      function openDetail(id) {
        selectedMemoId = id;
        const m = memos.find((x) => x.id === id);
        if (!m) return;

        document.getElementById("detailSection").value = m.section;
        document.getElementById("detailTitle").value = m.title;
        document.getElementById("detailContent").value = m.content || "";
        document.getElementById("detailImportant").checked = !!m.important;

        const lbl = document.getElementById("detailLastUpdate");
        lbl.textContent = m.updatedAt
          ? "更新：" + formatRocDateTime(m.updatedAt)
          : "";

        resetDetailPanels();

        const isRemoved = memoView === "removed";
        // 標籤文案
        const labels = document.querySelectorAll("#detailForm label");
        if (labels[0])
          labels[0].textContent = isRemoved ? "分類（已移除）" : "備忘分類";

        // 欄位唯讀/禁用
        document.getElementById("detailSection").disabled = isRemoved;
        document.getElementById("detailTitle").readOnly = isRemoved;
        document.getElementById("detailContent").readOnly = isRemoved;
        document.getElementById("detailImportant").disabled = isRemoved;

        // 儲存鈕 → 我知道了！
        const saveBtn = document.querySelector(
          "#detailForm .btn-half.btn-save"
        );
        if (saveBtn) {
          if (isRemoved) {
            saveBtn.textContent = "我知道了！";
            saveBtn.onclick = () => {
              closeModal("detailModal");
            };
          } else {
            saveBtn.textContent = "💾 儲存";
            saveBtn.onclick = saveMemo;
          }
        }

        document.getElementById("detailModal").style.display = "flex";
      }

      function saveMemo() {
        if (!selectedMemoId) return;
        const m = memos.find((x) => x.id === selectedMemoId);
        if (!m) return;

        m.section = document.getElementById("detailSection").value;
        m.title = document.getElementById("detailTitle").value;
        m.content = document.getElementById("detailContent").value;
        m.important = document.getElementById("detailImportant").checked;
        m.updatedAt = Date.now();

        saveMemos();
        renderAll();
        closeModal("detailModal");
      }

      function confirmDelete() {
        const title = document.querySelector("#confirmModal h3");
        if (title) {
          title.textContent =
            memoView === "removed"
              ? "確定要永久刪除這則備忘？"
              : "確定要移到「已移除」？";
        }
        openModal("confirmModal");
      }

      function deleteMemo() {
        if (!selectedMemoId) return;
        const idx = memos.findIndex((x) => x.id === selectedMemoId);
        if (idx < 0) return;

        if (memoView === "removed") {
          // 永久刪除
          memos.splice(idx, 1);
        } else {
          // 軟刪除 → 丟到「已移除」
          const m = memos[idx];
          m.removedAt = Date.now();
          m.updatedAt = m.updatedAt || Date.now();
        }

        saveMemos();
        renderAll();
        closeModal("confirmModal");
        closeModal("detailModal");
      }

      /* ===== Swipe（只保留左滑刪除；右滑完成禁用） ===== */
      function bindSwipeToTasks() {
        document.querySelectorAll(".task").forEach((task) => {
          if (task.dataset.swipeBound === "1") return;
          task.dataset.swipeBound = "1";
          task.onclick = null;

          const barL = task.querySelector(".swipe-bar.left");
          const labL = barL?.querySelector(".label");

          let sx = 0,
            sy = 0,
            dx = 0,
            dy = 0,
            width = 0,
            isDown = false,
            activeId = null,
            mode = "pending";
          const H_START = 16,
            V_CANCEL = 10,
            DOMINANCE = 1.3,
            BOUND = 0.75,
            MAX_TILT = 3;

          task.addEventListener("pointerdown", onDown);
          task.addEventListener("pointermove", onMove);
          task.addEventListener("pointerup", onUp);
          task.addEventListener("pointercancel", onCancel);
          task.addEventListener("lostpointercapture", onCancel);

          // 吞 click，自己判定「點一下」
          task.addEventListener(
            "click",
            (e) => {
              e.preventDefault();
              e.stopImmediatePropagation();
            },
            true
          );

          function onDown(e) {
            if (e.target.closest("button,input,select,textarea")) return;
            isDown = true;
            activeId = e.pointerId;
            sx = e.clientX;
            sy = e.clientY;
            dx = dy = 0;
            width = task.offsetWidth || 1;
            mode = "pending";
            task.style.transition = "none";
            try {
              task.setPointerCapture(e.pointerId);
            } catch (_) {}
          }
          function onMove(e) {
            if (!isDown || e.pointerId !== activeId) return;
            if (mode === "scroll") return;
            dx = e.clientX - sx;
            dy = e.clientY - sy;
            // 垂直為主 → 捲動
            if (mode === "pending") {
              const adx = Math.abs(dx),
                ady = Math.abs(dy);
              if (ady > V_CANCEL && ady > adx * 1.2) {
                mode = "scroll";
                resetBars();
                task.style.transform = "";
                return;
              }
              if (adx < H_START) return;
              if (adx > ady * DOMINANCE) {
                mode = "swipe";
              } else {
                mode = "scroll";
                return;
              }
            }
            if (mode !== "swipe") return;

            // 只處理左滑（刪除）
            const adx = Math.abs(dx);
            const pct = Math.min(1, adx / width);
            const tilt = (dx / width) * MAX_TILT;
            task.style.transform = `translateX(${Math.round(
              dx
            )}px) rotate(${tilt}deg)`;
            if (dx < 0) {
              barL.style.width = pct * 100 + "%";
              labL.style.opacity = Math.min(1, pct * 1.2);
              labL.style.transform = `translateX(${pct > 0.05 ? 0 : 6}px)`;
            } else {
              resetBars(); // 右滑不啟用
            }
          }
          function onUp(e) {
            finish(false);
          }
          function onCancel(e) {
            finish(true);
          }
          function finish(cancel) {
            const tapLike =
              Math.abs(dx) < 4 && Math.abs(dy) < 4 && mode !== "scroll";
            const wasSwipe = mode === "swipe";
            mode = "pending";
            isDown = false;
            activeId = null;
            task.style.transition = "transform .18s";
            task.style.transform = "";
            resetBars();

            if (!wasSwipe && !cancel && tapLike) {
              openDetail(task.dataset.id);
              cleanup();
              return;
            }

            if (!wasSwipe || cancel) {
              cleanup();
              return;
            }
            const passed = Math.abs(dx) >= width * BOUND;
            if (passed && dx < 0) {
              selectedMemoId = task.dataset.id;
              setTimeout(() => confirmDelete(), 10);
            }
            cleanup();
          }
          function cleanup() {
            dx = dy = 0;
            try {
              task.releasePointerCapture?.(activeId);
            } catch (_) {}
          }
          function resetBars() {
            if (barL) {
              barL.style.width = "0%";
              labL.style.opacity = 0;
              labL.style.transform = "translateX(6px)";
            }
          }
        });
      }

      /* ===== 展開閱讀面板（undo/redo/copy） ===== */
      let __expandedFieldId = null,
        __viewerHistory = [],
        __viewerRedoStack = [];
      function toggleDetailExpand(fieldId, title) {
        const form = document.getElementById("detailForm");
        const viewer = document.getElementById("detailViewer");
        const vTitle = document.getElementById("viewerTitle");
        const vBody = document.getElementById("viewerBody");

        // 先移除舊監聽（原程式碼保留）
        if (__expandedFieldId) {
          const prev = document.getElementById(__expandedFieldId);
          if (prev?.__viewerSync) {
            prev.removeEventListener("input", prev.__viewerSync);
            prev.__viewerSync = null;
          }
          if (vBody?.__formSync) {
            vBody.removeEventListener("input", vBody.__formSync);
            vBody.__formSync = null;
          }
          if (vBody?.__histHandler) {
            vBody.removeEventListener("input", vBody.__histHandler);
            vBody.__histHandler = null;
          }
        }

        // ★ 強化：只有在 viewer 目前是打開狀態時，才把同一鍵當作「收合」
        const isViewerOpen = viewer.classList.contains("show");
        const willCollapse =
          isViewerOpen &&
          __expandedFieldId &&
          (!fieldId || fieldId === __expandedFieldId);
        if (willCollapse) {
          form.classList.remove("hide");
          viewer.classList.remove("show");
          __expandedFieldId = null;
          return;
        }

        const src = document.getElementById(fieldId);
        vTitle.textContent = title || "";
        vBody.value = src ? src.value || "" : "";
        viewer.classList.add("show");
        form.classList.add("hide");
        __expandedFieldId = fieldId;

        if (src) {
          src.__viewerSync = () => {
            vBody.value = src.value || "";
          };
          src.addEventListener("input", src.__viewerSync);

          vBody.__formSync = () => {
            src.value = vBody.value || "";
          };
          vBody.addEventListener("input", vBody.__formSync);
        }

        __viewerHistory = [vBody.value || ""];
        __viewerRedoStack = [];
        if (vBody.__histHandler)
          vBody.removeEventListener("input", vBody.__histHandler);
        let timer = null;
        vBody.__histHandler = () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            pushViewerHistory(vBody.value || "");
          }, 180);
        };
        vBody.addEventListener("input", vBody.__histHandler);
      }

      function resetDetailPanels() {
        const form = document.getElementById("detailForm"),
          viewer = document.getElementById("detailViewer");
        const vBody = document.getElementById("viewerBody");
        if (vBody?.__histHandler) {
          vBody.removeEventListener("input", vBody.__histHandler);
          vBody.__histHandler = null;
        }
        __viewerHistory = [];
        __viewerRedoStack = [];
        __expandedFieldId = null; // ★ 加這行：避免下一次點擊被誤判為「收合」
        viewer?.classList.remove("show");
        form?.classList.remove("hide");
      }

      function pushViewerHistory(v) {
        if (
          !__viewerHistory.length ||
          __viewerHistory[__viewerHistory.length - 1] !== v
        ) {
          __viewerHistory.push(v);
          if (__viewerHistory.length > 100) __viewerHistory.shift();
        }
        __viewerRedoStack = [];
      }
      function viewerUndo() {
        const v = document.getElementById("viewerBody");
        if (__viewerHistory.length <= 1) return;
        const cur = __viewerHistory.pop();
        __viewerRedoStack.push(cur);
        v.value = __viewerHistory[__viewerHistory.length - 1];
        if (v.__formSync) v.__formSync();
      }
      function viewerRedo() {
        const v = document.getElementById("viewerBody");
        if (!__viewerRedoStack.length) return;
        const redo = __viewerRedoStack.pop();
        v.value = redo;
        if (v.__formSync) v.__formSync();
        pushViewerHistory(v.value);
      }
      function viewerCopy() {
        const t = document.getElementById("viewerBody").value || "";
        if (!t) return alert("沒有可複製的內容");
        (navigator.clipboard?.writeText(t) || Promise.reject())
          .then(() => alert("已複製內容"))
          .catch(() => {
            try {
              const ta = document.createElement("textarea");
              ta.value = t;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
              alert("已複製內容");
            } catch (_) {
              alert("複製失敗");
            }
          });
      }

      /* ===== 調色盤 ===== */
      function setAppBgColor(color) {
        const body = document.body;
        if (color === "metal") {
          body.classList.add("bg-metal");
          document.documentElement.style.setProperty("--app-bg", "#ececec");
        } else {
          body.classList.remove("bg-metal");
          document.documentElement.style.setProperty("--app-bg", color);
        }
        try {
          localStorage.setItem("app_bg_fixed", color);
        } catch (_) {}
      }
      function applySavedBgColor() {
        try {
          const saved = localStorage.getItem("app_bg_fixed");
          if (saved) setAppBgColor(saved);
        } catch (_) {}
      }
      applySavedBgColor();

      document
        .getElementById("openPaletteBtn")
        .addEventListener("click", () => openModal("paletteModal"));
      let pendingColor = null;
      document.addEventListener("click", (e) => {
        const tile = e.target.closest(".palette-choice");
        if (!tile) return;
        const wrap = document.getElementById("paletteModal");
        wrap
          .querySelectorAll(".palette-choice")
          .forEach((t) => t.classList.remove("selected"));
        tile.classList.add("selected");
        pendingColor = tile.dataset.color;
      });
      document
        .getElementById("paletteConfirmBtn")
        .addEventListener("click", () => {
          if (pendingColor) setAppBgColor(pendingColor);
          closeModal("paletteModal");
        });
        
          // 新增：讓「取消」關閉調色盤（並順手清空選取狀態）
  document.getElementById("paletteCancelBtn").addEventListener("click", () => {
    pendingColor = null;
    document
      .querySelectorAll("#paletteModal .palette-choice")
      .forEach(el => el.classList.remove("selected"));
    closeModal("paletteModal");
  });


      /* ===== 互動補強 ===== */
      // 點背景關閉 modal
      // 點背景關閉 modal（※ detailModal 例外：點背景不關）
      document.addEventListener("click", (e) => {
        const modal = e.target.closest(".modal");
        if (!modal) return;
        if (getComputedStyle(modal).display === "none") return;

        // 「備忘內容」視窗不啟用背景點擊關閉
        if (modal.id === "detailModal") return;

        const content = modal.querySelector(".modal-content");
        if (!content || !content.contains(e.target)) closeModal(modal.id);
      });

      // Esc 關閉
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.querySelectorAll(".modal").forEach((m) => {
            if (getComputedStyle(m).display !== "none") closeModal(m.id);
          });
          closeFabMenu(); // ← 新增：若 menu 展開也一併收
        }
      });

      /* ===== 其他 ===== */
      function formatRocDateTime(ts) {
        if (!ts && ts !== 0) return "";
        const d = new Date(ts);
        if (isNaN(d)) return "";
        const y = d.getFullYear() - 1911,
          m = d.getMonth() + 1,
          dd = d.getDate();
        const hh = String(d.getHours()).padStart(2, "0"),
          mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}/${m}/${dd} ${hh}:${mm}`;
      }

      /* ===== 初始資料 ===== */
      document.addEventListener("DOMContentLoaded", () => {
        try {
          memoView = localStorage.getItem("memo_view") || "active";
          memoMonthFilterActive =
            localStorage.getItem("memo_filter_active") || "all";
          memoMonthFilterRemoved =
            localStorage.getItem("memo_filter_removed") || "all";
        } catch (_) {}
        // 預設先畫空容器，等雲端回來再畫
        renderSections(categories);
      });

      function openLogoutModal() {
        openModal("logoutModal");
      }

      function showView(view) {
        const login = document.getElementById("loginPage");
        const app = document.getElementById("app");
        const load = document.getElementById("loadingScreen");

        login.style.display = view === "login" ? "flex" : "none";
        app.style.display = view === "app" ? "block" : "none";
        load.style.display = view === "loading" ? "flex" : "none";
      }

      // ===== Section 空白處：長按新增備忘（不阻擋捲動）＋ 輕點彈跳 =====
      (function enableCleanLongPressNewMemo() {
        const PRESS_MS = 900; // 長按門檻
        const MOVE_TOL = 10; // 位移門檻
        const PRESS_VISUAL_DELAY = 100; // 視覺壓下延遲

        const container = document.getElementById("section-container");
        if (!container) return;

        let timer = null,
          visualTimer = null;
        let startX = 0,
          startY = 0;
        let moved = false,
          longPressed = false;
        let pressSection = null;

        function isEligibleTarget(e) {
          if (memoView === "removed") return false;

          if (isEditing) return false; // 編輯分類時停用
          const sec = e.target.closest(".section"); // 必須點在分類區塊裡
          if (!sec) return false;
          if (e.target.closest(".task")) return false; // 不是點在卡片上
          if (e.target.closest(".drag-handle")) return false; // 不是把手
          return sec;
        }

        function clearTimers() {
          if (timer) {
            clearTimeout(timer);
            timer = null;
          }
          if (visualTimer) {
            clearTimeout(visualTimer);
            visualTimer = null;
          }
        }

        function removePressVisual() {
          if (pressSection) pressSection.classList.remove("__pressed");
        }

        function pointerDown(e) {
          const sec = isEligibleTarget(e);
          if (!sec) return;

          pressSection = sec;
          longPressed = false;
          moved = false;

          const p = e.touches ? e.touches[0] : e;
          startX = p.clientX;
          startY = p.clientY;

          clearTimers();

          // 視覺壓下（稍微延遲，避免一開始就縮小）
          visualTimer = setTimeout(() => {
            pressSection && pressSection.classList.add("__pressed");
          }, PRESS_VISUAL_DELAY);

          // 長按計時：到時觸發新增備忘並預選該分類
          timer = setTimeout(() => {
            longPressed = true;
            removePressVisual();
            clearTimers();
            openMemoModal(pressSection?.id);
          }, PRESS_MS);
        }

        function pointerMove(e) {
          if (!timer && !visualTimer) return;
          const p = e.touches ? e.touches[0] : e;
          const dx = Math.abs(p.clientX - startX);
          const dy = Math.abs(p.clientY - startY);

          // 移動太多或明顯垂直捲動 → 取消長按
          const verticalIntent = dy > dx + 2;
          if (dx > MOVE_TOL || dy > MOVE_TOL || verticalIntent) {
            moved = true;
            clearTimers();
            removePressVisual();
          }
        }

        function pointerUpOrCancel(e) {
          const wasLong = longPressed;
          clearTimers();

          // 短按且沒移動 → 小彈跳回饋
          if (pressSection && !wasLong && !moved) {
            const stillOk = isEligibleTarget(e) === pressSection;
            if (stillOk) {
              pressSection.classList.add("__bump");
              setTimeout(
                () => pressSection && pressSection.classList.remove("__bump"),
                200
              );
            }
          }
          removePressVisual();
          pressSection = null;
          moved = false;
          longPressed = false;
        }

        // 綁定（滑鼠 + 觸控）；觸控設為 passive 讓捲動順暢
        container.addEventListener("mousedown", pointerDown);
        container.addEventListener("mousemove", pointerMove);
        document.addEventListener("mouseup", pointerUpOrCancel);

        container.addEventListener("touchstart", pointerDown, {
          passive: true,
        });
        container.addEventListener("touchmove", pointerMove, { passive: true });
        container.addEventListener("touchend", pointerUpOrCancel, {
          passive: true,
        });
        container.addEventListener("touchcancel", pointerUpOrCancel, {
          passive: true,
        });
      })();

      function show(el) {
        if (el) el.style.display = "flex";
      }
      function hide(el) {
        if (el) el.style.display = "none";
      }

      async function bootFromTask() {
        const overlay = document.getElementById("autologin-overlay");
        const app = document.getElementById("app");

        // ★ 貼這三行（讀 fast_switch，決定寬限時間）
        const fast = sessionStorage.getItem("fast_switch") === "1";
        sessionStorage.removeItem("fast_switch");
        const graceMs = fast ? 800 : 400;

        // 0) 先不要動遮罩，保持 hidden（HTML/CSS 預設 display:none）
        // ★ 不要 overlay.style.display = "flex";

        // 1) 沒 roomPath 就回登入
        const rp = hydrateRoomPath();
        if (!rp) {
          location.replace("index.html");
          return;
        }
        roomPath = rp;

        // 2) 先綁觀察者（拿到 user 後會自動 bindFirebase + 顯示 App）
        attachAuthObserver();

        // 3) 固定會話（不要阻塞 UI）
        try {
          await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        } catch (_) {}

        // 4) 快速路徑：若 currentUser 已經就緒，直接進 App，完全不顯示遮罩
        if (auth.currentUser) {
          bindFirebase();
          app.style.display = "block";
          overlay.style.display = "none";
          return;
        }

        // 5) ★ 寬限 400ms：這段時間等 Firebase 還原既有 session
        const grace = setTimeout(() => {
          // 仍然沒有使用者 → 才把遮罩打開
          if (!auth.currentUser) overlay.style.display = "flex";
        }, 400);

        try {
          // 6) ★ 如果真的沒有 session，就匿名登入（觀察者會在登入後關遮罩）
          startAutoLoginWatchdog(8000);
          await auth.signInAnonymously();
        } catch (e) {
          console.warn("Anonymous sign-in failed", e);
          alert("自動登入失敗，請重新整理");
          overlay.style.display = "none";
        } finally {
          clearTimeout(grace);
          stopAutoLoginWatchdog();
        }
      }

      document.addEventListener("DOMContentLoaded", bootFromTask);
      function sanitizeKey(s) {
        return String(s).replace(/[.#$/\[\]\/]/g, "_");
      }

      function hydrateRoomPath() {
        let saved = null;
        try {
          saved =
            sessionStorage.getItem("todo_room_info") ||
            localStorage.getItem("todo_room_info") ||
            sessionStorage.getItem("todo_room_info_session") ||
            localStorage.getItem("todo_room_info_session");
        } catch (_) {}

        if (!saved) return null;

        try {
          const { username, password } = JSON.parse(saved);
          if (!username || !password) return null;
          return `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
        } catch (_) {
          return null;
        }
      }

      async function logout() {
        try {
          localStorage.removeItem("todo_room_info");
        } catch (_) {}
        try {
          await auth.signOut();
        } catch (_) {}
        window.location.href = "index.html";
      }
      // --- 看門狗（只有真的在嘗試登入時才會啟動） ---
      let __loginPending = false;
      let __autoLoginWD = null;

      function startAutoLoginWatchdog(ms = 8000) {
        stopAutoLoginWatchdog();
        __loginPending = true;
        __autoLoginWD = setTimeout(() => {
          if (!__loginPending) return;
          console.warn("[auto] login watchdog fired");
          runAutoLoginRescue(); // 可選：見下
        }, ms);
      }
      function stopAutoLoginWatchdog() {
        __loginPending = false;
        if (__autoLoginWD) {
          clearTimeout(__autoLoginWD);
          __autoLoginWD = null;
        }
      }

      // --- 觀察者：唯一入口，決定何時綁資料、顯示 App、關遮罩 ---
      function attachAuthObserver() {
        auth.onAuthStateChanged((user) => {
          const overlay = document.getElementById("autologin-overlay");
          const app = document.getElementById("app");
          if (user) {
            bindFirebase();
            app.style.display = "block";
            overlay.style.display = "none";
          }
        });
      }

      // ---（可選）救援：硬重置 Firebase 並重新登入匿名 ---
      async function runAutoLoginRescue() {
        try {
          console.warn("[auto] rescue: hard reset firebase");
          unbindFirebase();
          try {
            await firebase.app().delete();
          } catch (_) {}
          firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          db = firebase.database();
          attachAuthObserver(); // 重新綁觀察者

          await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
          await auth.signInAnonymously();
        } catch (e) {
          console.error("[auto] rescue failed", e);
          alert("登入逾時，請重新整理或稍後再試");
          document.getElementById("autologin-overlay").style.display = "none";
        } finally {
          stopAutoLoginWatchdog();
        }
      }

      // === 讓編輯模式在 re-render 後持續套用 ===
      function applyEditModeUI() {
        if (!isEditing || memoView !== "active") return;

        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.add("edit-mode");
          const bar = sec.querySelector(".section-title");
          const name = sec.id;
          bar.innerHTML = `
      <span class="drag-handle">☰</span>
      <span class="section-name">${name}</span>
      <button class="rename-btn" title="重命名">✎</button>
      <button class="delete-btn" title="刪除此分類">✕</button>
    `;

          bar.querySelector(".rename-btn").onclick = () => {
            pendingRenameId = sec.id;
            document.getElementById("renameInput").value = sec.id;
            openModal("renameModal");
          };
          bar.querySelector(".delete-btn").onclick = () =>
            confirmDeleteCategory(sec.id);
        });

        // 只在編輯時啟用拖拉
        initSectionSortable?.();
        initMemoSortables();

        // 底部的 ✅ 要持續顯示
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "block";
      }

      // 已移除檢視中的分類顯示：當前仍存在 → 原名；當前已刪 → 加 (已移除)
      function getRemovedSectionLabel(name) {
        const alive = (categories || []).includes(name);
        return alive ? name : `${name}(已移除)`;
      }

      const REMOVED_SUFFIX = "(已移除)";

      function stripRemovedSuffix(name = "") {
        return name.endsWith(REMOVED_SUFFIX)
          ? name.slice(0, -REMOVED_SUFFIX.length)
          : name;
      }

      function getRemovedSectionLabel(name) {
        // name 可能已經帶了(已移除)，先還原成原名後再決定顯示
        const base = stripRemovedSuffix(name);
        const alive = (categories || []).includes(base);
        return alive ? base : `${base}${REMOVED_SUFFIX}`;
      }
    </script>
    <script>
      /* ===== Google Drive × MyMemo（單檔全包；參考你 MyTask 版本）===== */
      /* ✅ 你的 Google OAuth Client ID（沿用你提供的） */
      const GOOGLE_CLIENT_ID =
        "735593435771-otisn8depskof8vmvp6sp5sl9n3t5e25.apps.googleusercontent.com";

      /* 權限：僅限本 App 建立/讀取 + 讀取檔名 */
      const GD_SCOPES = [
        "https://www.googleapis.com/auth/drive.file",
        "https://www.googleapis.com/auth/drive.metadata.readonly",
      ].join(" ");

      /* 根資料夾改為 MyMemo */
      const ROOT_APP_FOLDER = "MyMemo";

      /* --- 內部狀態 --- */
      let __gapiReady = false;
      let __gisReady = false;
      let __tokenClient = null;

      /* ✅ 第一次授權後要自動補跑一次的旗標 & 預備視窗 */
      const GD_POST_OPEN_KEY = "gdrive_post_open_memo";
      let __gd_prewin = null;

      /* 判斷 iOS PWA（供開 App 深連結時使用） */
      const isIOSPWA = (() => {
        try {
          const ua = navigator.userAgent || "";
          const isiOS =
            /iPad|iPhone|iPod/.test(ua) ||
            (/Macintosh/.test(ua) && navigator.maxTouchPoints > 1);
          const standalone = !!(
            window.matchMedia?.("(display-mode: standalone)")?.matches ||
            navigator.standalone
          );
          return isiOS && standalone;
        } catch {
          return false;
        }
      })();

      /* ---- 動態載入 Google SDK（單檔統包）---- */
      function addScriptOnce(src, id) {
        return new Promise((res, rej) => {
          if (id && document.getElementById(id)) return res();
          const s = document.createElement("script");
          if (id) s.id = id;
          s.src = src;
          s.async = true;
          s.defer = true;
          s.onload = () => res();
          s.onerror = () => rej(new Error("load fail: " + src));
          document.head.appendChild(s);
        });
      }

      async function loadGapiOnce() {
        if (__gapiReady && __gisReady && __tokenClient) return;

        if (!window.google?.accounts?.oauth2) {
          await addScriptOnce(
            "https://accounts.google.com/gsi/client",
            "gsi_client_js"
          );
        }
        if (!window.gapi) {
          await addScriptOnce("https://apis.google.com/js/api.js", "gapi_js");
        }

        await new Promise((r) => gapi.load("client", r));
        await gapi.client.init({});
        // ✅ 改用 discovery doc，Safari 穩定很多
        await gapi.client.load(
          "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        );
        __gapiReady = true;

        __tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: GD_SCOPES,
          callback: () => {},
          // ✅ 先關掉，避免 Safari / iOS 無聲失敗
          // use_fedcm_for_prompt: true,
        });
        __gisReady = true;
      }

      /* ---- OAuth / Token ---- */
      // 取代你現有的 ensureDriveAuth()
      async function ensureDriveAuth() {
        await loadGapiOnce();

        // 提早 10 分鐘刷新
        const skew = 10 * 60 * 1000;
        const exp = +localStorage.getItem("gdrive_token_exp") || 0;
        const tok = gapi.client.getToken();
        if (tok?.access_token && Date.now() + skew < exp) return; // 仍有效

        const alreadyConsented =
          localStorage.getItem("gdrive_consent_done") === "1";

        // 把 GIS 回呼包成 Promise，真的等到結果才往下
        const resp = await new Promise((resolve, reject) => {
          __tokenClient.callback = (r) => {
            if (r && r.access_token) return resolve(r);
            // 一些情況回傳 {error: "..."}；也可能是字串
            reject(r?.error || "授權失敗");
          };
          try {
            __tokenClient.requestAccessToken({
              prompt: alreadyConsented ? "" : "consent",
            });
          } catch (e) {
            // 少數環境需要強制 prompt（含 iOS PWA）
            if (alreadyConsented) {
              try {
                __tokenClient.requestAccessToken({ prompt: "consent" });
              } catch (e2) {
                reject(e2);
              }
            } else {
              reject(e);
            }
          }
        });

        // 只有真的拿到 token 才會跑到這裡
        gapi.client.setToken({ access_token: resp.access_token });
        const ttl = resp.expires_in ? resp.expires_in * 1000 : 60 * 60 * 1000;
        localStorage.setItem(
          "gdrive_token_exp",
          String(Date.now() + ttl - skew)
        );
        localStorage.setItem("gdrive_consent_done", "1");

        // 第一次授權：自動補跑一次（你原本邏輯）
        if (localStorage.getItem(GD_POST_OPEN_KEY) === "1") {
          setTimeout(async () => {
            try {
              const m = getCurrentDetailMemo();
              if (m) {
                const id = await ensureExistingOrRecreateFolder(m);
                updateDriveButtonState(m);
                openDriveFolderWeb(id, __gd_prewin);
              }
            } finally {
              localStorage.removeItem(GD_POST_OPEN_KEY);
              __gd_prewin = null;
            }
          }, 0);
        }
      }

      /* ---- 外觀：按鈕高亮（有資料夾時） ---- */
      function ensureDriveGlowCss() {
        if (document.getElementById("driveGlowCss")) return;
        const css = `
    .btn-gdrive { margin-left:.35rem;padding:.4rem .6rem;border:1px solid #ddd;background:#f9f9f9;border-radius:6px;cursor:pointer; }
    .btn-gdrive.has-folder { background:#FFD54F; border-color:#FFC107; box-shadow:0 0 .6rem rgba(255,193,7,.6); animation:drive-glow 1.2s ease-in-out infinite alternate; }
    @keyframes drive-glow { from { box-shadow:0 0 .35rem rgba(255,193,7,.45);} to { box-shadow:0 0 1rem rgba(255,193,7,.95);} }
  `;
        const st = document.createElement("style");
        st.id = "driveGlowCss";
        st.textContent = css;
        document.head.appendChild(st);
      }
      function updateDriveButtonState(memoObj) {
        const btn = document.getElementById("gdriveBtn");
        if (!btn) return;
        btn.classList.toggle(
          "has-folder",
          !!(memoObj && memoObj.driveFolderId)
        );
      }

      /* ---- Drive：資料夾工具 ---- */
      function escapeForQuery(s) {
        return String(s).replace(/['\\]/g, "\\$&");
      }

      async function findOrCreateFolderByName(name, parentId /* or 'root' */) {
        const q = [
          `name = '${escapeForQuery(name)}'`,
          `mimeType = 'application/vnd.google-apps.folder'`,
          `'${parentId}' in parents`,
          "trashed = false",
        ].join(" and ");

        const list = await gapi.client.drive.files.list({
          q,
          fields: "files(id,name)",
          pageSize: 1,
          includeItemsFromAllDrives: true,
          supportsAllDrives: true,
        });

        if (list?.result?.files?.length) return list.result.files[0].id;

        const created = await gapi.client.drive.files.create({
          resource: {
            name,
            mimeType: "application/vnd.google-apps.folder",
            parents: [parentId],
          },
          fields: "id",
          supportsAllDrives: true,
        });
        return created.result.id;
      }

      async function ensureFolderPath(segments) {
        let parent = "root";
        for (const seg of segments)
          parent = await findOrCreateFolderByName(seg, parent);
        return parent; // 末端 id
      }

      /* ---- 開啟資料夾（行動裝置優先呼叫 App） ---- */
      function openDriveFolderWeb(id, preWin) {
        const webUrl = `https://drive.google.com/drive/folders/${id}`;
        const ua = (navigator.userAgent || "").toLowerCase();
        const isAndroid = /android/.test(ua);
        const isIOS =
          /iphone|ipad|ipod/.test(ua) ||
          ((navigator.userAgent || "").includes("Macintosh") &&
            navigator.maxTouchPoints > 1);

        const iosSchemeUrl = `googledrive://${webUrl}`;
        const androidIntentUrl =
          `intent://drive.google.com/drive/folders/${id}` +
          `#Intent;scheme=https;package=com.google.android.apps.docs;end`;

        const usePreWin = (url) => {
          try {
            if (preWin && !preWin.closed) {
              preWin.location.href = url;
              setTimeout(() => {
                try {
                  preWin.close();
                } catch (_) {}
              }, 1500);
              return true;
            }
          } catch (_) {}
          return false;
        };

        if (isAndroid) {
          if (!usePreWin(androidIntentUrl))
            window.location.href = androidIntentUrl;
          return;
        }
        if (isIOS) {
          if (isIOSPWA) {
            // iOS PWA：直接用頂層導向呼叫 App，避免留下空白分頁
            try {
              window.location.href = iosSchemeUrl;
            } catch (_) {}
            return;
          }
          // iOS Safari（非 PWA）：維持預備分頁邏輯
          if (!usePreWin(iosSchemeUrl)) window.location.href = iosSchemeUrl;
          return;
        }
        // 桌機 → 開網頁
        try {
          window.open(webUrl, "_blank")?.focus?.();
        } catch (_) {
          window.location.href = webUrl;
        }
      }
      /* ---- 取得目前「備忘詳情」對應的 Memo 物件 ---- */
      function getCurrentDetailMemo() {
        if (typeof selectedMemoId !== "undefined" && selectedMemoId) {
          return (
            (Array.isArray(memos) ? memos : []).find(
              (m) => m.id === selectedMemoId
            ) || null
          );
        }
        return null;
      }

      /* ---- 主流程：建立或開啟資料夾（MyMemo / 分類 / 標題） ---- */
      async function openOrCreateDriveFolderForCurrentMemo() {
        const m = getCurrentDetailMemo();
        if (!m) return;

        await ensureDriveAuth();

        const segs = [
          ROOT_APP_FOLDER,
          m.section || "未分類",
          (m.title || "未命名").slice(0, 100),
        ];
        const folderId = await ensureFolderPath(segs);

        // 記住 ID 並存雲
        m.driveFolderId = folderId;
        try {
          window.saveMemos?.();
        } catch (_) {}

        updateDriveButtonState(m);
        openDriveFolderWeb(folderId, __gd_prewin);
      }

      /* 若已有 ID，驗證存在；不存在則重建路徑 */
      async function ensureExistingOrRecreateFolder(m) {
        if (m.driveFolderId) {
          try {
            const r = await gapi.client.drive.files.get({
              fileId: m.driveFolderId,
              fields: "id, trashed",
              supportsAllDrives: true,
            });
            if (r?.result?.id && !r.result.trashed) return m.driveFolderId;
          } catch (_) {
            // 404/無權限 → 重建
          }
          m.driveFolderId = null;
          try {
            window.saveMemos?.();
          } catch (_) {}
        }
        const segs = [
          ROOT_APP_FOLDER,
          m.section || "未分類",
          (m.title || "未命名").slice(0, 100),
        ];
        const newId = await ensureFolderPath(segs);
        m.driveFolderId = newId;
        try {
          window.saveMemos?.();
        } catch (_) {}
        updateDriveButtonState(m);
        return newId;
      }

      /* 僅開啟（若沒記錄就轉主流程建立） */
      function openCurrentMemoDriveFolder() {
        const m = getCurrentDetailMemo();
        if (!m) return;
        if (m.driveFolderId) openDriveFolderWeb(m.driveFolderId);
        else openOrCreateDriveFolderForCurrentMemo();
      }

      /* ---- 在詳情「重要」右邊插入按鈕 ---- */
      function ensureDriveButtonsInlineUI(memoObj) {
        ensureDriveGlowCss();
        // 找到 詳情 的那一排（分類下拉 + 重要）
        const row = document.querySelector("#detailForm .inline-row");
        if (!row) return;

        if (!row.querySelector("#gdriveBtn")) {
          const btn = document.createElement("button");
          btn.id = "gdriveBtn";
          btn.type = "button";
          btn.title = "建立/開啟此備忘的雲端資料夾";
          btn.style.cssText =
            "width:30px;height:30px;aspect-ratio:1/1;padding:0;" +
            "border:1px solid #ddd;border-radius:6px;" +
            "background:#f9f9f9 url('https://cdn.jsdelivr.net/gh/a355226/kj-reminder@main/drive.png') no-repeat center/18px 18px;" +
            "display:inline-flex;align-items:center;justify-content:center;" +
            "appearance:none;-webkit-appearance:none;line-height:0;box-sizing:border-box;cursor:pointer;";
          btn.className = "btn-gdrive";
          row.appendChild(btn);
        }
        updateDriveButtonState(memoObj);
      }

      /* ---- 點擊行為（含第一次授權的預備視窗） ---- */
      async function onDriveButtonClickMemo() {
        const m = getCurrentDetailMemo();
        if (!m) return;

        // 在「已移除」檢視：只允許開啟既有，不新建
        if (window.memoView === "removed") {
          if (m.driveFolderId) {
            openDriveFolderWeb(m.driveFolderId);
          } else {
            alert("此備忘在「已移除」檢視，僅能開啟既有資料夾。");
          }
          return;
        }

        try {
          const firstTime = localStorage.getItem("gdrive_consent_done") !== "1";
          if (firstTime) {
            // 首次授權一律立旗標，讓 ensureDriveAuth 完成後自動補跑開啟
            localStorage.setItem(GD_POST_OPEN_KEY, "1");
            if (!isIOSPWA) {
              // 非 iOS PWA 才開預備分頁（提升喚起成功率）
              try {
                __gd_prewin = window.open("", "_blank");
              } catch (_) {
                __gd_prewin = null;
              }
            } else {
              // iOS PWA 不開預備分頁，避免殘留空白頁
              __gd_prewin = null;
            }
          } else {
            // 非首次：不需要旗標與預備分頁
            localStorage.removeItem(GD_POST_OPEN_KEY);
            __gd_prewin = null;
          }

          await ensureDriveAuth();
          if (firstTime) return; // 交給 ensureDriveAuth 的補跑邏輯處理

          const folderId = await ensureExistingOrRecreateFolder(m);
          updateDriveButtonState(m);

          openDriveFolderWeb(folderId, __gd_prewin);

          localStorage.removeItem(GD_POST_OPEN_KEY);
          __gd_prewin = null;
        } catch (e) {
          localStorage.removeItem(GD_POST_OPEN_KEY);
          __gd_prewin = null;
          const msg =
            e?.result?.error?.message || e?.message || JSON.stringify(e);
          alert("Google 雲端硬碟動作失敗：" + msg);
          console.error("Drive error:", e);
        }
      }

      /* ---- 暖機：載入 SDK，pageshow 回補，首次授權後自動開啟 ---- */
      (function driveWarmup() {
        const kickoff = () => {
          loadGapiOnce().catch((e) => console.warn("Drive warmup failed:", e));
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", kickoff, {
            once: true,
          });
        } else {
          kickoff();
        }

        window.addEventListener(
          "pageshow",
          () => {
            if (!__gapiReady || !__gisReady || !__tokenClient) {
              loadGapiOnce().catch(() => {});
            }
            if (localStorage.getItem(GD_POST_OPEN_KEY) === "1") {
              (async () => {
                try {
                  await ensureDriveAuth();
                  const m = getCurrentDetailMemo();
                  if (m) {
                    const id = await ensureExistingOrRecreateFolder(m);
                    updateDriveButtonState(m);
                    openDriveFolderWeb(id, __gd_prewin);
                  }
                } finally {
                  localStorage.removeItem(GD_POST_OPEN_KEY);
                  __gd_prewin = null;
                }
              })().catch(() => {});
            }
          },
          { once: true }
        );
      })();

      // ---- 取代原本的 hookOpenDetailForMemo（延一幀插入）----
      (function hookOpenDetailForMemo() {
        const original = window.openDetail;
        window.openDetail = function (id) {
          original?.call(this, id);
          // 等詳情 DOM 真正 render 完再插入按鈕
          requestAnimationFrame(() => {
            try {
              ensureDriveButtonsInlineUI(getCurrentDetailMemo());
            } catch (_) {}
          });
        };
      })();

      // ---- 全域事件委派：不靠 btn.onclick，避免被重繪吃掉 ----
      document.addEventListener(
        "click",
        (e) => {
          const btn = e.target.closest("#gdriveBtn");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          // 明確呼叫，任何時機都吃得到
          (async () => {
            try {
              await onDriveButtonClickMemo();
            } catch (err) {
              const msg =
                err?.result?.error?.message || err?.message || String(err);
              alert("Google 雲端硬碟動作失敗：" + msg);
              console.error("Drive error:", err);
            }
          })();
        },
        false
      );

      Object.assign(window, {
        onDriveButtonClickMemo,
        openCurrentMemoDriveFolder,
        openOrCreateDriveFolderForCurrentMemo,
        ensureDriveButtonsInlineUI,
      });

      /* ===== Search 狀態與工具 ===== */
      let searchQuery = "";
      let searchTokens = [];

      function setSearchQuery(q = "") {
        searchQuery = (q || "").trim();
        searchTokens = searchQuery
          ? searchQuery.toLowerCase().split(/\s+/).filter(Boolean)
          : [];
        renderAll();
      }

      // 只比對「標題 + 內容」
      function memoMatchesSearch(m) {
        if (!searchTokens.length) return true;
        const hay = ((m.title || "") + " " + (m.content || "")).toLowerCase();
        return searchTokens.every((tok) => hay.includes(tok));
      }

      // 安全轉義 + 高亮
      function escHTML(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch])
        );
      }
      function hiHTML(s = "", tokens) {
        if (!tokens?.length) return escHTML(s);
        let out = escHTML(s);
        tokens.forEach((t) => {
          if (!t) return;
          const re = new RegExp(
            `(${t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
            "gi"
          );
          out = out.replace(re, '<span class="hl">$1</span>');
        });
        return out;
      }
      function makeSnippet(text = "", tokens, max = 80) {
        const raw = text || "";
        if (!tokens?.length)
          return raw.length > max ? raw.slice(0, max - 1) + "…" : raw;
        const lower = raw.toLowerCase();
        let pos = -1;
        for (const t of tokens) {
          const i = lower.indexOf(t);
          if (i >= 0) {
            pos = i;
            break;
          }
        }
        if (pos < 0)
          return raw.length > max ? raw.slice(0, max - 1) + "…" : raw;
        const start = Math.max(0, pos - Math.floor(max / 2));
        const end = Math.min(raw.length, start + max);
        const slice =
          (start > 0 ? "…" : "") +
          raw.slice(start, end) +
          (end < raw.length ? "…" : "");
        return slice;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // 綁定 moreModal 搜尋欄
        let __searchDebounce = null;
        function bindModalSearch() {
          const box = document.getElementById("taskSearchInput");
          const clear = document.getElementById("taskSearchClear");
          if (!box || box.__bound) return;
          box.__bound = true;

          const syncClear = () => {
            if (clear)
              clear.style.visibility = box.value ? "visible" : "hidden";
          };

          // 初始
          box.value = searchQuery;
          syncClear();

          box.addEventListener("input", (e) => {
            clearTimeout(__searchDebounce);
            __searchDebounce = setTimeout(() => {
              setSearchQuery(e.target.value);
              syncClear();
            });
          });

          // Esc 清除
          box.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              e.stopPropagation();
              box.value = "";
              setSearchQuery("");
              syncClear();
            }
          });

          // 右側 X
          clear?.addEventListener("click", () => {
            box.value = "";
            setSearchQuery("");
            syncClear();
            box.focus();
          });
        }

        // 打開 moreModal 時，同步搜尋欄位與按鈕狀態
        const _openModal = window.openModal;
        window.openModal = function (id) {
          _openModal.call(this, id);
          if (id === "moreModal") {
            // 你的檢視切換保持不變，這裡只處理搜尋欄
            const box = document.getElementById("taskSearchInput");
            const clear = document.getElementById("taskSearchClear");
            if (box) {
              bindModalSearch();
              box.value = searchQuery;
              if (clear)
                clear.style.visibility = box.value ? "visible" : "hidden";
              setTimeout(() => box.focus(), 0);
            }
          }
        };
      });
    </script>

    <!-- Loading（切換中） -->
    <div id="loadingScreen" style="display: none">
      <div class="loading-wrap">
        <div class="loading-spinner"></div>
        <div class="loading-text">切換中…</div>
      </div>
    </div>
  </body>
</html>