<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <title>MyMemo</title>

    <!-- Icons / PWA å¯è‡ªè¡Œæ›¿æ› -->
    <link rel="icon" type="image/png" sizes="32x32" href="mymemo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="mymemo.png" />

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <!-- Sortable (åˆ†é¡æ‹–æ‹‰ç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
      :root {
        --blue-light: #ebf5fc;
        --yellow-light: #fffbe6; /* ç”¨ MyTask çš„é»ƒ */
        --white: #fff;
        --gray-text: #444;
        --app-bg: var(--blue-light);
      }
      * {
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }
      /* å…¨åŸŸè¼¸å…¥å…ƒä»¶å­—é«”å¤§å° */
      input,
      select,
      textarea,
      option {
        font-size: 16px; /* æ¨è–¦æ‰‹æ©Ÿå®‰å…¨å­—é«”å¤§å°ï¼Œé¿å… iOS è‡ªå‹•æ”¾å¤§ */
        line-height: 1.4; /* è¡Œé«˜ç¨å¾®åŠ é«˜ä¸€é»ï¼Œé–±è®€æ›´èˆ’æœ */
      }
      button {
        font-size: 15px;
      }
      body {
        margin: 0;
        background: var(--app-bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 16px;
      }
      .container {
        width: 100%;
        max-width: 480px;
        position: relative;
        display: none;
      }

      /* æ¨™é¡Œ */
      h1 {
        display: inline-flex; /* åŸæœ¬æ˜¯ flex */
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 24px;
        margin: 6px 0 10px;
        padding: 4px 10px;
        color: #444;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
      }

      h1:hover {
        background: rgba(0, 0, 0, 0.05);
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08) inset;
      }

      /* â‹¯ */
      /* â‹¯ æŒ‰éˆ•æœ¬èº«ï¼ˆåŸç‰ˆï¼‰ */
      /* â‹¯ æµ®éˆ•ï¼ˆåŸç‰ˆå°ºå¯¸/é™°å½±ï¼‰ */
      .more-btn {
        position: fixed;
        top: 12px;
        left: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #fff;
        color: #555;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 100;
        line-height: 1;
      }

      /* æ›´å¤šåŠŸèƒ½ï¼šå°å¡ç‰‡å¯¬åº¦èˆ‡ç·Šå¯¦æ¨™é¡Œ */
      #moreModal .modal-content {
        max-width: 300px;
      }
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }
      .more-row-inline {
        justify-content: flex-start !important;
        gap: 0.75rem;
      }

      /* row ä½ˆå±€ï¼šå·¦æ–‡å³éˆ• */
      .more-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin: 10px 0;
      }

      /* å°æ·ºåº•ï¼šèª¿è‰²ç›¤æŒ‰éˆ• */
      button.palette-btn {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        padding: 4px 8px !important;
        font-size: 0.85rem !important;
        font-weight: normal;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9 !important;
        color: #333 !important;
        width: auto !important;
        min-width: unset !important;
        margin-top: 0; /* ä¿æŒç·Šè²¼æ¨™é¡Œ */
      }
      button.palette-btn:hover {
        background: #f1f1f1 !important;
      }
      button.palette-btn:active {
        background: #e8e8e8 !important;
      }

      /* èª¿è‰²ç›¤ä¹å®®æ ¼ */
      /* --- èª¿è‰²ç›¤æŒ‰éˆ•ï¼ˆå°æ·ºåº•ï¼‰å·²åœ¨ä½ æª”æ¡ˆå…§ï¼Œä¿ç•™å³å¯ --- */

      /* èª¿è‰²ç›¤ä¹å®®æ ¼ï¼ˆä½ å·²æœ‰ï¼Œé€™è£¡è£œè¶³ data-color èƒŒæ™¯èˆ‡é¸å–æ…‹ï¼‰ */
      .palette-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-top: 0.5rem;
      }
      .palette-choice {
        position: relative;
        width: 100%;
        aspect-ratio: 1/1;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        overflow: hidden;
      }
      .palette-choice[data-color="#f6fbfe"] {
        background: #f6fbfe;
      }
      .palette-choice[data-color="#f3fcf8"] {
        background: #f3fcf8;
      }
      .palette-choice[data-color="#fffcf3"] {
        background: #fffcf3;
      }
      .palette-choice[data-color="#fef6f9"] {
        background: #fef6f9;
      }
      .palette-choice[data-color="#f9f8fd"] {
        background: #f9f8fd;
      }
      .palette-choice[data-color="#ffeded"] {
        background: #ffeded;
      }
      .palette-choice[data-color="#fff8f5"] {
        background: #fff8f5;
      }
      .palette-choice[data-color="#fdfcf9"] {
        background: #fdfcf9;
      }
      .palette-choice[data-color="metal"] {
        background: #e5e5e5;
      }
      .palette-choice .metal-sheen {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.35),
            rgba(255, 255, 255, 0.1)
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.08) 0 1px,
            rgba(0, 0, 0, 0.04) 1px 2px
          );
        mix-blend-mode: screen;
        pointer-events: none;
      }
      .palette-choice.selected {
        outline: 3px solid #176dff;
        box-shadow: 0 0 0 3px rgba(23, 109, 255, 0.15) inset;
      }

      /* èª¿è‰²ç›¤åº•éƒ¨ï¼šç¢ºèªï¼å–æ¶ˆï¼ˆèˆ‡ MyTask é¢¨æ ¼ä¸€è‡´ï¼‰ */
      .dialog-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 12px;
      }
      .btn-primary,
      .btn-secondary {
        flex: 1;
        height: 42px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        border: 0;
        margin-top: 1rem;
      }
      .btn-primary {
        background: #fc97ba;
        color: #fff;
        box-shadow: 0 6px 16px rgba(0, 170, 255, 0.28);
      }
      .btn-primary:hover {
        background: #ffa49c;
      }
      .btn-primary:active {
        transform: translateY(1px);
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .btn-secondary:hover {
        background: #eee;
      }

      /* æ›´å¤šåŠŸèƒ½å…§çš„è¡Œæ’åˆ—ï¼šå·¦æ–‡å³éˆ• */
      .more-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin: 10px 0;
      }

      /* æ¨™é¡Œæ›´ç·Šå¯¦ä¸€äº›ï¼ŒåƒåŸç‰ˆ */
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }

      /* è—è‰²å¤§æŒ‰éˆ•ï¼šç™»å‡º */
      .logout-btn {
        width: 100%;
        height: 46px;
        background: #00aaff; /* ä¸»è— */
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 6px 16px rgba(0, 170, 255, 0.28);
      }
      .logout-btn:hover {
        background: #0791e6;
      }
      .logout-btn:active {
        transform: translateY(1px);
      }

      /* æ¨™é¡Œé–“è·ï¼ˆçœ‹èµ·ä¾†è·ŸåŸç‰ˆä¸€æ¨£ç·Šå¯¦ï¼‰ */
      #moreModal .modal-content h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: 1.1rem;
      }

      /* ä»Šæ—¥å¾½ç« ï¼ˆå³ä¸Šè§’è¼•é‡ï¼‰ */
      #today-badge {
        position: fixed;
        top: 14px;
        right: 12px;
        z-index: 90;
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(6px);
        color: rgba(50, 50, 50, 0.85);
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.3px;
        pointer-events: none;
      }

      /* å€å¡Š/å¡ç‰‡ */
      .section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .section-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--yellow-light);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
      }
      .task-content {
        flex: 1;
      }
      .task-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .task .task-preview {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* é€²åº¦æ¢ï¼ˆæ»‘å‹•ï¼‰â€” åªä¿ç•™å·¦å´åˆªé™¤ */
      .swipe-bar {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 0%;
        display: flex;
        align-items: center;
        pointer-events: none;
        transition: width 0.18s;
      }
      .swipe-bar.left {
        right: 0;
        justify-content: flex-end;
        background: #ffe4e6;
        color: #5c2020;
      }
      .swipe-bar .label {
        font-weight: 800;
        opacity: 0;
        transition: opacity 0.12s, transform 0.12s;
        transform: translateX(6px);
        margin: 0 12px;
      }

      /* FAB */
      .fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 170, 255, 0.85) !important;
        color: #fff;
        font-size: 28px;
        font-weight: 700;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        z-index: 110;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease,
          background-color 0.2s ease;
      }
      .fab:hover {
        background: rgba(0, 170, 255, 0.95) !important;
      }
      .fab:active {
        transform: scale(0.98);
      }
      .fab.open {
        transform: rotate(45deg);
      }

      /* ç»ç’ƒå¡é¸å–® */
      .menu {
        position: fixed;
        bottom: 88px;
        right: 24px;
        min-width: 100px;
        padding: 8px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(180, 210, 255, 0.35);
        box-shadow: 0 12px 28px rgba(0, 60, 130, 0.12);
        display: block; /* ç”¨é€æ˜æ§åˆ¶é¡¯ç¤º */
        opacity: 0;
        transform: translateY(8px) scale(0.98);
        pointer-events: none;
        z-index: 105;
      }
      .menu.show {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
        transition: opacity 0.18s ease, transform 0.18s ease;
      }
      .menu button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        background: transparent;
        border: 0;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        color: #176dff; /* æ·ºè—ç³»ä¸»è‰² */
        letter-spacing: 0.2px;
        cursor: pointer;
      }
      .menu button:hover {
        background: linear-gradient(0deg, #eef6ff, #f7fbff);
      }
      .menu button:active {
        transform: translateY(1px);
      }
      .menu button + button {
        margin-top: 4px;
      }
      .menu::after {
        content: "";
        position: absolute;
        right: 12px;
        bottom: -6px;
        width: 12px;
        height: 12px;
        background: rgba(255, 255, 255, 0.72);
        border: 1px solid rgba(180, 210, 255, 0.35);
        border-top: none;
        border-left: none;
        transform: rotate(45deg);
        box-shadow: 4px 4px 10px rgba(0, 60, 130, 0.06);
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-content {
        width: 90%;
        max-width: 420px;
        background: #fff;
        border-radius: 12px;
        padding: 14px;
        position: relative;
      }
      .close-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        width: 28px;
        height: 28px;
        border: 0;
        border-radius: 50%;
        background: #eee;
        cursor: pointer;
      }

      .modal-content label {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.95rem;
      }
      .modal-content input:not([type="checkbox"]),
      .modal-content select,
      .modal-content textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 0.25rem;
        font-size: 16px;
      }
      .inline-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.25rem;
      }
      .half {
        width: 50%;
        min-width: 160px;
      }
      .important-flag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        white-space: nowrap;
      }

      .save-btn {
        width: 100%;
        padding: 0.6rem;
        border: 0;
        border-radius: 6px;
        background: #77d4bc;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
        margin-top: 1rem;
        font-size: 16px;
      }
      .row-btns {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .btn-half {
        flex: 1;
        padding: 0.6rem;
        border: 0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-save {
        background: #e8faf3;
        color: #176d59;
        border: 1px solid #ccefe2;
      }
      .btn-del {
        background: #fff3f3;
        color: #b23b3b;
        border: 1px solid #ffd8d8;
      }

      /* Login */
      #loginPage {
        display: flex;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        background: #ebf5fc;
      }
      #loginCard {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 24px;
        width: 95%;
        max-width: 450px;
      }
      .login-input {
        width: 100%;
        height: 44px;
        padding: 0 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        margin: 0.6rem 0 1rem;
      }
      .login-btn {
        width: 100%;
        height: 46px;
        background: #00aaff;
        color: #fff;
        border: 0;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
      }
      .login-btn:hover {
        background: #0791e6;
      }

      /* å¹³æ»‘éœ§é¢é‡‘å±¬æ•ˆæœï¼ˆç„¡æ ¼ç·šæ„Ÿï¼‰ */
      body.bg-metal::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;

        /* æŸ”å…‰é«˜äº® + å‚ç›´åˆ·çµ²ç´‹è·¯ï¼ˆè¶…ç´°å¾®ï¼‰ */
        background-image: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.2),
            rgba(255, 255, 255, 0.12)
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.03) 0px,
            rgba(255, 255, 255, 0.03) 1px,
            rgba(0, 0, 0, 0.02) 1px,
            rgba(0, 0, 0, 0.02) 2px
          );

        background-blend-mode: screen, normal;

        /* è®“ç´‹ç†æ¥µåº¦ç´°ç·»ï¼Œé¿å…ç¶²æ ¼æ„Ÿ */
        background-size: 100% 100%, 600px 100%;
        background-repeat: no-repeat, repeat;

        /* è¼•å¾®å°æ¯”èˆ‡é£½å’Œåº¦ï¼Œä¿ç•™é‡‘å±¬æ„Ÿ */
        filter: contrast(103%) saturate(97%);
      }

      /* å±•é–‹é–±è®€é¢æ¿ï¼ˆå«å¾©åŸ/é‡åš/è¤‡è£½ï¼‰ */
      #detailViewer {
        display: none;
      }
      #detailViewer.show {
        display: block;
      }
      #detailForm.hide {
        display: none;
      }
      .viewer-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
      .viewer-title {
        font-weight: 700;
      }
      .viewer-close {
        border: 1px solid #ddd;
        background: #f7f7f7;
        border-radius: 6px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
      }
      .viewer-toolbar {
        display: flex;
        gap: 0.4rem;
        margin: 0.1rem 0 0.4rem;
      }
      .vt-btn {
        border: 1px solid #ddd;
        background: #f8f8f8;
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      .viewer-body {
        width: 100%;
        min-height: 50vh;
        padding: 0.75rem;
        border: 1px solid #eee;
        border-radius: 8px;
        background: #fafafa;
        line-height: 1.6;
        font-size: 0.95rem;
        resize: vertical;
      }

      /* === ç·¨è¼¯æ¨¡å¼ï¼šæ¨™é¡Œè¡Œå¯æ”¾æŠŠæ‰‹/é‰›ç­†/åˆªé™¤ï¼ŒX å›ºå®šåœ¨æœ€å³ === */
      .section.edit-mode .rename-btn,
      .section.edit-mode .delete-btn {
        display: inline-flex !important;
      }

      .section-title {
        position: relative; /* è®“å³ä¸Šè§’ X å¯ä»¥çµ•å°å®šä½ */
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* æŠŠæ‰‹ */
      .drag-handle {
        cursor: grab;
        color: #888;
      }

      /* é‰›ç­†ï¼šè·Ÿåœ¨æ–‡å­—å¾Œï¼ˆä¸è¦çµ•å°å®šä½ï¼‰ */
      .rename-btn {
        position: static;
        border: 0;
        background: transparent;
        color: #999;
        cursor: pointer;
      }

      /* X åœ¨æœ€å³ä¸Šè§’ */
      .delete-btn {
        position: absolute;
        top: 0;
        right: 0;
        border: 0;
        background: transparent;
        color: #999;
        cursor: pointer;
        display: none; /* åªåœ¨ edit-mode é¡¯ç¤º */
      }

      /* è®“åˆ†é¡å€å¯è¢«è¼•è§¸å›é¥‹ */
      #section-container {
        -webkit-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        touch-action: pan-y; /* å…è¨±ä¸Šä¸‹æ²å‹• */
      }

      /* é»å£“ä¸­çš„å¾®ç¸®æ•ˆæœ */
      .section.__pressed {
        transform: scale(0.985);
        transition: transform 120ms ease;
      }

      /* é»ä¸€ä¸‹çš„å°å½ˆè·³æ•ˆæœ */
      @keyframes __bump {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(0.985);
        }
        100% {
          transform: scale(1);
        }
      }
      .section.__bump {
        animation: __bump 0.18s ease;
      }

      #loadingScreen {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        background: var(--app-bg);
      }
      #loadingScreen .loading-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 16px 20px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(8px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      }
      .loading-spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid rgba(0, 0, 0, 0.15);
        border-top-color: rgba(0, 0, 0, 0.5);
        animation: spin 0.9s linear infinite;
      }
      .loading-text {
        color: #444;
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* åŠ åœ¨ä½ çš„ <style> è£¡ */
      #app {
        display: none;
      } /* ç­‰é©—è­‰å®Œå†é¡¯ç¤º */

      /* è®“é€²åº¦æ¢å…§éƒ¨ä¸æœƒå› å¯¬åº¦è®Šå‹•è€Œæ›è¡Œ/è·³å‹• */
      .swipe-bar {
        overflow: hidden; /* å¯¬åº¦ä¸å¤ æ™‚æŠŠå·¦å´è¶…å‡ºéƒ¨åˆ†è£æ‰ */
      }

      .swipe-bar .label {
        white-space: nowrap; /* ç¦æ­¢æ›è¡Œï¼ˆCJK ä¹Ÿä¸æ›ï¼‰ */
        flex: 0 0 auto; /* ä¸è¦è¢«å£“ç¸® */
        width: 72px; /* å›ºå®šä¸€å€‹å¯¬åº¦ï¼šğŸ—‘ +ã€Œç§»é™¤ã€å‰›å¥½å–®è¡Œ */
        text-align: right; /* æ–‡å­—é å³å°é½Šï¼Œè¦–è¦ºä¸Šè²¼è¿‘å³é‚Š */
        letter-spacing: 0.02em; /* å¯æœ‰å¯ç„¡ï¼šå¾®èª¿å­—è· */
      }

      /* å·²ç§»é™¤ï¼šæ·ºè‰²æ¯›ç»ç’ƒå¡ç‰‡ */
      .task.removed {
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(8px) saturate(1.05);
        -webkit-backdrop-filter: blur(8px) saturate(1.05);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .task.removed .task-title {
        color: #555;
        font-weight: 600;
      }

      /* åœ¨ã€Œå·²ç§»é™¤ã€æª¢è¦–æ™‚ï¼Œå¼·åˆ¶é¡¯ç¤ºåˆ†é¡å³ä¸Šè§’çš„ X */
      #app.view-removed .section .delete-btn {
        display: inline-flex !important;
      }

      /* ã€Œå·²ç§»é™¤ã€æª¢è¦–æ™‚ï¼Œå³ä¸‹ï¼‹æ¡åç°åŠé€æ˜ï¼ˆä¸”ä¸å¯é»ï¼‰ */
      .fab.fab-disabled {
        opacity: 0.38;
        filter: grayscale(100%);
        background: rgba(200, 200, 200, 0.5) !important;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        pointer-events: none;
      }

      /* é è¨­ä¸é¡¯ç¤ºå‚™å¿˜æ‹–æ‹‰æŠŠæ‰‹ */
      .memo-drag {
        display: none;
      }

      /* åªæœ‰ç·¨è¼¯ä¸­æ‰é¡¯ç¤ºæŠŠæ‰‹ */
      #app.editing .memo-drag {
        display: inline-flex;
        margin-right: 6px;
        color: #888;
        cursor: grab;
      }

      /* ç·¨è¼¯ä¸­å…è¨±æ‹–æ‹‰å¡ç‰‡ï¼ˆé¿å…å…ˆå‰æŠŠ .task è¨­æˆ pointer-events:noneï¼‰ */
      #app.editing .task {
        pointer-events: auto;
        cursor: grab;
      }

      /* ===== æœå°‹æ¬„ï¼ˆæ”¾åœ¨ moreModal è£¡ï¼‰ ===== */
      #moreModal .modal-content {
        position: relative;
      }
      .search-wrap {
        max-width: 200px;
        margin: 0 auto 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0 0 0.25rem 0;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(180, 210, 255, 0.35);
        box-shadow: 0 8px 20px rgba(0, 60, 130, 0.08);
        margin-bottom: 1rem;
      }
      .search-ico {
        font-size: 1rem;
        opacity: 0.7;
        transform: translateY(1px);
        pointer-events: none;
      }
      #taskSearchInput {
        flex: 1;
        height: 24px;
        border: 0;
        outline: none;
        background: transparent;
        font-size: 12px;
      }
      #taskSearchInput::placeholder {
        color: #9aa7bd;
      }
      .search-clear {
        border: 0;
        background: #eef3ff;
        color: #4a6aa8;
        width: 20px;
        height: 20px;
        font-size: 12px;
        border-radius: 50%;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
      }
      .search-clear:active {
        transform: translateY(1px);
      }

      /* æœå°‹éš±è—ï¼ˆä¸å½±éŸ¿å…¶å®ƒç¯©é¸ï¼Œèƒ½ç–ŠåŠ ï¼‰ */
      .task.search-hide {
        display: none !important;
      }
      
            /* åªè®“ #memoContent æœ‰æœ€å°é«˜åº¦ï¼›ä¿ç•™å³ä¸‹è§’å¯èª¿æ•´ */
#memoContent{
  min-height: 30vh;
  resize: vertical;     /* è‹¥ä¹‹å‰è¢«é—œæ‰ï¼Œé€™è¡Œå¯è®“å³ä¸‹è§’æ‰‹æŠŠå›ä¾† */
  box-sizing: border-box;
}
    </style>
  </head>
  <body>
    <!-- æ”¾åœ¨ <body> è£¡ã€#app ä¹‹å‰ -->
    <div
      id="autologin-overlay"
      aria-hidden="true"
      style="
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        z-index: 260;
      "
    >
      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.75rem;
          padding: 16px 18px;
          border-radius: 14px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid rgba(180, 210, 255, 0.35);
          box-shadow: 0 12px 28px rgba(0, 60, 130, 0.12);
        "
      >
        <div
          style="
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 3px solid #e6f4ff;
            border-top-color: #00aaff;
            animation: spin 0.8s linear infinite;
          "
        ></div>
        <div
          style="
            font-weight: 700;
            letter-spacing: 0.3px;
            color: #176dff;
            font-size: 14px;
          "
        >
          åˆ‡æ›ä¸­â€¦
        </div>
      </div>
    </div>

    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

    </style>

    <!-- App -->
    <div class="container" id="app">
      <div class="more-btn" onclick="openModal('moreModal')">â‹¯</div>
      <div id="today-badge"></div>

      <div style="text-align: center">
        <h1 onclick="location.href='index.html'" style="cursor: pointer">
          <img
            src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder@main/mymemo.png"
            alt="icon"
            width="40"
            style="transform: translateY(2px)"
          />
          MyMemo
        </h1>
      </div>

      <div id="section-container"></div>

      <div class="fab" onclick="toggleMenu()">ï¼‹</div>
      <div class="menu" id="menu">
        <button
          onclick="openMemoModal()"
          style="
            background: #e6f6fc;
            color: #0091cc;
            font-weight: 600;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            margin-bottom: 12px;
          "
        >
          æ–°å¢å‚™å¿˜
        </button>

        <button
          onclick="openCategoryModal()"
          style="
            background: #e9f9f1;
            color: #1fa87a;
            font-weight: 500;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            margin-bottom: 12px;
          "
        >
          æ–°å¢åˆ†é¡
        </button>

        <button
          onclick="enterEditMode()"
          style="
            background: #fff6e6;
            color: #d98a00;
            font-weight: 600;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            cursor: pointer;
          "
        >
          ç·¨è¼¯åˆ†é¡
        </button>
      </div>
      <!-- âœ… ç·¨è¼¯å®Œæˆï¼ˆç½®ä¸­æ‡¸æµ®ï¼‰ -->
      <button
        id="exitEditBtn"
        onclick="exitEditMode()"
        style="
          display: none;
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #e3ffe8;
          color: #176d59;
          border: none;
          border-radius: 8px;
          padding: 6px 14px;
          font-size: 13px;
          font-weight: bold;
          cursor: pointer;
          z-index: 120;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        "
      >
        âœ…
      </button>
    </div>

    <!-- æ–°å¢å‚™å¿˜ -->
    <div class="modal" id="memoModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('memoModal')">âœ•</button>
        <h3>æ–°å¢å‚™å¿˜</h3>

        <label>å‚™å¿˜åˆ†é¡</label>
        <div class="inline-row">
          <select id="memoSection" class="half"></select>
          <label class="important-flag"
            ><input type="checkbox" id="memoImportant" /> é‡è¦</label
          >
        </div>

        <label>å‚™å¿˜æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰</label>
        <input type="text" id="memoTitle" />

        <label>å‚™å¿˜å…§å®¹</label>
        <textarea id="memoContent"></textarea>

        <button class="save-btn" onclick="addMemo()">æ–°å¢</button>
      </div>
    </div>

    <!-- è©³æƒ… -->
    <div class="modal" id="detailModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('detailModal')">âœ•</button>
        <h3 style="display: flex; align-items: center; gap: 0.5rem">
          <span>å‚™å¿˜å…§å®¹</span>
          <small
            id="detailLastUpdate"
            style="font-size: 0.9rem; color: #666; white-space: nowrap"
          ></small>
        </h3>

        <!-- è¡¨å–® -->
        <div id="detailForm">
          <label>å‚™å¿˜åˆ†é¡</label>
          <div class="inline-row">
            <select id="detailSection" class="half"></select>
            <label class="important-flag"
              ><input type="checkbox" id="detailImportant" /> é‡è¦</label
            >
          </div>

          <label>å‚™å¿˜æ¨™é¡Œ</label>
          <input type="text" id="detailTitle" style="margin-bottom: 10px" />

          <div style="display: flex; align-items: center; gap: 0.4rem">
            <label for="detailContent" style="margin: 0">å‚™å¿˜å…§å®¹</label>
            <button
              type="button"
              class="expand-icon"
              onclick="event.stopPropagation(); toggleDetailExpand('detailContent','å‚™å¿˜å…§å®¹')"
              title="å±•é–‹"
              style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 22px;
                height: 22px;
                margin-left: 0.4rem;
                border-radius: 4px;
                border: 1px solid #ddd;
                background: #f8f8f8;
                cursor: pointer;
                font-size: 12px;
                color: #555;
              "
            >
              â¤¢
            </button>
          </div>
          <textarea id="detailContent"></textarea>

          <div class="row-btns">
            <button class="btn-half btn-save" onclick="saveMemo()">
              ğŸ’¾ å„²å­˜
            </button>
            <button class="btn-half btn-del" onclick="confirmDelete()">
              ğŸ—‘ï¸ ç§»é™¤
            </button>
          </div>
        </div>

        <!-- å±•é–‹é–±è®€/ç·¨è¼¯å™¨ -->
        <div id="detailViewer">
          <div class="viewer-head">
            <div class="viewer-title" id="viewerTitle"></div>
            <button
              type="button"
              class="viewer-close"
              onclick="toggleDetailExpand()"
              style="margin-top: 6px"
            >
              â¤¢
            </button>
          </div>
          <div class="viewer-toolbar">
            <button class="vt-btn" title="é‚„åŸ" onclick="viewerUndo()">
              â¤º
            </button>
            <button class="vt-btn" title="å¾©åŸ" onclick="viewerRedo()">
              â¤»
            </button>
            <button class="vt-btn" title="è¤‡è£½" onclick="viewerCopy()">
              â§‰
            </button>
          </div>
          <textarea class="viewer-body" id="viewerBody"></textarea>
        </div>
      </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª -->
    <div class="modal" id="confirmModal">
      <div class="modal-content">
        <h3 style="text-align: center">ç¢ºå®šè¦åˆªé™¤é€™å‰‡å‚™å¿˜ï¼Ÿ</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="deleteMemo()">ç¢ºèª</button>
          <button
            class="btn-half btn-save"
            onclick="closeModal('confirmModal')"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- åˆªé™¤ã€Œåˆ†é¡ã€ç¢ºèª -->
    <div class="modal" id="confirmCategoryModal">
      <div class="modal-content">
        <h3 style="text-align: center">ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡ï¼Ÿ</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="deleteCategoryConfirmed()">
            ç¢ºèª
          </button>
          <button
            class="btn-half btn-save"
            onclick="closeModal('confirmCategoryModal')"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢åˆ†é¡ -->
    <div class="modal" id="categoryModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('categoryModal')">
          âœ•
        </button>
        <h3>æ–°å¢åˆ†é¡</h3>
        <input type="text" id="newCategoryName" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±" />
        <button class="save-btn" onclick="addCategory()">æ–°å¢åˆ†é¡</button>
      </div>
    </div>

    <!-- æ›´ååˆ†é¡ -->
    <div class="modal" id="renameModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('renameModal')">âœ•</button>
        <h3>é‡å‘½ååˆ†é¡</h3>
        <input type="text" id="renameInput" placeholder="æ–°çš„åˆ†é¡åç¨±" />
        <button class="save-btn" onclick="confirmRename()">ç¢ºå®š</button>
      </div>
    </div>

    <!-- â‹¯ï¼ˆåªä¿ç•™æ›´æ›åº•è‰²èˆ‡ç™»å‡ºï¼‰ -->
    <!-- æ›´å¤šåŠŸèƒ½ Modalï¼ˆåŸç‰ˆæ¨£å¼ï¼‰ -->
    <div class="modal" id="moreModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('moreModal')">âœ•</button>
        <!-- ğŸ” æœå°‹æ¬„ï¼ˆåªä¿ç•™å³å´ Xï¼‰ -->
        <div
          id="globalSearch"
          class="search-wrap modal-search"
          role="search"
          aria-label="æœå°‹ä»»å‹™"
        >
          <span class="search-ico" aria-hidden="true">ğŸ”</span>
          <input
            id="taskSearchInput"
            type="text"
            autocomplete="off"
            placeholder="åœ¨MyMemoä¸­æœå°‹"
            aria-label="æœå°‹æ¨™é¡Œã€ä»»å‹™å…§å®¹ã€è™•ç†æƒ…å½¢"
          />
          <button
            id="taskSearchClear"
            class="search-clear"
            aria-label="æ¸…é™¤æœå°‹"
          >
            âœ•
          </button>
        </div>
        <h3>å‚™å¿˜éŒ„æª¢è¦–</h3>
        <div class="more-row more-row-inline">
          <label style="display: flex; align-items: center; gap: 0.4rem">
            <input type="checkbox" id="viewActiveToggle" />ç•¶å‰</label
          >
          <label style="display: flex; align-items: center; gap: 0.4rem">
            <input type="checkbox" id="viewRemovedToggle" />å·²ç§»é™¤</label
          >
        </div>

        <h3>æ›´æ›åº•è‰²</h3>

        <div
          class="more-row"
          style="flex-direction: column; align-items: flex-start; gap: 0.5rem"
        >
          <button id="openPaletteBtn" class="palette-btn">ğŸ¨ èª¿è‰²ç›¤</button>
        </div>

        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee" />

        <button class="logout-btn" onclick="openLogoutModal()">ç™»å‡º</button>
      </div>
    </div>

    <!-- èª¿è‰²ç›¤ -->
    <!-- èª¿è‰²ç›¤ï¼ˆåŸç‰ˆäº’å‹•ï¼šç¢ºèªï¼å–æ¶ˆï¼‰ -->
    <div class="modal" id="paletteModal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal('paletteModal')">
          âœ•
        </button>
        <h3>é¸æ“‡åº•è‰²</h3>

        <div class="palette-grid">
          <div class="palette-choice" data-color="#f6fbfe"></div>
          <div class="palette-choice" data-color="#f3fcf8"></div>
          <div class="palette-choice" data-color="#fffcf3"></div>
          <div class="palette-choice" data-color="#fef6f9"></div>
          <div class="palette-choice" data-color="#f9f8fd"></div>
          <div class="palette-choice" data-color="#ffeded"></div>
          <div class="palette-choice" data-color="#fff8f5"></div>
          <div class="palette-choice" data-color="#fdfcf9"></div>
          <div class="palette-choice" data-color="metal">
            <div class="metal-sheen"></div>
          </div>
        </div>

        <div class="dialog-actions">
          <button id="paletteConfirmBtn" class="btn-primary">ç¢ºèª</button>
          <button id="paletteCancelBtn" class="btn-secondary">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- ç™»å‡ºç¢ºèª -->
    <div class="modal" id="logoutModal">
      <div class="modal-content">
        <h3 style="text-align: center">ç¢ºå®šè¦ç™»å‡ºï¼Ÿ</h3>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
          <button class="btn-half btn-del" onclick="doLogout()">ç¢ºèª</button>
          <button class="btn-half btn-save" onclick="closeModal('logoutModal')">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <script>
      /* ===== åŸºæœ¬è¨­å®š ===== */
      const firebaseConfig = {
        apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
        authDomain: "kjreminder-24d74.firebaseapp.com",
        projectId: "kjreminder-24d74",
        storageBucket: "kjreminder-24d74.firebasestorage.app",
        messagingSenderId: "176371952161",
        appId: "1:176371952161:web:948121be209cd2e4181160",
        databaseURL:
          "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/",
      };
      firebase.initializeApp(firebaseConfig);
      let auth = firebase.auth();
      let db = firebase.database();

      /* ===== ç‹€æ…‹ ===== */
      let roomPath = ""; // rooms/{user}-{pass}
      let memos = []; // é€²è¡Œä¸­çš„å‚™å¿˜
      let categories = []; // åˆ†é¡
      let categoriesLoaded = false;
      let selectedMemoId = null;
      let memosRef = null,
        categoriesRef = null;
      let sectionSortable = null;
      let isEditing = false; // æ˜¯å¦åœ¨ç·¨è¼¯åˆ†é¡æ¨¡å¼ï¼ˆçµ¦é•·æŒ‰è¡Œç‚ºåˆ¤æ–·ï¼‰
      let memoSortables = []; // å‚™å¿˜æ¢æ‹–æ‹‰ï¼ˆè·¨åˆ†é¡ç”¨ï¼‰

      let memoMonthFilter = "all"; // 'all' | 'recent5' | '11407'ï¼ˆROC å¹´æœˆï¼‰
      let memoView = "active"; // 'active' | 'removed'
      let memoMonthFilterActive = "all";
      let memoMonthFilterRemoved = "all";
      let pendingCategoryMode = "active"; // 'active' | 'removed'

      function applyViewAffordances() {
        const fab = document.querySelector(".fab");
        const menu = document.getElementById("menu");
        const appEl = document.getElementById("app");

        // åˆ‡è¦–åœ–ç”¨ classï¼Œæ§åˆ¶ X é¡¯ç¤ºèˆ‡ FAB åç°
        appEl?.classList.toggle("view-removed", memoView === "removed");

        if (memoView === "removed") {
          fab?.classList.add("fab-disabled"); // åç°ï¼‹ä¸å¯é»
          menu?.classList.remove("show");
          fab?.classList.remove("open");
        } else {
          fab?.classList.remove("fab-disabled");
        }
      }

      function buildMemoMonthMenu() {
        const menu = document.getElementById("memoMonthMenu");
        if (!menu) return;
        menu.innerHTML = "";

        const isRemovedView = memoView === "removed";
        const list = (memos || []).filter((m) =>
          isRemovedView ? !!m.removedAt : !m.removedAt
        );

        const getFilter = () =>
          isRemovedView ? memoMonthFilterRemoved : memoMonthFilterActive;
        const setFilter = (val) => {
          if (isRemovedView) memoMonthFilterRemoved = val;
          else memoMonthFilterActive = val;
          try {
            localStorage.setItem(
              isRemovedView ? "memo_filter_removed" : "memo_filter_active",
              val
            );
          } catch (_) {}
          renderAll();
        };

        const mkBtn = (label, value) => {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.style.cssText =
            "display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;" +
            (getFilter() === value ? "font-weight:700;" : "");
          btn.onclick = () => {
            setFilter(value);
            menu.style.display = "none";
          };
          return btn;
        };

        menu.appendChild(mkBtn("å…¨éƒ¨", "all"));
        menu.appendChild(mkBtn("è¿‘5æ—¥", "recent5"));
        menu.appendChild(mkBtn("è¿‘30æ—¥", "recent30"));
        menu.appendChild(mkBtn("é‡è¦ â—", "important"));

        const monthSet = new Set();
        list.forEach((m) => {
          const ts = getMemoRefTime(m);
          const ym = toRocYMFromTs(ts);
          if (ym !== "ç„¡") monthSet.add(ym);
        });

        if (monthSet.size === 0) {
          const empty = document.createElement("div");
          empty.textContent = "ç„¡æ›´å¤šæœˆä»½";
          empty.style.cssText = "padding:6px 8px; color:#666;";
          menu.appendChild(empty);
          return;
        }
        Array.from(monthSet)
          .sort((a, b) => b.localeCompare(a))
          .forEach((ym) => menu.appendChild(mkBtn(ym, ym)));
      }

      /* ===== å°å·¥å…· ===== */

      function openModal(id) {
        document.getElementById(id).style.display = "flex";
        if (id === "moreModal") {
          const a = document.getElementById("viewActiveToggle");
          const r = document.getElementById("viewRemovedToggle");
          if (a && r) {
            a.checked = memoView === "active";
            r.checked = memoView === "removed";
          }
        }
      }

      document
        .getElementById("viewActiveToggle")
        ?.addEventListener("change", (e) => {
          const other = document.getElementById("viewRemovedToggle");
          if (e.target.checked) {
            if (other) other.checked = false;
            setMemoView("active");
          } else if (other && !other.checked) e.target.checked = true;
        });
      document
        .getElementById("viewRemovedToggle")
        ?.addEventListener("change", (e) => {
          const other = document.getElementById("viewActiveToggle");
          if (e.target.checked) {
            if (other) other.checked = false;
            setMemoView("removed");
          } else if (other && !other.checked) e.target.checked = true;
        });

      document.addEventListener("DOMContentLoaded", () => {
        try {
          memoView = localStorage.getItem("memo_view") || "active";
          memoMonthFilterActive =
            localStorage.getItem("memo_filter_active") || "all";
          memoMonthFilterRemoved =
            localStorage.getItem("memo_filter_removed") || "all";
        } catch (_) {}
        applyViewAffordances();
        renderSections();
      });

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }

      function setMemoView(view) {
        memoView = view;
        try {
          localStorage.setItem("memo_view", view);
        } catch (_) {}
        applyViewAffordances();
        renderSections();
        renderAll();
      }

      function openMemoModal(prefSectionId) {
        updateSectionOptions();
        if (prefSectionId) {
          const sel = document.getElementById("memoSection");
          const opt = sel?.querySelector(`option[value="${prefSectionId}"]`);
          if (opt) sel.value = prefSectionId;
        }
        closeFabMenu(); // é—œæ‰ï¼‹é¸å–®
        openModal("memoModal");
      }

      function toggleMenu() {
        if (memoView === "removed") return;
        const m = document.getElementById("menu");
        const fab = document.querySelector(".fab");
        const willShow = !m.classList.contains("show");
        m.classList.toggle("show", willShow);
        fab?.classList.toggle("open", willShow);
      }

      document.addEventListener("click", (e) => {
        const menu = document.getElementById("menu");
        if (!menu || !menu.classList.contains("show")) return;
        const fab = document.querySelector(".fab");
        const inside = menu.contains(e.target);
        const onFab = fab && fab.contains(e.target);
        if (!inside && !onFab) closeFabMenu(); // â† åŒæ­¥é—œ & é‚„åŸã€Œï¼‹ã€
      });

      async function doLogout() {
        // 1) é—œæ‰ Firebase ç›£è½
        try {
          if (memosRef) {
            memosRef.off();
            memosRef = null;
          }
          if (categoriesRef) {
            categoriesRef.off();
            categoriesRef = null;
          }
        } catch (_) {}

        // 2) æ¸…ç©ºæœ¬æ©Ÿç‹€æ…‹
        memos = [];
        categories = [];
        selectedMemoId = null;

        // 3) æ¸…æ‰å…©å€‹ App å…±ç”¨çš„è‡ªå‹•ç™»å…¥è³‡è¨Šï¼ˆè®“å›åˆ° index éœ€è¦é‡æ–°ç™»å…¥ï¼‰
        try {
          localStorage.removeItem("todo_room_info");
        } catch (_) {}
        roomPath = "";

        // 4) ç™»å‡º Firebase åŒ¿åæœƒè©±ï¼ˆè‹¥å­˜åœ¨ï¼‰
        try {
          await auth.signOut();
        } catch (_) {}

        // 5) é—œæ‰å½ˆçª—ï¼ˆå¯æœ‰å¯ç„¡ï¼‰
        try {
          closeModal("logoutModal");
          closeModal("moreModal");
        } catch (_) {}

        // 6) å°å› MyTask çš„ç™»å…¥é 
        location.replace("index.html"); // æˆ– window.location.href = 'index.html';
      }

      /* ===== Firebase ç¶å®š ===== */
      function bindFirebase() {
        unbindFirebase();
        memosRef = db.ref(`${roomPath}/memos`);
        categoriesRef = db.ref(`${roomPath}/memoCategories`);

        memosRef.on("value", (snap) => {
          const data = snap.val() || {};
          memos = Object.values(data);
          renderAll();
        });

        categoriesRef.on("value", (snap) => {
          const cloud = snap.val();
          if (cloud === null) {
            categories = [];
            saveCategories();
          } else if (Array.isArray(cloud)) {
            categories = cloud.slice();
          } else if (cloud && typeof cloud === "object") {
            categories = Object.values(cloud);
          } else {
            categories = [];
          }
          categoriesLoaded = true;
          renderSections(categories);
          renderAll();
        });
      }
      function unbindFirebase() {
        try {
          memosRef && memosRef.off();
          categoriesRef && categoriesRef.off();
        } catch (_) {}
      }
      function saveMemos() {
        const obj = {};
        memos.forEach((m) => (obj[m.id] = m));
        db.ref(`${roomPath}/memos`).set(obj);
      }
      function saveCategories() {
        db.ref(`${roomPath}/memoCategories`).set(categories);
      }

      /* ===== UIï¼šä»Šæ—¥å¾½ç«  ===== */
      (function () {
        const el = document.getElementById("today-badge");
        const WEEK = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        function draw() {
          const now = new Date();
          el.textContent = `${now.getMonth() + 1}/${now.getDate()}ï¼ˆ${
            WEEK[now.getDay()]
          }ï¼‰`;
        }
        draw();
        const t = new Date();
        const mid = new Date(t);
        mid.setHours(24, 0, 0, 0);
        setTimeout(() => {
          draw();
          setInterval(draw, 24 * 3600 * 1000);
        }, mid - t);
      })();

      /* ===== åˆ†é¡å€ ===== */
      function renderSections() {
        const wrap = document.getElementById("section-container");
        if (!wrap) return;

        // ä¸Šæ–¹ ğŸ—‚ï¸ + ç¯©é¸é¸å–®å®¹å™¨
        wrap.innerHTML = `
    <div id="memoMore" style="text-align:right; margin:0.25rem 0; position:relative;">
      <button id="memoMoreBtn"
              style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">
        ğŸ—‚ï¸
      </button>
      <div id="memoMonthMenu"
           style="display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd;
                  border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;">
      </div>
    </div>
  `;

        // å–å‡ºè¦é¡¯ç¤ºçš„åˆ†é¡æ¸…å–®
        // å–å‡ºè¦é¡¯ç¤ºçš„åˆ†é¡æ¸…å–®
        let names = [];
        if (memoView === "active") {
          names = (categories || []).slice();
        } else {
          // removedï¼šåªé¡¯ç¤ºã€Œæœ‰è¢«ç§»é™¤å‚™å¿˜ã€çš„åˆ†é¡ï¼ˆçµ±ä¸€ç”¨åŸå§‹åˆ†é¡åï¼‰
          const set = new Set();
          (memos || []).forEach((m) => {
            if (m.removedAt) set.add(stripRemovedSuffix(m.section));
          });
          names = Array.from(set);
        }

        // ç•«å‡ºå„åˆ†é¡çš„å€å¡Š
        names.forEach((name) => {
          if (memoView === "removed") {
            const displayName = getRemovedSectionLabel(name); // é¡¯ç¤ºç”¨(å¯èƒ½å¸¶å¾Œç¶´)
            const sec = document.createElement("div");
            sec.className = "section";
            sec.id = name; // â† id æ°¸é ç”¨ã€ŒåŸå§‹åˆ†é¡åã€
            sec.innerHTML = `
      <div class="section-title">
        <span class="section-name">${displayName}</span>
        <button class="delete-btn" title="åˆªé™¤æ­¤åˆ†é¡">âœ•</button>
      </div>
    `;
            // å³ä¸Šè§’ Xï¼šæ¸…æ‰è©²åˆ†é¡åº•ä¸‹æ‰€æœ‰ã€Œå·²ç§»é™¤ã€å‚™å¿˜ï¼ˆä¸ç®¡èˆŠè³‡æ–™æ˜¯å¦å¸¶(å·²ç§»é™¤)å¾Œç¶´ï¼‰
            sec.querySelector(".delete-btn").onclick = () =>
              confirmDeleteCategory(name, "removed");
            wrap.appendChild(sec);
          } else {
            // active è¦–åœ–ç¶­æŒåŸæ¨£
            const sec = document.createElement("div");
            sec.className = "section" + (isEditing ? " edit-mode" : "");
            sec.id = name;
            sec.innerHTML = `<div class="section-title">${name}</div>`;
            wrap.appendChild(sec);
          }
        });

        // ğŸ—‚ï¸ æŒ‰éˆ•
        document
          .getElementById("memoMoreBtn")
          ?.addEventListener("click", () => {
            const menu = document.getElementById("memoMonthMenu");
            if (!menu) return;
            menu.style.display =
              menu.style.display === "block" ? "none" : "block";
          });

        // ä¾ç›®å‰ memos é‡å»ºæœˆä»½æ¸…å–®ï¼ˆä½ çš„ buildMemoMonthMenu å…§å·²æœƒåƒç…§ memoView/memoMonthFilterï¼‰
        buildMemoMonthMenu();

        // ç·¨è¼¯æ¨¡å¼èˆ‡æ‹–æ‹‰ï¼ˆåœ¨ã€Œå·²ç§»é™¤ã€ç¦æ­¢ï¼‰
        if (memoView === "active") {
          updateSectionOptions();
          if (isEditing) {
            applyEditModeUI(); // åŠ ä¸ŠæŠŠæ‰‹ã€âœã€âœ• ç­‰
          } else {
            initSectionSortable?.();
          }
        } else {
          updateSectionOptions(); // ä¸‹æ‹‰ä»å¯çœ‹ï¼Œä½†å”¯è®€
        }

        // âœ… åº•éƒ¨ã€Œå®Œæˆç·¨è¼¯ã€æŒ‰éˆ•åªåœ¨ã€Œç•¶å‰ã€ä¸”ç·¨è¼¯ä¸­é¡¯ç¤º
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn)
          exitBtn.style.display =
            memoView === "active" && isEditing ? "block" : "none";
      }

      function updateSectionOptions() {
        const optsHTML = (categories || [])
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("");

        // æ–°å¢å‚™å¿˜ç”¨çš„ä¸‹æ‹‰
        const s1 = document.getElementById("memoSection");
        if (s1) {
          const prev = s1.value;
          if (s1.__optsHTML !== optsHTML) {
            s1.innerHTML = optsHTML;
            s1.__optsHTML = optsHTML;
          }
          // é‚„åŸåŸæœ¬é¸å–ï¼ˆå­˜åœ¨æ‰é‚„åŸï¼‰
          if (prev && Array.from(s1.options).some((o) => o.value === prev)) {
            s1.value = prev;
          }
        }

        // è©³æƒ…è¦–çª—çš„ä¸‹æ‹‰ï¼ˆé‡é»ï¼šè¦ç¶­æŒç›®å‰ memo çš„åˆ†é¡ï¼‰
        const s2 = document.getElementById("detailSection");
        if (s2) {
          const prev = s2.value;
          if (s2.__optsHTML !== optsHTML) {
            s2.innerHTML = optsHTML;
            s2.__optsHTML = optsHTML;
          }

          // ä»¥ç›®å‰é¸ä¸­çš„ memo ç‚ºæº–
          let want = prev;
          try {
            const m = (Array.isArray(memos) ? memos : []).find(
              (x) => x.id === selectedMemoId
            );
            if (m && m.section) want = m.section;
          } catch (_) {}

          if (want && Array.from(s2.options).some((o) => o.value === want)) {
            s2.value = want;
          }
          // å¦å‰‡è®“ç€è¦½å™¨ç¶­æŒç¾æ³ï¼Œä¸å¼·åˆ¶è·³ç¬¬ä¸€å€‹
        }
      }
      function initSectionSortable() {
        const el = document.getElementById("section-container");
        if (!el) return;
        if (sectionSortable && sectionSortable.destroy)
          sectionSortable.destroy();
        sectionSortable = new Sortable(el, {
          animation: 150,
          handle: ".drag-handle",
          draggable: ".section",
          ghostClass: "dragging",
          onEnd: () => {
            categories = Array.from(
              document.querySelectorAll("#section-container .section")
            ).map((sec) => sec.id);
            saveCategories();
          },
        });
      }

      function destroyMemoSortables() {
        memoSortables.forEach((s) => {
          try {
            s.destroy();
          } catch (_) {}
        });
        memoSortables = [];
      }

      // â˜… ä¾ç›®å‰ DOM çš„å¯¦éš›ä½ç½®ï¼Œå›å¡«æ¯å¼µå‚™å¿˜çš„åˆ†é¡èˆ‡æ’åºåºè™Ÿ(order)
      function commitMemoPositionsFromDOM() {
        let changed = false;
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const secId = sec.id;
            const tasks = sec.querySelectorAll(".task");
            tasks.forEach((t, idx) => {
              const id = t.dataset.id;
              if (!id) return;
              const m = (memos || []).find((x) => x.id === id);
              if (!m) return;

              let updated = false;
              // åˆ†é¡è®Šæ›´
              if (m.section !== secId) {
                m.section = secId;
                updated = true;
              }
              // æ’åºåºè™Ÿï¼ˆæ¯ 10 éå¢ï¼Œæ–¹ä¾¿æœªä¾†æ’å…¥ï¼‰
              const ord = (idx + 1) * 10;
              if (m.order !== ord) {
                m.order = ord;
                updated = true;
              }
              if (updated) {
                m.updatedAt = Date.now();
                changed = true;
              }
            });
          });
        if (changed) saveMemos(); // å¯«å›é›²ç«¯
      }

      function initMemoSortables() {
        destroyMemoSortables();
        if (!(memoView === "active" && isEditing)) return;

        // æ¯å€‹åˆ†é¡å€å¡Šéƒ½æ˜¯ä¸€å€‹å¯æŠ•éçš„æ¸…å–®
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const s = new Sortable(sec, {
              animation: 150,
              handle: ".memo-drag", // åªå…è¨±æŠ“æŠŠæ‰‹æ‹–
              draggable: ".task", // æ‹–çš„æ˜¯å‚™å¿˜æ¢
              group: "memos", // è·¨å®¹å™¨ç§»å‹•
              ghostClass: "dragging",
              onAdd: (evt) => {
                const el = evt.item;
                const id = el?.dataset?.id;
                const targetSection = evt.to?.id; // ç›®æ¨™åˆ†é¡å = section çš„ id
                if (!id || !targetSection) return;
                const m = memos.find((x) => x.id === id);
                if (m && m.section !== targetSection) {
                  m.section = targetSection;
                  m.updatedAt = Date.now();
                }
                commitMemoPositionsFromDOM();
              },
              onUpdate: () => {
                commitMemoPositionsFromDOM();

                // ç›®å‰æœªå„²å­˜æ’åºé †åºï¼Œä¿æŒç¾ç‹€å³å¯
              },
            });
            memoSortables.push(s);
          });
      }

      /* ===== åˆ†é¡ï¼šæ–°å¢/ç·¨è¼¯/åˆªé™¤/æ›´å ===== */
      function openCategoryModal() {
        closeFabMenu(); // é—œæ‰ï¼‹é¸å–®
        document.getElementById("newCategoryName").value = "";
        openModal("categoryModal");
      }
      function addCategory() {
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) return;
        if (categories.includes(name)) return alert("æ­¤åˆ†é¡å·²å­˜åœ¨");
        categories.push(name);
        saveCategories();
        renderSections(categories);
        memoMonthFilter = "all";
        renderAll();
        closeModal("categoryModal");
      }
      let pendingRenameId = null;
      let pendingCategoryId = null;

      function enterEditMode() {
        if (memoView === "removed") {
          return;
        }
        isEditing = true;
        document.getElementById("app")?.classList.add("editing");
        closeFabMenu(); // é—œæ‰ï¼‹é¸å–®

        // æ¯å€‹å€å¡Šå¥—ä¸Šç·¨è¼¯é…ä»¶
        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.add("edit-mode");

          const bar = sec.querySelector(".section-title");
          const name = sec.id;

          // é‡ç•«æ¨™é¡Œåˆ—ï¼šâ˜° åç¨± âœï¼ˆX äº¤çµ¦ CSS æ”¾å³ä¸Šè§’ï¼‰
          bar.innerHTML = `
                <span class="drag-handle">â˜°</span>
                <span class="section-name">${name}</span>
                <button class="rename-btn" title="é‡å‘½å">âœ</button>
                <button class="delete-btn" title="åˆªé™¤æ­¤åˆ†é¡">âœ•</button>
              `;

          bar.querySelector(".rename-btn").onclick = () => {
            pendingRenameId = sec.id;
            document.getElementById("renameInput").value = sec.id;
            openModal("renameModal");
          };
          bar.querySelector(".delete-btn").onclick = () =>
            confirmDeleteCategory(sec.id);
        });

        // é‡æ–°å•Ÿç”¨æ‹–æ‹‰
        initSectionSortable();
        initMemoSortables(); // å•Ÿç”¨å‚™å¿˜æ¢æ‹–æ‹‰ï¼ˆè·¨åˆ†é¡ï¼‰

        memoMonthFilter = "all";

        renderAll();

        // é¡¯ç¤ºåº•éƒ¨ âœ… éˆ•
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "block";
      }

      function exitEditMode() {
        commitMemoPositionsFromDOM();
        isEditing = false;
        document.getElementById("app")?.classList.remove("editing");

        // é‚„åŸæ¨™é¡Œåˆ—æˆåªæœ‰åç¨±
        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.remove("edit-mode");
          const bar = sec.querySelector(".section-title");
          bar.textContent = sec.id;
        });

        // é—œé–‰åº•éƒ¨ âœ… éˆ•
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "none";

        // ä¿éšªï¼šéŠ·æ¯€ä¸¦é‡å»ºæ‹–æ‹‰
        if (sectionSortable && sectionSortable.destroy) {
          sectionSortable.destroy();
          sectionSortable = null;
        }
        initSectionSortable();
        destroyMemoSortables(); // é—œé–‰å‚™å¿˜æ¢æ‹–æ‹‰
        renderAll();

        // æ›´æ–°ä¸‹æ‹‰
        updateSectionOptions();
      }

      function confirmDeleteCategory(id, mode = "active") {
        pendingCategoryId = id;
        pendingCategoryMode = mode; // è¨˜ä½æ˜¯åœ¨å“ªå€‹è¦–åœ–æ“ä½œçš„
        openModal("confirmCategoryModal");
      }
      function deleteCategoryConfirmed() {
        if (!pendingCategoryId) {
          closeModal("confirmCategoryModal");
          return;
        }

        const id = pendingCategoryId;
        const mode = pendingCategoryMode || "active";

        if (mode === "removed") {
          // æŠŠé€™å€‹åˆ†é¡åœ¨ã€Œå·²ç§»é™¤ã€ä¸­çš„æ‰€æœ‰å‚™å¿˜éƒ½æ¸…æ‰
          const base = stripRemovedSuffix(id);
          memos = (memos || []).filter(
            (m) => !(m.removedAt && stripRemovedSuffix(m.section) === base)
          );
          saveMemos();

          renderSections();
          renderAll();

          pendingCategoryId = null;
          pendingCategoryMode = "active";
          closeModal("confirmCategoryModal");
          return;
        }

        // === ä¿®æ­£é»ï¼ˆactive åˆ†æ”¯ï¼‰===
        // 1) æº–å‚™å‚™ç”¨åˆ†é¡ï¼ˆç›¡é‡ç”¨ç¾æœ‰ç¬¬ä¸€å€‹éæœ¬åˆ†é¡çš„ï¼›æ²’æœ‰å°±ç”¨ã€Œå…¶å®ƒã€ï¼Œä¹Ÿé †æ‰‹å»ºç«‹ï¼‰

        // 3) å¾ã€Œç•¶å‰ã€çš„åˆ†é¡æ¸…å–®ç§»é™¤è©²åˆ†é¡
        categories = categories.filter((c) => c !== id);

        // 4) å­˜æª”èˆ‡é‡ç•«
        saveMemos();
        saveCategories();
        renderSections();
        renderAll();

        pendingCategoryId = null;
        pendingCategoryMode = "active";
        closeModal("confirmCategoryModal");
      }

      function closeFabMenu() {
        const m = document.getElementById("menu");
        const fab = document.querySelector(".fab");
        m?.classList.remove("show");
        fab?.classList.remove("open");
      }

      function confirmRename() {
        const oldId = pendingRenameId;
        const newName = document.getElementById("renameInput").value.trim();
        if (!newName || document.getElementById(newName))
          return alert("åç¨±ä¸å¯ç‚ºç©ºæˆ–å·²å­˜åœ¨ï¼");
        memos.forEach((m) => {
          if (m.section === oldId) m.section = newName;
        });
        categories = categories.map((c) => (c === oldId ? newName : c));
        saveMemos();
        saveCategories();
        renderSections(categories);
        renderAll();
        pendingRenameId = null;
        closeModal("renameModal");
      }

      /* ===== Memo CRUD ===== */
      function memoCardHTML(m) {
        const showHandle = memoView === "active" && isEditing;
        const handle = showHandle ? '<span class="memo-drag">â˜°</span>' : "";
        return `
    <div class="swipe-bar left"><span class="label">ğŸ—‘ ç§»é™¤</span></div>
    <div class="task-content">
      <div class="task-title">${handle}${m.important ? "â— " : ""}${
          m.title || ""
        }</div>
    </div>
  `;
      }

      function renderAll() {
        // æ¸…ç©ºæ¯å€‹åˆ†é¡çš„ memo å¡
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            sec.querySelectorAll(".task").forEach((t) => t.remove());
          });

        const isRemoved = memoView === "removed";
        const filterVal = isRemoved
          ? memoMonthFilterRemoved
          : memoMonthFilterActive;

        // åªå–ç•¶å‰è¦–åœ–éœ€è¦çš„è³‡æ–™
        const source = (Array.isArray(memos) ? memos : []).filter((m) =>
          isRemoved ? !!m.removedAt : !m.removedAt
        );

        // ç¯©é¸ï¼ˆæœˆä»½ / é‡è¦ + æœå°‹ï¼šåªæ¯”å°æ¨™é¡Œ/å…§å®¹ï¼‰
        const filtered = source.filter((m) => {
          const passMonth = (() => {
            if (filterVal === "all") return true;
            if (filterVal === "important") return !!m.important;
            const ts = getMemoRefTime(m);
            if (!ts) return false;
            if (filterVal === "recent5")
              return (Date.now() - ts) / 86400000 <= 5;
            if (filterVal === "recent30")
              return (Date.now() - ts) / 86400000 <= 30;
            return toRocYMFromTs(ts) === filterVal;
          })();
          if (!passMonth) return false;

          // â˜… åªæª¢ç´¢æ¨™é¡Œï¼‹å…§å®¹
          return memoMatchesSearch(m);
        });

        // â˜… ä¾ã€Œåˆ†é¡ + orderã€æ’åºï¼›order ä¸åœ¨æ™‚ç”¨ createdAt/updatedAt ä½œå¾Œå‚™ï¼Œè®“é †åºå¯é‡ç¾
        filtered.sort((a, b) => {
          const secA = isRemoved
            ? stripRemovedSuffix(a.section || "")
            : a.section || "";
          const secB = isRemoved
            ? stripRemovedSuffix(b.section || "")
            : b.section || "";
          const sc = secA.localeCompare(secB);
          if (sc !== 0) return sc;

          const ao =
            typeof a.order === "number"
              ? a.order
              : a.createdAt || a.updatedAt || 0;
          const bo =
            typeof b.order === "number"
              ? b.order
              : b.createdAt || b.updatedAt || 0;
          if (ao !== bo) return ao - bo;

          // æœ€å¾Œç”¨ updatedAt ç•¶ tie-breakerï¼Œé¿å…ä¸ç©©å®š
          return (a.updatedAt || 0) - (b.updatedAt || 0);
        });

        // å»ºç«‹ DOMï¼ˆåœ¨ã€Œå·²ç§»é™¤ã€è¦–åœ–ï¼Œsection çš„ id æ˜¯åŸå§‹åˆ†é¡åï¼‰
        filtered.forEach((m) => {
          const el = document.createElement("div");
          el.className = "task" + (isRemoved ? " removed" : "");
          el.dataset.id = m.id;
          el.innerHTML = memoCardHTML(m);

          const secId = isRemoved ? stripRemovedSuffix(m.section) : m.section;
          let sec = document.getElementById(secId);

          // æ‰¾ä¸åˆ°å°±ä¸Ÿåˆ°ç¬¬ä¸€å€‹ sectionï¼Œé¿å… throwï¼ˆæ¥µå°‘è¦‹çš„é˜²å‘†ï¼‰
          if (!sec) sec = document.querySelector("#section-container .section");
          sec?.appendChild(el);
        });

        // éç·¨è¼¯æ™‚æ‰ç¶ swipeï¼ˆé¿å…èˆ‡æ‹–æ‹‰è¡çªï¼‰
        if (!isEditing) bindSwipeToTasks?.();

        updateSectionOptions?.();

        // === ä¾ç¯©é¸é¡¯ç¤º/éš±è—ç©ºåˆ†é¡ï¼ˆæœå°‹ä¸­ä¹Ÿè¦–ç‚ºä¸€ç¨®ç¯©é¸ï¼‰===
        const searchActive = (() => {
          try {
            // è‹¥æœ‰é å…ˆ tokenize çš„é™£åˆ—å°±ç”¨å®ƒï¼›å¦å‰‡è®€è¼¸å…¥æ¡†
            if (
              Array.isArray(window.searchTokens) &&
              window.searchTokens.length
            )
              return true;
            const q = (
              document.getElementById("taskSearchInput")?.value || ""
            ).trim();
            return q.length > 0;
          } catch (_) {
            return false;
          }
        })();

        if (filterVal === "all" && !searchActive) {
          document
            .querySelectorAll("#section-container .section")
            .forEach((sec) => {
              sec.style.display = "";
            });
        } else {
          hideEmptySectionsAfterFilter();
        }

        // åªåœ¨ã€Œç•¶å‰ã€ï¼‹ ç·¨è¼¯ä¸­å•Ÿç”¨æ‹–æ‹‰
        if (isEditing && memoView === "active") initMemoSortables();

        // ä¾ç›®å‰æª¢è¦–é‡å»ºæœˆä»½é¸å–®
        buildMemoMonthMenu();
      }

      function getMemoRefTime(m) {
        return m?.updatedAt || m?.createdAt || null;
      }
      function toRocYMFromTs(ts) {
        if (!ts) return "ç„¡";
        const d = new Date(ts);
        if (isNaN(d)) return "ç„¡";
        const yy = d.getFullYear() - 1911;
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${yy}${mm}`;
      }

      function hideEmptySectionsAfterFilter() {
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const hasVisible = Array.from(sec.querySelectorAll(".task")).some(
              (el) => getComputedStyle(el).display !== "none"
            );
            sec.style.display = hasVisible ? "" : "none";
          });
      }

      function hideEmptySections() {
        document
          .querySelectorAll("#section-container .section")
          .forEach((sec) => {
            const has = sec.querySelector(".task");
            sec.style.display = has ? "" : "";
          });
      }

      function addMemo() {
        const section = document.getElementById("memoSection").value;
        const title = document.getElementById("memoTitle").value.trim();
        const content = document.getElementById("memoContent").value;
        const important = document.getElementById("memoImportant").checked;
        if (!title) return;

        const id = "memo-" + Date.now();
        const now = Date.now();
        const memo = {
          id,
          section,
          title,
          content,
          important,
          createdAt: now,
          updatedAt: now,
          order: Date.now(),
        };

        memos.push(memo);
        saveMemos();
        renderAll();
        document.getElementById("memoTitle").value = "";
        document.getElementById("memoContent").value = "";
        document.getElementById("memoImportant").checked = false;
        closeModal("memoModal");
      }

      function openDetail(id) {
        selectedMemoId = id;
        const m = memos.find((x) => x.id === id);
        if (!m) return;

        document.getElementById("detailSection").value = m.section;
        document.getElementById("detailTitle").value = m.title;
        document.getElementById("detailContent").value = m.content || "";
        document.getElementById("detailImportant").checked = !!m.important;

        const lbl = document.getElementById("detailLastUpdate");
        lbl.textContent = m.updatedAt
          ? "æ›´æ–°ï¼š" + formatRocDateTime(m.updatedAt)
          : "";

        resetDetailPanels();

        const isRemoved = memoView === "removed";
        // æ¨™ç±¤æ–‡æ¡ˆ
        const labels = document.querySelectorAll("#detailForm label");
        if (labels[0])
          labels[0].textContent = isRemoved ? "åˆ†é¡ï¼ˆå·²ç§»é™¤ï¼‰" : "å‚™å¿˜åˆ†é¡";

        // æ¬„ä½å”¯è®€/ç¦ç”¨
        document.getElementById("detailSection").disabled = isRemoved;
        document.getElementById("detailTitle").readOnly = isRemoved;
        document.getElementById("detailContent").readOnly = isRemoved;
        document.getElementById("detailImportant").disabled = isRemoved;

        // å„²å­˜éˆ• â†’ æˆ‘çŸ¥é“äº†ï¼
        const saveBtn = document.querySelector(
          "#detailForm .btn-half.btn-save"
        );
        if (saveBtn) {
          if (isRemoved) {
            saveBtn.textContent = "æˆ‘çŸ¥é“äº†ï¼";
            saveBtn.onclick = () => {
              closeModal("detailModal");
            };
          } else {
            saveBtn.textContent = "ğŸ’¾ å„²å­˜";
            saveBtn.onclick = saveMemo;
          }
        }

        document.getElementById("detailModal").style.display = "flex";
      }

      function saveMemo() {
        if (!selectedMemoId) return;
        const m = memos.find((x) => x.id === selectedMemoId);
        if (!m) return;

        m.section = document.getElementById("detailSection").value;
        m.title = document.getElementById("detailTitle").value;
        m.content = document.getElementById("detailContent").value;
        m.important = document.getElementById("detailImportant").checked;
        m.updatedAt = Date.now();

        saveMemos();
        renderAll();
        closeModal("detailModal");
      }

      function confirmDelete() {
        const title = document.querySelector("#confirmModal h3");
        if (title) {
          title.textContent =
            memoView === "removed"
              ? "ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å‰‡å‚™å¿˜ï¼Ÿ"
              : "ç¢ºå®šè¦ç§»åˆ°ã€Œå·²ç§»é™¤ã€ï¼Ÿ";
        }
        openModal("confirmModal");
      }

      function deleteMemo() {
        if (!selectedMemoId) return;
        const idx = memos.findIndex((x) => x.id === selectedMemoId);
        if (idx < 0) return;

        if (memoView === "removed") {
          // æ°¸ä¹…åˆªé™¤
          memos.splice(idx, 1);
        } else {
          // è»Ÿåˆªé™¤ â†’ ä¸Ÿåˆ°ã€Œå·²ç§»é™¤ã€
          const m = memos[idx];
          m.removedAt = Date.now();
          m.updatedAt = m.updatedAt || Date.now();
        }

        saveMemos();
        renderAll();
        closeModal("confirmModal");
        closeModal("detailModal");
      }

      /* ===== Swipeï¼ˆåªä¿ç•™å·¦æ»‘åˆªé™¤ï¼›å³æ»‘å®Œæˆç¦ç”¨ï¼‰ ===== */
      function bindSwipeToTasks() {
        document.querySelectorAll(".task").forEach((task) => {
          if (task.dataset.swipeBound === "1") return;
          task.dataset.swipeBound = "1";
          task.onclick = null;

          const barL = task.querySelector(".swipe-bar.left");
          const labL = barL?.querySelector(".label");

          let sx = 0,
            sy = 0,
            dx = 0,
            dy = 0,
            width = 0,
            isDown = false,
            activeId = null,
            mode = "pending";
          const H_START = 16,
            V_CANCEL = 10,
            DOMINANCE = 1.3,
            BOUND = 0.75,
            MAX_TILT = 3;

          task.addEventListener("pointerdown", onDown);
          task.addEventListener("pointermove", onMove);
          task.addEventListener("pointerup", onUp);
          task.addEventListener("pointercancel", onCancel);
          task.addEventListener("lostpointercapture", onCancel);

          // å clickï¼Œè‡ªå·±åˆ¤å®šã€Œé»ä¸€ä¸‹ã€
          task.addEventListener(
            "click",
            (e) => {
              e.preventDefault();
              e.stopImmediatePropagation();
            },
            true
          );

          function onDown(e) {
            if (e.target.closest("button,input,select,textarea")) return;
            isDown = true;
            activeId = e.pointerId;
            sx = e.clientX;
            sy = e.clientY;
            dx = dy = 0;
            width = task.offsetWidth || 1;
            mode = "pending";
            task.style.transition = "none";
            try {
              task.setPointerCapture(e.pointerId);
            } catch (_) {}
          }
          function onMove(e) {
            if (!isDown || e.pointerId !== activeId) return;
            if (mode === "scroll") return;
            dx = e.clientX - sx;
            dy = e.clientY - sy;
            // å‚ç›´ç‚ºä¸» â†’ æ²å‹•
            if (mode === "pending") {
              const adx = Math.abs(dx),
                ady = Math.abs(dy);
              if (ady > V_CANCEL && ady > adx * 1.2) {
                mode = "scroll";
                resetBars();
                task.style.transform = "";
                return;
              }
              if (adx < H_START) return;
              if (adx > ady * DOMINANCE) {
                mode = "swipe";
              } else {
                mode = "scroll";
                return;
              }
            }
            if (mode !== "swipe") return;

            // åªè™•ç†å·¦æ»‘ï¼ˆåˆªé™¤ï¼‰
            const adx = Math.abs(dx);
            const pct = Math.min(1, adx / width);
            const tilt = (dx / width) * MAX_TILT;
            task.style.transform = `translateX(${Math.round(
              dx
            )}px) rotate(${tilt}deg)`;
            if (dx < 0) {
              barL.style.width = pct * 100 + "%";
              labL.style.opacity = Math.min(1, pct * 1.2);
              labL.style.transform = `translateX(${pct > 0.05 ? 0 : 6}px)`;
            } else {
              resetBars(); // å³æ»‘ä¸å•Ÿç”¨
            }
          }
          function onUp(e) {
            finish(false);
          }
          function onCancel(e) {
            finish(true);
          }
          function finish(cancel) {
            const tapLike =
              Math.abs(dx) < 4 && Math.abs(dy) < 4 && mode !== "scroll";
            const wasSwipe = mode === "swipe";
            mode = "pending";
            isDown = false;
            activeId = null;
            task.style.transition = "transform .18s";
            task.style.transform = "";
            resetBars();

            if (!wasSwipe && !cancel && tapLike) {
              openDetail(task.dataset.id);
              cleanup();
              return;
            }

            if (!wasSwipe || cancel) {
              cleanup();
              return;
            }
            const passed = Math.abs(dx) >= width * BOUND;
            if (passed && dx < 0) {
              selectedMemoId = task.dataset.id;
              setTimeout(() => confirmDelete(), 10);
            }
            cleanup();
          }
          function cleanup() {
            dx = dy = 0;
            try {
              task.releasePointerCapture?.(activeId);
            } catch (_) {}
          }
          function resetBars() {
            if (barL) {
              barL.style.width = "0%";
              labL.style.opacity = 0;
              labL.style.transform = "translateX(6px)";
            }
          }
        });
      }

      /* ===== å±•é–‹é–±è®€é¢æ¿ï¼ˆundo/redo/copyï¼‰ ===== */
      let __expandedFieldId = null,
        __viewerHistory = [],
        __viewerRedoStack = [];
      function toggleDetailExpand(fieldId, title) {
        const form = document.getElementById("detailForm");
        const viewer = document.getElementById("detailViewer");
        const vTitle = document.getElementById("viewerTitle");
        const vBody = document.getElementById("viewerBody");

        // å…ˆç§»é™¤èˆŠç›£è½ï¼ˆåŸç¨‹å¼ç¢¼ä¿ç•™ï¼‰
        if (__expandedFieldId) {
          const prev = document.getElementById(__expandedFieldId);
          if (prev?.__viewerSync) {
            prev.removeEventListener("input", prev.__viewerSync);
            prev.__viewerSync = null;
          }
          if (vBody?.__formSync) {
            vBody.removeEventListener("input", vBody.__formSync);
            vBody.__formSync = null;
          }
          if (vBody?.__histHandler) {
            vBody.removeEventListener("input", vBody.__histHandler);
            vBody.__histHandler = null;
          }
        }

        // â˜… å¼·åŒ–ï¼šåªæœ‰åœ¨ viewer ç›®å‰æ˜¯æ‰“é–‹ç‹€æ…‹æ™‚ï¼Œæ‰æŠŠåŒä¸€éµç•¶ä½œã€Œæ”¶åˆã€
        const isViewerOpen = viewer.classList.contains("show");
        const willCollapse =
          isViewerOpen &&
          __expandedFieldId &&
          (!fieldId || fieldId === __expandedFieldId);
        if (willCollapse) {
          form.classList.remove("hide");
          viewer.classList.remove("show");
          __expandedFieldId = null;
          return;
        }

        const src = document.getElementById(fieldId);
        vTitle.textContent = title || "";
        vBody.value = src ? src.value || "" : "";
        viewer.classList.add("show");
        form.classList.add("hide");
        __expandedFieldId = fieldId;

        if (src) {
          src.__viewerSync = () => {
            vBody.value = src.value || "";
          };
          src.addEventListener("input", src.__viewerSync);

          vBody.__formSync = () => {
            src.value = vBody.value || "";
          };
          vBody.addEventListener("input", vBody.__formSync);
        }

        __viewerHistory = [vBody.value || ""];
        __viewerRedoStack = [];
        if (vBody.__histHandler)
          vBody.removeEventListener("input", vBody.__histHandler);
        let timer = null;
        vBody.__histHandler = () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            pushViewerHistory(vBody.value || "");
          }, 180);
        };
        vBody.addEventListener("input", vBody.__histHandler);
      }

      function resetDetailPanels() {
        const form = document.getElementById("detailForm"),
          viewer = document.getElementById("detailViewer");
        const vBody = document.getElementById("viewerBody");
        if (vBody?.__histHandler) {
          vBody.removeEventListener("input", vBody.__histHandler);
          vBody.__histHandler = null;
        }
        __viewerHistory = [];
        __viewerRedoStack = [];
        __expandedFieldId = null; // â˜… åŠ é€™è¡Œï¼šé¿å…ä¸‹ä¸€æ¬¡é»æ“Šè¢«èª¤åˆ¤ç‚ºã€Œæ”¶åˆã€
        viewer?.classList.remove("show");
        form?.classList.remove("hide");
      }

      function pushViewerHistory(v) {
        if (
          !__viewerHistory.length ||
          __viewerHistory[__viewerHistory.length - 1] !== v
        ) {
          __viewerHistory.push(v);
          if (__viewerHistory.length > 100) __viewerHistory.shift();
        }
        __viewerRedoStack = [];
      }
      function viewerUndo() {
        const v = document.getElementById("viewerBody");
        if (__viewerHistory.length <= 1) return;
        const cur = __viewerHistory.pop();
        __viewerRedoStack.push(cur);
        v.value = __viewerHistory[__viewerHistory.length - 1];
        if (v.__formSync) v.__formSync();
      }
      function viewerRedo() {
        const v = document.getElementById("viewerBody");
        if (!__viewerRedoStack.length) return;
        const redo = __viewerRedoStack.pop();
        v.value = redo;
        if (v.__formSync) v.__formSync();
        pushViewerHistory(v.value);
      }
      function viewerCopy() {
        const t = document.getElementById("viewerBody").value || "";
        if (!t) return alert("æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹");
        (navigator.clipboard?.writeText(t) || Promise.reject())
          .then(() => alert("å·²è¤‡è£½å…§å®¹"))
          .catch(() => {
            try {
              const ta = document.createElement("textarea");
              ta.value = t;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
              alert("å·²è¤‡è£½å…§å®¹");
            } catch (_) {
              alert("è¤‡è£½å¤±æ•—");
            }
          });
      }

      /* ===== èª¿è‰²ç›¤ ===== */
      function setAppBgColor(color) {
        const body = document.body;
        if (color === "metal") {
          body.classList.add("bg-metal");
          document.documentElement.style.setProperty("--app-bg", "#ececec");
        } else {
          body.classList.remove("bg-metal");
          document.documentElement.style.setProperty("--app-bg", color);
        }
        try {
          localStorage.setItem("app_bg_fixed", color);
        } catch (_) {}
      }
      function applySavedBgColor() {
        try {
          const saved = localStorage.getItem("app_bg_fixed");
          if (saved) setAppBgColor(saved);
        } catch (_) {}
      }
      applySavedBgColor();

      document
        .getElementById("openPaletteBtn")
        .addEventListener("click", () => openModal("paletteModal"));
      let pendingColor = null;
      document.addEventListener("click", (e) => {
        const tile = e.target.closest(".palette-choice");
        if (!tile) return;
        const wrap = document.getElementById("paletteModal");
        wrap
          .querySelectorAll(".palette-choice")
          .forEach((t) => t.classList.remove("selected"));
        tile.classList.add("selected");
        pendingColor = tile.dataset.color;
      });
      document
        .getElementById("paletteConfirmBtn")
        .addEventListener("click", () => {
          if (pendingColor) setAppBgColor(pendingColor);
          closeModal("paletteModal");
        });
        
          // æ–°å¢ï¼šè®“ã€Œå–æ¶ˆã€é—œé–‰èª¿è‰²ç›¤ï¼ˆä¸¦é †æ‰‹æ¸…ç©ºé¸å–ç‹€æ…‹ï¼‰
  document.getElementById("paletteCancelBtn").addEventListener("click", () => {
    pendingColor = null;
    document
      .querySelectorAll("#paletteModal .palette-choice")
      .forEach(el => el.classList.remove("selected"));
    closeModal("paletteModal");
  });


      /* ===== äº’å‹•è£œå¼· ===== */
      // é»èƒŒæ™¯é—œé–‰ modal
      // é»èƒŒæ™¯é—œé–‰ modalï¼ˆâ€» detailModal ä¾‹å¤–ï¼šé»èƒŒæ™¯ä¸é—œï¼‰
      document.addEventListener("click", (e) => {
        const modal = e.target.closest(".modal");
        if (!modal) return;
        if (getComputedStyle(modal).display === "none") return;

        // ã€Œå‚™å¿˜å…§å®¹ã€è¦–çª—ä¸å•Ÿç”¨èƒŒæ™¯é»æ“Šé—œé–‰
        if (modal.id === "detailModal") return;

        const content = modal.querySelector(".modal-content");
        if (!content || !content.contains(e.target)) closeModal(modal.id);
      });

      // Esc é—œé–‰
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.querySelectorAll(".modal").forEach((m) => {
            if (getComputedStyle(m).display !== "none") closeModal(m.id);
          });
          closeFabMenu(); // â† æ–°å¢ï¼šè‹¥ menu å±•é–‹ä¹Ÿä¸€ä½µæ”¶
        }
      });

      /* ===== å…¶ä»– ===== */
      function formatRocDateTime(ts) {
        if (!ts && ts !== 0) return "";
        const d = new Date(ts);
        if (isNaN(d)) return "";
        const y = d.getFullYear() - 1911,
          m = d.getMonth() + 1,
          dd = d.getDate();
        const hh = String(d.getHours()).padStart(2, "0"),
          mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}/${m}/${dd} ${hh}:${mm}`;
      }

      /* ===== åˆå§‹è³‡æ–™ ===== */
      document.addEventListener("DOMContentLoaded", () => {
        try {
          memoView = localStorage.getItem("memo_view") || "active";
          memoMonthFilterActive =
            localStorage.getItem("memo_filter_active") || "all";
          memoMonthFilterRemoved =
            localStorage.getItem("memo_filter_removed") || "all";
        } catch (_) {}
        // é è¨­å…ˆç•«ç©ºå®¹å™¨ï¼Œç­‰é›²ç«¯å›ä¾†å†ç•«
        renderSections(categories);
      });

      function openLogoutModal() {
        openModal("logoutModal");
      }

      function showView(view) {
        const login = document.getElementById("loginPage");
        const app = document.getElementById("app");
        const load = document.getElementById("loadingScreen");

        login.style.display = view === "login" ? "flex" : "none";
        app.style.display = view === "app" ? "block" : "none";
        load.style.display = view === "loading" ? "flex" : "none";
      }

      // ===== Section ç©ºç™½è™•ï¼šé•·æŒ‰æ–°å¢å‚™å¿˜ï¼ˆä¸é˜»æ“‹æ²å‹•ï¼‰ï¼‹ è¼•é»å½ˆè·³ =====
      (function enableCleanLongPressNewMemo() {
        const PRESS_MS = 900; // é•·æŒ‰é–€æª»
        const MOVE_TOL = 10; // ä½ç§»é–€æª»
        const PRESS_VISUAL_DELAY = 100; // è¦–è¦ºå£“ä¸‹å»¶é²

        const container = document.getElementById("section-container");
        if (!container) return;

        let timer = null,
          visualTimer = null;
        let startX = 0,
          startY = 0;
        let moved = false,
          longPressed = false;
        let pressSection = null;

        function isEligibleTarget(e) {
          if (memoView === "removed") return false;

          if (isEditing) return false; // ç·¨è¼¯åˆ†é¡æ™‚åœç”¨
          const sec = e.target.closest(".section"); // å¿…é ˆé»åœ¨åˆ†é¡å€å¡Šè£¡
          if (!sec) return false;
          if (e.target.closest(".task")) return false; // ä¸æ˜¯é»åœ¨å¡ç‰‡ä¸Š
          if (e.target.closest(".drag-handle")) return false; // ä¸æ˜¯æŠŠæ‰‹
          return sec;
        }

        function clearTimers() {
          if (timer) {
            clearTimeout(timer);
            timer = null;
          }
          if (visualTimer) {
            clearTimeout(visualTimer);
            visualTimer = null;
          }
        }

        function removePressVisual() {
          if (pressSection) pressSection.classList.remove("__pressed");
        }

        function pointerDown(e) {
          const sec = isEligibleTarget(e);
          if (!sec) return;

          pressSection = sec;
          longPressed = false;
          moved = false;

          const p = e.touches ? e.touches[0] : e;
          startX = p.clientX;
          startY = p.clientY;

          clearTimers();

          // è¦–è¦ºå£“ä¸‹ï¼ˆç¨å¾®å»¶é²ï¼Œé¿å…ä¸€é–‹å§‹å°±ç¸®å°ï¼‰
          visualTimer = setTimeout(() => {
            pressSection && pressSection.classList.add("__pressed");
          }, PRESS_VISUAL_DELAY);

          // é•·æŒ‰è¨ˆæ™‚ï¼šåˆ°æ™‚è§¸ç™¼æ–°å¢å‚™å¿˜ä¸¦é é¸è©²åˆ†é¡
          timer = setTimeout(() => {
            longPressed = true;
            removePressVisual();
            clearTimers();
            openMemoModal(pressSection?.id);
          }, PRESS_MS);
        }

        function pointerMove(e) {
          if (!timer && !visualTimer) return;
          const p = e.touches ? e.touches[0] : e;
          const dx = Math.abs(p.clientX - startX);
          const dy = Math.abs(p.clientY - startY);

          // ç§»å‹•å¤ªå¤šæˆ–æ˜é¡¯å‚ç›´æ²å‹• â†’ å–æ¶ˆé•·æŒ‰
          const verticalIntent = dy > dx + 2;
          if (dx > MOVE_TOL || dy > MOVE_TOL || verticalIntent) {
            moved = true;
            clearTimers();
            removePressVisual();
          }
        }

        function pointerUpOrCancel(e) {
          const wasLong = longPressed;
          clearTimers();

          // çŸ­æŒ‰ä¸”æ²’ç§»å‹• â†’ å°å½ˆè·³å›é¥‹
          if (pressSection && !wasLong && !moved) {
            const stillOk = isEligibleTarget(e) === pressSection;
            if (stillOk) {
              pressSection.classList.add("__bump");
              setTimeout(
                () => pressSection && pressSection.classList.remove("__bump"),
                200
              );
            }
          }
          removePressVisual();
          pressSection = null;
          moved = false;
          longPressed = false;
        }

        // ç¶å®šï¼ˆæ»‘é¼  + è§¸æ§ï¼‰ï¼›è§¸æ§è¨­ç‚º passive è®“æ²å‹•é †æš¢
        container.addEventListener("mousedown", pointerDown);
        container.addEventListener("mousemove", pointerMove);
        document.addEventListener("mouseup", pointerUpOrCancel);

        container.addEventListener("touchstart", pointerDown, {
          passive: true,
        });
        container.addEventListener("touchmove", pointerMove, { passive: true });
        container.addEventListener("touchend", pointerUpOrCancel, {
          passive: true,
        });
        container.addEventListener("touchcancel", pointerUpOrCancel, {
          passive: true,
        });
      })();

      function show(el) {
        if (el) el.style.display = "flex";
      }
      function hide(el) {
        if (el) el.style.display = "none";
      }

      async function bootFromTask() {
        const overlay = document.getElementById("autologin-overlay");
        const app = document.getElementById("app");

        // â˜… è²¼é€™ä¸‰è¡Œï¼ˆè®€ fast_switchï¼Œæ±ºå®šå¯¬é™æ™‚é–“ï¼‰
        const fast = sessionStorage.getItem("fast_switch") === "1";
        sessionStorage.removeItem("fast_switch");
        const graceMs = fast ? 800 : 400;

        // 0) å…ˆä¸è¦å‹•é®ç½©ï¼Œä¿æŒ hiddenï¼ˆHTML/CSS é è¨­ display:noneï¼‰
        // â˜… ä¸è¦ overlay.style.display = "flex";

        // 1) æ²’ roomPath å°±å›ç™»å…¥
        const rp = hydrateRoomPath();
        if (!rp) {
          location.replace("index.html");
          return;
        }
        roomPath = rp;

        // 2) å…ˆç¶è§€å¯Ÿè€…ï¼ˆæ‹¿åˆ° user å¾Œæœƒè‡ªå‹• bindFirebase + é¡¯ç¤º Appï¼‰
        attachAuthObserver();

        // 3) å›ºå®šæœƒè©±ï¼ˆä¸è¦é˜»å¡ UIï¼‰
        try {
          await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        } catch (_) {}

        // 4) å¿«é€Ÿè·¯å¾‘ï¼šè‹¥ currentUser å·²ç¶“å°±ç·’ï¼Œç›´æ¥é€² Appï¼Œå®Œå…¨ä¸é¡¯ç¤ºé®ç½©
        if (auth.currentUser) {
          bindFirebase();
          app.style.display = "block";
          overlay.style.display = "none";
          return;
        }

        // 5) â˜… å¯¬é™ 400msï¼šé€™æ®µæ™‚é–“ç­‰ Firebase é‚„åŸæ—¢æœ‰ session
        const grace = setTimeout(() => {
          // ä»ç„¶æ²’æœ‰ä½¿ç”¨è€… â†’ æ‰æŠŠé®ç½©æ‰“é–‹
          if (!auth.currentUser) overlay.style.display = "flex";
        }, 400);

        try {
          // 6) â˜… å¦‚æœçœŸçš„æ²’æœ‰ sessionï¼Œå°±åŒ¿åç™»å…¥ï¼ˆè§€å¯Ÿè€…æœƒåœ¨ç™»å…¥å¾Œé—œé®ç½©ï¼‰
          startAutoLoginWatchdog(8000);
          await auth.signInAnonymously();
        } catch (e) {
          console.warn("Anonymous sign-in failed", e);
          alert("è‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
          overlay.style.display = "none";
        } finally {
          clearTimeout(grace);
          stopAutoLoginWatchdog();
        }
      }

      document.addEventListener("DOMContentLoaded", bootFromTask);
      function sanitizeKey(s) {
        return String(s).replace(/[.#$/\[\]\/]/g, "_");
      }

      function hydrateRoomPath() {
        let saved = null;
        try {
          saved =
            sessionStorage.getItem("todo_room_info") ||
            localStorage.getItem("todo_room_info") ||
            sessionStorage.getItem("todo_room_info_session") ||
            localStorage.getItem("todo_room_info_session");
        } catch (_) {}

        if (!saved) return null;

        try {
          const { username, password } = JSON.parse(saved);
          if (!username || !password) return null;
          return `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
        } catch (_) {
          return null;
        }
      }

      async function logout() {
        try {
          localStorage.removeItem("todo_room_info");
        } catch (_) {}
        try {
          await auth.signOut();
        } catch (_) {}
        window.location.href = "index.html";
      }
      // --- çœ‹é–€ç‹—ï¼ˆåªæœ‰çœŸçš„åœ¨å˜—è©¦ç™»å…¥æ™‚æ‰æœƒå•Ÿå‹•ï¼‰ ---
      let __loginPending = false;
      let __autoLoginWD = null;

      function startAutoLoginWatchdog(ms = 8000) {
        stopAutoLoginWatchdog();
        __loginPending = true;
        __autoLoginWD = setTimeout(() => {
          if (!__loginPending) return;
          console.warn("[auto] login watchdog fired");
          runAutoLoginRescue(); // å¯é¸ï¼šè¦‹ä¸‹
        }, ms);
      }
      function stopAutoLoginWatchdog() {
        __loginPending = false;
        if (__autoLoginWD) {
          clearTimeout(__autoLoginWD);
          __autoLoginWD = null;
        }
      }

      // --- è§€å¯Ÿè€…ï¼šå”¯ä¸€å…¥å£ï¼Œæ±ºå®šä½•æ™‚ç¶è³‡æ–™ã€é¡¯ç¤º Appã€é—œé®ç½© ---
      function attachAuthObserver() {
        auth.onAuthStateChanged((user) => {
          const overlay = document.getElementById("autologin-overlay");
          const app = document.getElementById("app");
          if (user) {
            bindFirebase();
            app.style.display = "block";
            overlay.style.display = "none";
          }
        });
      }

      // ---ï¼ˆå¯é¸ï¼‰æ•‘æ´ï¼šç¡¬é‡ç½® Firebase ä¸¦é‡æ–°ç™»å…¥åŒ¿å ---
      async function runAutoLoginRescue() {
        try {
          console.warn("[auto] rescue: hard reset firebase");
          unbindFirebase();
          try {
            await firebase.app().delete();
          } catch (_) {}
          firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          db = firebase.database();
          attachAuthObserver(); // é‡æ–°ç¶è§€å¯Ÿè€…

          await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
          await auth.signInAnonymously();
        } catch (e) {
          console.error("[auto] rescue failed", e);
          alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°æ•´ç†æˆ–ç¨å¾Œå†è©¦");
          document.getElementById("autologin-overlay").style.display = "none";
        } finally {
          stopAutoLoginWatchdog();
        }
      }

      // === è®“ç·¨è¼¯æ¨¡å¼åœ¨ re-render å¾ŒæŒçºŒå¥—ç”¨ ===
      function applyEditModeUI() {
        if (!isEditing || memoView !== "active") return;

        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.add("edit-mode");
          const bar = sec.querySelector(".section-title");
          const name = sec.id;
          bar.innerHTML = `
      <span class="drag-handle">â˜°</span>
      <span class="section-name">${name}</span>
      <button class="rename-btn" title="é‡å‘½å">âœ</button>
      <button class="delete-btn" title="åˆªé™¤æ­¤åˆ†é¡">âœ•</button>
    `;

          bar.querySelector(".rename-btn").onclick = () => {
            pendingRenameId = sec.id;
            document.getElementById("renameInput").value = sec.id;
            openModal("renameModal");
          };
          bar.querySelector(".delete-btn").onclick = () =>
            confirmDeleteCategory(sec.id);
        });

        // åªåœ¨ç·¨è¼¯æ™‚å•Ÿç”¨æ‹–æ‹‰
        initSectionSortable?.();
        initMemoSortables();

        // åº•éƒ¨çš„ âœ… è¦æŒçºŒé¡¯ç¤º
        const exitBtn = document.getElementById("exitEditBtn");
        if (exitBtn) exitBtn.style.display = "block";
      }

      // å·²ç§»é™¤æª¢è¦–ä¸­çš„åˆ†é¡é¡¯ç¤ºï¼šç•¶å‰ä»å­˜åœ¨ â†’ åŸåï¼›ç•¶å‰å·²åˆª â†’ åŠ  (å·²ç§»é™¤)
      function getRemovedSectionLabel(name) {
        const alive = (categories || []).includes(name);
        return alive ? name : `${name}(å·²ç§»é™¤)`;
      }

      const REMOVED_SUFFIX = "(å·²ç§»é™¤)";

      function stripRemovedSuffix(name = "") {
        return name.endsWith(REMOVED_SUFFIX)
          ? name.slice(0, -REMOVED_SUFFIX.length)
          : name;
      }

      function getRemovedSectionLabel(name) {
        // name å¯èƒ½å·²ç¶“å¸¶äº†(å·²ç§»é™¤)ï¼Œå…ˆé‚„åŸæˆåŸåå¾Œå†æ±ºå®šé¡¯ç¤º
        const base = stripRemovedSuffix(name);
        const alive = (categories || []).includes(base);
        return alive ? base : `${base}${REMOVED_SUFFIX}`;
      }
    </script>
    <script>
      /* ===== Google Drive Ã— MyMemoï¼ˆå–®æª”å…¨åŒ…ï¼›åƒè€ƒä½  MyTask ç‰ˆæœ¬ï¼‰===== */
      /* âœ… ä½ çš„ Google OAuth Client IDï¼ˆæ²¿ç”¨ä½ æä¾›çš„ï¼‰ */
      const GOOGLE_CLIENT_ID =
        "735593435771-otisn8depskof8vmvp6sp5sl9n3t5e25.apps.googleusercontent.com";

      /* æ¬Šé™ï¼šåƒ…é™æœ¬ App å»ºç«‹/è®€å– + è®€å–æª”å */
      const GD_SCOPES = [
        "https://www.googleapis.com/auth/drive.file",
        "https://www.googleapis.com/auth/drive.metadata.readonly",
      ].join(" ");

      /* æ ¹è³‡æ–™å¤¾æ”¹ç‚º MyMemo */
      const ROOT_APP_FOLDER = "MyMemo";

      /* --- å…§éƒ¨ç‹€æ…‹ --- */
      let __gapiReady = false;
      let __gisReady = false;
      let __tokenClient = null;

      /* âœ… ç¬¬ä¸€æ¬¡æˆæ¬Šå¾Œè¦è‡ªå‹•è£œè·‘ä¸€æ¬¡çš„æ——æ¨™ & é å‚™è¦–çª— */
      const GD_POST_OPEN_KEY = "gdrive_post_open_memo";
      let __gd_prewin = null;

      /* åˆ¤æ–· iOS PWAï¼ˆä¾›é–‹ App æ·±é€£çµæ™‚ä½¿ç”¨ï¼‰ */
      const isIOSPWA = (() => {
        try {
          const ua = navigator.userAgent || "";
          const isiOS =
            /iPad|iPhone|iPod/.test(ua) ||
            (/Macintosh/.test(ua) && navigator.maxTouchPoints > 1);
          const standalone = !!(
            window.matchMedia?.("(display-mode: standalone)")?.matches ||
            navigator.standalone
          );
          return isiOS && standalone;
        } catch {
          return false;
        }
      })();

      /* ---- å‹•æ…‹è¼‰å…¥ Google SDKï¼ˆå–®æª”çµ±åŒ…ï¼‰---- */
      function addScriptOnce(src, id) {
        return new Promise((res, rej) => {
          if (id && document.getElementById(id)) return res();
          const s = document.createElement("script");
          if (id) s.id = id;
          s.src = src;
          s.async = true;
          s.defer = true;
          s.onload = () => res();
          s.onerror = () => rej(new Error("load fail: " + src));
          document.head.appendChild(s);
        });
      }

      async function loadGapiOnce() {
        if (__gapiReady && __gisReady && __tokenClient) return;

        if (!window.google?.accounts?.oauth2) {
          await addScriptOnce(
            "https://accounts.google.com/gsi/client",
            "gsi_client_js"
          );
        }
        if (!window.gapi) {
          await addScriptOnce("https://apis.google.com/js/api.js", "gapi_js");
        }

        await new Promise((r) => gapi.load("client", r));
        await gapi.client.init({});
        // âœ… æ”¹ç”¨ discovery docï¼ŒSafari ç©©å®šå¾ˆå¤š
        await gapi.client.load(
          "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        );
        __gapiReady = true;

        __tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: GD_SCOPES,
          callback: () => {},
          // âœ… å…ˆé—œæ‰ï¼Œé¿å… Safari / iOS ç„¡è²å¤±æ•—
          // use_fedcm_for_prompt: true,
        });
        __gisReady = true;
      }

      /* ---- OAuth / Token ---- */
      // å–ä»£ä½ ç¾æœ‰çš„ ensureDriveAuth()
      async function ensureDriveAuth() {
        await loadGapiOnce();

        // ææ—© 10 åˆ†é˜åˆ·æ–°
        const skew = 10 * 60 * 1000;
        const exp = +localStorage.getItem("gdrive_token_exp") || 0;
        const tok = gapi.client.getToken();
        if (tok?.access_token && Date.now() + skew < exp) return; // ä»æœ‰æ•ˆ

        const alreadyConsented =
          localStorage.getItem("gdrive_consent_done") === "1";

        // æŠŠ GIS å›å‘¼åŒ…æˆ Promiseï¼ŒçœŸçš„ç­‰åˆ°çµæœæ‰å¾€ä¸‹
        const resp = await new Promise((resolve, reject) => {
          __tokenClient.callback = (r) => {
            if (r && r.access_token) return resolve(r);
            // ä¸€äº›æƒ…æ³å›å‚³ {error: "..."}ï¼›ä¹Ÿå¯èƒ½æ˜¯å­—ä¸²
            reject(r?.error || "æˆæ¬Šå¤±æ•—");
          };
          try {
            __tokenClient.requestAccessToken({
              prompt: alreadyConsented ? "" : "consent",
            });
          } catch (e) {
            // å°‘æ•¸ç’°å¢ƒéœ€è¦å¼·åˆ¶ promptï¼ˆå« iOS PWAï¼‰
            if (alreadyConsented) {
              try {
                __tokenClient.requestAccessToken({ prompt: "consent" });
              } catch (e2) {
                reject(e2);
              }
            } else {
              reject(e);
            }
          }
        });

        // åªæœ‰çœŸçš„æ‹¿åˆ° token æ‰æœƒè·‘åˆ°é€™è£¡
        gapi.client.setToken({ access_token: resp.access_token });
        const ttl = resp.expires_in ? resp.expires_in * 1000 : 60 * 60 * 1000;
        localStorage.setItem(
          "gdrive_token_exp",
          String(Date.now() + ttl - skew)
        );
        localStorage.setItem("gdrive_consent_done", "1");

        // ç¬¬ä¸€æ¬¡æˆæ¬Šï¼šè‡ªå‹•è£œè·‘ä¸€æ¬¡ï¼ˆä½ åŸæœ¬é‚è¼¯ï¼‰
        if (localStorage.getItem(GD_POST_OPEN_KEY) === "1") {
          setTimeout(async () => {
            try {
              const m = getCurrentDetailMemo();
              if (m) {
                const id = await ensureExistingOrRecreateFolder(m);
                updateDriveButtonState(m);
                openDriveFolderWeb(id, __gd_prewin);
              }
            } finally {
              localStorage.removeItem(GD_POST_OPEN_KEY);
              __gd_prewin = null;
            }
          }, 0);
        }
      }

      /* ---- å¤–è§€ï¼šæŒ‰éˆ•é«˜äº®ï¼ˆæœ‰è³‡æ–™å¤¾æ™‚ï¼‰ ---- */
      function ensureDriveGlowCss() {
        if (document.getElementById("driveGlowCss")) return;
        const css = `
    .btn-gdrive { margin-left:.35rem;padding:.4rem .6rem;border:1px solid #ddd;background:#f9f9f9;border-radius:6px;cursor:pointer; }
    .btn-gdrive.has-folder { background:#FFD54F; border-color:#FFC107; box-shadow:0 0 .6rem rgba(255,193,7,.6); animation:drive-glow 1.2s ease-in-out infinite alternate; }
    @keyframes drive-glow { from { box-shadow:0 0 .35rem rgba(255,193,7,.45);} to { box-shadow:0 0 1rem rgba(255,193,7,.95);} }
  `;
        const st = document.createElement("style");
        st.id = "driveGlowCss";
        st.textContent = css;
        document.head.appendChild(st);
      }
      function updateDriveButtonState(memoObj) {
        const btn = document.getElementById("gdriveBtn");
        if (!btn) return;
        btn.classList.toggle(
          "has-folder",
          !!(memoObj && memoObj.driveFolderId)
        );
      }

      /* ---- Driveï¼šè³‡æ–™å¤¾å·¥å…· ---- */
      function escapeForQuery(s) {
        return String(s).replace(/['\\]/g, "\\$&");
      }

      async function findOrCreateFolderByName(name, parentId /* or 'root' */) {
        const q = [
          `name = '${escapeForQuery(name)}'`,
          `mimeType = 'application/vnd.google-apps.folder'`,
          `'${parentId}' in parents`,
          "trashed = false",
        ].join(" and ");

        const list = await gapi.client.drive.files.list({
          q,
          fields: "files(id,name)",
          pageSize: 1,
          includeItemsFromAllDrives: true,
          supportsAllDrives: true,
        });

        if (list?.result?.files?.length) return list.result.files[0].id;

        const created = await gapi.client.drive.files.create({
          resource: {
            name,
            mimeType: "application/vnd.google-apps.folder",
            parents: [parentId],
          },
          fields: "id",
          supportsAllDrives: true,
        });
        return created.result.id;
      }

      async function ensureFolderPath(segments) {
        let parent = "root";
        for (const seg of segments)
          parent = await findOrCreateFolderByName(seg, parent);
        return parent; // æœ«ç«¯ id
      }

      /* ---- é–‹å•Ÿè³‡æ–™å¤¾ï¼ˆè¡Œå‹•è£ç½®å„ªå…ˆå‘¼å« Appï¼‰ ---- */
      function openDriveFolderWeb(id, preWin) {
        const webUrl = `https://drive.google.com/drive/folders/${id}`;
        const ua = (navigator.userAgent || "").toLowerCase();
        const isAndroid = /android/.test(ua);
        const isIOS =
          /iphone|ipad|ipod/.test(ua) ||
          ((navigator.userAgent || "").includes("Macintosh") &&
            navigator.maxTouchPoints > 1);

        const iosSchemeUrl = `googledrive://${webUrl}`;
        const androidIntentUrl =
          `intent://drive.google.com/drive/folders/${id}` +
          `#Intent;scheme=https;package=com.google.android.apps.docs;end`;

        const usePreWin = (url) => {
          try {
            if (preWin && !preWin.closed) {
              preWin.location.href = url;
              setTimeout(() => {
                try {
                  preWin.close();
                } catch (_) {}
              }, 1500);
              return true;
            }
          } catch (_) {}
          return false;
        };

        if (isAndroid) {
          if (!usePreWin(androidIntentUrl))
            window.location.href = androidIntentUrl;
          return;
        }
        if (isIOS) {
          if (isIOSPWA) {
            // iOS PWAï¼šç›´æ¥ç”¨é ‚å±¤å°å‘å‘¼å« Appï¼Œé¿å…ç•™ä¸‹ç©ºç™½åˆ†é 
            try {
              window.location.href = iosSchemeUrl;
            } catch (_) {}
            return;
          }
          // iOS Safariï¼ˆé PWAï¼‰ï¼šç¶­æŒé å‚™åˆ†é é‚è¼¯
          if (!usePreWin(iosSchemeUrl)) window.location.href = iosSchemeUrl;
          return;
        }
        // æ¡Œæ©Ÿ â†’ é–‹ç¶²é 
        try {
          window.open(webUrl, "_blank")?.focus?.();
        } catch (_) {
          window.location.href = webUrl;
        }
      }
      /* ---- å–å¾—ç›®å‰ã€Œå‚™å¿˜è©³æƒ…ã€å°æ‡‰çš„ Memo ç‰©ä»¶ ---- */
      function getCurrentDetailMemo() {
        if (typeof selectedMemoId !== "undefined" && selectedMemoId) {
          return (
            (Array.isArray(memos) ? memos : []).find(
              (m) => m.id === selectedMemoId
            ) || null
          );
        }
        return null;
      }

      /* ---- ä¸»æµç¨‹ï¼šå»ºç«‹æˆ–é–‹å•Ÿè³‡æ–™å¤¾ï¼ˆMyMemo / åˆ†é¡ / æ¨™é¡Œï¼‰ ---- */
      async function openOrCreateDriveFolderForCurrentMemo() {
        const m = getCurrentDetailMemo();
        if (!m) return;

        await ensureDriveAuth();

        const segs = [
          ROOT_APP_FOLDER,
          m.section || "æœªåˆ†é¡",
          (m.title || "æœªå‘½å").slice(0, 100),
        ];
        const folderId = await ensureFolderPath(segs);

        // è¨˜ä½ ID ä¸¦å­˜é›²
        m.driveFolderId = folderId;
        try {
          window.saveMemos?.();
        } catch (_) {}

        updateDriveButtonState(m);
        openDriveFolderWeb(folderId, __gd_prewin);
      }

      /* è‹¥å·²æœ‰ IDï¼Œé©—è­‰å­˜åœ¨ï¼›ä¸å­˜åœ¨å‰‡é‡å»ºè·¯å¾‘ */
      async function ensureExistingOrRecreateFolder(m) {
        if (m.driveFolderId) {
          try {
            const r = await gapi.client.drive.files.get({
              fileId: m.driveFolderId,
              fields: "id, trashed",
              supportsAllDrives: true,
            });
            if (r?.result?.id && !r.result.trashed) return m.driveFolderId;
          } catch (_) {
            // 404/ç„¡æ¬Šé™ â†’ é‡å»º
          }
          m.driveFolderId = null;
          try {
            window.saveMemos?.();
          } catch (_) {}
        }
        const segs = [
          ROOT_APP_FOLDER,
          m.section || "æœªåˆ†é¡",
          (m.title || "æœªå‘½å").slice(0, 100),
        ];
        const newId = await ensureFolderPath(segs);
        m.driveFolderId = newId;
        try {
          window.saveMemos?.();
        } catch (_) {}
        updateDriveButtonState(m);
        return newId;
      }

      /* åƒ…é–‹å•Ÿï¼ˆè‹¥æ²’è¨˜éŒ„å°±è½‰ä¸»æµç¨‹å»ºç«‹ï¼‰ */
      function openCurrentMemoDriveFolder() {
        const m = getCurrentDetailMemo();
        if (!m) return;
        if (m.driveFolderId) openDriveFolderWeb(m.driveFolderId);
        else openOrCreateDriveFolderForCurrentMemo();
      }

      /* ---- åœ¨è©³æƒ…ã€Œé‡è¦ã€å³é‚Šæ’å…¥æŒ‰éˆ• ---- */
      function ensureDriveButtonsInlineUI(memoObj) {
        ensureDriveGlowCss();
        // æ‰¾åˆ° è©³æƒ… çš„é‚£ä¸€æ’ï¼ˆåˆ†é¡ä¸‹æ‹‰ + é‡è¦ï¼‰
        const row = document.querySelector("#detailForm .inline-row");
        if (!row) return;

        if (!row.querySelector("#gdriveBtn")) {
          const btn = document.createElement("button");
          btn.id = "gdriveBtn";
          btn.type = "button";
          btn.title = "å»ºç«‹/é–‹å•Ÿæ­¤å‚™å¿˜çš„é›²ç«¯è³‡æ–™å¤¾";
          btn.style.cssText =
            "width:30px;height:30px;aspect-ratio:1/1;padding:0;" +
            "border:1px solid #ddd;border-radius:6px;" +
            "background:#f9f9f9 url('https://cdn.jsdelivr.net/gh/a355226/kj-reminder@main/drive.png') no-repeat center/18px 18px;" +
            "display:inline-flex;align-items:center;justify-content:center;" +
            "appearance:none;-webkit-appearance:none;line-height:0;box-sizing:border-box;cursor:pointer;";
          btn.className = "btn-gdrive";
          row.appendChild(btn);
        }
        updateDriveButtonState(memoObj);
      }

      /* ---- é»æ“Šè¡Œç‚ºï¼ˆå«ç¬¬ä¸€æ¬¡æˆæ¬Šçš„é å‚™è¦–çª—ï¼‰ ---- */
      async function onDriveButtonClickMemo() {
        const m = getCurrentDetailMemo();
        if (!m) return;

        // åœ¨ã€Œå·²ç§»é™¤ã€æª¢è¦–ï¼šåªå…è¨±é–‹å•Ÿæ—¢æœ‰ï¼Œä¸æ–°å»º
        if (window.memoView === "removed") {
          if (m.driveFolderId) {
            openDriveFolderWeb(m.driveFolderId);
          } else {
            alert("æ­¤å‚™å¿˜åœ¨ã€Œå·²ç§»é™¤ã€æª¢è¦–ï¼Œåƒ…èƒ½é–‹å•Ÿæ—¢æœ‰è³‡æ–™å¤¾ã€‚");
          }
          return;
        }

        try {
          const firstTime = localStorage.getItem("gdrive_consent_done") !== "1";
          if (firstTime) {
            // é¦–æ¬¡æˆæ¬Šä¸€å¾‹ç«‹æ——æ¨™ï¼Œè®“ ensureDriveAuth å®Œæˆå¾Œè‡ªå‹•è£œè·‘é–‹å•Ÿ
            localStorage.setItem(GD_POST_OPEN_KEY, "1");
            if (!isIOSPWA) {
              // é iOS PWA æ‰é–‹é å‚™åˆ†é ï¼ˆæå‡å–šèµ·æˆåŠŸç‡ï¼‰
              try {
                __gd_prewin = window.open("", "_blank");
              } catch (_) {
                __gd_prewin = null;
              }
            } else {
              // iOS PWA ä¸é–‹é å‚™åˆ†é ï¼Œé¿å…æ®˜ç•™ç©ºç™½é 
              __gd_prewin = null;
            }
          } else {
            // éé¦–æ¬¡ï¼šä¸éœ€è¦æ——æ¨™èˆ‡é å‚™åˆ†é 
            localStorage.removeItem(GD_POST_OPEN_KEY);
            __gd_prewin = null;
          }

          await ensureDriveAuth();
          if (firstTime) return; // äº¤çµ¦ ensureDriveAuth çš„è£œè·‘é‚è¼¯è™•ç†

          const folderId = await ensureExistingOrRecreateFolder(m);
          updateDriveButtonState(m);

          openDriveFolderWeb(folderId, __gd_prewin);

          localStorage.removeItem(GD_POST_OPEN_KEY);
          __gd_prewin = null;
        } catch (e) {
          localStorage.removeItem(GD_POST_OPEN_KEY);
          __gd_prewin = null;
          const msg =
            e?.result?.error?.message || e?.message || JSON.stringify(e);
          alert("Google é›²ç«¯ç¡¬ç¢Ÿå‹•ä½œå¤±æ•—ï¼š" + msg);
          console.error("Drive error:", e);
        }
      }

      /* ---- æš–æ©Ÿï¼šè¼‰å…¥ SDKï¼Œpageshow å›è£œï¼Œé¦–æ¬¡æˆæ¬Šå¾Œè‡ªå‹•é–‹å•Ÿ ---- */
      (function driveWarmup() {
        const kickoff = () => {
          loadGapiOnce().catch((e) => console.warn("Drive warmup failed:", e));
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", kickoff, {
            once: true,
          });
        } else {
          kickoff();
        }

        window.addEventListener(
          "pageshow",
          () => {
            if (!__gapiReady || !__gisReady || !__tokenClient) {
              loadGapiOnce().catch(() => {});
            }
            if (localStorage.getItem(GD_POST_OPEN_KEY) === "1") {
              (async () => {
                try {
                  await ensureDriveAuth();
                  const m = getCurrentDetailMemo();
                  if (m) {
                    const id = await ensureExistingOrRecreateFolder(m);
                    updateDriveButtonState(m);
                    openDriveFolderWeb(id, __gd_prewin);
                  }
                } finally {
                  localStorage.removeItem(GD_POST_OPEN_KEY);
                  __gd_prewin = null;
                }
              })().catch(() => {});
            }
          },
          { once: true }
        );
      })();

      // ---- å–ä»£åŸæœ¬çš„ hookOpenDetailForMemoï¼ˆå»¶ä¸€å¹€æ’å…¥ï¼‰----
      (function hookOpenDetailForMemo() {
        const original = window.openDetail;
        window.openDetail = function (id) {
          original?.call(this, id);
          // ç­‰è©³æƒ… DOM çœŸæ­£ render å®Œå†æ’å…¥æŒ‰éˆ•
          requestAnimationFrame(() => {
            try {
              ensureDriveButtonsInlineUI(getCurrentDetailMemo());
            } catch (_) {}
          });
        };
      })();

      // ---- å…¨åŸŸäº‹ä»¶å§”æ´¾ï¼šä¸é  btn.onclickï¼Œé¿å…è¢«é‡ç¹ªåƒæ‰ ----
      document.addEventListener(
        "click",
        (e) => {
          const btn = e.target.closest("#gdriveBtn");
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          // æ˜ç¢ºå‘¼å«ï¼Œä»»ä½•æ™‚æ©Ÿéƒ½åƒå¾—åˆ°
          (async () => {
            try {
              await onDriveButtonClickMemo();
            } catch (err) {
              const msg =
                err?.result?.error?.message || err?.message || String(err);
              alert("Google é›²ç«¯ç¡¬ç¢Ÿå‹•ä½œå¤±æ•—ï¼š" + msg);
              console.error("Drive error:", err);
            }
          })();
        },
        false
      );

      Object.assign(window, {
        onDriveButtonClickMemo,
        openCurrentMemoDriveFolder,
        openOrCreateDriveFolderForCurrentMemo,
        ensureDriveButtonsInlineUI,
      });

      /* ===== Search ç‹€æ…‹èˆ‡å·¥å…· ===== */
      let searchQuery = "";
      let searchTokens = [];

      function setSearchQuery(q = "") {
        searchQuery = (q || "").trim();
        searchTokens = searchQuery
          ? searchQuery.toLowerCase().split(/\s+/).filter(Boolean)
          : [];
        renderAll();
      }

      // åªæ¯”å°ã€Œæ¨™é¡Œ + å…§å®¹ã€
      function memoMatchesSearch(m) {
        if (!searchTokens.length) return true;
        const hay = ((m.title || "") + " " + (m.content || "")).toLowerCase();
        return searchTokens.every((tok) => hay.includes(tok));
      }

      // å®‰å…¨è½‰ç¾© + é«˜äº®
      function escHTML(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch])
        );
      }
      function hiHTML(s = "", tokens) {
        if (!tokens?.length) return escHTML(s);
        let out = escHTML(s);
        tokens.forEach((t) => {
          if (!t) return;
          const re = new RegExp(
            `(${t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
            "gi"
          );
          out = out.replace(re, '<span class="hl">$1</span>');
        });
        return out;
      }
      function makeSnippet(text = "", tokens, max = 80) {
        const raw = text || "";
        if (!tokens?.length)
          return raw.length > max ? raw.slice(0, max - 1) + "â€¦" : raw;
        const lower = raw.toLowerCase();
        let pos = -1;
        for (const t of tokens) {
          const i = lower.indexOf(t);
          if (i >= 0) {
            pos = i;
            break;
          }
        }
        if (pos < 0)
          return raw.length > max ? raw.slice(0, max - 1) + "â€¦" : raw;
        const start = Math.max(0, pos - Math.floor(max / 2));
        const end = Math.min(raw.length, start + max);
        const slice =
          (start > 0 ? "â€¦" : "") +
          raw.slice(start, end) +
          (end < raw.length ? "â€¦" : "");
        return slice;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // ç¶å®š moreModal æœå°‹æ¬„
        let __searchDebounce = null;
        function bindModalSearch() {
          const box = document.getElementById("taskSearchInput");
          const clear = document.getElementById("taskSearchClear");
          if (!box || box.__bound) return;
          box.__bound = true;

          const syncClear = () => {
            if (clear)
              clear.style.visibility = box.value ? "visible" : "hidden";
          };

          // åˆå§‹
          box.value = searchQuery;
          syncClear();

          box.addEventListener("input", (e) => {
            clearTimeout(__searchDebounce);
            __searchDebounce = setTimeout(() => {
              setSearchQuery(e.target.value);
              syncClear();
            });
          });

          // Esc æ¸…é™¤
          box.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              e.stopPropagation();
              box.value = "";
              setSearchQuery("");
              syncClear();
            }
          });

          // å³å´ X
          clear?.addEventListener("click", () => {
            box.value = "";
            setSearchQuery("");
            syncClear();
            box.focus();
          });
        }

        // æ‰“é–‹ moreModal æ™‚ï¼ŒåŒæ­¥æœå°‹æ¬„ä½èˆ‡æŒ‰éˆ•ç‹€æ…‹
        const _openModal = window.openModal;
        window.openModal = function (id) {
          _openModal.call(this, id);
          if (id === "moreModal") {
            // ä½ çš„æª¢è¦–åˆ‡æ›ä¿æŒä¸è®Šï¼Œé€™è£¡åªè™•ç†æœå°‹æ¬„
            const box = document.getElementById("taskSearchInput");
            const clear = document.getElementById("taskSearchClear");
            if (box) {
              bindModalSearch();
              box.value = searchQuery;
              if (clear)
                clear.style.visibility = box.value ? "visible" : "hidden";
              setTimeout(() => box.focus(), 0);
            }
          }
        };
      });
    </script>

    <!-- Loadingï¼ˆåˆ‡æ›ä¸­ï¼‰ -->
    <div id="loadingScreen" style="display: none">
      <div class="loading-wrap">
        <div class="loading-spinner"></div>
        <div class="loading-text">åˆ‡æ›ä¸­â€¦</div>
      </div>
    </div>
  </body>
</html>