<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>MyMemo</title>

  <!-- Icons / PWA å¯è‡ªè¡Œæ›¿æ› -->
  <link rel="icon" type="image/png" sizes="32x32" href="reminder.png">
  <link rel="apple-touch-icon" sizes="180x180" href="reminder.png">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Sortable (åˆ†é¡æ‹–æ‹‰ç”¨) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>


:root{
  --blue-light:#ebf5fc;
  --yellow-light:#fffbe6; /* ç”¨ MyTask çš„é»ƒ */
  --white:#fff;
  --gray-text:#444;
  --app-bg:var(--blue-light);
}
    *{ box-sizing:border-box; font-family:'Segoe UI',system-ui,-apple-system,sans-serif; }
    body{ margin:0; background:var(--app-bg); color:var(--text); display:flex; justify-content:center; padding:16px; }
    .container{ width:100%; max-width:480px; position:relative; display:none; }

    /* æ¨™é¡Œ */
h1 {
  display: inline-flex;  /* åŸæœ¬æ˜¯ flex */
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 24px;
  margin: 6px 0 10px;
  padding: 4px 10px;
  border-radius: 8px;
  transition: background-color .2s, box-shadow .2s;
}

    h1:hover{ background:rgba(0,0,0,.05); box-shadow:0 0 0 2px rgba(0,0,0,.08) inset; }

    /* â‹¯ */
/* â‹¯ æŒ‰éˆ•æœ¬èº«ï¼ˆåŸç‰ˆï¼‰ */
/* â‹¯ æµ®éˆ•ï¼ˆåŸç‰ˆå°ºå¯¸/é™°å½±ï¼‰ */
.more-btn{
  position:fixed; top:12px; left:12px; width:32px; height:32px;
  border-radius:50%; background:#fff; color:#555; font-size:18px; font-weight:bold;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,.15); cursor:pointer; z-index:100; line-height:1;
}

/* æ›´å¤šåŠŸèƒ½ï¼šå°å¡ç‰‡å¯¬åº¦èˆ‡ç·Šå¯¦æ¨™é¡Œ */
#moreModal .modal-content{ max-width:300px; }
#moreModal .modal-content h3{ margin:.2rem 0 .6rem; font-size:1.1rem; }

/* row ä½ˆå±€ï¼šå·¦æ–‡å³éˆ• */
.more-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; margin:10px 0;
}

/* å°æ·ºåº•ï¼šèª¿è‰²ç›¤æŒ‰éˆ• */
button.palette-btn {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  padding: 4px 8px !important;
  font-size: 0.85rem !important;
  font-weight: normal;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #f9f9f9 !important;
  color: #333 !important;
  width: auto !important;
  min-width: unset !important;
  margin-top: 0; /* ä¿æŒç·Šè²¼æ¨™é¡Œ */
}
button.palette-btn:hover { background: #f1f1f1 !important; }
button.palette-btn:active { background: #e8e8e8 !important; }

/* èª¿è‰²ç›¤ä¹å®®æ ¼ */
/* --- èª¿è‰²ç›¤æŒ‰éˆ•ï¼ˆå°æ·ºåº•ï¼‰å·²åœ¨ä½ æª”æ¡ˆå…§ï¼Œä¿ç•™å³å¯ --- */

/* èª¿è‰²ç›¤ä¹å®®æ ¼ï¼ˆä½ å·²æœ‰ï¼Œé€™è£¡è£œè¶³ data-color èƒŒæ™¯èˆ‡é¸å–æ…‹ï¼‰ */
.palette-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:.75rem; margin-top:.5rem; }
.palette-choice{
  position:relative;
  width:100%; aspect-ratio:1/1; border-radius:12px; border:1px solid #e5e5e5;
  box-shadow: 0 1px 2px rgba(0,0,0,.06); cursor:pointer; overflow:hidden;
}
.palette-choice[data-color="#f6fbfe"]{ background:#f6fbfe; }
.palette-choice[data-color="#f3fcf8"]{ background:#f3fcf8; }
.palette-choice[data-color="#fffcf3"]{ background:#fffcf3; }
.palette-choice[data-color="#fef6f9"]{ background:#fef6f9; }
.palette-choice[data-color="#f9f8fd"]{ background:#f9f8fd; }
.palette-choice[data-color="#ffeded"]{ background:#ffeded; }
.palette-choice[data-color="#fff8f5"]{ background:#fff8f5; }
.palette-choice[data-color="#fdfcf9"]{ background:#fdfcf9; }
.palette-choice[data-color="metal"]{ background:#e5e5e5; }
.palette-choice .metal-sheen{
  position:absolute; inset:0;
  background:
    linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.1)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, rgba(0,0,0,.04) 1px 2px);
  mix-blend-mode: screen; pointer-events:none;
}
.palette-choice.selected{
  outline: 3px solid #176dff;
  box-shadow: 0 0 0 3px rgba(23,109,255,.15) inset;
}

/* èª¿è‰²ç›¤åº•éƒ¨ï¼šç¢ºèªï¼å–æ¶ˆï¼ˆèˆ‡ MyTask é¢¨æ ¼ä¸€è‡´ï¼‰ */
.dialog-actions{
  display:flex; gap:.5rem; margin-top:12px;
}
.btn-primary, .btn-secondary{
  flex:1; height:42px; border-radius:8px; font-weight:700; font-size:15px; cursor:pointer; border:0;margin-top:1rem
}
.btn-primary{ background:#fc97ba; color:#fff; box-shadow:0 6px 16px rgba(0,170,255,.28); }
.btn-primary:hover{ background:#ffa49c; }
.btn-primary:active{ transform: translateY(1px); }

.btn-secondary{ background:#f5f5f5; color:#333; border:1px solid #ddd; }
.btn-secondary:hover{ background:#eee; }


/* æ›´å¤šåŠŸèƒ½å…§çš„è¡Œæ’åˆ—ï¼šå·¦æ–‡å³éˆ• */
.more-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; margin:10px 0;
}

/* æ¨™é¡Œæ›´ç·Šå¯¦ä¸€äº›ï¼ŒåƒåŸç‰ˆ */
#moreModal .modal-content h3{
  margin:.2rem 0 .6rem; font-size:1.1rem;
}

/* è—è‰²å¤§æŒ‰éˆ•ï¼šç™»å‡º */
.logout-btn{
  width:100%;
  height:46px;
  background:#00aaff;          /* ä¸»è— */
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,170,255,.28);
}
.logout-btn:hover{ background:#0791e6; }
.logout-btn:active{ transform: translateY(1px); }



/* æ¨™é¡Œé–“è·ï¼ˆçœ‹èµ·ä¾†è·ŸåŸç‰ˆä¸€æ¨£ç·Šå¯¦ï¼‰ */
#moreModal .modal-content h3{ margin:.2rem 0 .6rem; font-size:1.1rem; }



    /* ä»Šæ—¥å¾½ç« ï¼ˆå³ä¸Šè§’è¼•é‡ï¼‰ */
    #today-badge{
      position:fixed; top:14px; right:12px; z-index:90;
      padding:4px 8px; border-radius:6px; background:rgba(255,255,255,.4); backdrop-filter:blur(6px);
      color:rgba(50,50,50,.85); font-size:14px; font-weight:500; letter-spacing:.3px; pointer-events:none;
    }

    /* å€å¡Š/å¡ç‰‡ */
.section{
  background:#fff; border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.04);
  padding:1rem; margin-bottom:1rem;
}
.section-title{ font-size:1.2rem; font-weight:bold; margin-bottom:.5rem; }
.task{
  display:flex; justify-content:space-between; align-items:center;
  background:var(--yellow-light);
  padding:.75rem 1rem; border-radius:8px; margin-bottom:.5rem; cursor:pointer;
  position:relative; overflow:hidden; touch-action:pan-y;
}
.task-content{ flex:1; }
.task-title{ font-size:1.2rem; font-weight:600; }

    .task .task-preview{ font-size:.9rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* é€²åº¦æ¢ï¼ˆæ»‘å‹•ï¼‰â€” åªä¿ç•™å·¦å´åˆªé™¤ */
    .swipe-bar{ position:absolute; top:0; bottom:0; width:0%; display:flex; align-items:center; pointer-events:none; transition:width .18s; }
    .swipe-bar.left{ right:0; justify-content:flex-end; background:#ffe4e6; color:#5c2020; }
    .swipe-bar .label{ font-weight:800; opacity:0; transition:opacity .12s, transform .12s; transform:translateX(6px); margin:0 12px; }

    /* FAB */
  .fab{
  position: fixed; bottom: 24px; right: 24px;
  width: 48px; height: 48px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  background: rgba(0,170,255,.85) !important;
  color:#fff; font-size:28px; font-weight:700;
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
  cursor:pointer; z-index:110;
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease, background-color .2s ease;
}
.fab:hover{ background: rgba(0,170,255,.95) !important; }
.fab:active{ transform: scale(.98); }
.fab.open{ transform: rotate(45deg); }

/* ç»ç’ƒå¡é¸å–® */
.menu{
  position: fixed; bottom: 88px; right: 24px;
  min-width: 100px; padding: 8px;
  border-radius: 14px;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(180, 210, 255, .35);
  box-shadow: 0 12px 28px rgba(0, 60, 130, .12);
  display: block;               /* ç”¨é€æ˜æ§åˆ¶é¡¯ç¤º */
  opacity: 0; transform: translateY(8px) scale(.98);
  pointer-events: none;
  z-index: 105;
}
.menu.show{
  opacity: 1; transform: translateY(0) scale(1);
  pointer-events: auto;
  transition: opacity .18s ease, transform .18s ease;
}
.menu button{
  display:flex; align-items:center; gap:.5rem;
  width:100%;
  background: transparent;
  border: 0;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 15px; font-weight: 600;
  color: #176dff;                 /* æ·ºè—ç³»ä¸»è‰² */
  letter-spacing:.2px;
  cursor:pointer;
}
.menu button:hover{
  background: linear-gradient(0deg,#eef6ff,#f7fbff);
}
.menu button:active{
  transform: translateY(1px);
}
.menu button + button{ margin-top: 4px; }
.menu::after{
  content:"";
  position:absolute;
  right: 12px; bottom: -6px;
  width: 12px; height:12px;
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(180,210,255,.35);
  border-top: none; border-left: none;
  transform: rotate(45deg);
  box-shadow: 4px 4px 10px rgba(0,60,130,.06);
}


    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:200; }
    .modal-content{ width:90%; max-width:420px; background:#fff; border-radius:12px; padding:14px; position:relative; }
    .close-btn{ position:absolute; right:12px; top:12px; width:28px; height:28px; border:0; border-radius:50%; background:#eee; cursor:pointer; }

    .modal-content label{ display:block; margin-top:.5rem; font-size:.95rem; }
    .modal-content input:not([type="checkbox"]), .modal-content select, .modal-content textarea{
      width:100%; padding:.5rem; border:1px solid #ccc; border-radius:6px; margin-top:.25rem; font-size:16px;
    }
    .inline-row{ display:flex; align-items:center; gap:.75rem; margin-top:.25rem; }
    .half{ width:50%; min-width:160px; }
    .important-flag{ display:inline-flex; align-items:center; gap:.35rem; white-space:nowrap; }

.save-btn{ width:100%; padding:.6rem; border:0; border-radius:6px; background:#77d4bc; color:#fff; cursor:pointer; font-weight:900; margin-top:1rem; font-size:16px}
    .row-btns{ display:flex; gap:.5rem; margin-top:.5rem; }
    .btn-half{ flex:1; padding:.6rem; border:0; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn-save{ background:#e8faf3; color:#176d59; border:1px solid #ccefe2; }
    .btn-del{ background:#fff3f3; color:#b23b3b; border:1px solid #ffd8d8; }

    /* Login */
    #loginPage{ display:flex; min-height:100vh; align-items:center; justify-content:center; background:#ebf5fc; }
    #loginCard{ background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); padding:24px; width:95%; max-width:450px; }
    .login-input{ width:100%; height:44px; padding:0 12px; border:1px solid #ccc; border-radius:8px; font-size:16px; margin:.6rem 0 1rem; }
    .login-btn{ width:100%; height:46px; background:#00aaff; color:#fff; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .login-btn:hover{ background:#0791e6; }


    /* é‡‘å±¬èƒŒæ™¯ç‰¹æ•ˆ */
    body.bg-metal::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.15)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 .5px, rgba(0,0,0,.05) .5px 1px),
        repeating-linear-gradient(0deg, rgba(0,0,0,.015) 0 2px, rgba(255,255,255,.015) 2px 3px);
      background-blend-mode:screen,normal,normal;
      background-size:100% 100%, 2000px 100%, 100% 240px;
      background-repeat:no-repeat, no-repeat, repeat;
      filter:contrast(104%) saturate(96%);
    }

    /* å±•é–‹é–±è®€é¢æ¿ï¼ˆå«å¾©åŸ/é‡åš/è¤‡è£½ï¼‰ */
    #detailViewer{ display:none; }
    #detailViewer.show{ display:block; }
    #detailForm.hide{ display:none; }
    .viewer-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .viewer-title{ font-weight:700; }
    .viewer-close{ border:1px solid #ddd; background:#f7f7f7; border-radius:6px; padding:.35rem .6rem; cursor:pointer; }
    .viewer-toolbar{ display:flex; gap:.4rem; margin:.1rem 0 .4rem; }
    .vt-btn{ border:1px solid #ddd; background:#f8f8f8; border-radius:6px; padding:.3rem .5rem; font-size:1rem; cursor:pointer; }
    .viewer-body{ width:100%; min-height:50vh; padding:.75rem; border:1px solid #eee; border-radius:8px; background:#fafafa; line-height:1.6; font-size:.95rem; resize:vertical; }

/* === ç·¨è¼¯æ¨¡å¼ï¼šæ¨™é¡Œè¡Œå¯æ”¾æŠŠæ‰‹/é‰›ç­†/åˆªé™¤ï¼ŒX å›ºå®šåœ¨æœ€å³ === */
.section.edit-mode .rename-btn,
.section.edit-mode .delete-btn { display: inline-flex !important; }

.section-title{
  position: relative;  /* è®“å³ä¸Šè§’ X å¯ä»¥çµ•å°å®šä½ */
  display: flex;
  align-items: center;
  gap: .5rem;
}

/* æŠŠæ‰‹ */
.drag-handle{ cursor: grab; color:#888; }

/* é‰›ç­†ï¼šè·Ÿåœ¨æ–‡å­—å¾Œï¼ˆä¸è¦çµ•å°å®šä½ï¼‰ */
.rename-btn{
  position: static;
  border: 0;
  background: transparent;
  color: #999;
  cursor: pointer;
}

/* X åœ¨æœ€å³ä¸Šè§’ */
.delete-btn{
  position: absolute;
  top: 0;
  right: 0;
  border: 0;
  background: transparent;
  color: #999;
  cursor: pointer;
  display: none; /* åªåœ¨ edit-mode é¡¯ç¤º */
}

/* è®“åˆ†é¡å€å¯è¢«è¼•è§¸å›é¥‹ */
#section-container {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
  touch-action: pan-y; /* å…è¨±ä¸Šä¸‹æ²å‹• */
}

/* é»å£“ä¸­çš„å¾®ç¸®æ•ˆæœ */
.section.__pressed { 
  transform: scale(0.985); 
  transition: transform 120ms ease;
}

/* é»ä¸€ä¸‹çš„å°å½ˆè·³æ•ˆæœ */
@keyframes __bump {
  0%   { transform: scale(1); }
  50%  { transform: scale(0.985); }
  100% { transform: scale(1); }
}
.section.__bump { animation: __bump .18s ease; }


#loadingScreen{
  position:fixed; inset:0; z-index:9999;
  display:none; align-items:center; justify-content:center;
  background:var(--app-bg);
}
#loadingScreen .loading-wrap{
  display:flex; flex-direction:column; align-items:center; gap:10px;
  padding:16px 20px; border-radius:12px;
  background:rgba(255,255,255,.7); backdrop-filter:blur(8px);
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}
.loading-spinner{
  width:28px; height:28px; border-radius:50%;
  border:3px solid rgba(0,0,0,.15);
  border-top-color: rgba(0,0,0,.5);
  animation: spin 0.9s linear infinite;
}
.loading-text{ color:#444; font-weight:600; letter-spacing:.2px; }
@keyframes spin{ to{ transform: rotate(360deg); } }

  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <div id="loginCard">
      <h1 style="justify-content:center;gap:10px;">
        <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="transform:translateY(2px);" />
        MyMemo
      </h1>
      <label>è‡ªè¨‚å¸³è™Ÿ</label>
      <input type="text" id="login-username" class="login-input" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" />
      <label>è‡ªè¨‚å¯†ç¢¼</label>
      <input type="password" id="login-password" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
      <label style="display:flex;align-items:center;gap:.4rem;">
        <input type="checkbox" id="auto-login" /> <span>è‡ªå‹•ç™»å…¥</span>
      </label>
      <button id="login-btn" class="login-btn">ç™»å…¥</button>
      <p style="margin-top:12px;color:#cc4444;text-align:center;font-size:.9rem;">å¹³å°å…è¨»å†Šï¼Œè‡ªè¨‚å¸³è™Ÿå¯†ç¢¼å³å¯ç™»éŒ„</p>
    </div>
  </div>

  <!-- App -->
  <div class="container" id="app">
    <div class="more-btn" onclick="openModal('moreModal')">â‹¯</div>
    <div id="today-badge"></div>

<div style="text-align:center;">
  <h1 onclick="location.href='index.html'" style="cursor:pointer;">
    <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="transform:translateY(2px);" />
    MyMemo
  </h1>
</div>


    <div id="section-container"></div>

    <div class="fab" onclick="toggleMenu()">ï¼‹</div>
<div class="menu" id="menu">
  <button onclick="openModal('memoModal')" 
          style="background:#e6f6fc; color:#0091cc; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
                 margin-bottom:12px;">
    æ–°å¢å‚™å¿˜
  </button>

  <button onclick="openCategoryModal()" 
          style="background:#e9f9f1; color:#1fa87a; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
                 margin-bottom:12px;">
    æ–°å¢åˆ†é¡
  </button>

  <button onclick="enterEditMode()" 
          style="background:#fff6e6; color:#d98a00; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;">
    ç·¨è¼¯åˆ†é¡
  </button>
</div>
<!-- âœ… ç·¨è¼¯å®Œæˆï¼ˆç½®ä¸­æ‡¸æµ®ï¼‰ -->
<button id="exitEditBtn" onclick="exitEditMode()" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #e3ffe8;
  color: #176d59;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  z-index: 120;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
">âœ…</button>


  </div>

  <!-- æ–°å¢å‚™å¿˜ -->
  <div class="modal" id="memoModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('memoModal')">âœ•</button>
      <h3>æ–°å¢å‚™å¿˜</h3>

      <label>å‚™å¿˜åˆ†é¡</label>
      <div class="inline-row">
        <select id="memoSection" class="half"></select>
        <label class="important-flag"><input type="checkbox" id="memoImportant"> é‡è¦</label>
      </div>

      <label>å‚™å¿˜æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="memoTitle" />

      <label>å‚™å¿˜å…§å®¹</label>
      <textarea id="memoContent"></textarea>

      <button class="save-btn" onclick="addMemo()">æ–°å¢</button>
    </div>
  </div>

  <!-- è©³æƒ… -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('detailModal')">âœ•</button>
      <h3 style="display:flex;align-items:center;gap:.5rem;">
        <span>å‚™å¿˜å…§å®¹</span>
        <small id="detailLastUpdate" style="font-size:.9rem;color:#666;white-space:nowrap;"></small>
      </h3>

      <!-- è¡¨å–® -->
      <div id="detailForm">
        <label>å‚™å¿˜åˆ†é¡</label>
        <div class="inline-row">
          <select id="detailSection" class="half"></select>
          <label class="important-flag"><input type="checkbox" id="detailImportant"> é‡è¦</label>
        </div>

        <label>å‚™å¿˜æ¨™é¡Œ</label>
        <input type="text" id="detailTitle" />

        <label style="display:flex;align-items:center;">
          å‚™å¿˜å…§å®¹
          <button type="button" class="expand-icon" onclick="toggleDetailExpand('detailContent','å‚™å¿˜å…§å®¹')" title="å±•é–‹"
                  style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-left:.4rem;border-radius:4px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer;font-size:12px;color:#555;">â¤¢</button>
        </label>
        <textarea id="detailContent"></textarea>

        <div class="row-btns">
          <button class="btn-half btn-save" onclick="saveMemo()">ğŸ’¾ å„²å­˜</button>
          <button class="btn-half btn-del" onclick="confirmDelete()">ğŸ—‘ï¸ ç§»é™¤</button>
        </div>
      </div>

      <!-- å±•é–‹é–±è®€/ç·¨è¼¯å™¨ -->
      <div id="detailViewer">
        <div class="viewer-head">
          <div class="viewer-title" id="viewerTitle"></div>
          <button type="button" class="viewer-close" onclick="toggleDetailExpand()">â¤¢</button>
        </div>
        <div class="viewer-toolbar">
          <button class="vt-btn" title="é‚„åŸ" onclick="viewerUndo()">â¤º</button>
          <button class="vt-btn" title="å¾©åŸ" onclick="viewerRedo()">â¤»</button>
          <button class="vt-btn" title="è¤‡è£½" onclick="viewerCopy()">â§‰</button>
        </div>
        <textarea class="viewer-body" id="viewerBody"></textarea>
      </div>
    </div>
  </div>

  <!-- åˆªé™¤ç¢ºèª -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 style="text-align:center;">ç¢ºå®šè¦åˆªé™¤é€™å‰‡å‚™å¿˜ï¼Ÿ</h3>
      <div style="display:flex;gap:.75rem;margin-top:1rem;">
        <button class="btn-half btn-del" onclick="deleteMemo()">ç¢ºèª</button>
        <button class="btn-half btn-save" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

<!-- åˆªé™¤ã€Œåˆ†é¡ã€ç¢ºèª -->
<div class="modal" id="confirmCategoryModal">
  <div class="modal-content">
    <h3 style="text-align:center;">ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡ï¼Ÿ</h3>
    <div style="display:flex;gap:.75rem;margin-top:1rem;">
      <button class="btn-half btn-del" onclick="deleteCategoryConfirmed()">ç¢ºèª</button>
      <button class="btn-half btn-save" onclick="closeModal('confirmCategoryModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>


  <!-- æ–°å¢åˆ†é¡ -->
  <div class="modal" id="categoryModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('categoryModal')">âœ•</button>
      <h3>æ–°å¢åˆ†é¡</h3>
      <input type="text" id="newCategoryName" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±" />
      <button class="save-btn" onclick="addCategory()">æ–°å¢åˆ†é¡</button>
    </div>
  </div>

  <!-- æ›´ååˆ†é¡ -->
  <div class="modal" id="renameModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('renameModal')">âœ•</button>
      <h3>é‡å‘½ååˆ†é¡</h3>
      <input type="text" id="renameInput" placeholder="æ–°çš„åˆ†é¡åç¨±" />
      <button class="save-btn" onclick="confirmRename()">ç¢ºå®š</button>
    </div>
  </div>

<!-- â‹¯ï¼ˆåªä¿ç•™æ›´æ›åº•è‰²èˆ‡ç™»å‡ºï¼‰ -->
<!-- æ›´å¤šåŠŸèƒ½ Modalï¼ˆåŸç‰ˆæ¨£å¼ï¼‰ -->
<div class="modal" id="moreModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('moreModal')">âœ•</button>
    <h3>æ›´å¤šåŠŸèƒ½</h3>

    <div class="more-row" style="flex-direction:column; align-items:flex-start; gap:0.5rem;">
      <span style="font-weight:bold;">æ›´æ›åº•è‰²</span>
      <button id="openPaletteBtn" class="palette-btn">ğŸ¨ èª¿è‰²ç›¤</button>
    </div>

    <hr style="margin:1rem 0;border:none;border-top:1px solid #eee;">

    <button class="logout-btn" onclick="openLogoutModal()">ç™»å‡º</button>
  </div>
</div>





  <!-- èª¿è‰²ç›¤ -->
  <!-- èª¿è‰²ç›¤ï¼ˆåŸç‰ˆäº’å‹•ï¼šç¢ºèªï¼å–æ¶ˆï¼‰ -->
<div class="modal" id="paletteModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paletteModal')">âœ•</button>
    <h3>é¸æ“‡åº•è‰²</h3>

    <div class="palette-grid">
      <div class="palette-choice" data-color="#f6fbfe"></div>
      <div class="palette-choice" data-color="#f3fcf8"></div>
      <div class="palette-choice" data-color="#fffcf3"></div>
      <div class="palette-choice" data-color="#fef6f9"></div>
      <div class="palette-choice" data-color="#f9f8fd"></div>
      <div class="palette-choice" data-color="#ffeded"></div>
      <div class="palette-choice" data-color="#fff8f5"></div>
      <div class="palette-choice" data-color="#fdfcf9"></div>
      <div class="palette-choice" data-color="metal"><div class="metal-sheen"></div></div>
    </div>

    <div class="dialog-actions">
      <button id="paletteConfirmBtn" class="btn-primary">ç¢ºèª</button>
      <button id="paletteCancelBtn" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>


  <!-- ç™»å‡ºç¢ºèª -->
  <div class="modal" id="logoutModal">
    <div class="modal-content">
      <h3 style="text-align:center;">ç¢ºå®šè¦ç™»å‡ºï¼Ÿ</h3>
      <div style="display:flex;gap:.75rem;margin-top:1rem;">
        <button class="btn-half btn-del" onclick="doLogout()">ç¢ºèª</button>
        <button class="btn-half btn-save" onclick="closeModal('logoutModal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== åŸºæœ¬è¨­å®š ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
      authDomain: "kjreminder-24d74.firebaseapp.com",
      projectId: "kjreminder-24d74",
      storageBucket: "kjreminder-24d74.firebasestorage.app",
      messagingSenderId: "176371952161",
      appId: "1:176371952161:web:948121be209cd2e4181160",
      databaseURL: "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    /* ===== ç‹€æ…‹ ===== */
    let roomPath = "";                  // rooms/{user}-{pass}
    let memos = [];                     // é€²è¡Œä¸­çš„å‚™å¿˜
    let categories = [];                // åˆ†é¡
    let categoriesLoaded = false;
    let selectedMemoId = null;
    let memosRef = null, categoriesRef = null;
    let sectionSortable = null;

    let memoMonthFilter = 'all';   // 'all' | 'recent5' | '11407'ï¼ˆROC å¹´æœˆï¼‰
    
function buildMemoMonthMenu(){
  const menu = document.getElementById('memoMonthMenu');
  if (!menu) return;
  menu.innerHTML = '';

  const mkBtn = (label, onClick, bold=false) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;' + (bold?'font-weight:600;':'');
    btn.onclick = ()=>{ onClick(); menu.style.display='none'; };
    return btn;
  };

  // å…¨éƒ¨
  menu.appendChild(mkBtn('å…¨éƒ¨', ()=>{
    memoMonthFilter = 'all';
    renderAll();
  }, true));

  // è¿‘5æ—¥
  menu.appendChild(mkBtn('è¿‘5æ—¥', ()=>{
    memoMonthFilter = 'recent5';
    renderAll();
  }));

  // è¿‘30æ—¥
  menu.appendChild(mkBtn('è¿‘30æ—¥', ()=>{
    memoMonthFilter = 'recent30';
    renderAll();
  }));

  // é‡è¦â—
  menu.appendChild(mkBtn('é‡è¦ â—', ()=>{
    memoMonthFilter = 'important';
    renderAll();
  }));

  // æœˆä»½ï¼ˆä»¥æœ€å¾Œæ›´æ–°æ™‚é–“ç‚ºä¸»ï¼Œæ²’æœ‰æ›´æ–°å°±ç”¨å»ºç«‹æ™‚é–“ï¼‰
  const monthSet = new Set();
  (memos || []).forEach(m=>{
    const ts = getMemoRefTime(m);            // ä½ ä¸Šä¸€ç‰ˆå·²åŠ ï¼šreturn m.updatedAt || m.createdAt || null;
    const ym = toRocYMFromTs(ts);            // ä½ ä¸Šä¸€ç‰ˆå·²åŠ ï¼šæŠŠæ™‚é–“æˆ³è½‰æˆ ROC å¹´æœˆå­—ä¸²
    if (ym !== 'ç„¡') monthSet.add(ym);
  });

  if (monthSet.size === 0){
    const empty = document.createElement('div');
    empty.textContent = 'ç„¡æ›´å¤šæœˆä»½';
    empty.style.cssText = 'padding:6px 8px; color:#666;';
    menu.appendChild(empty);
    return;
  }

  Array.from(monthSet).sort((a,b)=>b.localeCompare(a)).forEach(ym=>{
    menu.appendChild(mkBtn(ym, ()=>{
      memoMonthFilter = ym;
      renderAll();
    }));
  });
}


    /* ===== å°å·¥å…· ===== */
    function sanitizeKey(s){ return String(s || '').replace(/[.#$/\[\]\/]/g,'_'); }
    function hydrateRoomPath(){
      try{
        const saved = localStorage.getItem('todo_room_info');
        if (!saved) return;
        const { username, password } = JSON.parse(saved);
        roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
      }catch(_){}
    }
    function openModal(id){ document.getElementById(id).style.display = 'flex'; }
    function closeModal(id){ document.getElementById(id).style.display = 'none'; }
    function toggleMenu(){
      const m = document.getElementById('menu');
      m.classList.toggle('show');
    }
    document.addEventListener('click', (e)=>{
      const menu = document.getElementById('menu');
      if (menu.classList.contains('show')){
        const inside = menu.contains(e.target);
        const onFab  = document.querySelector('.fab').contains(e.target);
        if (!inside && !onFab) menu.classList.remove('show');
      }
    });

    /* ===== Login ===== */
    function setLoginBusy(b){ const btn = document.getElementById('login-btn'); btn.disabled = b; btn.textContent = b ? 'ç™»å…¥ä¸­â€¦' : 'ç™»å…¥'; }
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  auth.onAuthStateChanged(async (user)=>{
  hydrateRoomPath();

  if (roomPath) {
    if (user) {
      // ç›´æ¥é€² App
      showView('app');
      bindFirebase();
    } else {
      // é‚„æ²’ç™»å…¥ â†’ é¡¯ç¤ºã€Œåˆ‡æ›ä¸­â€¦ã€ä¸¦å˜—è©¦åŒ¿åç™»å…¥
      showView('loading');
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInAnonymously(); // æˆåŠŸæœƒå†é€²åˆ°ä¸Šé¢åˆ†æ”¯
      } catch (e) {
        console.warn('Anonymous sign-in failed:', e);
        showView('login'); // å¤±æ•—æ‰é¡¯ç¤ºç™»å…¥é 
      }
    }
  } else {
    // æ²’æœ‰ roomPathï¼ˆæ²’æœ‰å­˜å¸³å¯†ï¼‰â†’ é¡¯ç¤ºç™»å…¥
    showView('login');
    unbindFirebase();
  }
});


document.getElementById('login-btn').addEventListener('click', async ()=>{
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value.trim();
  const auto = document.getElementById('auto-login').checked;
  if (!u || !p) { alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼'); return; }

  setLoginBusy(true);
  try {
    const info = { username: u, password: p };
    if (auto) localStorage.setItem('todo_room_info', JSON.stringify(info));
    else      localStorage.removeItem('todo_room_info');

    roomPath = `rooms/${sanitizeKey(u)}-${sanitizeKey(p)}`;

    if (auth.currentUser) {
      // å·²æœ‰æœƒè©±ï¼šç›´æ¥ç¶è³‡æ–™ä¸¦é€²å…¥ App
      showView('loading');           // å°éå ´
      bindFirebase();
      showView('app');
    } else {
      // æ²’æœƒè©±ï¼šé¡¯ç¤º loadingï¼Œåšä¸€æ¬¡åŒ¿åç™»å…¥
      showView('loading');
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInAnonymously(); // æˆåŠŸå¾Œ onAuthStateChanged æœƒå¸¶ä½ é€² App
    }
  } catch (e) {
    alert('ç™»å…¥å¤±æ•—ï¼š' + (e?.message || e));
    showView('login');
  } finally {
    setLoginBusy(false);
  }
});



    function doLogout(){
      try{ if (memosRef) memosRef.off(); if (categoriesRef) categoriesRef.off(); }catch(_){}
      memos = []; categories = []; selectedMemoId = null;
      try{ localStorage.removeItem('todo_room_info'); }catch(_){}
      roomPath = "";
      try{ auth.signOut(); }catch(_){}
      closeModal('logoutModal'); closeModal('moreModal');
      document.getElementById('app').style.display='none';
      document.getElementById('loginPage').style.display='flex';
    }

    /* ===== Firebase ç¶å®š ===== */
    function bindFirebase(){
      unbindFirebase();
      memosRef = db.ref(`${roomPath}/memos`);
      categoriesRef = db.ref(`${roomPath}/memoCategories`);

      memosRef.on('value', (snap)=>{
        const data = snap.val() || {};
        memos = Object.values(data);
        renderAll();
      });

      categoriesRef.on('value', (snap)=>{
        const cloud = snap.val();
        if (cloud === null) {
          categories = [];
          saveCategories();
        } else if (Array.isArray(cloud)) {
          categories = cloud.slice();
        } else if (cloud && typeof cloud === 'object') {
          categories = Object.values(cloud);
        } else {
          categories = [];
        }
        categoriesLoaded = true;
        renderSections(categories);
        renderAll();
      });
    }
    function unbindFirebase(){ try{ memosRef && memosRef.off(); categoriesRef && categoriesRef.off(); }catch(_){} }
    function saveMemos(){
      const obj = {}; memos.forEach(m=>obj[m.id]=m);
      db.ref(`${roomPath}/memos`).set(obj);
    }
    function saveCategories(){ db.ref(`${roomPath}/memoCategories`).set(categories); }

    /* ===== UIï¼šä»Šæ—¥å¾½ç«  ===== */
    (function(){
      const el = document.getElementById('today-badge');
      const WEEK = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      function draw(){
        const now=new Date();
        el.textContent = `${now.getMonth()+1}/${now.getDate()}ï¼ˆ${WEEK[now.getDay()]}ï¼‰`;
      }
      draw();
      const t = new Date(); const mid = new Date(t); mid.setHours(24,0,0,0);
      setTimeout(()=>{ draw(); setInterval(draw,24*3600*1000); }, mid - t);
    })();

    /* ===== åˆ†é¡å€ ===== */
function renderSections(list){
  const wrap = document.getElementById('section-container');

  // å…ˆç•«å‡ºã€Œæ›´å¤šâ€¦ã€ + ä¸‹æ‹‰æ¸…å–®
  wrap.innerHTML = `
    <div id="memoMore" style="text-align:right; margin:0.25rem 0; position:relative;">
      <button id="memoMoreBtn"
              style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">
        æ›´å¤šâ€¦
      </button>
      <div id="memoMonthMenu"
           style="display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd;
                  border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;">
      </div>
    </div>
  `;

  // ä¾åˆ†é¡ç•«å€å¡Š
  list.forEach(name=>{
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.id = name;
    sec.innerHTML = `<div class="section-title">${name}</div>`;
    wrap.appendChild(sec);
  });

  updateSectionOptions();
  initSectionSortable?.();

  // é‡æ–°æ›ã€Œæ›´å¤šâ€¦ã€æŒ‰éˆ•
  document.getElementById('memoMoreBtn')?.addEventListener('click', ()=>{
    const menu = document.getElementById('memoMonthMenu');
    if (!menu) return;
    menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
  });

  // ä¾ç›®å‰ memos å»ºä¸€æ¬¡æœˆä»½æ¸…å–®
  buildMemoMonthMenu();
}
    function updateSectionOptions(){
      const opts = (categories||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
      const s1=document.getElementById('memoSection'), s2=document.getElementById('detailSection');
      if (s1) s1.innerHTML = opts;
      if (s2) s2.innerHTML = opts;
    }
    function initSectionSortable(){
      const el = document.getElementById('section-container');
      if (!el) return;
      if (sectionSortable && sectionSortable.destroy) sectionSortable.destroy();
      sectionSortable = new Sortable(el, {
        animation:150, handle:'.drag-handle', draggable:'.section', ghostClass:'dragging',
        onEnd: ()=>{
          categories = Array.from(document.querySelectorAll('#section-container .section')).map(sec=>sec.id);
          saveCategories();
        }
      });
    }

    /* ===== åˆ†é¡ï¼šæ–°å¢/ç·¨è¼¯/åˆªé™¤/æ›´å ===== */
    function openCategoryModal(){ document.getElementById('newCategoryName').value=''; openModal('categoryModal'); }
    function addCategory(){
      const name = document.getElementById('newCategoryName').value.trim();
      if (!name) return;
      if (categories.includes(name)) return alert('æ­¤åˆ†é¡å·²å­˜åœ¨');
      categories.push(name); saveCategories(); renderSections(categories);
      closeModal('categoryModal');
    }
    let pendingRenameId = null;
    function enterEditMode(){
  isEditing = true;

  // æ¯å€‹å€å¡Šå¥—ä¸Šç·¨è¼¯é…ä»¶
  document.querySelectorAll('.section').forEach(sec=>{
    sec.classList.add('edit-mode');

    const bar = sec.querySelector('.section-title');
    const name = sec.id;

    // é‡ç•«æ¨™é¡Œåˆ—ï¼šâ˜° åç¨± âœï¼ˆX äº¤çµ¦ CSS æ”¾å³ä¸Šè§’ï¼‰
    bar.innerHTML = `
      <span class="drag-handle">â˜°</span>
      <span class="section-name">${name}</span>
      <button class="rename-btn" title="é‡å‘½å">âœ</button>
      <button class="delete-btn" title="åˆªé™¤æ­¤åˆ†é¡">âœ•</button>
    `;

    bar.querySelector('.rename-btn').onclick = ()=>{
      pendingRenameId = sec.id;
      document.getElementById('renameInput').value = sec.id;
      openModal('renameModal');
    };
    bar.querySelector('.delete-btn').onclick = ()=> confirmDeleteCategory(sec.id);
  });

  // é‡æ–°å•Ÿç”¨æ‹–æ‹‰
  initSectionSortable();

  // é¡¯ç¤ºåº•éƒ¨ âœ… éˆ•
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'block';
}

function exitEditMode(){
  isEditing = false;

  // é‚„åŸæ¨™é¡Œåˆ—æˆåªæœ‰åç¨±
  document.querySelectorAll('.section').forEach(sec=>{
    sec.classList.remove('edit-mode');
    const bar = sec.querySelector('.section-title');
    bar.textContent = sec.id;
  });

  // é—œé–‰åº•éƒ¨ âœ… éˆ•
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'none';

  // ä¿éšªï¼šéŠ·æ¯€ä¸¦é‡å»ºæ‹–æ‹‰
  if (sectionSortable && sectionSortable.destroy){
    sectionSortable.destroy();
    sectionSortable = null;
  }
  initSectionSortable();

  // æ›´æ–°ä¸‹æ‹‰
  updateSectionOptions();
}

    function confirmDeleteCategory(id){
  pendingCategoryId = id;
  openModal('confirmCategoryModal'); // æ‰“é–‹è‡ªè¨‚è¦–çª—
}

function deleteCategoryConfirmed(){
  if (!pendingCategoryId) { closeModal('confirmCategoryModal'); return; }

  const id = pendingCategoryId;
  const fallback = categories.find(c => c !== "å…¶å®ƒ" && c !== id) || "å…¶å®ƒ";

  // æŠŠè©²åˆ†é¡ä¸‹çš„ memo ç§»åˆ° fallback
  memos.forEach(m => { if (m.section === id) m.section = fallback; });

  // åˆªæ‰åˆ†é¡
  categories = categories.filter(c => c !== id);

  // å­˜é›²ï¼‹é‡ç•«
  saveMemos();
  saveCategories();
  renderSections(categories);
  renderAll();

  // æ”¶å°¾
  pendingCategoryId = null;
  closeModal('confirmCategoryModal');
}

    function confirmRename(){
      const oldId = pendingRenameId;
      const newName = document.getElementById('renameInput').value.trim();
      if (!newName || document.getElementById(newName)) return alert('åç¨±ä¸å¯ç‚ºç©ºæˆ–å·²å­˜åœ¨ï¼');
      memos.forEach(m=>{ if (m.section===oldId) m.section=newName; });
      categories = categories.map(c=> c===oldId ? newName : c);
      saveMemos(); saveCategories(); renderSections(categories); renderAll();
      pendingRenameId = null; closeModal('renameModal');
    }

    /* ===== Memo CRUD ===== */
function memoCardHTML(m){
  return `
    <div class="swipe-bar left"><span class="label">ğŸ—‘ ç§»é™¤</span></div>
    <div class="task-content">
      <div class="task-title">${m.important ? 'â— ' : ''}${m.title || ''}</div>
    </div>
  `;
}


function renderAll(){
  // æ¸…ç©ºæ¯å€‹åˆ†é¡çš„ memo å¡
  document.querySelectorAll('.section').forEach(sec=>{
    Array.from(sec.querySelectorAll('.task')).forEach(t=>t.remove());
  });

  // ä¾é¸æ“‡ç¯©é¸ï¼ˆall ä¸éæ¿¾ / important åªçœ‹æ——æ¨™ / å…¶ä»–çœ‹æ™‚é–“æˆ–æœˆä»½ï¼‰
  const filtered = (memos||[]).filter(m=>{
    if (memoMonthFilter === 'all') return true;            // å…¨éƒ¨
    if (memoMonthFilter === 'important') return !!m.important;

    const ts = getMemoRefTime(m);                          // ä»¥ã€Œæœ€å¾Œæ›´æ–°æ—¥ï¼ˆç„¡å‰‡å»ºç«‹æ—¥ï¼‰ã€ç‚ºåŸºæº–
    if (!ts) return false;

    if (memoMonthFilter === 'recent5'){
      const diffDays = Math.floor((Date.now() - ts) / 86400000);
      return diffDays <= 5;
    }
    if (memoMonthFilter === 'recent30'){
      const diffDays = Math.floor((Date.now() - ts) / 86400000);
      return diffDays <= 30;
    }
    // æŒ‡å®šæœˆä»½ï¼ˆROC å¹´æœˆï¼‰
    return toRocYMFromTs(ts) === memoMonthFilter;
  });

  // ç•«å¡ç‰‡
  filtered.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'task';
    el.dataset.id = m.id;
    el.innerHTML = memoCardHTML(m);
    const sec = document.getElementById(m.section);
    (sec || document.getElementById(categories[0]))?.appendChild(el);
  });

  bindSwipeToTasks?.();
  updateSectionOptions?.();

  // â˜… éã€Œå…¨éƒ¨ã€æ™‚ï¼ŒæŠŠæ²’æœ‰ä»»ä½•ç¬¦åˆå¡ç‰‡çš„åˆ†é¡éš±è—èµ·ä¾†
  if (memoMonthFilter === 'all') {
    document.querySelectorAll('#section-container .section')
      .forEach(sec => sec.style.display = '');
  } else {
    hideEmptySectionsAfterFilter();
  }

  // æ¸…å–®åŒæ­¥ï¼ˆé˜²æ–°å¢/ç·¨è¼¯å¾Œæœˆä»½è®Šå‹•ï¼‰
  buildMemoMonthMenu();
}


function getMemoRefTime(m){ return m?.updatedAt || m?.createdAt || null; }
function toRocYMFromTs(ts){
  if (!ts) return 'ç„¡';
  const d = new Date(ts);
  if (isNaN(d)) return 'ç„¡';
  const yy = d.getFullYear() - 1911;
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yy}${mm}`;
}

function hideEmptySectionsAfterFilter(){
  document.querySelectorAll('#section-container .section').forEach(sec=>{
    const hasVisible = Array.from(sec.querySelectorAll('.task'))
      .some(el => getComputedStyle(el).display !== 'none');
    sec.style.display = hasVisible ? '' : 'none';
  });
}


    function hideEmptySections(){
      document.querySelectorAll('#section-container .section').forEach(sec=>{
        const has = sec.querySelector('.task');
        sec.style.display = has ? '' : '';
      });
    }

    function addMemo(){
      const section = document.getElementById('memoSection').value;
      const title   = document.getElementById('memoTitle').value.trim();
      const content = document.getElementById('memoContent').value;
      const important = document.getElementById('memoImportant').checked;
      if (!title) return;

      const id = 'memo-' + Date.now();
      const now = Date.now();
      const memo = { id, section, title, content, important, createdAt: now, updatedAt: now };

      memos.push(memo); saveMemos(); renderAll();
      document.getElementById('memoTitle').value='';
      document.getElementById('memoContent').value='';
      document.getElementById('memoImportant').checked=false;
      closeModal('memoModal');
    }

    function openDetail(id){
      selectedMemoId = id;
      const m = memos.find(x=>x.id===id); if (!m) return;

      document.getElementById('detailSection').value = m.section;
      document.getElementById('detailTitle').value   = m.title;
      document.getElementById('detailContent').value = m.content || '';
      document.getElementById('detailImportant').checked = !!m.important;

      const lbl = document.getElementById('detailLastUpdate');
      lbl.textContent = m.updatedAt ? ('æ›´æ–°ï¼š' + formatRocDateTime(m.updatedAt)) : '';

      resetDetailPanels();
      document.getElementById('detailModal').style.display='flex';
    }

    function saveMemo(){
      if (!selectedMemoId) return;
      const m = memos.find(x=>x.id===selectedMemoId); if (!m) return;

      m.section   = document.getElementById('detailSection').value;
      m.title     = document.getElementById('detailTitle').value;
      m.content   = document.getElementById('detailContent').value;
      m.important = document.getElementById('detailImportant').checked;
      m.updatedAt = Date.now();

      saveMemos(); renderAll(); closeModal('detailModal');
    }

    function confirmDelete(){ openModal('confirmModal'); }
    function deleteMemo(){
      if (!selectedMemoId) return;
      const idx = memos.findIndex(x=>x.id===selectedMemoId);
      if (idx>=0) memos.splice(idx,1);
      saveMemos(); renderAll();
      closeModal('confirmModal'); closeModal('detailModal');
    }

    /* ===== Swipeï¼ˆåªä¿ç•™å·¦æ»‘åˆªé™¤ï¼›å³æ»‘å®Œæˆç¦ç”¨ï¼‰ ===== */
    function bindSwipeToTasks(){
      document.querySelectorAll('.task').forEach(task=>{
        if (task.dataset.swipeBound==='1') return;
        task.dataset.swipeBound='1';
        task.onclick = null;

        const barL = task.querySelector('.swipe-bar.left');
        const labL = barL?.querySelector('.label');

        let sx=0, sy=0, dx=0, dy=0, width=0, isDown=false, activeId=null, mode='pending';
        const H_START=16, V_CANCEL=10, DOMINANCE=1.3, BOUND=0.75, MAX_TILT=3;

        task.addEventListener('pointerdown', onDown);
        task.addEventListener('pointermove', onMove);
        task.addEventListener('pointerup', onUp);
        task.addEventListener('pointercancel', onCancel);
        task.addEventListener('lostpointercapture', onCancel);

        // å clickï¼Œè‡ªå·±åˆ¤å®šã€Œé»ä¸€ä¸‹ã€
        task.addEventListener('click', (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); }, true);

        function onDown(e){
          if (e.target.closest('button,input,select,textarea')) return;
          isDown=true; activeId=e.pointerId; sx=e.clientX; sy=e.clientY; dx=dy=0; width = task.offsetWidth||1; mode='pending';
          task.style.transition='none'; try{ task.setPointerCapture(e.pointerId); }catch(_){}
        }
        function onMove(e){
          if (!isDown || e.pointerId!==activeId) return;
          if (mode==='scroll') return;
          dx = e.clientX - sx; dy = e.clientY - sy;
          // å‚ç›´ç‚ºä¸» â†’ æ²å‹•
          if (mode==='pending'){
            const adx=Math.abs(dx), ady=Math.abs(dy);
            if (ady>V_CANCEL && ady>adx*1.2){ mode='scroll'; resetBars(); task.style.transform=''; return; }
            if (adx<H_START) return;
            if (adx>ady*DOMINANCE){ mode='swipe'; } else { mode='scroll'; return; }
          }
          if (mode!=='swipe') return;

          // åªè™•ç†å·¦æ»‘ï¼ˆåˆªé™¤ï¼‰
          const adx=Math.abs(dx); const pct=Math.min(1, adx/width); const tilt=(dx/width)*MAX_TILT;
          task.style.transform = `translateX(${Math.round(dx)}px) rotate(${tilt}deg)`;
          if (dx<0){
            barL.style.width = (pct*100)+'%';
            labL.style.opacity = Math.min(1, pct*1.2);
            labL.style.transform = `translateX(${pct>0.05?0:6}px)`;
          }else{
            resetBars(); // å³æ»‘ä¸å•Ÿç”¨
          }
        }
        function onUp(e){ finish(false); }
        function onCancel(e){ finish(true); }
        function finish(cancel){
          const tapLike = Math.abs(dx)<4 && Math.abs(dy)<4 && mode!=='scroll';
          const wasSwipe = (mode==='swipe'); mode='pending'; isDown=false; activeId=null;
          task.style.transition='transform .18s'; task.style.transform=''; resetBars();

          if (!wasSwipe && !cancel && tapLike){ openDetail(task.dataset.id); cleanup(); return; }

          if (!wasSwipe || cancel){ cleanup(); return; }
          const passed = Math.abs(dx) >= width*BOUND;
          if (passed && dx<0){ selectedMemoId = task.dataset.id; setTimeout(()=>confirmDelete(),10); }
          cleanup();
        }
        function cleanup(){ dx=dy=0; try{ task.releasePointerCapture?.(activeId); }catch(_){ } }
        function resetBars(){ if (barL){ barL.style.width='0%'; labL.style.opacity=0; labL.style.transform='translateX(6px)'; } }
      });
    }

    /* ===== å±•é–‹é–±è®€é¢æ¿ï¼ˆundo/redo/copyï¼‰ ===== */
    let __expandedFieldId = null, __viewerHistory=[], __viewerRedoStack=[];
    function toggleDetailExpand(fieldId, title){
      const form = document.getElementById('detailForm');
      const viewer = document.getElementById('detailViewer');
      const vTitle = document.getElementById('viewerTitle');
      const vBody  = document.getElementById('viewerBody');

      // ç§»é™¤èˆŠç›£è½
      if (__expandedFieldId){
        const prev = document.getElementById(__expandedFieldId);
        if (prev?.__viewerSync){ prev.removeEventListener('input', prev.__viewerSync); prev.__viewerSync=null; }
        if (vBody?.__formSync){ vBody.removeEventListener('input', vBody.__formSync); vBody.__formSync=null; }
        if (vBody?.__histHandler){ vBody.removeEventListener('input', vBody.__histHandler); vBody.__histHandler=null; }
      }

      const willCollapse = (__expandedFieldId && (!fieldId || fieldId===__expandedFieldId));
      if (willCollapse){
        form.classList.remove('hide'); viewer.classList.remove('show'); __expandedFieldId=null; return;
      }

      const src = document.getElementById(fieldId);
      vTitle.textContent = title || '';
      vBody.value = src ? (src.value||'') : '';
      viewer.classList.add('show'); form.classList.add('hide'); __expandedFieldId = fieldId;

      if (src){
        src.__viewerSync = ()=>{ vBody.value = src.value || ''; };
        src.addEventListener('input', src.__viewerSync);

        vBody.__formSync = ()=>{ src.value = vBody.value || ''; };
        vBody.addEventListener('input', vBody.__formSync);
      }

      __viewerHistory=[vBody.value||'']; __viewerRedoStack=[];
      if (vBody.__histHandler) vBody.removeEventListener('input', vBody.__histHandler);
      let timer=null;
      vBody.__histHandler=()=>{ clearTimeout(timer); timer=setTimeout(()=>{ pushViewerHistory(vBody.value||''); },180); };
      vBody.addEventListener('input', vBody.__histHandler);
    }
    function resetDetailPanels(){
      const form=document.getElementById('detailForm'), viewer=document.getElementById('detailViewer');
      const vBody=document.getElementById('viewerBody');
      if (vBody?.__histHandler){ vBody.removeEventListener('input', vBody.__histHandler); vBody.__histHandler=null; }
      __viewerHistory=[]; __viewerRedoStack=[];
      viewer?.classList.remove('show'); form?.classList.remove('hide');
    }
    function pushViewerHistory(v){ if (!__viewerHistory.length || __viewerHistory[__viewerHistory.length-1]!==v){ __viewerHistory.push(v); if (__viewerHistory.length>100) __viewerHistory.shift(); } __viewerRedoStack=[]; }
    function viewerUndo(){ const v=document.getElementById('viewerBody'); if (__viewerHistory.length<=1) return; const cur=__viewerHistory.pop(); __viewerRedoStack.push(cur); v.value = __viewerHistory[__viewerHistory.length-1]; if (v.__formSync) v.__formSync(); }
    function viewerRedo(){ const v=document.getElementById('viewerBody'); if (!__viewerRedoStack.length) return; const redo=__viewerRedoStack.pop(); v.value=redo; if (v.__formSync) v.__formSync(); pushViewerHistory(v.value); }
    function viewerCopy(){
      const t=document.getElementById('viewerBody').value||'';
      if (!t) return alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
      (navigator.clipboard?.writeText(t)||Promise.reject()).then(()=>alert('å·²è¤‡è£½å…§å®¹')).catch(()=>{
        try{ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('å·²è¤‡è£½å…§å®¹'); }catch(_){ alert('è¤‡è£½å¤±æ•—'); }
      });
    }

    /* ===== èª¿è‰²ç›¤ ===== */
    function setAppBgColor(color){
      const body=document.body;
      if (color==='metal'){ body.classList.add('bg-metal'); document.documentElement.style.setProperty('--app-bg','#ececec'); }
      else { body.classList.remove('bg-metal'); document.documentElement.style.setProperty('--app-bg', color); }
      try{ localStorage.setItem('app_bg_fixed', color); }catch(_){}
    }
    function applySavedBgColor(){ try{ const saved=localStorage.getItem('app_bg_fixed'); if (saved) setAppBgColor(saved); }catch(_){} }
    applySavedBgColor();

    document.getElementById('openPaletteBtn').addEventListener('click', ()=> openModal('paletteModal'));
    let pendingColor=null;
    document.addEventListener('click', (e)=>{
      const tile = e.target.closest('.palette-choice');
      if (!tile) return;
      const wrap = document.getElementById('paletteModal');
      wrap.querySelectorAll('.palette-choice').forEach(t=>t.classList.remove('selected'));
      tile.classList.add('selected'); pendingColor = tile.dataset.color;
    });
    document.getElementById('paletteConfirmBtn').addEventListener('click', ()=>{
      if (pendingColor) setAppBgColor(pendingColor);
      closeModal('paletteModal');
    });

    /* ===== äº’å‹•è£œå¼· ===== */
    // é»èƒŒæ™¯é—œé–‰ modal
    document.addEventListener('click', (e)=>{
      const modal = e.target.closest('.modal');
      if (!modal) return;
      if (getComputedStyle(modal).display==='none') return;
      const content = modal.querySelector('.modal-content');
      if (!content || !content.contains(e.target)) closeModal(modal.id);
    });
    // Esc é—œé–‰
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>{ if (getComputedStyle(m).display!=='none') closeModal(m.id); }); } });

    /* ===== å…¶ä»– ===== */
    function formatRocDateTime(ts){
      if (!ts && ts!==0) return '';
      const d=new Date(ts); if (isNaN(d)) return '';
      const y=d.getFullYear()-1911, m=d.getMonth()+1, dd=d.getDate();
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mm}`;
    }

    /* ===== åˆå§‹è³‡æ–™ ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // é è¨­å…ˆç•«ç©ºå®¹å™¨ï¼Œç­‰é›²ç«¯å›ä¾†å†ç•«
      renderSections(categories);
    });

function openLogoutModal(){
  openModal('logoutModal');
}

function showView(view){
  const login = document.getElementById('loginPage');
  const app   = document.getElementById('app');
  const load  = document.getElementById('loadingScreen');

  login.style.display = (view === 'login')   ? 'flex'  : 'none';
  app.style.display   = (view === 'app')     ? 'block' : 'none';
  load.style.display  = (view === 'loading') ? 'flex'  : 'none';
}

  </script>

<!-- Loadingï¼ˆåˆ‡æ›ä¸­ï¼‰ -->
<div id="loadingScreen" style="display:none;">
  <div class="loading-wrap">
    <div class="loading-spinner"></div>
    <div class="loading-text">åˆ‡æ›ä¸­â€¦</div>
  </div>
</div>

</body>
</html>
