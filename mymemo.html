<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>MyMemo</title>

  <!-- Icons / PWA 可自行替換 -->
  <link rel="icon" type="image/png" sizes="32x32" href="reminder.png">
  <link rel="apple-touch-icon" sizes="180x180" href="reminder.png">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Sortable (分類拖拉用) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>


:root{
  --blue-light:#ebf5fc;
  --yellow-light:#fffbe6; /* 用 MyTask 的黃 */
  --white:#fff;
  --gray-text:#444;
  --app-bg:var(--blue-light);
}
    *{ box-sizing:border-box; font-family:'Segoe UI',system-ui,-apple-system,sans-serif; }
    body{ margin:0; background:var(--app-bg); color:var(--text); display:flex; justify-content:center; padding:16px; }
    .container{ width:100%; max-width:480px; position:relative; display:none; }

    /* 標題 */
h1 {
  display: inline-flex;  /* 原本是 flex */
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 24px;
  margin: 6px 0 10px;
  padding: 4px 10px;
  border-radius: 8px;
  transition: background-color .2s, box-shadow .2s;
}

    h1:hover{ background:rgba(0,0,0,.05); box-shadow:0 0 0 2px rgba(0,0,0,.08) inset; }

    /* ⋯ */
/* ⋯ 按鈕本身（原版） */
/* ⋯ 浮鈕（原版尺寸/陰影） */
.more-btn{
  position:fixed; top:12px; left:12px; width:32px; height:32px;
  border-radius:50%; background:#fff; color:#555; font-size:18px; font-weight:bold;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,.15); cursor:pointer; z-index:100; line-height:1;
}

/* 更多功能：小卡片寬度與緊實標題 */
#moreModal .modal-content{ max-width:300px; }
#moreModal .modal-content h3{ margin:.2rem 0 .6rem; font-size:1.1rem; }

/* row 佈局：左文右鈕 */
.more-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; margin:10px 0;
}

/* 小淺底：調色盤按鈕 */
button.palette-btn {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  padding: 4px 8px !important;
  font-size: 0.85rem !important;
  font-weight: normal;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #f9f9f9 !important;
  color: #333 !important;
  width: auto !important;
  min-width: unset !important;
  margin-top: 0; /* 保持緊貼標題 */
}
button.palette-btn:hover { background: #f1f1f1 !important; }
button.palette-btn:active { background: #e8e8e8 !important; }

/* 調色盤九宮格 */
/* --- 調色盤按鈕（小淺底）已在你檔案內，保留即可 --- */

/* 調色盤九宮格（你已有，這裡補足 data-color 背景與選取態） */
.palette-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:.75rem; margin-top:.5rem; }
.palette-choice{
  position:relative;
  width:100%; aspect-ratio:1/1; border-radius:12px; border:1px solid #e5e5e5;
  box-shadow: 0 1px 2px rgba(0,0,0,.06); cursor:pointer; overflow:hidden;
}
.palette-choice[data-color="#f6fbfe"]{ background:#f6fbfe; }
.palette-choice[data-color="#f3fcf8"]{ background:#f3fcf8; }
.palette-choice[data-color="#fffcf3"]{ background:#fffcf3; }
.palette-choice[data-color="#fef6f9"]{ background:#fef6f9; }
.palette-choice[data-color="#f9f8fd"]{ background:#f9f8fd; }
.palette-choice[data-color="#ffeded"]{ background:#ffeded; }
.palette-choice[data-color="#fff8f5"]{ background:#fff8f5; }
.palette-choice[data-color="#fdfcf9"]{ background:#fdfcf9; }
.palette-choice[data-color="metal"]{ background:#e5e5e5; }
.palette-choice .metal-sheen{
  position:absolute; inset:0;
  background:
    linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.1)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, rgba(0,0,0,.04) 1px 2px);
  mix-blend-mode: screen; pointer-events:none;
}
.palette-choice.selected{
  outline: 3px solid #176dff;
  box-shadow: 0 0 0 3px rgba(23,109,255,.15) inset;
}

/* 調色盤底部：確認／取消（與 MyTask 風格一致） */
.dialog-actions{
  display:flex; gap:.5rem; margin-top:12px;
}
.btn-primary, .btn-secondary{
  flex:1; height:42px; border-radius:8px; font-weight:700; font-size:15px; cursor:pointer; border:0;margin-top:1rem
}
.btn-primary{ background:#fc97ba; color:#fff; box-shadow:0 6px 16px rgba(0,170,255,.28); }
.btn-primary:hover{ background:#ffa49c; }
.btn-primary:active{ transform: translateY(1px); }

.btn-secondary{ background:#f5f5f5; color:#333; border:1px solid #ddd; }
.btn-secondary:hover{ background:#eee; }


/* 更多功能內的行排列：左文右鈕 */
.more-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; margin:10px 0;
}

/* 標題更緊實一些，像原版 */
#moreModal .modal-content h3{
  margin:.2rem 0 .6rem; font-size:1.1rem;
}

/* 藍色大按鈕：登出 */
.logout-btn{
  width:100%;
  height:46px;
  background:#00aaff;          /* 主藍 */
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,170,255,.28);
}
.logout-btn:hover{ background:#0791e6; }
.logout-btn:active{ transform: translateY(1px); }



/* 標題間距（看起來跟原版一樣緊實） */
#moreModal .modal-content h3{ margin:.2rem 0 .6rem; font-size:1.1rem; }



    /* 今日徽章（右上角輕量） */
    #today-badge{
      position:fixed; top:14px; right:12px; z-index:90;
      padding:4px 8px; border-radius:6px; background:rgba(255,255,255,.4); backdrop-filter:blur(6px);
      color:rgba(50,50,50,.85); font-size:14px; font-weight:500; letter-spacing:.3px; pointer-events:none;
    }

    /* 區塊/卡片 */
.section{
  background:#fff; border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.04);
  padding:1rem; margin-bottom:1rem;
}
.section-title{ font-size:1.2rem; font-weight:bold; margin-bottom:.5rem; }
.task{
  display:flex; justify-content:space-between; align-items:center;
  background:var(--yellow-light);
  padding:.75rem 1rem; border-radius:8px; margin-bottom:.5rem; cursor:pointer;
  position:relative; overflow:hidden; touch-action:pan-y;
}
.task-content{ flex:1; }
.task-title{ font-size:1.2rem; font-weight:600; }

    .task .task-preview{ font-size:.9rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* 進度條（滑動）— 只保留左側刪除 */
    .swipe-bar{ position:absolute; top:0; bottom:0; width:0%; display:flex; align-items:center; pointer-events:none; transition:width .18s; }
    .swipe-bar.left{ right:0; justify-content:flex-end; background:#ffe4e6; color:#5c2020; }
    .swipe-bar .label{ font-weight:800; opacity:0; transition:opacity .12s, transform .12s; transform:translateX(6px); margin:0 12px; }

    /* FAB */
  .fab{
  position: fixed; bottom: 24px; right: 24px;
  width: 48px; height: 48px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  background: rgba(0,170,255,.85) !important;
  color:#fff; font-size:28px; font-weight:700;
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
  cursor:pointer; z-index:110;
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease, background-color .2s ease;
}
.fab:hover{ background: rgba(0,170,255,.95) !important; }
.fab:active{ transform: scale(.98); }
.fab.open{ transform: rotate(45deg); }

/* 玻璃卡選單 */
.menu{
  position: fixed; bottom: 88px; right: 24px;
  min-width: 100px; padding: 8px;
  border-radius: 14px;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(180, 210, 255, .35);
  box-shadow: 0 12px 28px rgba(0, 60, 130, .12);
  display: block;               /* 用透明控制顯示 */
  opacity: 0; transform: translateY(8px) scale(.98);
  pointer-events: none;
  z-index: 105;
}
.menu.show{
  opacity: 1; transform: translateY(0) scale(1);
  pointer-events: auto;
  transition: opacity .18s ease, transform .18s ease;
}
.menu button{
  display:flex; align-items:center; gap:.5rem;
  width:100%;
  background: transparent;
  border: 0;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 15px; font-weight: 600;
  color: #176dff;                 /* 淺藍系主色 */
  letter-spacing:.2px;
  cursor:pointer;
}
.menu button:hover{
  background: linear-gradient(0deg,#eef6ff,#f7fbff);
}
.menu button:active{
  transform: translateY(1px);
}
.menu button + button{ margin-top: 4px; }
.menu::after{
  content:"";
  position:absolute;
  right: 12px; bottom: -6px;
  width: 12px; height:12px;
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(180,210,255,.35);
  border-top: none; border-left: none;
  transform: rotate(45deg);
  box-shadow: 4px 4px 10px rgba(0,60,130,.06);
}


    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:200; }
    .modal-content{ width:90%; max-width:420px; background:#fff; border-radius:12px; padding:14px; position:relative; }
    .close-btn{ position:absolute; right:12px; top:12px; width:28px; height:28px; border:0; border-radius:50%; background:#eee; cursor:pointer; }

    .modal-content label{ display:block; margin-top:.5rem; font-size:.95rem; }
    .modal-content input:not([type="checkbox"]), .modal-content select, .modal-content textarea{
      width:100%; padding:.5rem; border:1px solid #ccc; border-radius:6px; margin-top:.25rem; font-size:16px;
    }
    .inline-row{ display:flex; align-items:center; gap:.75rem; margin-top:.25rem; }
    .half{ width:50%; min-width:160px; }
    .important-flag{ display:inline-flex; align-items:center; gap:.35rem; white-space:nowrap; }

.save-btn{ width:100%; padding:.6rem; border:0; border-radius:6px; background:#77d4bc; color:#fff; cursor:pointer; font-weight:900; margin-top:1rem; font-size:16px}
    .row-btns{ display:flex; gap:.5rem; margin-top:.5rem; }
    .btn-half{ flex:1; padding:.6rem; border:0; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn-save{ background:#e8faf3; color:#176d59; border:1px solid #ccefe2; }
    .btn-del{ background:#fff3f3; color:#b23b3b; border:1px solid #ffd8d8; }

    /* Login */
    #loginPage{ display:flex; min-height:100vh; align-items:center; justify-content:center; background:#ebf5fc; }
    #loginCard{ background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); padding:24px; width:95%; max-width:450px; }
    .login-input{ width:100%; height:44px; padding:0 12px; border:1px solid #ccc; border-radius:8px; font-size:16px; margin:.6rem 0 1rem; }
    .login-btn{ width:100%; height:46px; background:#00aaff; color:#fff; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .login-btn:hover{ background:#0791e6; }


    /* 金屬背景特效 */
    body.bg-metal::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.15)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 .5px, rgba(0,0,0,.05) .5px 1px),
        repeating-linear-gradient(0deg, rgba(0,0,0,.015) 0 2px, rgba(255,255,255,.015) 2px 3px);
      background-blend-mode:screen,normal,normal;
      background-size:100% 100%, 2000px 100%, 100% 240px;
      background-repeat:no-repeat, no-repeat, repeat;
      filter:contrast(104%) saturate(96%);
    }

    /* 展開閱讀面板（含復原/重做/複製） */
    #detailViewer{ display:none; }
    #detailViewer.show{ display:block; }
    #detailForm.hide{ display:none; }
    .viewer-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .viewer-title{ font-weight:700; }
    .viewer-close{ border:1px solid #ddd; background:#f7f7f7; border-radius:6px; padding:.35rem .6rem; cursor:pointer; }
    .viewer-toolbar{ display:flex; gap:.4rem; margin:.1rem 0 .4rem; }
    .vt-btn{ border:1px solid #ddd; background:#f8f8f8; border-radius:6px; padding:.3rem .5rem; font-size:1rem; cursor:pointer; }
    .viewer-body{ width:100%; min-height:50vh; padding:.75rem; border:1px solid #eee; border-radius:8px; background:#fafafa; line-height:1.6; font-size:.95rem; resize:vertical; }

/* === 編輯模式：標題行可放把手/鉛筆/刪除，X 固定在最右 === */
.section.edit-mode .rename-btn,
.section.edit-mode .delete-btn { display: inline-flex !important; }

.section-title{
  position: relative;  /* 讓右上角 X 可以絕對定位 */
  display: flex;
  align-items: center;
  gap: .5rem;
}

/* 把手 */
.drag-handle{ cursor: grab; color:#888; }

/* 鉛筆：跟在文字後（不要絕對定位） */
.rename-btn{
  position: static;
  border: 0;
  background: transparent;
  color: #999;
  cursor: pointer;
}

/* X 在最右上角 */
.delete-btn{
  position: absolute;
  top: 0;
  right: 0;
  border: 0;
  background: transparent;
  color: #999;
  cursor: pointer;
  display: none; /* 只在 edit-mode 顯示 */
}

/* 讓分類區可被輕觸回饋 */
#section-container {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
  touch-action: pan-y; /* 允許上下捲動 */
}

/* 點壓中的微縮效果 */
.section.__pressed { 
  transform: scale(0.985); 
  transition: transform 120ms ease;
}

/* 點一下的小彈跳效果 */
@keyframes __bump {
  0%   { transform: scale(1); }
  50%  { transform: scale(0.985); }
  100% { transform: scale(1); }
}
.section.__bump { animation: __bump .18s ease; }


#loadingScreen{
  position:fixed; inset:0; z-index:9999;
  display:none; align-items:center; justify-content:center;
  background:var(--app-bg);
}
#loadingScreen .loading-wrap{
  display:flex; flex-direction:column; align-items:center; gap:10px;
  padding:16px 20px; border-radius:12px;
  background:rgba(255,255,255,.7); backdrop-filter:blur(8px);
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}
.loading-spinner{
  width:28px; height:28px; border-radius:50%;
  border:3px solid rgba(0,0,0,.15);
  border-top-color: rgba(0,0,0,.5);
  animation: spin 0.9s linear infinite;
}
.loading-text{ color:#444; font-weight:600; letter-spacing:.2px; }
@keyframes spin{ to{ transform: rotate(360deg); } }

  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <div id="loginCard">
      <h1 style="justify-content:center;gap:10px;">
        <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="transform:translateY(2px);" />
        MyMemo
      </h1>
      <label>自訂帳號</label>
      <input type="text" id="login-username" class="login-input" placeholder="請輸入帳號" />
      <label>自訂密碼</label>
      <input type="password" id="login-password" class="login-input" placeholder="請輸入密碼" />
      <label style="display:flex;align-items:center;gap:.4rem;">
        <input type="checkbox" id="auto-login" /> <span>自動登入</span>
      </label>
      <button id="login-btn" class="login-btn">登入</button>
      <p style="margin-top:12px;color:#cc4444;text-align:center;font-size:.9rem;">平台免註冊，自訂帳號密碼即可登錄</p>
    </div>
  </div>

  <!-- App -->
  <div class="container" id="app">
    <div class="more-btn" onclick="openModal('moreModal')">⋯</div>
    <div id="today-badge"></div>

<div style="text-align:center;">
  <h1 onclick="location.href='index.html'" style="cursor:pointer;">
    <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="transform:translateY(2px);" />
    MyMemo
  </h1>
</div>


    <div id="section-container"></div>

    <div class="fab" onclick="toggleMenu()">＋</div>
<div class="menu" id="menu">
  <button onclick="openModal('memoModal')" 
          style="background:#e6f6fc; color:#0091cc; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
                 margin-bottom:12px;">
    新增備忘
  </button>

  <button onclick="openCategoryModal()" 
          style="background:#e9f9f1; color:#1fa87a; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
                 margin-bottom:12px;">
    新增分類
  </button>

  <button onclick="enterEditMode()" 
          style="background:#fff6e6; color:#d98a00; font-weight:600; 
                 padding:8px 16px; border:none; border-radius:8px; 
                 box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;">
    編輯分類
  </button>
</div>
<!-- ✅ 編輯完成（置中懸浮） -->
<button id="exitEditBtn" onclick="exitEditMode()" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #e3ffe8;
  color: #176d59;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  z-index: 120;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
">✅</button>


  </div>

  <!-- 新增備忘 -->
  <div class="modal" id="memoModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('memoModal')">✕</button>
      <h3>新增備忘</h3>

      <label>備忘分類</label>
      <div class="inline-row">
        <select id="memoSection" class="half"></select>
        <label class="important-flag"><input type="checkbox" id="memoImportant"> 重要</label>
      </div>

      <label>備忘標題（必填）</label>
      <input type="text" id="memoTitle" />

      <label>備忘內容</label>
      <textarea id="memoContent"></textarea>

      <button class="save-btn" onclick="addMemo()">新增</button>
    </div>
  </div>

  <!-- 詳情 -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('detailModal')">✕</button>
      <h3 style="display:flex;align-items:center;gap:.5rem;">
        <span>備忘內容</span>
        <small id="detailLastUpdate" style="font-size:.9rem;color:#666;white-space:nowrap;"></small>
      </h3>

      <!-- 表單 -->
      <div id="detailForm">
        <label>備忘分類</label>
        <div class="inline-row">
          <select id="detailSection" class="half"></select>
          <label class="important-flag"><input type="checkbox" id="detailImportant"> 重要</label>
        </div>

        <label>備忘標題</label>
        <input type="text" id="detailTitle" />

        <label style="display:flex;align-items:center;">
          備忘內容
          <button type="button" class="expand-icon" onclick="toggleDetailExpand('detailContent','備忘內容')" title="展開"
                  style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-left:.4rem;border-radius:4px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer;font-size:12px;color:#555;">⤢</button>
        </label>
        <textarea id="detailContent"></textarea>

        <div class="row-btns">
          <button class="btn-half btn-save" onclick="saveMemo()">💾 儲存</button>
          <button class="btn-half btn-del" onclick="confirmDelete()">🗑️ 移除</button>
        </div>
      </div>

      <!-- 展開閱讀/編輯器 -->
      <div id="detailViewer">
        <div class="viewer-head">
          <div class="viewer-title" id="viewerTitle"></div>
          <button type="button" class="viewer-close" onclick="toggleDetailExpand()">⤢</button>
        </div>
        <div class="viewer-toolbar">
          <button class="vt-btn" title="還原" onclick="viewerUndo()">⤺</button>
          <button class="vt-btn" title="復原" onclick="viewerRedo()">⤻</button>
          <button class="vt-btn" title="複製" onclick="viewerCopy()">⧉</button>
        </div>
        <textarea class="viewer-body" id="viewerBody"></textarea>
      </div>
    </div>
  </div>

  <!-- 刪除確認 -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 style="text-align:center;">確定要刪除這則備忘？</h3>
      <div style="display:flex;gap:.75rem;margin-top:1rem;">
        <button class="btn-half btn-del" onclick="deleteMemo()">確認</button>
        <button class="btn-half btn-save" onclick="closeModal('confirmModal')">取消</button>
      </div>
    </div>
  </div>

<!-- 刪除「分類」確認 -->
<div class="modal" id="confirmCategoryModal">
  <div class="modal-content">
    <h3 style="text-align:center;">確定要刪除此分類？</h3>
    <div style="display:flex;gap:.75rem;margin-top:1rem;">
      <button class="btn-half btn-del" onclick="deleteCategoryConfirmed()">確認</button>
      <button class="btn-half btn-save" onclick="closeModal('confirmCategoryModal')">取消</button>
    </div>
  </div>
</div>


  <!-- 新增分類 -->
  <div class="modal" id="categoryModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('categoryModal')">✕</button>
      <h3>新增分類</h3>
      <input type="text" id="newCategoryName" placeholder="請輸入分類名稱" />
      <button class="save-btn" onclick="addCategory()">新增分類</button>
    </div>
  </div>

  <!-- 更名分類 -->
  <div class="modal" id="renameModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('renameModal')">✕</button>
      <h3>重命名分類</h3>
      <input type="text" id="renameInput" placeholder="新的分類名稱" />
      <button class="save-btn" onclick="confirmRename()">確定</button>
    </div>
  </div>

<!-- ⋯（只保留更換底色與登出） -->
<!-- 更多功能 Modal（原版樣式） -->
<div class="modal" id="moreModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('moreModal')">✕</button>
    <h3>更多功能</h3>

    <div class="more-row" style="flex-direction:column; align-items:flex-start; gap:0.5rem;">
      <span style="font-weight:bold;">更換底色</span>
      <button id="openPaletteBtn" class="palette-btn">🎨 調色盤</button>
    </div>

    <hr style="margin:1rem 0;border:none;border-top:1px solid #eee;">

    <button class="logout-btn" onclick="openLogoutModal()">登出</button>
  </div>
</div>





  <!-- 調色盤 -->
  <!-- 調色盤（原版互動：確認／取消） -->
<div class="modal" id="paletteModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paletteModal')">✕</button>
    <h3>選擇底色</h3>

    <div class="palette-grid">
      <div class="palette-choice" data-color="#f6fbfe"></div>
      <div class="palette-choice" data-color="#f3fcf8"></div>
      <div class="palette-choice" data-color="#fffcf3"></div>
      <div class="palette-choice" data-color="#fef6f9"></div>
      <div class="palette-choice" data-color="#f9f8fd"></div>
      <div class="palette-choice" data-color="#ffeded"></div>
      <div class="palette-choice" data-color="#fff8f5"></div>
      <div class="palette-choice" data-color="#fdfcf9"></div>
      <div class="palette-choice" data-color="metal"><div class="metal-sheen"></div></div>
    </div>

    <div class="dialog-actions">
      <button id="paletteConfirmBtn" class="btn-primary">確認</button>
      <button id="paletteCancelBtn" class="btn-secondary">取消</button>
    </div>
  </div>
</div>


  <!-- 登出確認 -->
  <div class="modal" id="logoutModal">
    <div class="modal-content">
      <h3 style="text-align:center;">確定要登出？</h3>
      <div style="display:flex;gap:.75rem;margin-top:1rem;">
        <button class="btn-half btn-del" onclick="doLogout()">確認</button>
        <button class="btn-half btn-save" onclick="closeModal('logoutModal')">取消</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== 基本設定 ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
      authDomain: "kjreminder-24d74.firebaseapp.com",
      projectId: "kjreminder-24d74",
      storageBucket: "kjreminder-24d74.firebasestorage.app",
      messagingSenderId: "176371952161",
      appId: "1:176371952161:web:948121be209cd2e4181160",
      databaseURL: "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    /* ===== 狀態 ===== */
    let roomPath = "";                  // rooms/{user}-{pass}
    let memos = [];                     // 進行中的備忘
    let categories = [];                // 分類
    let categoriesLoaded = false;
    let selectedMemoId = null;
    let memosRef = null, categoriesRef = null;
    let sectionSortable = null;

    let memoMonthFilter = 'all';   // 'all' | 'recent5' | '11407'（ROC 年月）
    
function buildMemoMonthMenu(){
  const menu = document.getElementById('memoMonthMenu');
  if (!menu) return;
  menu.innerHTML = '';

  const mkBtn = (label, onClick, bold=false) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;' + (bold?'font-weight:600;':'');
    btn.onclick = ()=>{ onClick(); menu.style.display='none'; };
    return btn;
  };

  // 全部
  menu.appendChild(mkBtn('全部', ()=>{
    memoMonthFilter = 'all';
    renderAll();
  }, true));

  // 近5日
  menu.appendChild(mkBtn('近5日', ()=>{
    memoMonthFilter = 'recent5';
    renderAll();
  }));

  // 近30日
  menu.appendChild(mkBtn('近30日', ()=>{
    memoMonthFilter = 'recent30';
    renderAll();
  }));

  // 重要❗
  menu.appendChild(mkBtn('重要 ❗', ()=>{
    memoMonthFilter = 'important';
    renderAll();
  }));

  // 月份（以最後更新時間為主，沒有更新就用建立時間）
  const monthSet = new Set();
  (memos || []).forEach(m=>{
    const ts = getMemoRefTime(m);            // 你上一版已加：return m.updatedAt || m.createdAt || null;
    const ym = toRocYMFromTs(ts);            // 你上一版已加：把時間戳轉成 ROC 年月字串
    if (ym !== '無') monthSet.add(ym);
  });

  if (monthSet.size === 0){
    const empty = document.createElement('div');
    empty.textContent = '無更多月份';
    empty.style.cssText = 'padding:6px 8px; color:#666;';
    menu.appendChild(empty);
    return;
  }

  Array.from(monthSet).sort((a,b)=>b.localeCompare(a)).forEach(ym=>{
    menu.appendChild(mkBtn(ym, ()=>{
      memoMonthFilter = ym;
      renderAll();
    }));
  });
}


    /* ===== 小工具 ===== */
    function sanitizeKey(s){ return String(s || '').replace(/[.#$/\[\]\/]/g,'_'); }
    function hydrateRoomPath(){
      try{
        const saved = localStorage.getItem('todo_room_info');
        if (!saved) return;
        const { username, password } = JSON.parse(saved);
        roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
      }catch(_){}
    }
    function openModal(id){ document.getElementById(id).style.display = 'flex'; }
    function closeModal(id){ document.getElementById(id).style.display = 'none'; }
    function toggleMenu(){
      const m = document.getElementById('menu');
      m.classList.toggle('show');
    }
    document.addEventListener('click', (e)=>{
      const menu = document.getElementById('menu');
      if (menu.classList.contains('show')){
        const inside = menu.contains(e.target);
        const onFab  = document.querySelector('.fab').contains(e.target);
        if (!inside && !onFab) menu.classList.remove('show');
      }
    });

    /* ===== Login ===== */
    function setLoginBusy(b){ const btn = document.getElementById('login-btn'); btn.disabled = b; btn.textContent = b ? '登入中…' : '登入'; }
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  auth.onAuthStateChanged(async (user)=>{
  hydrateRoomPath();

  if (roomPath) {
    if (user) {
      // 直接進 App
      showView('app');
      bindFirebase();
    } else {
      // 還沒登入 → 顯示「切換中…」並嘗試匿名登入
      showView('loading');
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInAnonymously(); // 成功會再進到上面分支
      } catch (e) {
        console.warn('Anonymous sign-in failed:', e);
        showView('login'); // 失敗才顯示登入頁
      }
    }
  } else {
    // 沒有 roomPath（沒有存帳密）→ 顯示登入
    showView('login');
    unbindFirebase();
  }
});


document.getElementById('login-btn').addEventListener('click', async ()=>{
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value.trim();
  const auto = document.getElementById('auto-login').checked;
  if (!u || !p) { alert('請輸入帳號與密碼'); return; }

  setLoginBusy(true);
  try {
    const info = { username: u, password: p };
    if (auto) localStorage.setItem('todo_room_info', JSON.stringify(info));
    else      localStorage.removeItem('todo_room_info');

    roomPath = `rooms/${sanitizeKey(u)}-${sanitizeKey(p)}`;

    if (auth.currentUser) {
      // 已有會話：直接綁資料並進入 App
      showView('loading');           // 小過場
      bindFirebase();
      showView('app');
    } else {
      // 沒會話：顯示 loading，做一次匿名登入
      showView('loading');
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInAnonymously(); // 成功後 onAuthStateChanged 會帶你進 App
    }
  } catch (e) {
    alert('登入失敗：' + (e?.message || e));
    showView('login');
  } finally {
    setLoginBusy(false);
  }
});



    function doLogout(){
      try{ if (memosRef) memosRef.off(); if (categoriesRef) categoriesRef.off(); }catch(_){}
      memos = []; categories = []; selectedMemoId = null;
      try{ localStorage.removeItem('todo_room_info'); }catch(_){}
      roomPath = "";
      try{ auth.signOut(); }catch(_){}
      closeModal('logoutModal'); closeModal('moreModal');
      document.getElementById('app').style.display='none';
      document.getElementById('loginPage').style.display='flex';
    }

    /* ===== Firebase 綁定 ===== */
    function bindFirebase(){
      unbindFirebase();
      memosRef = db.ref(`${roomPath}/memos`);
      categoriesRef = db.ref(`${roomPath}/memoCategories`);

      memosRef.on('value', (snap)=>{
        const data = snap.val() || {};
        memos = Object.values(data);
        renderAll();
      });

      categoriesRef.on('value', (snap)=>{
        const cloud = snap.val();
        if (cloud === null) {
          categories = [];
          saveCategories();
        } else if (Array.isArray(cloud)) {
          categories = cloud.slice();
        } else if (cloud && typeof cloud === 'object') {
          categories = Object.values(cloud);
        } else {
          categories = [];
        }
        categoriesLoaded = true;
        renderSections(categories);
        renderAll();
      });
    }
    function unbindFirebase(){ try{ memosRef && memosRef.off(); categoriesRef && categoriesRef.off(); }catch(_){} }
    function saveMemos(){
      const obj = {}; memos.forEach(m=>obj[m.id]=m);
      db.ref(`${roomPath}/memos`).set(obj);
    }
    function saveCategories(){ db.ref(`${roomPath}/memoCategories`).set(categories); }

    /* ===== UI：今日徽章 ===== */
    (function(){
      const el = document.getElementById('today-badge');
      const WEEK = ['日','一','二','三','四','五','六'];
      function draw(){
        const now=new Date();
        el.textContent = `${now.getMonth()+1}/${now.getDate()}（${WEEK[now.getDay()]}）`;
      }
      draw();
      const t = new Date(); const mid = new Date(t); mid.setHours(24,0,0,0);
      setTimeout(()=>{ draw(); setInterval(draw,24*3600*1000); }, mid - t);
    })();

    /* ===== 分類區 ===== */
function renderSections(list){
  const wrap = document.getElementById('section-container');

  // 先畫出「更多…」 + 下拉清單
  wrap.innerHTML = `
    <div id="memoMore" style="text-align:right; margin:0.25rem 0; position:relative;">
      <button id="memoMoreBtn"
              style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">
        更多…
      </button>
      <div id="memoMonthMenu"
           style="display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd;
                  border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;">
      </div>
    </div>
  `;

  // 依分類畫區塊
  list.forEach(name=>{
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.id = name;
    sec.innerHTML = `<div class="section-title">${name}</div>`;
    wrap.appendChild(sec);
  });

  updateSectionOptions();
  initSectionSortable?.();

  // 重新掛「更多…」按鈕
  document.getElementById('memoMoreBtn')?.addEventListener('click', ()=>{
    const menu = document.getElementById('memoMonthMenu');
    if (!menu) return;
    menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
  });

  // 依目前 memos 建一次月份清單
  buildMemoMonthMenu();
}
    function updateSectionOptions(){
      const opts = (categories||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
      const s1=document.getElementById('memoSection'), s2=document.getElementById('detailSection');
      if (s1) s1.innerHTML = opts;
      if (s2) s2.innerHTML = opts;
    }
    function initSectionSortable(){
      const el = document.getElementById('section-container');
      if (!el) return;
      if (sectionSortable && sectionSortable.destroy) sectionSortable.destroy();
      sectionSortable = new Sortable(el, {
        animation:150, handle:'.drag-handle', draggable:'.section', ghostClass:'dragging',
        onEnd: ()=>{
          categories = Array.from(document.querySelectorAll('#section-container .section')).map(sec=>sec.id);
          saveCategories();
        }
      });
    }

    /* ===== 分類：新增/編輯/刪除/更名 ===== */
    function openCategoryModal(){ document.getElementById('newCategoryName').value=''; openModal('categoryModal'); }
    function addCategory(){
      const name = document.getElementById('newCategoryName').value.trim();
      if (!name) return;
      if (categories.includes(name)) return alert('此分類已存在');
      categories.push(name); saveCategories(); renderSections(categories);
      closeModal('categoryModal');
    }
    let pendingRenameId = null;
    function enterEditMode(){
  isEditing = true;

  // 每個區塊套上編輯配件
  document.querySelectorAll('.section').forEach(sec=>{
    sec.classList.add('edit-mode');

    const bar = sec.querySelector('.section-title');
    const name = sec.id;

    // 重畫標題列：☰ 名稱 ✎（X 交給 CSS 放右上角）
    bar.innerHTML = `
      <span class="drag-handle">☰</span>
      <span class="section-name">${name}</span>
      <button class="rename-btn" title="重命名">✎</button>
      <button class="delete-btn" title="刪除此分類">✕</button>
    `;

    bar.querySelector('.rename-btn').onclick = ()=>{
      pendingRenameId = sec.id;
      document.getElementById('renameInput').value = sec.id;
      openModal('renameModal');
    };
    bar.querySelector('.delete-btn').onclick = ()=> confirmDeleteCategory(sec.id);
  });

  // 重新啟用拖拉
  initSectionSortable();

  // 顯示底部 ✅ 鈕
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'block';
}

function exitEditMode(){
  isEditing = false;

  // 還原標題列成只有名稱
  document.querySelectorAll('.section').forEach(sec=>{
    sec.classList.remove('edit-mode');
    const bar = sec.querySelector('.section-title');
    bar.textContent = sec.id;
  });

  // 關閉底部 ✅ 鈕
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'none';

  // 保險：銷毀並重建拖拉
  if (sectionSortable && sectionSortable.destroy){
    sectionSortable.destroy();
    sectionSortable = null;
  }
  initSectionSortable();

  // 更新下拉
  updateSectionOptions();
}

    function confirmDeleteCategory(id){
  pendingCategoryId = id;
  openModal('confirmCategoryModal'); // 打開自訂視窗
}

function deleteCategoryConfirmed(){
  if (!pendingCategoryId) { closeModal('confirmCategoryModal'); return; }

  const id = pendingCategoryId;
  const fallback = categories.find(c => c !== "其它" && c !== id) || "其它";

  // 把該分類下的 memo 移到 fallback
  memos.forEach(m => { if (m.section === id) m.section = fallback; });

  // 刪掉分類
  categories = categories.filter(c => c !== id);

  // 存雲＋重畫
  saveMemos();
  saveCategories();
  renderSections(categories);
  renderAll();

  // 收尾
  pendingCategoryId = null;
  closeModal('confirmCategoryModal');
}

    function confirmRename(){
      const oldId = pendingRenameId;
      const newName = document.getElementById('renameInput').value.trim();
      if (!newName || document.getElementById(newName)) return alert('名稱不可為空或已存在！');
      memos.forEach(m=>{ if (m.section===oldId) m.section=newName; });
      categories = categories.map(c=> c===oldId ? newName : c);
      saveMemos(); saveCategories(); renderSections(categories); renderAll();
      pendingRenameId = null; closeModal('renameModal');
    }

    /* ===== Memo CRUD ===== */
function memoCardHTML(m){
  return `
    <div class="swipe-bar left"><span class="label">🗑 移除</span></div>
    <div class="task-content">
      <div class="task-title">${m.important ? '❗ ' : ''}${m.title || ''}</div>
    </div>
  `;
}


function renderAll(){
  // 清空每個分類的 memo 卡
  document.querySelectorAll('.section').forEach(sec=>{
    Array.from(sec.querySelectorAll('.task')).forEach(t=>t.remove());
  });

  // 依選擇篩選（all 不過濾 / important 只看旗標 / 其他看時間或月份）
  const filtered = (memos||[]).filter(m=>{
    if (memoMonthFilter === 'all') return true;            // 全部
    if (memoMonthFilter === 'important') return !!m.important;

    const ts = getMemoRefTime(m);                          // 以「最後更新日（無則建立日）」為基準
    if (!ts) return false;

    if (memoMonthFilter === 'recent5'){
      const diffDays = Math.floor((Date.now() - ts) / 86400000);
      return diffDays <= 5;
    }
    if (memoMonthFilter === 'recent30'){
      const diffDays = Math.floor((Date.now() - ts) / 86400000);
      return diffDays <= 30;
    }
    // 指定月份（ROC 年月）
    return toRocYMFromTs(ts) === memoMonthFilter;
  });

  // 畫卡片
  filtered.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'task';
    el.dataset.id = m.id;
    el.innerHTML = memoCardHTML(m);
    const sec = document.getElementById(m.section);
    (sec || document.getElementById(categories[0]))?.appendChild(el);
  });

  bindSwipeToTasks?.();
  updateSectionOptions?.();

  // ★ 非「全部」時，把沒有任何符合卡片的分類隱藏起來
  if (memoMonthFilter === 'all') {
    document.querySelectorAll('#section-container .section')
      .forEach(sec => sec.style.display = '');
  } else {
    hideEmptySectionsAfterFilter();
  }

  // 清單同步（防新增/編輯後月份變動）
  buildMemoMonthMenu();
}


function getMemoRefTime(m){ return m?.updatedAt || m?.createdAt || null; }
function toRocYMFromTs(ts){
  if (!ts) return '無';
  const d = new Date(ts);
  if (isNaN(d)) return '無';
  const yy = d.getFullYear() - 1911;
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yy}${mm}`;
}

function hideEmptySectionsAfterFilter(){
  document.querySelectorAll('#section-container .section').forEach(sec=>{
    const hasVisible = Array.from(sec.querySelectorAll('.task'))
      .some(el => getComputedStyle(el).display !== 'none');
    sec.style.display = hasVisible ? '' : 'none';
  });
}


    function hideEmptySections(){
      document.querySelectorAll('#section-container .section').forEach(sec=>{
        const has = sec.querySelector('.task');
        sec.style.display = has ? '' : '';
      });
    }

    function addMemo(){
      const section = document.getElementById('memoSection').value;
      const title   = document.getElementById('memoTitle').value.trim();
      const content = document.getElementById('memoContent').value;
      const important = document.getElementById('memoImportant').checked;
      if (!title) return;

      const id = 'memo-' + Date.now();
      const now = Date.now();
      const memo = { id, section, title, content, important, createdAt: now, updatedAt: now };

      memos.push(memo); saveMemos(); renderAll();
      document.getElementById('memoTitle').value='';
      document.getElementById('memoContent').value='';
      document.getElementById('memoImportant').checked=false;
      closeModal('memoModal');
    }

    function openDetail(id){
      selectedMemoId = id;
      const m = memos.find(x=>x.id===id); if (!m) return;

      document.getElementById('detailSection').value = m.section;
      document.getElementById('detailTitle').value   = m.title;
      document.getElementById('detailContent').value = m.content || '';
      document.getElementById('detailImportant').checked = !!m.important;

      const lbl = document.getElementById('detailLastUpdate');
      lbl.textContent = m.updatedAt ? ('更新：' + formatRocDateTime(m.updatedAt)) : '';

      resetDetailPanels();
      document.getElementById('detailModal').style.display='flex';
    }

    function saveMemo(){
      if (!selectedMemoId) return;
      const m = memos.find(x=>x.id===selectedMemoId); if (!m) return;

      m.section   = document.getElementById('detailSection').value;
      m.title     = document.getElementById('detailTitle').value;
      m.content   = document.getElementById('detailContent').value;
      m.important = document.getElementById('detailImportant').checked;
      m.updatedAt = Date.now();

      saveMemos(); renderAll(); closeModal('detailModal');
    }

    function confirmDelete(){ openModal('confirmModal'); }
    function deleteMemo(){
      if (!selectedMemoId) return;
      const idx = memos.findIndex(x=>x.id===selectedMemoId);
      if (idx>=0) memos.splice(idx,1);
      saveMemos(); renderAll();
      closeModal('confirmModal'); closeModal('detailModal');
    }

    /* ===== Swipe（只保留左滑刪除；右滑完成禁用） ===== */
    function bindSwipeToTasks(){
      document.querySelectorAll('.task').forEach(task=>{
        if (task.dataset.swipeBound==='1') return;
        task.dataset.swipeBound='1';
        task.onclick = null;

        const barL = task.querySelector('.swipe-bar.left');
        const labL = barL?.querySelector('.label');

        let sx=0, sy=0, dx=0, dy=0, width=0, isDown=false, activeId=null, mode='pending';
        const H_START=16, V_CANCEL=10, DOMINANCE=1.3, BOUND=0.75, MAX_TILT=3;

        task.addEventListener('pointerdown', onDown);
        task.addEventListener('pointermove', onMove);
        task.addEventListener('pointerup', onUp);
        task.addEventListener('pointercancel', onCancel);
        task.addEventListener('lostpointercapture', onCancel);

        // 吞 click，自己判定「點一下」
        task.addEventListener('click', (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); }, true);

        function onDown(e){
          if (e.target.closest('button,input,select,textarea')) return;
          isDown=true; activeId=e.pointerId; sx=e.clientX; sy=e.clientY; dx=dy=0; width = task.offsetWidth||1; mode='pending';
          task.style.transition='none'; try{ task.setPointerCapture(e.pointerId); }catch(_){}
        }
        function onMove(e){
          if (!isDown || e.pointerId!==activeId) return;
          if (mode==='scroll') return;
          dx = e.clientX - sx; dy = e.clientY - sy;
          // 垂直為主 → 捲動
          if (mode==='pending'){
            const adx=Math.abs(dx), ady=Math.abs(dy);
            if (ady>V_CANCEL && ady>adx*1.2){ mode='scroll'; resetBars(); task.style.transform=''; return; }
            if (adx<H_START) return;
            if (adx>ady*DOMINANCE){ mode='swipe'; } else { mode='scroll'; return; }
          }
          if (mode!=='swipe') return;

          // 只處理左滑（刪除）
          const adx=Math.abs(dx); const pct=Math.min(1, adx/width); const tilt=(dx/width)*MAX_TILT;
          task.style.transform = `translateX(${Math.round(dx)}px) rotate(${tilt}deg)`;
          if (dx<0){
            barL.style.width = (pct*100)+'%';
            labL.style.opacity = Math.min(1, pct*1.2);
            labL.style.transform = `translateX(${pct>0.05?0:6}px)`;
          }else{
            resetBars(); // 右滑不啟用
          }
        }
        function onUp(e){ finish(false); }
        function onCancel(e){ finish(true); }
        function finish(cancel){
          const tapLike = Math.abs(dx)<4 && Math.abs(dy)<4 && mode!=='scroll';
          const wasSwipe = (mode==='swipe'); mode='pending'; isDown=false; activeId=null;
          task.style.transition='transform .18s'; task.style.transform=''; resetBars();

          if (!wasSwipe && !cancel && tapLike){ openDetail(task.dataset.id); cleanup(); return; }

          if (!wasSwipe || cancel){ cleanup(); return; }
          const passed = Math.abs(dx) >= width*BOUND;
          if (passed && dx<0){ selectedMemoId = task.dataset.id; setTimeout(()=>confirmDelete(),10); }
          cleanup();
        }
        function cleanup(){ dx=dy=0; try{ task.releasePointerCapture?.(activeId); }catch(_){ } }
        function resetBars(){ if (barL){ barL.style.width='0%'; labL.style.opacity=0; labL.style.transform='translateX(6px)'; } }
      });
    }

    /* ===== 展開閱讀面板（undo/redo/copy） ===== */
    let __expandedFieldId = null, __viewerHistory=[], __viewerRedoStack=[];
    function toggleDetailExpand(fieldId, title){
      const form = document.getElementById('detailForm');
      const viewer = document.getElementById('detailViewer');
      const vTitle = document.getElementById('viewerTitle');
      const vBody  = document.getElementById('viewerBody');

      // 移除舊監聽
      if (__expandedFieldId){
        const prev = document.getElementById(__expandedFieldId);
        if (prev?.__viewerSync){ prev.removeEventListener('input', prev.__viewerSync); prev.__viewerSync=null; }
        if (vBody?.__formSync){ vBody.removeEventListener('input', vBody.__formSync); vBody.__formSync=null; }
        if (vBody?.__histHandler){ vBody.removeEventListener('input', vBody.__histHandler); vBody.__histHandler=null; }
      }

      const willCollapse = (__expandedFieldId && (!fieldId || fieldId===__expandedFieldId));
      if (willCollapse){
        form.classList.remove('hide'); viewer.classList.remove('show'); __expandedFieldId=null; return;
      }

      const src = document.getElementById(fieldId);
      vTitle.textContent = title || '';
      vBody.value = src ? (src.value||'') : '';
      viewer.classList.add('show'); form.classList.add('hide'); __expandedFieldId = fieldId;

      if (src){
        src.__viewerSync = ()=>{ vBody.value = src.value || ''; };
        src.addEventListener('input', src.__viewerSync);

        vBody.__formSync = ()=>{ src.value = vBody.value || ''; };
        vBody.addEventListener('input', vBody.__formSync);
      }

      __viewerHistory=[vBody.value||'']; __viewerRedoStack=[];
      if (vBody.__histHandler) vBody.removeEventListener('input', vBody.__histHandler);
      let timer=null;
      vBody.__histHandler=()=>{ clearTimeout(timer); timer=setTimeout(()=>{ pushViewerHistory(vBody.value||''); },180); };
      vBody.addEventListener('input', vBody.__histHandler);
    }
    function resetDetailPanels(){
      const form=document.getElementById('detailForm'), viewer=document.getElementById('detailViewer');
      const vBody=document.getElementById('viewerBody');
      if (vBody?.__histHandler){ vBody.removeEventListener('input', vBody.__histHandler); vBody.__histHandler=null; }
      __viewerHistory=[]; __viewerRedoStack=[];
      viewer?.classList.remove('show'); form?.classList.remove('hide');
    }
    function pushViewerHistory(v){ if (!__viewerHistory.length || __viewerHistory[__viewerHistory.length-1]!==v){ __viewerHistory.push(v); if (__viewerHistory.length>100) __viewerHistory.shift(); } __viewerRedoStack=[]; }
    function viewerUndo(){ const v=document.getElementById('viewerBody'); if (__viewerHistory.length<=1) return; const cur=__viewerHistory.pop(); __viewerRedoStack.push(cur); v.value = __viewerHistory[__viewerHistory.length-1]; if (v.__formSync) v.__formSync(); }
    function viewerRedo(){ const v=document.getElementById('viewerBody'); if (!__viewerRedoStack.length) return; const redo=__viewerRedoStack.pop(); v.value=redo; if (v.__formSync) v.__formSync(); pushViewerHistory(v.value); }
    function viewerCopy(){
      const t=document.getElementById('viewerBody').value||'';
      if (!t) return alert('沒有可複製的內容');
      (navigator.clipboard?.writeText(t)||Promise.reject()).then(()=>alert('已複製內容')).catch(()=>{
        try{ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('已複製內容'); }catch(_){ alert('複製失敗'); }
      });
    }

    /* ===== 調色盤 ===== */
    function setAppBgColor(color){
      const body=document.body;
      if (color==='metal'){ body.classList.add('bg-metal'); document.documentElement.style.setProperty('--app-bg','#ececec'); }
      else { body.classList.remove('bg-metal'); document.documentElement.style.setProperty('--app-bg', color); }
      try{ localStorage.setItem('app_bg_fixed', color); }catch(_){}
    }
    function applySavedBgColor(){ try{ const saved=localStorage.getItem('app_bg_fixed'); if (saved) setAppBgColor(saved); }catch(_){} }
    applySavedBgColor();

    document.getElementById('openPaletteBtn').addEventListener('click', ()=> openModal('paletteModal'));
    let pendingColor=null;
    document.addEventListener('click', (e)=>{
      const tile = e.target.closest('.palette-choice');
      if (!tile) return;
      const wrap = document.getElementById('paletteModal');
      wrap.querySelectorAll('.palette-choice').forEach(t=>t.classList.remove('selected'));
      tile.classList.add('selected'); pendingColor = tile.dataset.color;
    });
    document.getElementById('paletteConfirmBtn').addEventListener('click', ()=>{
      if (pendingColor) setAppBgColor(pendingColor);
      closeModal('paletteModal');
    });

    /* ===== 互動補強 ===== */
    // 點背景關閉 modal
    document.addEventListener('click', (e)=>{
      const modal = e.target.closest('.modal');
      if (!modal) return;
      if (getComputedStyle(modal).display==='none') return;
      const content = modal.querySelector('.modal-content');
      if (!content || !content.contains(e.target)) closeModal(modal.id);
    });
    // Esc 關閉
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>{ if (getComputedStyle(m).display!=='none') closeModal(m.id); }); } });

    /* ===== 其他 ===== */
    function formatRocDateTime(ts){
      if (!ts && ts!==0) return '';
      const d=new Date(ts); if (isNaN(d)) return '';
      const y=d.getFullYear()-1911, m=d.getMonth()+1, dd=d.getDate();
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mm}`;
    }

    /* ===== 初始資料 ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // 預設先畫空容器，等雲端回來再畫
      renderSections(categories);
    });

function openLogoutModal(){
  openModal('logoutModal');
}

function showView(view){
  const login = document.getElementById('loginPage');
  const app   = document.getElementById('app');
  const load  = document.getElementById('loadingScreen');

  login.style.display = (view === 'login')   ? 'flex'  : 'none';
  app.style.display   = (view === 'app')     ? 'block' : 'none';
  load.style.display  = (view === 'loading') ? 'flex'  : 'none';
}

  </script>

<!-- Loading（切換中） -->
<div id="loadingScreen" style="display:none;">
  <div class="loading-wrap">
    <div class="loading-spinner"></div>
    <div class="loading-text">切換中…</div>
  </div>
</div>

</body>
</html>
