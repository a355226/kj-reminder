<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<!-- Firebase SDK (compat ç‰ˆï¼Œæœ€ç°¡å–®æ¥) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="reminder.png">
<link rel="apple-touch-icon" sizes="180x180" href="reminder.png">
<link rel="manifest" href="manifest.json">

  <title>MyTask</title>
  <style>

/* æ—¥æœŸè¼¸å…¥æ¬„ä½ï¼šå›ºå®šé«˜åº¦ï¼ŒiOS/Android/æ¡Œæ©Ÿä¸€è‡´ */
input[type="date"] {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  font-size: 1rem;
  -webkit-appearance: none;
  flex: 1;
  min-width: 0;
  
  /* å›ºå®šé«˜åº¦ï¼Œé¿å…æœ‰ç„¡æ—¥æœŸæ™‚è·³å‹• */
  height: 38px;       /* ä½ å¯ä»¥ä¾ç¾æœ‰è¡¨å–®é«˜åº¦èª¿æ•´ï¼Œä¾‹å¦‚ 36px æˆ– 40px */
  line-height: 38px;  /* è·Ÿ height ä¸€æ¨£ï¼Œç¢ºä¿æ–‡å­—å‚ç›´ç½®ä¸­ */
}
/* å…¨åŸŸè¼¸å…¥å…ƒä»¶å­—é«”å¤§å° */
input, select, textarea, option {
  font-size: 16px;     /* æ¨è–¦æ‰‹æ©Ÿå®‰å…¨å­—é«”å¤§å°ï¼Œé¿å… iOS è‡ªå‹•æ”¾å¤§ */
  line-height: 1.4;    /* è¡Œé«˜ç¨å¾®åŠ é«˜ä¸€é»ï¼Œé–±è®€æ›´èˆ’æœ */
}
button {
  font-size: 15px;
}

    :root {
      --blue-light: #ebf5fc;
      --green-light: #e6f9f0;
      --yellow-light: #fffbe6;
      --white: #ffffff;
      --gray-text: #444;
      --urgent-color: #ffeaea;
  --app-bg: var(--blue-light);
    }
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body {
  margin: 0; padding: 1rem; background-color: var(--app-bg);
  color: var(--gray-text); display: flex; justify-content: center;
}
    .container { width: 100%; max-width: 480px; position: relative; }
h1 {
  display: inline-flex;  /* åŸæœ¬æ˜¯ flex */
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 24px;
  margin: 6px 0 10px;
  padding: 4px 10px;
  border-radius: 8px;
  transition: background-color .2s, box-shadow .2s;
}

h1:hover {
  background: rgba(0,0,0,.05);
  box-shadow: 0 0 0 2px rgba(0,0,0,.08) inset;
}
    .section {
      background-color: #ffffff; border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      padding: 1rem; margin-bottom: 1rem;
    }
    .section-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
    .task {
      display: flex; justify-content: space-between; align-items: center;
      background-color: var(--yellow-light); padding: 0.75rem 1rem;
      border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;
    }
    .task-content { flex: 1; }
    .task-title { font-size: 1.2rem;font-weight: 600; margin-bottom: 0.25rem; }
    .task-due { font-size: 0.85rem; color: #888; }
    .task-days {
      background-color: var(--yellow-light); color: brown;
      border-radius: 50%; padding: 0.4rem 0.6rem; font-size: 0.85rem;
      font-weight: bold; flex-shrink: 0; text-align: center; margin-left: 1rem;
    }
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 40px; height: 40px;
      background-color: #00aaff; color: white; border-radius: 50%; font-size: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 10;
    }
    .menu {
      position: fixed; bottom: 90px; right: 24px; background-color: white;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none; flex-direction: column; z-index: 9;
    }
    .menu button {
      border: none; background: none; padding: 12px 16px;
      font-size: 14px; text-align: left; cursor: pointer;
    }

    .modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(0, 0, 0, 0.3); display: none;
      justify-content: center; align-items: center; z-index: 20;
    }
    .modal-content {
      background-color: white; padding: 1rem; border-radius: 12px;
      width: 90%; max-width: 400px; position: relative;
    }
    .modal-content label { display: block; margin-top: 0.5rem; font-size: 0.9rem; }
/* åªçµ¦è¼¸å…¥æ¡†/ä¸‹æ‹‰/æ–‡å­—å€ï¼Œæ’é™¤ radio & checkbox */
.modal-content input:not([type="radio"]):not([type="checkbox"]),
.modal-content select,
.modal-content textarea {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.25rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}

//å„²å­˜æŒ‰éˆ•
.save-btn {
  background-color: #009973;
  color: white;
  border: none;
  padding: 0.5rem;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 0.5rem;
  width: 100%;
}
.save-btn:hover {
  background-color: #008060;
}

.modal-content > button {
  margin-top: 1rem;
  width: 100%;
  padding: 0.5rem;
  background-color: #00aaff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}


.save-btn-half, .delete-btn-half {
  flex: 1;
  padding: 0.5rem;
  border-radius: 6px;
  cursor: pointer;
  width: 50%;
  border: none;
}

.save-btn-half {
  background-color: #77d4bc;
  color: white;
}
.save-btn-half:hover {
  background-color: #008060;
}

.delete-btn-half {
  background-color: #fc9a9a;
  color: white;
}
.delete-btn-half:hover {
  background-color: #cc3333;
}

.close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 28px;
  height: 28px;
  padding: 0;
  margin: 0;
  border: none;
  border-radius: 50%;
  background-color: #eee;
  color: #333;
  font-size: 16px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.modal-content > .close-btn {
  width: auto;
}

#check-success {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  width: 100px;
  height: 100px;
  opacity: 0;
  pointer-events: none;
}

#check-success.show {
  animation: pop-in 1.5s ease forwards;
}

#check-success svg {
  width: 100px;
  height: 100px;
}

.circle {
  stroke: #a2f4c5;
  stroke-width: 4;
  stroke-dasharray: 157;
  stroke-dashoffset: 157;
  animation: draw-circle 0.5s ease-out forwards;
}

.check {
  stroke: #2ecc71;
  stroke-width: 5;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 30;
  stroke-dashoffset: 30;
  animation: draw-check 0.3s 0.5s ease-out forwards;
}

@keyframes draw-circle {
  to {
    stroke-dashoffset: 0;
  }
}

@keyframes draw-check {
  to {
    stroke-dashoffset: 0;
  }
}

@keyframes pop-in {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5);
    filter: blur(4px);
  }
  40% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.1);
    filter: blur(0);
  }
  80% {
    transform: translate(-50%, -50%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
  }
}
.confirm-buttons {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.confirm-buttons button {
  flex: 1;
  padding: 0.6rem;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.confirm-btn {
  background-color: #fc9a9a;
  color: white;
}
.confirm-btn:hover {
  background-color: #cc4444;
}

.cancel-btn {
  background-color: #f0f0f0;
  color: #333;
}
.cancel-btn:hover {
  background-color: #ddd;
}

//ç·¨è¼¯åˆ†é¡ç”¨
.section.edit-mode {
  position: relative;
  padding-left: 2.5rem;
}

.section-title {
  position: relative; /* æ–°å¢é€™ä¸€è¡Œè®“å…§éƒ¨çµ•å°å®šä½ç”Ÿæ•ˆ */
  font-size: 1.2rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.drag-handle {
  display: inline-block;
  margin-right: 0.5rem;
  font-size: 1.2rem;
  cursor: grab;
  color: #888;
  vertical-align: middle;
}


.delete-btn {
  position: absolute;
  top: 0;
  right: 0;
  background-color: transparent;
  border: none;
  font-size: 1rem;
  color: #999;
  cursor: pointer;
  display: none;
}
.section.edit-mode .delete-btn {
  display: block;
}

.section.dragging {
  opacity: 0.5;
  background-color: transparent !important;
}

.dragging {
  opacity: 0.6;
  background: #eef8ff;
}


/* é‡å‘½åæŒ‰éˆ• */
/* è®“æ¨™é¡Œæˆä¸€è¡Œæ’åˆ—ï¼šâ˜°ã€æ¨™é¡Œæ–‡å­—ã€âœï¼ˆåˆªé™¤éµä¾ç„¶åœ¨å³ä¸Šè§’çµ•å°å®šä½ï¼‰ */
.section-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* é‰›ç­†è·Ÿåœ¨æ¨™é¡Œæ–‡å­—å¾Œæ–¹ï¼ˆä¸è¦çµ•å°å®šä½ï¼‰ */
.rename-btn {
  position: static;           /* é‡è¦ï¼šå–æ¶ˆåŸæœ¬çš„ absolute */
  display: none;              /* åªæœ‰ç·¨è¼¯æ¨¡å¼æ‰é¡¯ç¤º */
  background: transparent;
  border: none;
  font-size: 1rem;
  color: #999;
  cursor: pointer;
  margin-left: 0.8rem;
transform: translateY(-2.2px); /* â¬† å¾€ä¸Š 2pxï¼Œå¯è‡ªè¡Œèª¿æ•´ */
  padding: 0;                 /* å–æ¶ˆå°æ–¹å¡Šå¤–æ¡†æ„Ÿ */
}
.section.edit-mode .rename-btn { display: inline-flex; }

/* æ›´å¤šåŠŸèƒ½ï¼ˆä¿®æ­£å¾Œï¼‰*/
/* å³ä¸Šè§’ ... æŒ‰éˆ• */
.more-btn {
  position: fixed;
  top: 12px;
  left: 12px;
  width: 32px;      /* ç¸®å°å¯¬ */
  height: 32px;     /* ç¸®å°é«˜ */
  border-radius: 50%;
  background: #fff;
  color: #555;
  font-size: 18px;  /* å­—é«”ä¹Ÿç¸®å° */
  font-weight: bold;
  display: flex;
  align-items: center;    /* å‚ç›´ç½®ä¸­ */
  justify-content: center;/* æ°´å¹³ç½®ä¸­ */
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  z-index: 100;
  line-height: 1;         /* ç¢ºä¿æ–‡å­—å‚ç›´å±…ä¸­ */
}



/* æ›´å¤šåŠŸèƒ½ Modal */
#moreModal .modal-content {
  max-width: 300px;
}
.filter-days {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: -1rem;
}
.filter-days label {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.9rem;
}

/* æ­·å²ç´€éŒ„ */
.filter-status {
  display: flex;
  gap: 1rem;    
  margin-top: -1rem;           /* å…©å€‹é¸é …ä¹‹é–“çš„è·é›¢ */
}

.filter-status label {
  display: inline-flex;    /* é—œéµï¼šè®“â—‹å’Œæ–‡å­—åœ¨åŒä¸€è¡Œ */
  align-items: center;
  gap: 0.25rem;            /* â—‹ å’Œæ–‡å­—è·é›¢ */
  white-space: nowrap;     /* ç¦æ­¢æ–‡å­—æ›è¡Œ */
}

/* å¤©æ•¸è¨­å®š */
.filter-mode {
  display: flex;
  gap: 1rem;          /* é¸é …ä¹‹é–“è·é›¢ */
  margin-top: -1rem;  /* è·Ÿä¸Šæ–¹æ¨™é¡Œçš„è·é›¢å¯ä¾éœ€æ±‚èª¿æ•´ */
}

.filter-mode label {
  display: inline-flex;     /* â—‹ å’Œæ–‡å­—åŒä¸€è¡Œ */
  align-items: center;
  gap: 0.25rem;             /* â—‹ å’Œæ–‡å­—è·é›¢ */
  white-space: nowrap;      /* ç¦æ­¢æ›è¡Œ */
}

.logout-btn{
  width:100%;
font-size:15px;
  padding:0.6rem;
  background:#f5f5f5;
  color:#333;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.logout-btn:hover{ background:#eee; }

/* çµ±ä¸€æŠŠæ‰€æœ‰ modal è“‹åœ¨é é¢ä¸Š */
.modal { z-index: 200; }

/* â‹¯ é¸å–®çš„å±¤ç´šç¨ä½ä¸€é» */
#moreModal { z-index: 180; }

/* ç™»å‡ºç¢ºèªå†é«˜ä¸€é»ï¼Œç¢ºä¿æ°¸é åœ¨æœ€ä¸Šé¢ */
#logoutModal { z-index: 220; }

/* ç™»å…¥CSS */
#loginPage{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  background:var(--blue-light);
}

/* ç™½è‰²å¡ç‰‡ï¼šé€™è£¡æ§åˆ¶å¯¬åº¦ã€åœ“è§’ã€é™°å½±ã€å…§è· */
#loginCard{
  position: absolute !important; /* ç„¡è¦–å‰é¢è¨­å®š */
  top: 80px;                      /* å¾€ä¸Š 20pxï¼Œä½ å¯ä»¥æ”¹ */
  left: 50%;
  transform: translateX(-50%);    /* æ°´å¹³ç½®ä¸­ */
  background:var(--white);
  border-radius:12px;          /* â† å¡ç‰‡åœ“è§’ */
  box-shadow:0 2px 6px rgba(0,0,0,0.08); /* â† å¡ç‰‡é™°å½± */
  padding:2rem;                /* â† å¡ç‰‡å…§è· */
  width:95%;
  max-width:450px;
min-height: 500px; /* æœ€å°é«˜åº¦ï¼Œå…§å®¹è¶…éæ™‚æœƒè‡ªå‹•è®Šé«˜ */

}

/* æ¨™é¡Œ */
.login-title{
  text-align:center;
  margin:0 0 1.5rem;
  font-size:28px;              /* â† æ¨™é¡Œå¤§å° */
  font-weight:800;
}

/* label èˆ‡æ¬„ä½çš„é–“è· */
.login-label{
  font-weight:600;
  margin:0.4rem 0 0.4rem;
}

/* è¼¸å…¥æ¡†å¤–è§€ï¼šé«˜åº¦ã€å­—é«”ã€åœ“è§’ã€é‚Šæ¡† */
.login-input{
  width:100%;
  height:44px;                 /* â† æ¬„ä½é«˜åº¦ */
  padding:0 12px;              /* â† æ–‡å­—å·¦å³å…§è· */
  border:1px solid #ccc;
  border-radius:8px;           /* â† æ¬„ä½åœ“è§’ */
  font-size:16px;              /* â† æ¬„ä½å­—é«”å¤§å° */
  margin:0 0 1rem;
margin-top:0.8rem;
  outline:none;
}
.login-input:focus{
  border-color:#95d3ff;
  box-shadow:0 0 0 3px rgba(0,170,255,.15);
}

/* å‹¾é¸åˆ—ï¼ˆcheckbox èˆ‡æ–‡å­—åœ¨åŒä¸€è¡Œï¼‰ */
.login-checkrow{
  display:flex;
  align-items:center;
  gap:.4rem;
  margin:0 0 1rem;
}

/* ç™»å…¥æŒ‰éˆ•å¤–è§€èˆ‡äº’å‹• */
.login-btn{
  width:100%;
  height:46px;                 /* â† æŒ‰éˆ•é«˜åº¦ */
  background:#00aaff;          /* â† æŒ‰éˆ•ä¸»è‰² */
  color:#fff;
  border:none;
  border-radius:8px;           /* â† æŒ‰éˆ•åœ“è§’ */
  font-size:16px;
  cursor:pointer;
}
.login-btn:hover{ background:#0791e6; }
.login-btn:active{ transform:translateY(1px); }

/* åº•ä¸‹ç´…è‰²æç¤º */
.login-tip{
  margin-top:1rem;
  color:#cc4444;
  font-size:0.85rem;           /* â† æç¤ºæ–‡å­—å¤§å° */
  text-align:center;
}

/* å¯é¸ï¼šå°è¢å¹•å†ç¸®ä¸€é» padding */
@media (max-width:360px){
  #loginCard{ padding:1.25rem; }
}

/* å€å¡Šåˆ†é¡ + é‡è¦ å‹¾é¸ åŒè¡Œæ’ç‰ˆ */
.inline-row {
  display: flex;
  align-items: center;
  gap: .75rem;
  margin-top: .25rem;     /* èˆ‡ä¸Šæ–¹ label çš„è·é›¢ */
}

/* ä¸‹æ‹‰é¸å–®ç¸®åˆ°ä¸€åŠå¯¬ã€é å·¦ */
.inline-row .half {
  width: 50%;
  min-width: 160px;       /* è¦–éœ€è¦å¯èª¿æˆ–æ‹¿æ‰ */
}

/* å‹¾é¸çš„å¤–è§€ */
.important-flag {
  display: inline-flex;
  align-items: center;
  gap: .35rem;
  white-space: nowrap;
  font-size: 0.95rem;
}
.drag-handle{
  cursor: grab;
  touch-action: none;          /* é‡é»ï¼šé˜»æ­¢é è¨­æ²å‹• */
  -webkit-user-select: none;   /* iOS ä¸è¦é¸å­— */
  user-select: none;
  -webkit-user-drag: none;
}
/* å¯é¸ï¼šå…§å®¹å€ä»å¯ä¸Šä¸‹æ²å‹• */
.section { touch-action: pan-y; }


/* æ»‘å‹•å®Œæˆï¼ˆè—è‰²åŸºåº•ï¼‰ */
.slide-complete {
  margin-top: .75rem;
}

.slide-track {
  position: relative;
  height: 44px;
  border-radius: 999px;
  background: linear-gradient(0deg, #e8f4ff, #f4faff);
  border: 1px solid #d6eaff;
  overflow: hidden;
  box-shadow: inset 0 1px 2px rgba(0,0,0,.05);
  -webkit-user-select: none;
  user-select: none;
  touch-action: none;
}

.slide-fill {
  position: absolute;
  inset: 0 auto 0 0;
  width: 0%;
  background: linear-gradient(90deg, #77c7ff, #00aaff);
  opacity: .25;
  transition: width .25s ease;
  pointer-events: none;
}

.slide-hint {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #449ad6;
  font-weight: 600;
  letter-spacing: .5px;
  pointer-events: none;
}

.slide-handle {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff, #e6f3ff);
  border: 1px solid #cfe6ff;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  cursor: grab;
  transition: transform .2s ease;
}
.slide-handle:active { cursor: grabbing; }

.slide-track.done .slide-hint {
  color: #2f9e44;
}
.slide-track.done .slide-fill {
  background: linear-gradient(90deg, #7ee8b5, #2ecc71);
  opacity: .35;
}

/* åªåœ¨ç·¨è¼¯ç‹€æ…‹é¡¯ç¤ºæ»‘æ¡¿ï¼›å®Œæˆæª¢è¦–(readonly)éš±è— */
#detailModal.readonly .slide-complete { display: none; }

/* æ·ºè‰²ç‰ˆï¼šå„²å­˜ & ç§»é™¤ */
.save-btn-half,
.delete-btn-half {
  border: 1px solid transparent;
  font-weight: 600;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
  transition: background-color .15s ease, box-shadow .15s ease, transform .02s ease;
}

/* å„²å­˜ï¼šè–„è–„ç¶ è— */
.save-btn-half {
  background: linear-gradient(0deg, #eefbf6, #f6fdf9);
  border-color: #ccefe2;
  color: #176d59;           /* æ·±ä¸€é»ï¼Œæ˜“è®€ */
}
.save-btn-half:hover {
  background: #e8faf3;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.save-btn-half:active { transform: translateY(1px); }

/* ç§»é™¤ï¼šè–„è–„çŠç‘šç²‰ */
.delete-btn-half {
  background: linear-gradient(0deg, #fff3f3, #fff7f7);
  border-color: #ffd8d8;
  color: #b23b3b;           /* æ·±ä¸€é»ï¼Œæ˜“è®€ */
}
.delete-btn-half:hover {
  background: #ffeef0;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.delete-btn-half:active { transform: translateY(1px); }

/* å…¨å¹…å„²å­˜ï¼ˆè‹¥ä½ ä¹Ÿæƒ³åŒæ­¥è®Šæ·ºï¼‰ */
.save-btn {
  background: linear-gradient(0deg, #eefbf6, #f6fdf9);
  border: 1px solid #ccefe2;
  color: #176d59;
}
.save-btn:hover { background:#e8faf3; }

/* FABï¼šé–‹åˆæ™‚æ—‹è½‰ã€é™°å½±æ›´æŸ”å’Œ */
.fab{
  position: fixed; bottom: 24px; right: 24px;
  width: 48px; height: 48px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  background:#00aaff; color:#fff; font-size:28px; font-weight:700;
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
  cursor:pointer; z-index: 110;
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
}
.fab:active{ transform: scale(.98); }
.fab.open{ transform: rotate(45deg); }   /* æ‰“é–‹æ™‚è®Šæˆ Ã— çš„æ„Ÿè¦º */

/* æ–°ï¼šæ¥µç°¡ç»ç’ƒå¡ç‰‡æµ®å±¤ */
.menu{
  position: fixed; bottom: 88px; right: 24px;
  min-width: 100px;
  padding: 8px;
  border-radius: 14px;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(180, 210, 255, .35);
  box-shadow: 0 12px 28px rgba(0, 60, 130, .12);
  display: block;               /* ç”¨é€æ˜æ§åˆ¶é¡¯ç¤º */
  opacity: 0; transform: translateY(8px) scale(.98);
  pointer-events: none;
  z-index: 105;
}

/* æ‰“é–‹ç‹€æ…‹ */
.menu.show{
  opacity: 1; transform: translateY(0) scale(1);
  pointer-events: auto;
  transition: opacity .18s ease, transform .18s ease;
}

/* å°åœ“è§’åˆ†éš” + å“ç‰Œè‰²ç³»æŒ‰éˆ• */
.menu button{
  display:flex; align-items:center; gap:.5rem;
  width:100%;
  background: transparent;
  border: 0;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 15px; font-weight: 600;
  color: #176dff;                 /* æ·ºè—ç³»ä¸»è‰²ï¼Œèˆ‡ä¸»è¦–è¦ºå”èª¿ */
  letter-spacing:.2px;
  cursor:pointer;
}

/* hover / active çš„è¼•å¾®å›é¥‹ï¼ˆæ‰‹æ©Ÿä¹Ÿå¥½é»ï¼‰ */
.menu button:hover{
  background: linear-gradient(0deg,#eef6ff,#f7fbff);
}
.menu button:active{
  transform: translateY(1px);
}

/* é …ç›®ä¹‹é–“åŠ ä¸€é»é–“è· */
.menu button + button{ margin-top: 4px; }

/* æŒ‡å‘ FAB çš„å°å°¾å·´ */
.menu::after{
  content:"";
  position:absolute;
  right: 12px; bottom: -6px;
  width: 12px; height:12px;
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(180,210,255,.35);
  border-top: none; border-left: none;
  transform: rotate(45deg);
  box-shadow: 4px 4px 10px rgba(0,60,130,.06);
}

/* åœ¨ã€Œå·²å®Œæˆã€æ™‚ç¦ç”¨ï¼ˆä½ å‰é¢å·²åš pointer-events/opactiyï¼Œä¹Ÿå¯æ²¿ç”¨ï¼‰ */
.fab[aria-disabled="true"]{
  pointer-events: none; opacity:.5; box-shadow: none;
}
/* é è¨­éƒ½ä¸é¡¯ç¤ºï¼Œé¿å…é–ƒçˆ */
#loginPage { display: none; }
.container { display: none !important; }

/* åªåœ¨ç¢ºå®šè¦é¡¯ç¤ºæ™‚ï¼Œæ‰æ‰“é–‹å°æ‡‰å€å¡Š */
html.show-login #loginPage { display: flex; }      /* é¡¯ç¤ºç™»å…¥é  */
html.show-app   .container { display: block !important; } /* é¡¯ç¤ºä¸»ç•«é¢ */

/* ===== è‡ªå‹•ç™»å…¥è¼‰å…¥å±¤ ===== */
#autologin-overlay{
  position: fixed; inset: 0;
  display: none;                  /* é è¨­ä¸é¡¯ç¤º */
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 260;                   /* é«˜æ–¼ modal(200) ä½†ä¸æ“‹ä½ ç™»å‡ºç¢ºèª(220) çš„è©±å¯èª¿é«˜åˆ° 260 */
}
#autologin-overlay.show{ display:flex; }

.autologin-box{
  display:flex; flex-direction:column; align-items:center; gap:.75rem;
  padding: 16px 18px;
  border-radius: 14px;
  background: rgba(255,255,255,.9);
  border: 1px solid rgba(180,210,255,.35);
  box-shadow: 0 12px 28px rgba(0,60,130,.12);
  transform: translateY(6px);
  animation: al-pop .2s ease-out forwards;
}

.autologin-loader{
  width: 42px; height: 42px; border-radius: 50%;
  border: 3px solid #e6f4ff;
  border-top-color: #00aaff;     /* è·Ÿä¸»è‰²ä¸€è‡´ */
  animation: al-spin .8s linear infinite;
  box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
}

.autologin-text{
  font-weight: 700;
  letter-spacing: .3px;
  color: #176dff;                 /* æ·ºè—ç³»å­—è‰² */
  font-size: 14px;
}

@keyframes al-spin { to { transform: rotate(360deg); } }
@keyframes al-pop {
  from { opacity: 0; transform: translateY(10px) scale(.98); }
  to   { opacity: 1; transform: translateY(0)    scale(1); }
}
/* Section å€ï¼šé—œé–‰æ–‡å­—é¸å–ã€iOS é•·æŒ‰å‘¼å«èœå–®ã€é»æ“Šé«˜äº® */
#section-container {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}
#section-container .section {
  -webkit-tap-highlight-color: transparent;
  will-change: transform;
  transition: transform 120ms ease;
}

/* é»æ“Š/æŒ‰å£“çš„è¦–è¦ºå›é¥‹ */
.section.__pressed { transform: scale(0.985); }
@keyframes __bump {
  0% { transform: scale(1); }
  50%{ transform: scale(0.985); }
  100%{ transform: scale(1); }
}
.section.__bump { animation: __bump .18s ease; }

#section-container { touch-action: pan-y; }

/* æŠŠæª”æ¡ˆè£¡æ‰€æœ‰å…¶ä»– .fab åˆªæ‰ï¼Œåªç•™é€™æ®µï¼Œä¸¦æ”¾åœ¨ <style> çš„æœ€åº•éƒ¨ */
.fab{
  position: fixed; bottom: 24px; right: 24px;
  width: 48px; height: 48px; border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  background: rgba(0,170,255,0.85) !important; /* åŠé€æ˜ã€åæ·¡è— */
  color:#fff; font-size:28px; font-weight:700;
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
  cursor:pointer; z-index: 110;
  transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease, background-color .2s ease;
}
.fab:hover{ background: rgba(0,170,255,0.95) !important; }
.fab:active{ transform: scale(.98); }
.fab.open{ transform: rotate(45deg); }

/* è®“é€²åº¦æ¢èˆ‡å…¶æ–‡å­—è“‹åœ¨æœ€ä¸Šå±¤ï¼Œé¿å…è¢«ä»»å‹™æ¨™é¡Œ/å¤©æ•¸é®ä½ */
.task{
  position: relative;
  overflow: hidden;
  /* æ–°å¢ï¼šé¿å…èˆ‡åŸç”Ÿå‚ç›´æ²å‹•æ‰“æ¶ */
  touch-action: pan-y;
}

.task .task-content, .task .task-days { position: relative; z-index: 2; }

.task .swipe-bar {
  position: absolute; top: 0; bottom: 0;
  width: 0%;
  z-index: 4;            /* â† æåˆ°æœ€ä¸Šå±¤ */
  display: flex; align-items: center;
  pointer-events: none;  /* ä¸æ””äº’å‹• */
  overflow: hidden;
  transition: width .18s ease;
}

/* é€²åº¦æ¢ä¸Šçš„æ–‡å­—ä¹Ÿç¢ºä¿åœ¨ä¸Šå±¤ */
.task .swipe-bar .label{
  position: relative;
  z-index: 5;            /* â† ä¿éšªï¼Œå†é«˜ä¸€å±¤ */
  white-space: nowrap;
  opacity: 0;
  transition: opacity .12s ease, transform .12s ease;
  font-weight: 800; letter-spacing: .3px;
  font-size: .98rem;
}

/* é¡è‰²èˆ‡å·¦å³é…ç½®ï¼ˆæ›´æ·ºç‰ˆæœ¬ï¼‰ */
.task .swipe-bar.right { 
  left: 0;  
  background: #d6fae8; /* éå¸¸æ·¡çš„ç¶ è‰² */
  color: #0e4a36; 
}
.task .swipe-bar.right .label{ margin-left:12px; transform: translateX(-6px); }
.task .swipe-bar.left {  
  right: 0; 
  background: #ffe4e6; /* éå¸¸æ·¡çš„ç´…è‰² */
  color: #5c2020; 
  justify-content: flex-end; 
}
.task .swipe-bar.left  .label{ margin-right:12px; transform: translateX(6px); }

/* å–æ¶ˆæ‰‹æ©Ÿé»æŒ‰é«˜äº® & ç„¦é»å¤–æ¡† */
.task { -webkit-tap-highlight-color: transparent; }
.task:focus, .task:focus-visible { outline: none; }

/* å‹•ç•«æœŸé–“è®“ GPU åˆæˆæ›´ç©©ï¼Œé¿å…é‚Šç·£ã€Œè™›ç·šã€ */
.task.swiping { will-change: transform; }
.task { backface-visibility: hidden; transform: translateZ(0); }

/* é€²åº¦æ¢ä¹Ÿé–‹åˆæˆï¼Œé‚Šç·£æ›´ç©©å®š */
.task .swipe-bar { will-change: width; transform: translateZ(0); }

/* æœ‰åœ“è§’æ™‚è®“å¡—è‰²ç·Šè²¼å…§å´ï¼Œé™ä½é‚Šç·£é‹¸é½’ */
.task { background-clip: padding-box; }

/* ä»Šæ—¥æ—¥æœŸï¼šå³ä¸Šè§’è¼•é‡æ–‡å­—å¼ */
#today-badge{
  position: fixed;
  top: 14px;
  right: 12px;
  z-index: 120;
  padding: 4px 8px;
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  color: rgba(50, 50, 50, 0.85);
  font-size: 14px;
  font-weight: 500;
  letter-spacing: 0.3px;
  user-select: none;
  pointer-events: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
/* äºŒé¸ä¸€å³å¯ï¼ˆå…ˆè©¦ Aï¼Œä¸å¤ å†ç”¨ Bï¼‰ */

/* A. æ¥µå°ä½ç§» */
#today-badge{ transform: translateX(0.5px); }

/* B. éå°ç¨± paddingï¼ˆå³é‚Šå¤š 1pxï¼‰ */
#today-badge{ padding-left: 9px; padding-right: 0px; }

/* ===== æ‹‰çµ²é‡‘å±¬ï¼ˆç„¡æ–·å±¤ç‰ˆï¼‰===== */
/* ç„¡ç¸«ã€ç©©å®šã€ä¸åƒ DPI çš„é‡‘å±¬åº• */
/* å¹³æ»‘éœ§é¢é‡‘å±¬æ•ˆæœï¼ˆç„¡æ ¼ç·šæ„Ÿï¼‰ */
body.bg-metal::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;

  /* æŸ”å…‰é«˜äº® + å‚ç›´åˆ·çµ²ç´‹è·¯ï¼ˆè¶…ç´°å¾®ï¼‰ */
  background-image:
    linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.12)),
    repeating-linear-gradient(
      90deg,
      rgba(255,255,255,0.03) 0px,
      rgba(255,255,255,0.03) 1px,
      rgba(0,0,0,0.02) 1px,
      rgba(0,0,0,0.02) 2px
    );

  background-blend-mode: screen, normal;

  /* è®“ç´‹ç†æ¥µåº¦ç´°ç·»ï¼Œé¿å…ç¶²æ ¼æ„Ÿ */
  background-size: 100% 100%, 600px 100%;
  background-repeat: no-repeat, repeat;

  /* è¼•å¾®å°æ¯”èˆ‡é£½å’Œåº¦ï¼Œä¿ç•™é‡‘å±¬æ„Ÿ */
  filter: contrast(103%) saturate(97%);
}


/* å±•é–‹åœ–ç¤º */
.expand-icon{
  display:inline-flex; align-items:center; justify-content:center;
  width:22px; height:22px; margin-left:.4rem;
  border-radius:4px; border:1px solid #ddd; background:#f8f8f8;
  cursor:pointer; font-size:12px; line-height:1; color:#555;
}
.expand-icon:active{ transform: scale(.97); }

/* å¤§å‹é–±è®€é¢æ¿ */
#detailViewer{
  display:none;
}
#detailViewer.show{
  display:block;
}
#detailForm.hide{
  display:none;
}
.viewer-head{
  display:flex; align-items:center; justify-content:space-between;
  gap:.5rem; margin-bottom:.5rem;
}
.viewer-title{
  font-weight:700; font-size:1rem;
}
.viewer-close{
  border:1px solid #ddd; background:#f7f7f7; border-radius:6px;
  padding:.35rem .6rem; cursor:pointer;
}
.viewer-body{
  width:100%;
  min-height:50vh;
  padding:.75rem;
  border:1px solid #eee;
  border-radius:8px;
  background:#fafafa;
  line-height:1.6;
  font-size:.95rem;
  resize:vertical; /* å¯ä»¥èª¿æ•´é«˜åº¦ */
}
/* å¼·åˆ¶èª¿è‰²ç›¤æŒ‰éˆ•ç‚ºå°æ·ºåº•æ¨£å¼ */
button.palette-btn {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  padding: 4px 8px !important;
  font-size: 0.85rem !important;
  font-weight: normal;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #f9f9f9 !important;
  color: #333 !important;
  width: auto !important;
  min-width: unset !important;
  margin-top: -3rem; /* èˆ‡ã€Œæ›´æ›åº•è‰²ã€çš„è·é›¢ */
}
button.palette-btn:hover {
  background: #f1f1f1 !important;
}
button.palette-btn:active {
  background: #e8e8e8 !important;
}

/* èª¿è‰²ç›¤ä¹å®®æ ¼ */
.palette-grid{
  display:grid; grid-template-columns: repeat(3, 1fr);
  gap:.75rem;
}
.palette-choice{
  position:relative;
  width:100%; aspect-ratio:1/1; border-radius:12px; border:1px solid #e5e5e5;
  box-shadow: 0 1px 2px rgba(0,0,0,.06); cursor:pointer; overflow:hidden;
}
.palette-choice[data-color="#f6fbfe"]{ background:#f6fbfe; }
.palette-choice[data-color="#f3fcf8"]{ background:#f3fcf8; }
.palette-choice[data-color="#fffcf3"]{ background:#fffcf3; }
.palette-choice[data-color="#fef6f9"]{ background:#fef6f9; }
.palette-choice[data-color="#f9f8fd"]{ background:#f9f8fd; }
.palette-choice[data-color="#ffeded"]{ background:#ffeded; }
.palette-choice[data-color="#fff8f5"]{ background:#fff8f5; }
.palette-choice[data-color="#fdfcf9"]{ background:#fdfcf9; }
/* é‡‘å±¬ç‰¹æ•ˆï¼ˆçœ‹èµ·ä¾†åƒé‡‘å±¬ï¼‰ */
.palette-choice[data-color="metal"]{ background: #e5e5e5; }
.palette-choice .metal-sheen{
  position:absolute; inset:0;
  background:
    linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.1)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, rgba(0,0,0,.04) 1px 2px);
  mix-blend-mode: screen; pointer-events:none;
}

/* é¸å–ç‹€æ…‹ */
.palette-choice.selected{
  outline: 3px solid #176dff;
  box-shadow: 0 0 0 3px rgba(23,109,255,.15) inset;
}
.filter-status .important-only{
  display:inline-flex; align-items:center; gap:.25rem;
  margin-left:.25rem; user-select:none; cursor:pointer;
}

/* å±•é–‹å±¤å·¥å…·åˆ—ï¼šå°å·§ã€ä¸ä½”ç©ºé–“ï¼Œä½†å¥½æŒ‰ */
.viewer-toolbar{
  display:flex;
  gap:.4rem;
  margin: .1rem 0 .4rem;
}

.vt-btn{
  border:1px solid #ddd;
  background:#f8f8f8;
  border-radius:6px;
  padding:.3rem .5rem;
  font-size:1rem;
  line-height:1;
  cursor:pointer;
  transition: background .15s ease, transform .02s ease, opacity .2s ease;
}
.vt-btn:hover{ background:#f1f1f1; }
.vt-btn:active{ transform: translateY(1px); }
.vt-btn[disabled]{ opacity:.45; cursor:not-allowed; }


  </style>
</head>
<body>
<!-- ç™»éŒ„é é¢ -->
<div id="loginPage">
  <div id="loginCard">
   <h1 style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 24px;">
  <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="position: relative; top: 1px;">
  MyTask
</h1>

    <label class="login-label">è‡ªè¨‚å¸³è™Ÿ</label>
    <input type="text" id="login-username" class="login-input" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">

    <label class="login-label">è‡ªè¨‚å¯†ç¢¼</label>
    <input type="password" id="login-password" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">

    <label class="login-checkrow">
      <input type="checkbox" id="auto-login">
      <span>è‡ªå‹•ç™»å…¥</span>
    </label>

    <button id="login-btn" class="login-btn">ç™»å…¥</button>

    <p class="login-tip">å¹³å°å…è¨»å†Šï¼Œè‡ªè¨‚å¸³è™Ÿå¯†ç¢¼å³å¯ç™»éŒ„</p>
  </div>
</div>



  <div class="container" style="display:none">
<!-- åœ¨é€™è£¡è²¼ â†“â†“â†“ï¼ˆæŠŠåŸæœ¬ <a href="mymemo.html" â€¦> æ”¹æˆé€™æ¨£ï¼‰ -->
  <a href="javascript:void(0)" class="page-title-link"
  onclick="window.location.href='mymemo.html'"
  style="display:flex; justify-content:center; text-decoration:none; color:inherit;">
 <h1 style="display:inline-flex; align-items:center; gap:10px; font-size:24px; padding:4px 10px; border-radius:8px; transition:background-color .2s, box-shadow .2s;">
   <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png"
        alt="icon" width="40" style="transform: translateY(2px);">
   MyTask
 </h1>
</a>



<div id="today-badge" aria-label="ä»Šå¤©æ—¥æœŸ"></div>
<!-- å³ä¸Šè§’ ... æŒ‰éˆ• -->
<div class="more-btn" onclick="openModalById('moreModal')">â‹¯</div>
<div id="section-container">
<div id="doneMore" style="display:none; text-align:right; margin:0.25rem 0;">
  <button id="doneMoreBtn" style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">æ›´å¤šâ€¦</button>
  <div id="doneMonthMenu" style="display:none; position:absolute; right:16px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;"></div>
</div>

  </div>

  <div class="fab" onclick="toggleMenu()">ï¼‹</div>
<div class="menu" id="menu">
<button onclick="openModal()" 
        style="background:#e6f6fc; color:#0091cc; font-weight:600; 
               padding:8px 16px; border:none; border-radius:8px; 
               box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
               margin-bottom:12px;">
  æ–°å¢ä»»å‹™
</button>

<button onclick="openCategoryModal()" 
        style="background:#e9f9f1; color:#1fa87a; font-weight:600; 
               padding:8px 16px; border:none; border-radius:8px; 
               box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer; 
               margin-bottom:12px;">
  æ–°å¢åˆ†é¡
</button>

<button onclick="enterEditMode()" 
        style="background:#fff6e6; color:#d98a00; font-weight:600; 
               padding:8px 16px; border:none; border-radius:8px; 
               box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;">
  ç·¨è¼¯åˆ†é¡
</button>
</div>

<!-- âœ… æ–°å¢çš„æŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…å®Œæˆç·¨è¼¯åˆ†é¡ -->
<button id="exitEditBtn" onclick="exitEditMode()" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #e3ffe8;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
">âœ…</button>


  <!-- æ–°å¢ä»»å‹™è¦–çª— -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('taskModal')">âœ•</button>
      <h3>æ–°å¢ä»»å‹™</h3>
    <label>ä»»å‹™åˆ†é¡</label>
    <div class="inline-row">
      <!-- é€™è£¡è¦ç”¨ taskSectionï¼ˆä¸æ˜¯ detailSectionï¼‰-->
      <select id="taskSection" class="half">
      </select>

      <!-- é€™è£¡è¦ç”¨ taskImportantï¼ˆä¸æ˜¯ detailImportantï¼‰-->
      <label class="important-flag">
        <input type="checkbox" id="taskImportant">
        é‡è¦
      </label>
    </div>

      <label>ä»»å‹™æ¨™é¡Œ(å¿…å¡«)</label>
      <input type="text" id="taskTitle">
      <label>ä»»å‹™å…§å®¹</label>
      <textarea id="taskContent"></textarea>
      <label>é å®šå®Œæˆæ—¥</label>
      <input type="date" id="taskDate">
      <label>è™•ç†æƒ…å½¢</label>
      <textarea id="taskNote"></textarea>
      <button onclick="addTask()" style="font-weight:bold;">æ–°å¢</button>
    </div>
  </div>

  <!-- ä»»å‹™å…§å®¹æª¢è¦–è¦–çª— -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('detailModal')">âœ•</button>
    <h3 style="display:flex;align-items:center;gap:.5rem;">
  <span>ä»»å‹™è³‡è¨Š</span>
  <small id="detailLastUpdate" style="font-size:.9rem;color:#666;white-space:nowrap;margin-left:.5rem;"></small>
</h3>



<!-- â–¼ è¡¨å–®è¦–åœ–ï¼šé è¨­é¡¯ç¤º -->
<div id="detailForm">
  <label>ä»»å‹™åˆ†é¡</label>
  <div class="inline-row">
    <select id="detailSection" class="half"></select>
    <label class="important-flag">
      <input type="checkbox" id="detailImportant"> é‡è¦
    </label>
  </div>

  <label>ä»»å‹™æ¨™é¡Œ</label>
  <input type="text" id="detailTitle">

  <!-- ä»»å‹™å…§å®¹ï¼šåŠ å±•é–‹éˆ• -->
  <label style="display:flex;align-items:center;">
    ä»»å‹™å…§å®¹
    <button type="button" class="expand-icon" onclick="toggleDetailExpand('detailContent','ä»»å‹™å…§å®¹')" title="å±•é–‹">â¤¢</button>
  </label>
  <textarea id="detailContent"></textarea>

  <label>é å®šå®Œæˆæ—¥</label>
  <input type="date" id="detailDate">

  <!-- è™•ç†æƒ…å½¢ï¼šåŠ å±•é–‹éˆ• -->
  <label style="display:flex;align-items:center;">
    è™•ç†æƒ…å½¢
    <button type="button" class="expand-icon" onclick="toggleDetailExpand('detailNote','è™•ç†æƒ…å½¢')" title="å±•é–‹">â¤¢</button>
  </label>
  <textarea id="detailNote"></textarea>

  <div style="display: flex; gap: 0.5rem;">
    <button class="save-btn-half" onclick="saveTask()">ğŸ’¾ å„²å­˜</button>
    <button class="delete-btn-half" onclick="confirmDelete()">ğŸ—‘ï¸ ç§»é™¤</button>
  </div>

  <!-- æ»‘å‹•å®Œæˆ -->
  <div class="slide-complete" id="slideComplete">
    <div class="slide-track">
      <div class="slide-hint">â¡ å¾€å³æ‹–æ‹‰å®Œæˆ</div>
      <div class="slide-fill" id="slideFill"></div>
      <div class="slide-handle" id="slideHandle" aria-label="å¾€å³æ‹–æ‹‰å®Œæˆ"></div>
    </div>
  </div>
</div>
<!-- â–² è¡¨å–®è¦–åœ– -->

<!-- â–¼ é–±è®€è¦–åœ–ï¼šå±•é–‹å¾Œé¡¯ç¤ºï¼ˆé è¨­éš±è—ï¼‰ -->
<div id="detailViewer">
  <div class="viewer-head">
    <div class="viewer-title" id="viewerTitle"></div>
    <button type="button" class="viewer-close" onclick="toggleDetailExpand()">â¤¢</button>
  </div>
    <!-- âœ… æ–°å¢ï¼šå±•é–‹å±¤ä¸‰éµå·¥å…·åˆ— -->
  <div class="viewer-toolbar">
    <button class="vt-btn" title="é‚„åŸ" onclick="viewerUndo()">â¤º</button>
    <button class="vt-btn" title="å¾©åŸ" onclick="viewerRedo()">â¤»</button>
    <button class="vt-btn" title="è¤‡è£½" onclick="viewerCopy()">â§‰
</button>
  </div>
  <textarea class="viewer-body" id="viewerBody"></textarea>

</div>
<!-- â–² é–±è®€è¦–åœ– -->


    </div>
  </div>

  <script>
document.addEventListener('keydown', function(e){
  if (e.key !== 'Enter') return;

  // å¦‚æœç„¦é»åœ¨ textareaï¼Œç›´æ¥ returnï¼ˆå…è¨±æ›è¡Œï¼‰
  if (e.target.tagName === 'TEXTAREA') return;

  const openModals = Array.from(document.querySelectorAll('.modal'))
    .filter(m => getComputedStyle(m).display !== 'none');
  if (openModals.length === 0) return;

  e.preventDefault();
  e.stopPropagation();

  // å¯é¸ï¼šå¦‚æœä½ æƒ³ Enter = é»ã€Œç¢ºèªã€ï¼š
  // const top = openModals[openModals.length - 1];
  // top.querySelector('.confirm-btn')?.click();
}, true); // ç”¨æ•ç²éšæ®µï¼Œå„ªå…ˆæ””ä½

let importantOnly = false; // â— æœ€å¾Œä¸€å±¤ç¯©é¸ï¼ˆé è¨­é—œï¼‰
let isEditing = false;   // ç›®å‰æ˜¯å¦åœ¨ç·¨è¼¯åˆ†é¡æ¨¡å¼
  // âœ… åˆ†é¡åœ¨é€™è£¡ç¶­è­·ï¼ˆæœ‰é †åºï¼‰
let categoriesLoaded = false;  // åˆ†é¡æ˜¯å¦å·²å¾é›²ç«¯è¼‰å…¥
let categories = [];
let sectionSortable = null;  // å­˜ä½ Sortable å¯¦ä¾‹
// âœ… é‡æ–°ç•«å‡ºæ‰€æœ‰åˆ†é¡å€å¡Šï¼ˆä¾ç…§ categories é †åºï¼‰
function refreshCurrentView(){
  if (statusFilter === 'done') {
    buildDoneMonthMenu();
    renderCompletedTasks();
  } else {
    showOngoing();
  }
}
// âœ… åªå­˜åˆ†é¡ï¼ˆä¸è¦å†å¾ tasks æ¨å›å»ï¼‰
document.addEventListener('change', function(e){
  if (e.target && e.target.id === 'importantOnly') {
    importantOnly = !!e.target.checked;
    // é—œæ‰æ™‚ï¼šå®Œå…¨å›åˆ°åŸæœ¬è¦–åœ–ï¼ˆä¿æŒä½ åŸé‚è¼¯ï¼‰
    // æ‰“é–‹æ™‚ï¼šå…ˆè·‘å®ŒåŸæœ¬è¦–åœ– â†’ å†å¥—â—æœ€å¾Œä¸€å±¤
    if (!importantOnly) {
      refreshCurrentView();
    } else {
      applyImportantFilter(); // å°ã€Œç¾æœ‰å¯è¦‹çµæœã€åšæœ€å¾Œä¸€å±¤ç¯©é¸
    }
  }
});

function saveCategoriesToFirebase(){
  if(!roomPath) return;
  db.ref(`${roomPath}/categories`).set(categories);
}
// === Firebase åˆå§‹åŒ–ï¼ˆæ”¾åœ¨é€™æ”¯ <script> çš„æœ€ä¸Šé¢ï¼‰===
const firebaseConfig = {
  apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
  authDomain: "kjreminder-24d74.firebaseapp.com",
  projectId: "kjreminder-24d74",
  storageBucket: "kjreminder-24d74.firebasestorage.app",
  messagingSenderId: "176371952161",
  appId: "1:176371952161:web:948121be209cd2e4181160",
  databaseURL: "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();


// å»ºè­°ï¼šæ˜ç¢ºæŒ‡å®šæŒä¹…æ€§ï¼ˆiOS/Safari æ¯”è¼ƒä¸æœƒæ€ªï¼‰
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});
// æª¢æŸ¥æ˜¯å¦åœ¨ä¸»ç•«é¢ / PWA ç¨ç«‹æ¨¡å¼
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// ç­‰ç¶²è·¯èµ·ä¾†
function waitOnline() {
  if (navigator.onLine) return Promise.resolve();
  return new Promise(res => window.addEventListener('online', res, { once: true }));
}

// æ¸¬è©¦ IndexedDB æ˜¯å¦å¯ç”¨ï¼ˆiOS PWA å†·å•Ÿæœ‰æ™‚æœƒç‚¸ï¼‰
function testIndexedDB() {
  return new Promise((resolve) => {
    try {
      const req = indexedDB.open('kjreminder-idb-test', 1);
      req.onsuccess = () => { try { req.result.close(); } catch(_){} resolve(true); };
      req.onerror   = () => resolve(false);
      req.onblocked = () => resolve(false);
    } catch(_) { resolve(false); }
  });
}

// PWA å•Ÿå‹•æ™‚ï¼Œç¨ç­‰ä¸€ä¸‹è®“å­˜å„²èˆ‡ç¶²è·¯å°±ç·’ï¼Œä¸¦é¸æ“‡å®‰å…¨çš„æŒä¹…æ€§
async function pwaAuthWarmup() {
  // å…ˆç­‰ DOM å¦¥ç•¶
  await new Promise(r => setTimeout(r, 120));

  // ç­‰ç¶²è·¯
  await waitOnline();

  // iOS PWA å†·å•Ÿï¼šIndexedDB å¸¸å¸¸ 0.x ç§’å…§ä¸å¯ç”¨ï¼Œç¨ç­‰ä¸€é»å†æ¸¬
  await new Promise(r => setTimeout(r, 120));

  const idbOK = await testIndexedDB();

  try {
    if (idbOK) {
      // æ­£å¸¸ç”¨ LOCALï¼ˆèƒ½è¨˜ä½ç™»å…¥ï¼‰
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    } else {
      // é€€è€Œæ±‚å…¶æ¬¡ï¼šä¸æŒä¹…ï¼ˆæœ¬æ¬¡é–‹å•Ÿæœ‰æ•ˆï¼Œé¿å…å¡åœ¨æŒä¹…å±¤ï¼‰
      await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
    }
  } catch(_) {
    // å°±ç®— setPersistence å¤±æ•—ä¹Ÿåˆ¥æ“‹æµç¨‹
  }
}

// ä½ çš„ä¸€éµé–‹æ©Ÿï¼ˆå¦‚æœä½ å·²ç¶“åšäº† bootAuth/ensureSignedInï¼Œå°±åœ¨è£¡é¢å‘¼å« pwaAuthWarmupï¼‰
async function bootAuth() {
  if (bootAuth.__busy) return;
  bootAuth.__busy = true;
  setLoginBusy(true);

  // å…ˆæŠŠé¡¯ç¤ºç‹€æ…‹æ¸…æ‰ï¼Œé¿å…é–ƒçˆ
  document.documentElement.classList.remove('show-login', 'show-app');

  // PWA å…ˆç†±èº«ï¼ˆç¶²è·¯/å„²å­˜å°±ç·’ & è¨­å®šæŒä¹…æ€§ï¼‰
  if (isStandalone) {
    await pwaAuthWarmup();
  } else {
    try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_) {}
  }

  // è®€ sessionStorage æˆ– localStorageï¼Œç®—å‡º roomPath
  hydrateRoomPath();

  if (!roomPath) {
    // æ²’æ†‘è­‰ï¼šåœåœ¨ç™»å…¥é ï¼Œä¸¦ç¢ºä¿æ²’æœ‰æ®˜ç•™ç™»å…¥ç‹€æ…‹
    try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
    document.documentElement.classList.add('show-login');
    setLoginBusy(false);
    bootAuth.__busy = false;
    return;
  }

  // æœ‰æ†‘è­‰ï¼šä¹¾æ·¨ç™»å…¥ + è¶…æ™‚å‚™æ´
  try {
    try { if (auth.currentUser) await auth.signOut(); } catch(_) {}

    const timeout = new Promise((_, rej) =>
      setTimeout(() => rej(new Error('timeout')), 7000)
    );
    await Promise.race([auth.signInAnonymously(), timeout]);

    // æˆåŠŸ â†’ é¡¯ç¤ºä¸»ç•«é¢
    document.documentElement.classList.add('show-app');
    loadTasksFromFirebase();
    updateSectionOptions();
  } catch (e) {
    // å¤±æ•— â†’ åœåœ¨ç™»å…¥é 
    try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
    document.documentElement.classList.add('show-login');
  } finally {
    setLoginBusy(false);
    bootAuth.__busy = false;
  }
}

// äº‹ä»¶ï¼šé–‹é ã€å›å‰æ™¯ã€èšç„¦æ™‚éƒ½è£œå‘¼å«ä¸€æ¬¡


// ===== å…±ç”¨çš„ã€Œç¢ºä¿ç™»å…¥ã€æµç¨‹ï¼ˆæœ‰é‡è©¦/è¶…æ™‚ä¿è­·ï¼‰=====
const AUTH_TIMEOUT_MS = 6000;
let authBusy = false;
let authTimer = null;

async function ensureSignedIn() {
  if (authBusy) return;
  authBusy = true;
  setLoginBusy(true);

  // å…ˆå¾ localStorage æ‹¿ savedï¼ˆåˆ¤æ–·æ˜¯å¦æœ‰ã€Œè‡ªå‹•ç™»å…¥ã€è³‡æ–™ï¼‰
  let saved = null;
  try { saved = localStorage.getItem('todo_room_info'); } catch(_) {}

  // âœ… æƒ…æ³ 1ï¼šæ²’æœ‰å„²å­˜å¸³å¯† â†’ ä¸è¦è‡ªå‹•ç™»å…¥ï¼ç›´æ¥é¡¯ç¤ºç™»å…¥é 
  if (!saved) {
    authBusy = false;
    setLoginBusy(false);
    // é¡¯ç¤ºç™»å…¥é 
document.documentElement.classList.remove('show-app');
document.documentElement.classList.add('show-login');

    // ç‚ºäº†ä¿éšªï¼šè‹¥ç€è¦½å™¨é‚„ç•™è‘—èˆŠçš„åŒ¿åä½¿ç”¨è€…ï¼Œç™»å‡ºä¸€æ¬¡ï¼Œé¿å…ä¹‹å¾Œ onAuthStateChanged äº‚åˆ‡ç•«é¢
    try { if (auth.currentUser) await auth.signOut(); } catch(e) {}
    return;
  }

  // âœ… æƒ…æ³ 2ï¼šæœ‰å„²å­˜å¸³å¯† â†’ æ­£å¸¸è‡ªå‹•ç™»å…¥æµç¨‹
  hydrateRoomPath(); // çµ„å¥½ roomPath

showAutoLoginOverlay();
startAutoLoginWatchdog();

  try {
    // A. è‹¥å·²ç¶“æœ‰ user ä¸”æœ‰ roomPathï¼Œç›´æ¥é€²ä¸»ç•«é¢
    if (auth.currentUser && roomPath) {
      document.getElementById('loginPage').style.display = 'none';
      document.querySelector('.container').style.display = 'block';
      loadTasksFromFirebase();
      updateSectionOptions();
hideAutoLoginOverlay();
      return;
    }

    // B. ç¢ºä¿ä¹¾æ·¨ç‹€æ…‹å†ç™»å…¥ï¼ˆé¿å…æ®˜ç•™ sessionï¼‰
    if (auth.currentUser) await auth.signOut();

    // C. åŠ è¶…æ™‚ä¿è­·ï¼š6 ç§’é‚„æ²’å›æ‡‰å°±é‡è©¦ä¸€æ¬¡åŒ¿åç™»å…¥
    authTimer = setTimeout(async () => {
      try {
        if (auth.currentUser) await auth.signOut();
        await auth.signInAnonymously();
        window.location.href = 'app.html#memo';
      } catch(e) {/* å¿½ç•¥ */}
    }, AUTH_TIMEOUT_MS);

    await auth.signInAnonymously();
  } catch (e) {
    alert('è‡ªå‹•ç™»å…¥å¤±æ•—ï¼š' + (e?.message || e));
hideAutoLoginOverlay();
  } finally {
    authBusy = false;
    // å…¶é¤˜åˆ‡ç•«é¢ç”± onAuthStateChanged çµ±ä¸€è™•ç†
  }
}

let roomPath = ""; // â† æ”¾é€™è£¡ï¼å…¨æª”åªå‡ºç¾ä¸€æ¬¡
let tasksRef = null;
let completedRef = null; // ä¹‹å¾Œä½ æœ‰åš completedTasks å³å¯ç”¨åˆ°

const DEFAULT_CATEGORIES = ['ç…§é¡§æœå‹™','å°ˆæ¥­æœå‹™','äº¤é€šæ¥é€','å–˜æ¯æœå‹™','è¼”å…·ç”³è«‹','å…¶å®ƒ'];

// å°å·¥å…·ï¼šæŠŠä¸åˆæ³•å­—å…ƒæ›æ‰ï¼ˆFirebase è·¯å¾‘ä¸èƒ½æœ‰ . # $ [ ] /ï¼‰
function sanitizeKey(s){
  return String(s).replace(/[.#$/\[\]\/]/g, '_');
}


// 1) å…¨åŸŸç‹€æ…‹ï¼ˆæ”¾åœ¨ä½ çš„å…¨åŸŸè®Šæ•¸å€ï¼‰
let dayMode = 'work'; // 'work' å·¥ä½œå¤©(é è¨­) / 'calendar' æ—¥æ›†å¤©
    let tasks = [];
    let selectedTaskId = null;

function hydrateRoomPath() {
  try {
    // å…ˆè©¦ localStorageï¼ˆæœ‰å‹¾è‡ªå‹•ç™»å…¥æ™‚ï¼‰
    let saved = localStorage.getItem('todo_room_info');
    // æ²’æœ‰å°±é€€å› sessionStorageï¼ˆæœ¬æ¬¡ç™»å…¥æœ‰æ•ˆï¼‰
    if (!saved) saved = sessionStorage.getItem('todo_room_info');
    if (!saved) return;

    const { username, password } = JSON.parse(saved);
    roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
  } catch (_) {}
}

// ===== å±•é–‹å±¤ä¸‰éµï¼šæ­·ç¨‹èˆ‡æ“ä½œ =====
let __viewerHistory = [];
let __viewerRedoStack = [];

function getViewerBody(){
  return document.getElementById('viewerBody');
}
function getExpandedSource(){
  // ç›®å‰å±•é–‹çš„æ˜¯å“ªå€‹æ¬„ä½ï¼ˆdetailContent æˆ– detailNoteï¼‰
  return window.__expandedFieldId
    ? document.getElementById(window.__expandedFieldId)
    : null;
}

// æ”¾åœ¨ getViewerBody / getExpandedSource é™„è¿‘
function flushViewerSync(){
  try{
    const vBody = (typeof getViewerBody === 'function') ? getViewerBody() : null;
    const src   = (typeof getExpandedSource === 'function') ? getExpandedSource() : null;
    if (vBody && src) {
      src.value = vBody.value || '';
      src.dispatchEvent(new Event('input', { bubbles: true }));
    }
  }catch(_){}
}



function updateViewerToolbar(){
  const undoBtn = document.querySelector('.viewer-toolbar .vt-btn[onclick="viewerUndo()"]');
  const redoBtn = document.querySelector('.viewer-toolbar .vt-btn[onclick="viewerRedo()"]');
  if (undoBtn) undoBtn.disabled = __viewerHistory.length <= 1; // åªæœ‰ä¸€å€‹åˆå§‹ç‹€æ…‹æ™‚ä¸å¯é‚„åŸ
  if (redoBtn) redoBtn.disabled = __viewerRedoStack.length === 0;
}

function pushViewerHistory(nextValue){
  // é€£çºŒç›¸åŒä¸å…¥å †ï¼Œæœ€å¤šä¿ç•™ 100 ç­†
  if (__viewerHistory.length === 0 || __viewerHistory[__viewerHistory.length-1] !== nextValue){
    __viewerHistory.push(nextValue);
    if (__viewerHistory.length > 100) __viewerHistory.shift();
  }
  // ä¸€æ—¦æœ‰è¼¸å…¥ï¼Œredo æ¸…ç©º
  __viewerRedoStack = [];
  updateViewerToolbar();
}

function viewerUndo(){
  const vBody = getViewerBody();
  if (!vBody || __viewerHistory.length <= 1) return;
  const cur = __viewerHistory.pop();              // ç•¶å‰ -> é€² redo
  __viewerRedoStack.push(cur);
  const prev = __viewerHistory[__viewerHistory.length-1];
  vBody.value = prev;

  // åŒæ­¥å›è¡¨å–®æ¬„ä½
  if (vBody.__formSync) vBody.__formSync();
  updateViewerToolbar();
}

function viewerRedo(){
  const vBody = getViewerBody();
  if (!vBody || __viewerRedoStack.length === 0) return;
  const redoVal = __viewerRedoStack.pop();
  vBody.value = redoVal;
  if (vBody.__formSync) vBody.__formSync();

  // redo å¾Œä¹Ÿç®—æ–°ç‹€æ…‹
  pushViewerHistory(vBody.value);
  updateViewerToolbar();
}

function viewerCopy(){
  const vBody = getViewerBody();
  const text = vBody ? (vBody.value || '') : '';
  if (!text) {
    alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
    return;
  }
  // å„ªå…ˆç”¨ Clipboard APIï¼Œå¤±æ•—å‰‡é€€å›é¸å–è¤‡è£½
  navigator.clipboard?.writeText(text).then(()=>{
    alert('å·²è¤‡è£½å…§å®¹');
  }).catch(()=>{
    try{
      const t = document.createElement('textarea');
      t.value = text; document.body.appendChild(t);
      t.select(); document.execCommand('copy'); document.body.removeChild(t);
      alert('å·²è¤‡è£½å…§å®¹');
    }catch(_){ alert('è¤‡è£½å¤±æ•—'); }
  });
}

function openModal(prefSectionId) {
  updateSectionOptions();                 // â˜… å…ˆåŒæ­¥é¸é …
  if (prefSectionId) {
    const sel = document.getElementById('taskSection');
    if (sel) {
      // æœ‰å°æ‡‰é¸é …å°±é é¸ï¼›æ²’æœ‰å°±ç¶­æŒåŸç‹€
      const opt = sel.querySelector(`option[value="${prefSectionId}"]`);
      if (opt) sel.value = prefSectionId;
    }
  }
  document.getElementById('taskModal').style.display = 'flex';
  closeFabMenu();
}


function closeModal(id) {
  // é—œæ‰è©³æƒ…è¦–çª—æ™‚ï¼Œè§£ç¶å³æ™‚åŒæ­¥ï¼ˆåŠ ä¿éšªï¼‰
  if (id === 'detailModal' && typeof unbindDetailLiveSync === 'function') {
    unbindDetailLiveSync();
resetDetailPanels();
  }
  document.getElementById(id).style.display = 'none';
}


//å‰©é¤˜å¤©æ•¸é‚è¼¯
// 2) å–ä»£ä½ ç›®å‰çš„ getRemainingDaysï¼ˆæ”¯æ´å…©ç¨®æ¨¡å¼ï¼‰
function getRemainingDays(dateStr) {
  if (!dateStr) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const target = new Date(dateStr); target.setHours(0,0,0,0);

  if (dayMode === 'calendar') {
    const ms = target.getTime() - today.getTime();
    return Math.round(ms / 86400000); // ä»Šå¤©=0ã€æ˜å¤©=1ã€æ˜¨å¤©=-1
  }

  // å·¥ä½œå¤©ï¼šæ’é™¤å…­æ—¥ï¼›ä»Šå¤©=0ï¼›æœªä¾†/éå»éƒ½ä»¥å·¥ä½œå¤©è¨ˆ
  if (target.getTime() === today.getTime()) return 0;

  const forward = target > today;
  const start = new Date(forward ? today : target);
  const end   = new Date(forward ? target : today);

  let count = 0;

  // å¾ã€Œèµ·å§‹æ—¥çš„ä¸‹ä¸€å¤©ã€é–‹å§‹ç®—ï¼Œç›´åˆ° endï¼ˆåŒ…å« endï¼‰
  const cur = new Date(start);
  cur.setDate(cur.getDate() + 1);

  while (cur <= end) {
    const d = cur.getDay();
    if (d !== 0 && d !== 6) count++;  // åªç®—é€±ä¸€ï½é€±äº”
    cur.setDate(cur.getDate() + 1);
  }
  return forward ? count : -count;
}



    function getColorByDays(days) {
      if (days == null) return 'var(--green-light)';
      if (days >= 6) return 'var(--green-light)';
      if (days >= 4) return '#ffeaea';
      if (days >= 2) return '#ffb3b3';
      return '#ff8080';
    }

    function addTask() {
  const section = document.getElementById('taskSection').value;
  const title   = document.getElementById('taskTitle').value;
  const content = document.getElementById('taskContent').value;
  const date    = document.getElementById('taskDate').value;
  const note    = document.getElementById('taskNote').value;

  if (!title) return;

  // è®€ã€Œé‡è¦ã€å‹¾é¸ï¼ˆæ²’æœ‰é€™å€‹æ¬„ä½å°±å…ˆè¨­ falseï¼‰
  const importantEl = document.getElementById('taskImportant');
  const important   = importantEl ? importantEl.checked : false;

  const id = `task-${Date.now()}`;
const now = Date.now();
const task = { id, section, title, content, date, note, important, createdAt: now, updatedAt: now };

  tasks.push(task);

  const days = getRemainingDays(date);
  const bg = getColorByDays(days);
  const displayDays = (days == null) ? 'ç„¡' : days;

  const el = document.createElement('div');
  el.className = 'task';
  el.dataset.id = id;
  el.style.backgroundColor = bg;
el.innerHTML = taskCardHTML(task, displayDays);


  document.getElementById(section).appendChild(el);
  sortTasks(section);

// é—œé–‰è¦–çª—ï¼ˆåŠ å›é€™è¡Œï¼‰
closeModal('taskModal');

  // æ¸…ç©ºè¡¨å–®
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskContent').value = '';
  document.getElementById('taskDate').value = '';
  document.getElementById('taskNote').value = '';
  if (importantEl) importantEl.checked = false;   // â† æŠŠã€Œé‡è¦ã€å‹¾é¸æ¸…æ‰

  applyDayFilter();
  saveTasksToFirebase();
  bindSwipeToTasks();
}

// å¼·åˆ¶æäº¤ç›®å‰æ­£åœ¨è¼¸å…¥ï¼ˆæ”¶åˆè¼¸å…¥æ³•ã€è§¸ç™¼ compositionend / blurï¼‰
function commitActiveInput() {
  const ae = document.activeElement;
  if (!ae) return;
  const tag = ae.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
    try { ae.dispatchEvent(new Event('change', { bubbles: true })); } catch(_) {}
    try { ae.blur(); } catch(_) {}
  }
}


//æ’åºé‚è¼¯ç”¨
function sortTasks(section) {
  const container = document.getElementById(section);
  const tasksInSection = Array.from(container.querySelectorAll('.task'));

  tasksInSection.sort((a, b) => {
    const taskA = tasks.find(t => t.id === a.dataset.id);
    const taskB = tasks.find(t => t.id === b.dataset.id);

    const daysA = getRemainingDays(taskA.date);
    const daysB = getRemainingDays(taskB.date);

    // ç©ºæ—¥æœŸè¦–ç‚ºæœ€å¤§å¤©æ•¸ï¼ˆæ’åºåˆ°æœ€ä¸‹é¢ï¼‰
    const safeDaysA = daysA == null ? Infinity : daysA;
    const safeDaysB = daysB == null ? Infinity : daysB;

    return safeDaysA - safeDaysB;
  });

  // æ¸…ç©ºå¾Œä¾æ’åºçµæœé‡æ–°åŠ å…¥
  tasksInSection.forEach(taskEl => container.appendChild(taskEl));
}


   function openDetail(id) {
  selectedTaskId = id;
  const task = tasks.find(t => t.id === id);
  if (!task) return;


resetDetailPanels();
  document.getElementById('detailSection').value = task.section;
  document.getElementById('detailTitle').value   = task.title;
  document.getElementById('detailContent').value = task.content;
  document.getElementById('detailDate').value    = task.date;
  document.getElementById('detailNote').value    = task.note;

  document.getElementById('detailModal').style.display = 'flex';
  setDetailReadonly(false);
  document.getElementById('detailImportant').checked = !!task.important;
// é€²è¡Œä¸­ï¼šé¡¯ç¤ºæœ€å¾Œå„²å­˜ï¼›è‹¥æ²’å„²å­˜éå°±é¡¯ç¤ºå»ºç«‹æ™‚é–“
{
  const last = task.updatedAt || task.createdAt || null;
  const lbl  = document.getElementById('detailLastUpdate');
  if (lbl) lbl.textContent = last ? ('æ›´æ–°ï¼š' + formatRocDateTime(last)) : '';
}

  if (window.__resetSlideComplete) window.__resetSlideComplete();

  // â¬‡â¬‡â¬‡ æ–°å¢é€™è¡Œï¼šè©³æƒ…ä¸€é–‹å°±å³æ™‚åŒæ­¥
  bindDetailLiveSync(task);
}


function syncEditsIntoTask(task) {
  if (task.id !== selectedTaskId) return task;

  // â˜… åªæœ‰è©³æƒ…è¦–çª—æ‰“é–‹æ™‚æ‰åŒæ­¥è¼¸å…¥å€¼ï¼Œé¿å…æŠŠç©ºå­—ä¸²è¦†è“‹æ‰
  if (!isModalOpen('detailModal')) return task;

  const secEl  = document.getElementById('detailSection');
  const ttlEl  = document.getElementById('detailTitle');
  const ctnEl  = document.getElementById('detailContent');
  const dateEl = document.getElementById('detailDate');
  const noteEl = document.getElementById('detailNote');
  const impEl  = document.getElementById('detailImportant');

  if (secEl)  task.section   = secEl.value;
  if (ttlEl)  task.title     = ttlEl.value;
  if (ctnEl)  task.content   = ctnEl.value;
  if (dateEl) task.date      = dateEl.value;
  if (noteEl) task.note      = noteEl.value;
  if (impEl)  task.important = !!impEl.checked;

  return task;
}




//å„²å­˜åŠŸèƒ½
function saveTask() {
  if (!selectedTaskId) return;

  const task = tasks.find(t => t.id === selectedTaskId);
  if (!task) return;

  task.section = document.getElementById('detailSection').value;
  task.title = document.getElementById('detailTitle').value;
  task.content = document.getElementById('detailContent').value;
  task.date = document.getElementById('detailDate').value;
  task.note = document.getElementById('detailNote').value;
task.important = document.getElementById('detailImportant').checked;   // â˜…æ–°å¢
task.updatedAt = Date.now();
const _lbl = document.getElementById('detailLastUpdate');
if (_lbl) _lbl.textContent = 'æ›´æ–°ï¼š' + formatRocDateTime(task.updatedAt);


  const oldEl = document.querySelector(`[data-id='${task.id}']`);
  if (oldEl) oldEl.remove();

  const days = getRemainingDays(task.date);
  const bg = getColorByDays(days);
  const displayDays = (days == null) ? 'ç„¡' : days;

  const el = document.createElement('div');
  el.className = 'task';
  el.dataset.id = task.id;
  el.style.backgroundColor = bg;
el.innerHTML = taskCardHTML(task, displayDays);


  document.getElementById(task.section).appendChild(el);
  sortTasks(task.section);
  
  bindSwipeToTasks();

  closeModal('detailModal'); // âœ… æ–°å¢é€™ä¸€è¡Œ
applyDayFilter();
saveTasksToFirebase();


}

function isModalOpen(id){
  const m = document.getElementById(id);
  return m && getComputedStyle(m).display !== 'none';
}
//ç§»é™¤åŠŸèƒ½
function confirmDelete() {
  document.getElementById('confirmModal').style.display = 'flex';
}

function deleteTask() {
  if (!selectedTaskId) return;

  const el = document.querySelector(`[data-id='${selectedTaskId}']`);
  if (el) el.remove();

  tasks = tasks.filter(t => t.id !== selectedTaskId);

  closeModal('confirmModal');
  closeModal('detailModal');
saveTasksToFirebase();  // â† åŠ é€™è¡Œ

}
//æ–°å¢åˆ†é¡åŠŸèƒ½
function openCategoryModal() {
  document.getElementById('newCategoryName').value = '';
  document.getElementById('categoryModal').style.display = 'flex';
  closeFabMenu(); // âœ… è‡ªå‹•é—œé–‰é¸å–®
}

function addCategory() {
  const name = document.getElementById('newCategoryName').value.trim();
  if (!name) return;
  if (categories.includes(name)) { alert("æ­¤åˆ†é¡å·²å­˜åœ¨ï¼"); return; }

  // âœ… æ›´æ–°é™£åˆ—ã€å­˜é›²ã€é‡ç•«
  categories.push(name);
  saveCategoriesToFirebase();
  renderSections(categories);
refreshCurrentView();  
  closeModal('categoryModal');
}



//é˜²é›™æ“Š
  let lastTouchTime = 0;
  document.addEventListener('touchend', function (event) {
    const now = new Date().getTime();
    if (now - lastTouchTime <= 300) {
      event.preventDefault(); // é˜»æ­¢ç¬¬äºŒæ¬¡é»æ“Šå°è‡´æ”¾å¤§
    }
    lastTouchTime = now;
  }, false);


//ç·¨è¼¯åˆ†é¡åŠŸèƒ½

let pendingRenameId = null;

function enterEditMode() {
  isEditing = true;
  decorateSectionsForEdit();
  closeFabMenu();
  const exitBtn = document.getElementById('exitEditBtn');
if (exitBtn) exitBtn.style.display = 'block';
}
// åˆªé™¤åˆ†é¡å½ˆçª—
function confirmDeleteCategory(id) {
  const category = document.getElementById(id);
  if (!category) return;

  // å»ºç«‹ç¢ºèªè¦–çª—
  const confirmBox = document.createElement('div');
  confirmBox.className = 'modal';
  confirmBox.style.display = 'flex';
  confirmBox.innerHTML = `
    <div class="modal-content">
      <h3 style="text-align: center;">æ˜¯å¦ç¢ºèªåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ</h3>
      <div class="confirm-buttons">
        <button class="confirm-btn">ç¢ºèª</button>
        <button class="cancel-btn">å–æ¶ˆ</button>
      </div>
    </div>
  `;

  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
confirmBox.querySelector('.confirm-btn').onclick = () => {
  // âœ… å…ˆè™•ç†ä»»å‹™ï¼šæŠŠåœ¨é€™å€‹åˆ†é¡çš„ä»»å‹™ï¼Œç§»å»ä¸€å€‹å®‰å…¨åˆ†é¡
// ç›´æ¥åˆªæ‰è©²åˆ†é¡ä¸‹çš„æ‰€æœ‰ä»»å‹™
tasks = tasks.filter(t => t.section !== id);
completedTasks = completedTasks.filter(t => t.section !== id);

// è‹¥å‰›å¥½æ­£åœ¨çœ‹è¢«åˆªé™¤çš„ä»»å‹™ï¼Œæ¸…æ‰é¸å–ï¼ˆæœ‰ selectedTaskId çš„è©±ï¼‰
if (typeof selectedTaskId !== 'undefined') {
  const stillExists = [...tasks, ...completedTasks].some(t => t.id === selectedTaskId);
  if (!stillExists) {
    selectedTaskId = null;
    try { closeModal('detailModal'); } catch (_) {}
  }
}

saveTasksToFirebase(); // ä»»å‹™æœ‰å‹•åˆ°å°±å­˜ä¸€ä¸‹

  // âœ… æ›´æ–°åˆ†é¡é™£åˆ—
  categories = categories.filter(c => c !== id);
  saveCategoriesToFirebase();

  // âœ… é‡ç•«åˆ†é¡èˆ‡ä»»å‹™
  renderSections(categories);
  if (statusFilter === 'done') renderCompletedTasks(); else showOngoing();

  confirmBox.remove();
};
  confirmBox.querySelector('.cancel-btn').onclick = () => {
    confirmBox.remove();
  };

  document.body.appendChild(confirmBox);

// âœ… åŒæ­¥å¾æ‰€æœ‰ select ä¸­ç§»é™¤é€™å€‹åˆ†é¡é¸é …
const selects = [document.getElementById('taskSection'), document.getElementById('detailSection')];
selects.forEach(select => {
  const option = select.querySelector(`option[value="${id}"]`);
  if (option) option.remove();
});
}




//ç¢ºèªå®Œæˆç·¨è¼¯
function exitEditMode() {
  // é—œé–‰ç·¨è¼¯ç‹€æ…‹
  isEditing = false;

  // æ¸…æ‰ç·¨è¼¯é…ä»¶èˆ‡æ¨£å¼
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('edit-mode');

    const titleBar = section.querySelector('.section-title');
    if (titleBar) {
      // é‚„åŸåªé¡¯ç¤ºåç¨±
      titleBar.innerHTML = section.id;
    }
  });

  // éš±è—åº•éƒ¨ã€Œå®Œæˆç·¨è¼¯ã€éˆ•
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'none';

  // ï¼ˆå¯é¸ï¼‰ç¢ºä¿æ‹–æ‹‰å¯¦ä¾‹ä¹¾æ·¨
  if (sectionSortable && sectionSortable.destroy) {
    sectionSortable.destroy();
    sectionSortable = null;
  }
  // é‡æ–°åˆå§‹åŒ–æ‹–æ‹‰ï¼ˆéç·¨è¼¯æ¨¡å¼ä¸‹æœ‰æŠŠæ‰‹å°±èƒ½æ‹–ï¼Œæ²’æŠŠæ‰‹å°±ä¸æœƒå‹•ï¼‰
  initSectionSortable();

  // ç·¨è¼¯çµæŸå¾Œï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®
  updateSectionOptions();
}

//æ‰‹æ©Ÿæ‹–æ‹‰
function initSectionSortable(){
  const el = document.getElementById('section-container');
  if (!el) return;

  // å…ˆéŠ·æ¯€èˆŠçš„ï¼Œé¿å…å¤šæ¬¡åˆå§‹åŒ–è¡çª
  if (sectionSortable && sectionSortable.destroy) {
    sectionSortable.destroy();
  }

sectionSortable = new Sortable(el, {
  animation: 150,
  handle: '.drag-handle',
  draggable: '.section',
  ghostClass: 'dragging',

  // â¬‡ï¸ ç«‹åˆ»æ‹–ï¼šå–æ¶ˆé•·æŒ‰å»¶é²èˆ‡é–€æª»
  forceFallback: true,
  fallbackOnBody: true,
  delay: 0,                 // ç«‹åˆ»é–‹å§‹
  delayOnTouchOnly: false,  // ä¸éœ€è¦é•·æŒ‰é‚è¼¯
  touchStartThreshold: 0,   // è§¸ç¢°å°±æ‹–

  onEnd: () => {
    categories = Array.from(document.querySelectorAll('#section-container .section'))
      .map(sec => sec.id);
    saveCategoriesToFirebase();
  }
});
}
function openRenameModal(sectionId) {
  pendingRenameId = sectionId;
  document.getElementById('renameInput').value = sectionId;
  document.getElementById('renameModal').style.display = 'flex';
}

function confirmRename() {
  const oldId = pendingRenameId;
  const newName = document.getElementById('renameInput').value.trim();
  if (!newName || document.getElementById(newName)) {
    alert('åç¨±ä¸å¯ç‚ºç©ºæˆ–å·²å­˜åœ¨ï¼');
    return;
  }

  // é€²è¡Œä¸­ä»»å‹™ï¼šæ”¹ section
  tasks.forEach(t => { if (t.section === oldId) t.section = newName; });

  // å·²å®Œæˆä»»å‹™ï¼šä¹Ÿè¦æ”¹ section
  completedTasks.forEach(t => { if (t.section === oldId) t.section = newName; });

  // âœ… æŠŠ categories é™£åˆ—è£¡çš„èˆŠåæ›æ–°å
  categories = categories.map(c => c === oldId ? newName : c);
  saveCategoriesToFirebase();   // å­˜åˆ†é¡
  saveTasksToFirebase();        // å­˜ä»»å‹™

  // âœ… é‡ç•« + ä¾ç•¶å‰é ç±¤åˆ·æ–°
  renderSections(categories);
  if (statusFilter === 'done') {
    renderCompletedTasks();
  } else {
    showOngoing();
  }

  closeModal('renameModal');
  pendingRenameId = null;
}




//æ–°å¢åˆ†é¡
function updateSectionOptions() {
  const sections = document.querySelectorAll('.section');
  const options = Array.from(sections).map(section => {
    const id = section.id;
    return `<option value="${id}">${id}</option>`;
  }).join('');

  document.getElementById('taskSection').innerHTML = options;
  document.getElementById('detailSection').innerHTML = options;
}

//æ›´å¤šåŠŸèƒ½-ç¯©é¸å‰©é¤˜æ—¥
let filterDay = "default"; // é è¨­ï¼šé¡¯ç¤ºæ‰€æœ‰åˆ†é¡(å«ç©ºç™½)

document.addEventListener("change", function(e) {
  if (e.target.matches('.filter-days input[type="radio"]')) {
    filterDay = e.target.value;   // ç›´æ¥åˆ‡æ›
    applyDayFilter();
  }
});

function applyDayFilter() {
  const isDefault = (filterDay === 'default');

  // å…ˆæ±ºå®šæ¯å¼µä»»å‹™å¡æ˜¯å¦é¡¯ç¤ºï¼ˆåŸæœ¬é‚£æ®µä¿ç•™ï¼‰
  document.querySelectorAll(".task").forEach(taskEl => {
    const task = tasks.find(t => t.id === taskEl.dataset.id);
    if (!task) return;
    let show = true;
    if (!isDefault && filterDay !== 'all') {
      const days = getRemainingDays(task.date);
      const v = parseInt(filterDay, 10);
      show = (days !== null) && (days <= v);
    }
    taskEl.style.display = show ? "" : "none";
  });

  // åˆ†é¡é¡¯ç¤ºç­–ç•¥
  if (statusFilter === 'done' || !isDefault) {
    hideEmptySectionsAfterFilter();  // 1/3/5/ä¸é™/å·²å®Œæˆ â†’ éš±è—ç©ºåˆ†é¡
  } else {
    // é è¨­ â†’ é¡¯ç¤ºå…¨éƒ¨åˆ†é¡
    document.querySelectorAll('#section-container .section')
      .forEach(sec => sec.style.display = '');
  }
}



function openModalById(id) {
  document.getElementById(id).style.display = 'flex';
}

//æ­·å²ç´€éŒ„
// ====== æ–°å¢çš„å…¨åŸŸç‹€æ…‹ ======
let completedTasks = [];          // æ­¸æª”çš„å®Œæˆä»»å‹™
let statusFilter = "ongoing";     // é€²è¡Œä¸­ / å·²å®Œæˆ
let completedMonthFilter = "recent15"; // recent15 æˆ– '11407' é€™ç¨®æœˆä»½

// å–®é¸ï¼šä»»å‹™ç‹€æ…‹ï¼ˆå³æ™‚åˆ‡æ›ï¼‰
document.addEventListener("change", function(e){
  if (e.target.matches('.filter-status input[type="radio"]')) {
    statusFilter = e.target.value;              // 'ongoing' or 'done'
 if (statusFilter === 'done') {
  // ç¦ç”¨å³ä¸‹ï¼‹æŒ‰éˆ•
  const fab = document.querySelector('.fab');
  if (fab) {
    fab.style.pointerEvents = 'none';   // ä¸å¯é»
    fab.style.opacity = '0.5';          // è®Šæ·¡
  }

  completedMonthFilter = "recent15";
  buildDoneMonthMenu();                    
  document.getElementById('doneMore').style.display = 'block';
  renderCompletedTasks();
} else {
  // æ¢å¾©å³ä¸‹ï¼‹æŒ‰éˆ•
  const fab = document.querySelector('.fab');
  if (fab) {
    fab.style.pointerEvents = 'auto';   // å¯é»
    fab.style.opacity = '1';            // é‚„åŸ
  }

  document.getElementById('doneMore').style.display = 'none';
  showOngoing();                           
}
  }
});
// 3) ç›£è½ã€Œå¤©æ•¸è¨­å®šã€åˆ‡æ›ï¼ˆåœ¨ä½ çš„ document.addEventListener å€å¡ŠåŠ é€™æ®µï¼‰
document.addEventListener("change", function(e){
  if (e.target.matches('.filter-mode input[type="radio"]')) {
    dayMode = e.target.value;                 // 'work' or 'calendar'
    if (statusFilter === 'done') {
      renderCompletedTasks();                 // å®Œæˆè¦–åœ–ä¸åƒå¤©æ•¸ï¼Œä½†ä¿æŒä¸€è‡´åˆ·æ–°
    } else {
      showOngoing();                          // é‡æ–°è¨ˆç®—å¤©æ•¸/é¡è‰²/æ’åºä¸¦å¥—ç”¨ç¯©é¸
    }
  }
});


// å®ŒæˆæŒ‰éˆ•ï¼šæ”¹ç‚ºæ­¸æª”ï¼ˆè¦†è“‹ä½ çš„ completeTaskï¼‰
function completeTask(id) {
  commitActiveInput();       // åŸæœ¬å°±æœ‰ï¼šç›¡é‡æ”¶æ‰è¼¸å…¥æ³•/è§¸ç™¼ change
  flushViewerSync();         // æ–°å¢ï¼šè‹¥åœ¨å±•é–‹é–±è®€è¦–åœ–ï¼Œå…ˆæŠŠæ–‡å­—å›çŒåˆ°ä¾†æºæ¬„ä½

  const targetId = id || selectedTaskId;
  if (!targetId) return;

  const idx = tasks.findIndex(t => t.id === targetId);
  if (idx === -1) return;

  const t = tasks[idx];

  // â˜…â˜…â˜… æœ€å°ä¸”é—œéµçš„æ”¹å‹•ï¼šä¸å†ä»°è³´ syncEditsIntoTask çš„ã€Œmodal æ˜¯å¦é–‹å•Ÿã€åˆ¤æ–·ï¼Œ
  // åªè¦æ¬„ä½åœ¨ DOMï¼Œå°±ç›´æ¥æŠŠå€¼è¦†å¯«å› taskï¼ˆæ¡Œæ©Ÿæ‹–æ»‘æ¡¿æ™‚å°±ä¸æœƒæ¼æ‰æœ€å¾Œè¼¸å…¥ï¼‰
  (function harvestDetailFormIntoTask(task){
    const secEl  = document.getElementById('detailSection');
    const ttlEl  = document.getElementById('detailTitle');
    const ctnEl  = document.getElementById('detailContent');
    const dateEl = document.getElementById('detailDate');
    const noteEl = document.getElementById('detailNote');
    const impEl  = document.getElementById('detailImportant');

    if (secEl)  task.section   = secEl.value;
    if (ttlEl)  task.title     = ttlEl.value;
    if (ctnEl)  task.content   = ctnEl.value;
    if (dateEl) task.date      = dateEl.value;
    if (noteEl) task.note      = noteEl.value;
    if (impEl)  task.important = !!impEl.checked;

    task.updatedAt = Date.now();
  })(t);

  const finished = { ...t, completedAt: Date.now() };

  // å¾é€²è¡Œä¸­ç§»é™¤ DOM + é™£åˆ—
  const el = document.querySelector(`[data-id='${targetId}']`);
  if (el) el.remove();
  tasks.splice(idx, 1);

  // é—œè©³æƒ…ï¼ˆè‹¥æœ‰é–‹ï¼‰
  closeModal('detailModal');

  // æ¨é€²å·²å®Œæˆä¸¦å­˜é›²
  completedTasks.push(finished);
  saveTasksToFirebase();

  // å‹•ç•«
  const checkmark = document.getElementById('check-success');
  checkmark.classList.add('show');
  setTimeout(() => checkmark.classList.remove('show'), 1500);

  // ä¾ç›®å‰é ç±¤åˆ·æ–°
  if (statusFilter === 'done') {
    buildDoneMonthMenu();
    renderCompletedTasks();
  } else {
    applyDayFilter();   // â† äº¤çµ¦æ—¢æœ‰æ¿¾é¡ï¼šé è¨­æœƒé¡¯ç¤ºå…¨éƒ¨åˆ†é¡ï¼Œä¸æœƒæŠŠç©ºçš„è—èµ·ä¾†
  }
}



// ====== æ¸²æŸ“é‚è¼¯ ======
function clearAllSections() {
  document.querySelectorAll('.section').forEach(sec => {
    // ä¿ç•™ section-titleï¼Œæ¸…æ‰ä»»å‹™å¡
    Array.from(sec.querySelectorAll('.task')).forEach(t => t.remove());
  });
}

function showOngoing() {
  clearAllSections();
// æŠŠä»»å‹™è£¡ç”¨åˆ°çš„åˆ†é¡è£œé€² categoriesï¼ˆé¿å…æœ‰ä»»å‹™ä½†æ²’æœ‰åˆ†é¡ï¼‰
// æŠŠä»»å‹™è£¡ç”¨åˆ°çš„åˆ†é¡è£œé€² categoriesï¼ˆé¿å…æœ‰ä»»å‹™ä½†æ²’æœ‰åˆ†é¡ï¼‰
const needed = Array.from(new Set(tasks.map(t => t.section).filter(Boolean)));
const merged = Array.from(new Set([...(categories || []), ...needed]));

if (merged.length !== (categories || []).length) {
  categories = merged;
  if (categoriesLoaded) {          // â˜…â˜…â˜… åˆ†é¡è¼‰å¥½å¾Œæ‰å…è¨±å­˜é›²ç«¯
    saveCategoriesToFirebase();
  }
  renderSections(categories);       // é‡ç•«åˆ†é¡
}
  // é‡æ–°æŠŠé€²è¡Œä¸­ tasks ä¾ section æ¸²æŸ“
  tasks.forEach(t => {
    const days = getRemainingDays(t.date);
    const bg = getColorByDays(days);
    const displayDays = (days == null) ? 'ç„¡' : days;

    const el = document.createElement('div');
    el.className = 'task';
    el.dataset.id = t.id;
    el.style.backgroundColor = bg;
el.innerHTML = taskCardHTML(t, displayDays);

    const sec = document.getElementById(t.section);
    if (sec) sec.appendChild(el);
  });

  // ä¾ä½ åŸæœ¬é‚è¼¯æ’åº
  const sections = new Set(tasks.map(t => t.section));
  sections.forEach(sortTasks);

  // é€²è¡Œä¸­ä¹Ÿè¦å¥—ç”¨ä½ ç›®å‰çš„ã€Œå‰©é¤˜å¤©æ•¸ã€ç¯©é¸
  applyDayFilter();
bindSwipeToTasks(); 
applyImportantFilter(); // âœ… æœ€å¾Œä¸€å±¤
}

// è½‰æ°‘åœ‹å¹´æœˆï¼ˆå›å‚³å¦‚ "11407"ï¼‰
function toRocYM(input) {
  // å…è¨±å‚³é€²ä¾†æ˜¯å­—ä¸²æˆ– Date
  const d = (input instanceof Date) ? input : new Date(input);

  // æ²’å¡«æ—¥æœŸ or ç„¡æ•ˆæ—¥æœŸ â†’ ç›´æ¥æ­¸åˆ°ã€Œç„¡ã€
  if (!input || isNaN(d.getTime())) return 'ç„¡';

  const yy = d.getFullYear() - 1911;
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  return `${yy}${mm}`;
}

// ç”Ÿæˆæœˆä»½æ¸…å–®ï¼ˆåƒ…åˆ—å‡º >15 å¤©çš„æœˆä»½ï¼Œä¸”æœ‰è³‡æ–™çš„ï¼‰
function buildDoneMonthMenu() {
  const menu = document.getElementById('doneMonthMenu');
  if (!menu) return;
  menu.innerHTML = '';

  // ç½®é ‚ï¼šè¿‘5æ—¥
  const recentBtn = document.createElement('button');
  recentBtn.textContent = 'è¿‘5æ—¥';
  recentBtn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;font-weight:600;';
  recentBtn.onclick = () => {
   completedMonthFilter = 'recent15';
    menu.style.display = 'none';
    renderCompletedTasks();
  };
  menu.appendChild(recentBtn);

  const monthSet = new Set();
  
  completedTasks.forEach(t => {
    const d = new Date(t.date);  // â† æ”¹ç”¨é å®šå®Œæˆæ—¥æœŸ
    const rocYM = toRocYM(d);
    console.log('Adding month:', rocYM);  // èª¿è©¦ï¼Œæª¢æŸ¥æ¯å€‹ä»»å‹™çš„å¹´æœˆæ˜¯å¦æ­£ç¢º
    monthSet.add(rocYM);
  });

  if (monthSet.size === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'ç„¡æ›´å¤šæœˆä»½';
    menu.appendChild(empty);
    return;
  }

  // å°‡æœˆä»½æŒ‰å­—æ¯æ’åºä¸¦ç”ŸæˆæŒ‰éˆ•
  Array.from(monthSet).sort((a, b) => b.localeCompare(a)).forEach(ym => {
    const btn = document.createElement('button');
    btn.textContent = ym;
    btn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;';
    btn.onclick = () => {
      completedMonthFilter = ym;
      menu.style.display = 'none';
      renderCompletedTasks();
    };
    menu.appendChild(btn);
  });
}

// é»ã€Œæ›´å¤šâ€¦ã€å±•é–‹æœˆä»½æ¸…å–®
document.getElementById('doneMoreBtn')?.addEventListener('click', () => {
  const menu = document.getElementById('doneMonthMenu');
  if (!menu) return;
  menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
});

// æ¸²æŸ“å·²å®Œæˆï¼ˆé è¨­é¡¯ç¤º 15 æ—¥å…§ï¼›é»æœˆä»½å‰‡é¡¯ç¤ºè©²æœˆä»½ï¼‰
function renderCompletedTasks() {
  clearAllSections();
// æŠŠå·²å®Œæˆä»»å‹™ç”¨åˆ°çš„åˆ†é¡ä¹Ÿè£œå› categories
// æŠŠå·²å®Œæˆä»»å‹™ç”¨åˆ°çš„åˆ†é¡ä¹Ÿè£œå› categories
const needFromDone = Array.from(new Set(completedTasks.map(t => t.section).filter(Boolean)));
const merged2 = Array.from(new Set([...(categories || []), ...needFromDone]));

if (merged2.length !== (categories || []).length) {
  categories = merged2;
  if (categoriesLoaded) {          // â˜…â˜…â˜… åˆ†é¡è¼‰å¥½å¾Œæ‰å…è¨±å­˜é›²ç«¯
    saveCategoriesToFirebase();
  }
  renderSections(categories);
}

  const now = new Date();
  const list = completedTasks.filter(t => {
    const d = new Date(t.date);  // â† æ”¹ç”¨é å®šå®Œæˆæ—¥æœŸ
    const rocYM = toRocYM(d);  // è½‰æ›ç‚º ROC å¹´æœˆ

    console.log('Task completedAt:', t.completedAt, 'Converted to ROC YM:', rocYM); // èª¿è©¦ï¼Œç¢ºèªæ¯å€‹ä»»å‹™çš„æ™‚é–“æˆ³èˆ‡è½‰æ›çµæœ

if (completedMonthFilter === 'recent15') {
  const completedDate = new Date(t.completedAt);  // â† ç”¨å¯¦éš›å®Œæˆæ—¥æœŸ
  const diff = Math.floor((Date.now() - completedDate.getTime()) / 86400000);
  return diff <= 5;  // åªé¡¯ç¤ºæœ€è¿‘ 5 å¤©å®Œæˆçš„ä»»å‹™
} else {
  return rocYM === completedMonthFilter;  // æœˆä»½æ­¸é¡ç”¨é å®šå®Œæˆæ—¥æœŸ
}
  });

  list.forEach(t => {
    const el = document.createElement('div');
    el.className = 'task';
    el.dataset.id = t.id;
    el.style.backgroundColor = 'var(--green-light)'; // å®Œæˆç”¨æ·¡ç¶ è‰²èƒŒæ™¯
    el.innerHTML = `
      <div class="task-content">
        <div class="task-title">âœ… ${t.important ? 'â— ' : ''}${t.title}</div>
      </div>
      <div class="task-days">å®Œ</div>
    `;
      el.onclick = () => openCompletedDetail(t.id);


    const sec = document.getElementById(t.section);
    if (sec) sec.appendChild(el);
  });
  hideEmptySectionsAfterFilter();   // â† æ–°å¢ï¼šå®Œæˆè¦–åœ–ä¹Ÿéš±è—ç©ºç™½åˆ†é¡
applyImportantFilter(); // âœ… æœ€å¾Œä¸€å±¤

}




//å·²å®Œæˆè¦–çª—ç´°ç¯€
function setDetailReadonly(ro) {

const modal = document.getElementById('detailModal');
if (modal) modal.classList.toggle('readonly', !!ro);
  ['detailSection','detailTitle','detailContent','detailDate','detailNote']
    .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = ro; });

  const saveBtn = document.querySelector('#detailModal .save-btn-half');
  const delBtn  = document.querySelector('#detailModal .delete-btn-half');
  const completeBtn = Array.from(document.querySelectorAll('#detailModal button'))
    .find(b => b.textContent.includes('å·²å®Œæˆ'));


  if (ro) {
    if (saveBtn) { saveBtn.textContent = 'æˆ‘äº†è§£äº†ï¼'; saveBtn.onclick = () => closeModal('detailModal'); }
    if (delBtn)  { delBtn.onclick = confirmDeleteCompleted; } // â† æ”¹å«ã€Œç¢ºèªåˆªé™¤(å®Œæˆ)ã€

    if (completeBtn) completeBtn.style.display = 'none';
  } else {
    if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ å„²å­˜'; saveBtn.onclick = saveTask; }
    if (delBtn)  { delBtn.onclick = confirmDelete; }
    if (completeBtn) completeBtn.style.display = '';
  }

  // â˜… æ–°å¢ï¼šé–ä½/è§£é–ã€Œé‡è¦ã€checkbox
  const importantEl = document.getElementById('detailImportant');
  if (importantEl) importantEl.disabled = ro;

}

let selectedCompletedId = null;
function openCompletedDetail(id) {
 resetDetailPanels();

   selectedCompletedId = id;
  const t = completedTasks.find(x => x.id === id);
  if (!t) return;

  // å¡«å€¼
  document.getElementById('detailSection').value = t.section;
  document.getElementById('detailTitle').value   = t.title;
  document.getElementById('detailContent').value = t.content || '';
  document.getElementById('detailDate').value    = t.date || '';
  document.getElementById('detailNote').value    = t.note || '';
{
  const lbl = document.getElementById('detailLastUpdate');
  if (lbl) lbl.textContent = t.completedAt ? ('æ›´æ–°ï¼š' + formatRocDateTime(t.completedAt)) : '';
}

  setDetailReadonly(true);
  document.getElementById('detailModal').style.display = 'flex';
}

function deleteCompleted() {
  if (!selectedCompletedId) return;
  const idx = completedTasks.findIndex(x => x.id === selectedCompletedId);
  if (idx >= 0) completedTasks.splice(idx, 1);
  closeModal('detailModal');
  renderCompletedTasks();
}

function confirmDeleteCompleted() {
  const modal = document.getElementById('confirmModal');
  const confirmBtn = modal.querySelector('.confirm-btn');

  const oldHandler = confirmBtn.onclick;     // æš«å­˜åŸæœ¬ï¼ˆé€²è¡Œä¸­åˆªé™¤ï¼‰çš„ handler
  confirmBtn.onclick = () => {                // æš«æ™‚æ”¹æˆåˆªã€Œå·²å®Œæˆã€
    deleteCompletedConfirmed();
    confirmBtn.onclick = oldHandler;          // åˆªå®Œé‚„åŸ
  };

  modal.style.display = 'flex';
}

function deleteCompletedConfirmed() {
  if (!selectedCompletedId) return;
  const idx = completedTasks.findIndex(x => x.id === selectedCompletedId);
  if (idx >= 0) completedTasks.splice(idx, 1);

  // âœ… é€™è¡Œä¸€å®šè¦
  saveTasksToFirebase();

  closeModal('confirmModal');
  closeModal('detailModal');
  renderCompletedTasks();
}
//ç™»å…¥

let loggingIn = false;

function setLoginBusy(busy){
  const btn = document.getElementById('login-btn');
  if (!btn) return;
  btn.disabled = busy;
  btn.textContent = busy ? 'ç™»å…¥ä¸­â€¦' : 'ç™»å…¥';
}

auth.onAuthStateChanged(async (user) => {
  try {
    if (authTimer) { clearTimeout(authTimer); authTimer = null; }

    hydrateRoomPath();

    // å…ˆæ¸…ä¹¾æ·¨
    document.documentElement.classList.remove('show-login', 'show-app');

    if (user && roomPath) {
      // é¡¯ç¤ºä¸»ç•«é¢ï¼ˆç”¨ classï¼‰
    // é¡¯ç¤ºä¸»ç•«é¢ï¼ˆç”¨ classï¼‰
document.documentElement.classList.add('show-app');

// ğŸ”§ é‡è¦ï¼šæŠŠèˆŠçš„ inline é¡¯ç¤ºå€¼æ¸…æ‰ï¼Œé¿å…é‡ç–Š
const lp  = document.getElementById('loginPage');
const app = document.querySelector('.container');
if (lp)  lp.style.display  = '';   // æ¸…é™¤ "display:flex"
if (app) app.style.display = '';   // æ¸…é™¤ä»»ä½• inline display

      // åˆå§‹åŒ–è³‡æ–™
      loadTasksFromFirebase();
      updateSectionOptions();
    } else {
      // æ²’ç™»å…¥æˆ–æ²’ roomPath -> å›ç™»å…¥é 
      try { if (auth.currentUser) await auth.signOut(); } catch(e) {}
      document.documentElement.classList.add('show-login');
    }
  } catch (e) {
    console.error('onAuthStateChanged éŒ¯èª¤ï¼š', e);
    alert('ç•«é¢åˆå§‹åŒ–å¤±æ•—ï¼š' + (e?.message || e));
    try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
    document.documentElement.classList.remove('show-app');
    document.documentElement.classList.add('show-login');
  } finally {
hideAutoLoginOverlay();
stopAutoLoginWatchdog();    // â† æ–°å¢ï¼šç™»å…¥å®Œæˆæˆ–åˆ‡é éƒ½é—œæ‰çœ‹é–€ç‹—
setLoginBusy(false);
    loggingIn = false;
  }
});

document.getElementById('login-btn').addEventListener('click', async function(){
  if (loggingIn) return; // é˜²æ­¢é‡è¤‡é»
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value.trim();
  const autoLogin = document.getElementById('auto-login').checked;

  if(!username || !password){
    alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼');
    return;
  }

  roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
if (autoLogin){
  // æ—¢æœ‰ï¼šé•·æœŸè¨˜ä½
  localStorage.setItem('todo_room_info', JSON.stringify({ username, password }));
} else {
  // æ—¢æœ‰ï¼šä¸é•·æœŸè¨˜ä½
  localStorage.removeItem('todo_room_info');
}
// â˜… æ–°å¢ï¼šç•¶æ¬¡å·¥ä½œéšæ®µä¸€å®šæœ‰ï¼ˆåˆ‡åˆ° MyMemo ä¹Ÿè®€å¾—åˆ°ï¼‰
sessionStorage.setItem('todo_room_info', JSON.stringify({ username, password }));

  loggingIn = true;
  setLoginBusy(true);

 try {
  // å…ˆç™»å‡ºèˆŠçš„åŒ¿åä½¿ç”¨è€…ï¼ˆåŠ åœ¨é€™è£¡ï¼ï¼‰
  if (auth.currentUser) {
    await auth.signOut();
  }
    // è¨­ä¸€å€‹ 8 ç§’çš„ä¿è­·æ™‚é–“ï¼Œé¿å…å¡æ­»
    const loginPromise = auth.signInAnonymously();
    await Promise.race([
      loginPromise,
      new Promise((_, rej)=>setTimeout(()=>rej(new Error('ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡è©¦')), 8000))
    ]);
    // ä¸åœ¨é€™è£¡åˆ‡ç•«é¢ï¼Œç­‰ onAuthStateChanged è‡ªå‹•åˆ‡
  } catch (e) {
    loggingIn = false;
    setLoginBusy(false);
    alert('ç™»å…¥å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
  }
});

  // å¾é›²ç«¯è¼‰è³‡æ–™
  loadTasksFromFirebase();

// === è‡ªå‹•ç™»å…¥ï¼ˆæœ‰è¨˜éŒ„æˆ¿é–“å°±ç›´æ¥é€²ï¼‰ ===
// âœ… æœ€ç°¡å–®çš„ã€Œä¸€å®šæœƒè‡ªå‹•ç™»å…¥ã€ç‰ˆæœ¬


// === è‡ªå‹•ç™»å…¥ï¼ˆçµ±ä¸€èµ° ensureSignedInï¼‰ ===
document.addEventListener('DOMContentLoaded', ensureSignedIn);
window.addEventListener('pageshow', ensureSignedIn);
// === å¾é›²ç«¯è¼‰å…¥ï¼ˆå…ˆåšé€²è¡Œä¸­ tasksï¼›completed ä¹‹å¾Œå†æ¥ï¼‰===
function loadTasksFromFirebase() {
  if (!roomPath || !auth.currentUser) return;

  // å…ˆå–æ¶ˆèˆŠç›£è½ï¼Œé¿å…é‡è¤‡ç¶
  if (tasksRef) tasksRef.off();
  if (completedRef) completedRef.off();

  tasksRef = db.ref(`${roomPath}/tasks`);
  completedRef = db.ref(`${roomPath}/completedTasks`);
  const categoriesRef = db.ref(`${roomPath}/categories`);

  tasksRef.on('value', (snap) => {
    const data = snap.val() || {};
    tasks = Object.values(data);
    showOngoing();
  });

  completedRef.on('value', (snap) => {
    const data = snap.val() || {};
    completedTasks = Object.values(data);
    if (statusFilter === 'done') renderCompletedTasks();
  });

  // è¼‰å…¥åˆ†é¡åç¨±
// è¼‰å…¥åˆ†é¡åç¨±ï¼ˆå…è¨±ç©ºé™£åˆ—ï¼Œä¸è‡ªå‹•è£œé è¨­ï¼‰
categoriesRef.on('value', (snap) => {
  const cloud = snap.val();

  // ç”¨æ¯å€‹æˆ¿é–“å°ˆå±¬çš„ keyï¼Œç¢ºä¿ä¸åŒå¸³è™Ÿå„è‡ªé¡¯ç¤ºä¸€æ¬¡
  const welcomeKey = roomPath ? `welcome_shown_${roomPath}` : 'welcome_shown';

  if (cloud === null) {
    // ç¬¬ä¸€æ¬¡ç™»å…¥ï¼šä¸è£œé è¨­ï¼Œåˆ†é¡ç¶­æŒç©º
    categories = [];

    // æœ¬å¸³è™Ÿï¼ˆroomï¼‰é‚„æ²’çœ‹éæ‰é¡¯ç¤º
    if (!localStorage.getItem(welcomeKey)) {
      document.getElementById('welcomeModal').style.display = 'flex';
      localStorage.setItem(welcomeKey, '1');
    }

    // æŠŠç©ºé™£åˆ—å¯«ä¸Šé›²ç«¯ï¼Œä¹‹å¾Œå°±ä¸æ˜¯ null äº†
    saveCategoriesToFirebase();

  } else if (Array.isArray(cloud)) {
    categories = cloud.slice();
  } else if (cloud && typeof cloud === 'object') {
    categories = Object.values(cloud);
  } else {
    categories = [];
  }

  categoriesLoaded = true;
  renderSections(categories);
  if (statusFilter === 'done') { renderCompletedTasks(); } else { showOngoing(); }
});
}


// === å¯«å›é›²ç«¯ï¼ˆå…ˆå¯« tasksï¼›completed ä¹‹å¾Œå†æ¥ï¼‰===
function saveTasksToFirebase() {
  const obj = {};
  tasks.forEach(t => obj[t.id] = t);

  const doneObj = {};
  completedTasks.forEach(t => doneObj[t.id] = t);

  // å„²å­˜ä»»å‹™è³‡æ–™
  db.ref(`${roomPath}/tasks`).set(obj);
  db.ref(`${roomPath}/completedTasks`).set(doneObj);

  // å„²å­˜åˆ†é¡è³‡æ–™
}

//ç™»å‡º

function openLogoutModal(){
  document.getElementById('logoutModal').style.display = 'flex';
}

async function doLogout(){
  // é—œé–‰ DB ç›£è½
  try {
    if (tasksRef) { tasksRef.off(); tasksRef = null; }
    if (completedRef) { completedRef.off(); completedRef = null; }
  } catch(e){ console.warn(e); }

  // æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™
  tasks = [];
  completedTasks = [];
  selectedTaskId = null;
  clearAllSections();

  // æ¸…æ‰è‡ªå‹•ç™»å…¥èˆ‡æˆ¿é–“
  localStorage.removeItem('todo_room_info');
  roomPath = "";

  // å˜—è©¦ç™»å‡ºï¼ˆè‹¥æ²’é–‹ Auth ä¹Ÿæ²’é—œä¿‚ï¼‰
  try { if (firebase.auth) await auth.signOut(); } catch(e){ /* å¿½ç•¥ */ }

  // åˆ‡å›ç™»å…¥é 
document.documentElement.classList.remove('show-app');
document.documentElement.classList.add('show-login');

  closeModal('logoutModal');
  closeModal('moreModal'); // é—œæ‰ã€Œâ‹¯ã€é¸å–®
}


  //å¿«å–
const v = Date.now(); // æ¯æ¬¡åˆ·æ–°éƒ½å¸¶å…¥å”¯ä¸€å€¼ï¼Œé¿é–‹å¿«å–
document.querySelectorAll('link[rel="icon"], link[rel="manifest"]').forEach(el => {
  if (el.href) {
    el.href += (el.href.includes('?') ? '&' : '?') + 'v=' + v;
  }
});
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js?v=' + v)
    .then(reg => console.log('SW è¨»å†ŠæˆåŠŸ', reg.scope))
    .catch(err => console.log('SW è¨»å†Šå¤±æ•—', err));
}

function getTitleWithFlag(t){
  return (t.important ? 'â— ' : '') + (t.title || '');
}

// è½‰æ°‘åœ‹ yyyy/m/d HH:mmï¼ˆå°æ™‚èˆ‡åˆ†é˜è£œ0ï¼‰
function formatRocDateTime(ts){
  if (!ts && ts !== 0) return '';                 // ç©ºå­—ä¸²ï¼ä¸é¡¯ç¤º
  const d = new Date(ts);
  if (isNaN(d)) return '';
  const y  = d.getFullYear() - 1911;
  const m  = d.getMonth() + 1;                    // ä¸è£œ0
  const dd = d.getDate();                         // ä¸è£œ0
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${y}/${m}/${dd} ${hh}:${mm}`;
}


function renderSections(list){
  const wrap = document.getElementById('section-container');
  // å…ˆé‡å»º doneMoreï¼ˆå›ºå®šåœ¨æœ€ä¸Šé¢ï¼‰
  wrap.innerHTML = `
    <div id="doneMore" style="display:none; text-align:right; margin:0.25rem 0;">
      <button id="doneMoreBtn" style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">ğŸ—‚ï¸</button>
      <div id="doneMonthMenu" style="display:none; position:absolute; right:16px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;"></div>
    </div>
  `;

  // ä¾ categories ç•«å‡ºå„åˆ†é¡
  list.forEach(name => {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.id = name;
    sec.innerHTML = `<div class="section-title">${name}</div>`;
    wrap.appendChild(sec);
  });

  updateSectionOptions();
  initSectionSortable();      // ä½ å·²æœ‰çš„å‡½å¼

  // é‡æ–°æ›ã€Œæ›´å¤šâ€¦ã€æŒ‰éˆ•çš„äº‹ä»¶ï¼ˆå› ç‚º innerHTML æœƒæ¸…æ‰èˆŠçš„äº‹ä»¶ï¼‰
  const btn = document.getElementById('doneMoreBtn');
  if (btn) btn.onclick = () => {
    const menu = document.getElementById('doneMonthMenu');
    if (menu) menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
  };

  // âœ… å¦‚æœé‚„åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé‡ç•«å¾Œé¦¬ä¸Šå¥—å›ç·¨è¼¯é…ä»¶
  if (isEditing) {
    decorateSectionsForEdit();
  }
}

function decorateSectionsForEdit() {
  const sections = document.querySelectorAll('.section');
  sections.forEach(section => {
    section.classList.add('edit-mode');

    const titleBar = section.querySelector('.section-title');
    const currentName = section.id;

    // å…ˆæ¸…ä¹¾æ·¨é¿å…é‡è¤‡ç–Š
    titleBar.innerHTML = '';

    // æ‹–æ‹‰æŠŠæ‰‹
    const drag = document.createElement('span');
    drag.className = 'drag-handle';
    drag.innerHTML = 'â˜°';
    titleBar.appendChild(drag);

    // åç¨±
    const nameSpan = document.createElement('span');
    nameSpan.className = 'section-name';
    nameSpan.style.marginLeft = '0.5rem';
    nameSpan.textContent = currentName;
    titleBar.appendChild(nameSpan);

    // é‡å‘½åï¼ˆâœï¼‰
    const renameBtn = document.createElement('button');
    renameBtn.className = 'rename-btn';
    renameBtn.innerHTML = 'âœ';
    renameBtn.onclick = () => openRenameModal(section.id);
    titleBar.appendChild(renameBtn);

    // åˆªé™¤ï¼ˆâœ•ï¼‰
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.innerHTML = 'âœ•';
    delBtn.onclick = () => confirmDeleteCategory(section.id);
    titleBar.appendChild(delBtn);
  });

  // é‡æ–°æ›æ‹–æ‹‰
  initSectionSortable();

  // é¡¯ç¤ºåº•éƒ¨ã€Œå®Œæˆç·¨è¼¯ã€æŒ‰éˆ•
  const exitBtn = document.getElementById('exitEditBtn');
  if (exitBtn) exitBtn.style.display = 'block';
}

// ===== æ»‘å‹•å®Œæˆï¼šç«‹å³å¯ç”¨ =====
(function initSlideToComplete(){
  const track = document.getElementById('slideComplete')?.querySelector('.slide-track') 
    || (function(){
      // å¦‚æœé‚„æ²’æ¸²æŸ“ detailModal å°±å…ˆç­‰ä¸€ä¸‹
      document.addEventListener('DOMContentLoaded', initSlideToComplete);
      return null;
    })();
  if (!track) return;

  const handle = document.getElementById('slideHandle');
  const fill = document.getElementById('slideFill');

  let dragging = false;
  let startX = 0;
  let startLeft = 0;

  function maxLeft() {
    // å¯æ»‘å‹•ç¯„åœï¼ˆå®¹å™¨å¯¬ - æŠŠæ‰‹å¯¬ - å…©å´é‚Šè· 3px*2ï¼‰
    const W = track.clientWidth;
    const hw = handle.clientWidth;
    return Math.max(0, W - hw - 6);
  }

  function setLeft(px) {
    const lim = maxLeft();
    const x = Math.max(0, Math.min(px, lim));
    handle.style.transform = `translateX(${x}px)`;
    const percent = Math.round((x / lim) * 100);
    fill.style.width = `${percent}%`;
    return percent;
  }

  function pointerDown(e){
    dragging = true;
    const p = e.touches ? e.touches[0] : e;
    startX = p.clientX;
    // è§£æç›®å‰ translateX
    const cur = handle.style.transform.match(/translateX\(([-\d.]+)px\)/);
    startLeft = cur ? parseFloat(cur[1]) : 0;
    e.preventDefault();
  }

  function pointerMove(e){
    if (!dragging) return;
    const p = e.touches ? e.touches[0] : e;
    const dx = p.clientX - startX;
    setLeft(startLeft + dx);
    e.preventDefault();
  }

  function pointerUp(){
    if (!dragging) return;
    dragging = false;
    const lim = maxLeft();
    // è®€ç›®å‰ translateX
    const cur = handle.style.transform.match(/translateX\(([-\d.]+)px\)/);
    const x = cur ? parseFloat(cur[1]) : 0;
    const percent = lim === 0 ? 0 : (x / lim);

    // åˆ° 90% ä»¥ä¸Šè¦–ç‚ºå®Œæˆ
    if (percent >= 0.9) {
      track.classList.add('done');
      setLeft(lim);
      // ç¨ç­‰ä¸€ä¸‹è®“å‹•ç•«æœ‰æ„Ÿè¦º
      setTimeout(() => {
        // å‘¼å«ä½ ç¾æœ‰çš„å®Œæˆæµç¨‹
        completeTask();
        // é‡ç½®å¤–è§€ï¼ˆä¸‹æ¬¡å†æ‰“é–‹ modal æ™‚æ˜¯åˆå§‹ç‹€æ…‹ï¼‰
        resetSlider();
      }, 200);
    } else {
      // å›å½ˆ
      handle.style.transition = 'transform .25s ease';
      fill.style.transition = 'width .25s ease';
      setLeft(0);
      setTimeout(() => {
        handle.style.transition = '';
        fill.style.transition = 'width .25s ease'; // ä¿ç•™ fill çš„å°éæ¸¡
      }, 260);
    }
  }

  function resetSlider(){
    track.classList.remove('done');
    handle.style.transition = 'transform .2s ease';
    fill.style.transition = 'width .25s ease';
    setLeft(0);
    setTimeout(() => {
      handle.style.transition = '';
    }, 220);
  }

  // å°å¤–æš´éœ²ï¼Œè®“ openDetail æ™‚å¯ä»¥é‡ç½®
  window.__resetSlideComplete = resetSlider;

  // ç¶å®šäº‹ä»¶ï¼ˆæ»‘é¼  + è§¸æ§ï¼‰
  handle.addEventListener('mousedown', pointerDown);
  document.addEventListener('mousemove', pointerMove);
  document.addEventListener('mouseup', pointerUp);

  handle.addEventListener('touchstart', pointerDown, {passive:false});
  document.addEventListener('touchmove', pointerMove, {passive:false});
  document.addEventListener('touchend', pointerUp);
})();

function closeFabMenu(){
  const m = document.getElementById('menu');
  const fab = document.querySelector('.fab');
  if (!m) return;
  m.classList.remove('show');
  if (fab) fab.classList.remove('open');
}

function toggleMenu(){
  const m = document.getElementById('menu');
  const fab = document.querySelector('.fab');
  if (!m || !fab) return;
  const willOpen = !m.classList.contains('show');
  m.classList.toggle('show', willOpen);
  fab.classList.toggle('open', willOpen);
}

// ğŸ”» å…¨åŸŸé»æ“Šï¼šé»åˆ° menu ä»¥å¤–ï¼Œå°±è‡ªå‹•é—œ
document.addEventListener('click', function(e){
  const menu = document.getElementById('menu');
if (!menu || !menu.classList.contains('show')) return;

  const fab = document.querySelector('.fab');
  const clickInsideMenu = menu.contains(e.target);
  const clickOnFab = fab && fab.contains(e.target);

  if (!clickInsideMenu && !clickOnFab) {
    closeFabMenu();
  }
});

// ï¼ˆå¯é¸ä½†æ¨è–¦ï¼‰è§¸æ§æ›´éˆæ•ï¼šæ‰‹æ©Ÿå…ˆé—œ
document.addEventListener('touchstart', function(e){
  const menu = document.getElementById('menu');
  if (!menu || menu.style.display !== 'flex') return;

  const fab = document.querySelector('.fab');
  const touchInsideMenu = menu.contains(e.target);
  const touchOnFab = fab && fab.contains(e.target);

  if (!touchInsideMenu && !touchOnFab) {
    closeFabMenu();
  }
}, {passive:true});

// ï¼ˆå¯é¸ï¼‰æŒ‰ ESC é—œ
document.addEventListener('keydown', function(e){
  if (e.key === 'Escape') closeFabMenu();
});

// âœ… äº‹ä»¶å§”æ´¾ï¼šé»åˆ°ä»»ä½•é–‹è‘—çš„ modal çš„ã€ŒèƒŒæ™¯å€ã€å°±é—œé–‰
document.addEventListener('click', function(e){
  // åªè™•ç†é»åœ¨ .modal ç¯„åœå…§çš„äº‹ä»¶
  const modal = e.target.closest('.modal');
  if (!modal) return;

  // åªé—œã€Œæœ‰é–‹è‘—ã€çš„ modalï¼ˆdisplay !== 'none'ï¼‰
  if (getComputedStyle(modal).display === 'none') return;

  const content = modal.querySelector('.modal-content');
  // é»åˆ°å…§å®¹æ¡†å¤–ï¼ˆ=èƒŒæ™¯é®ç½©ï¼‰æ‰é—œ
  if (!content || !content.contains(e.target)) {
    closeModal(modal.id);
  }
}, { passive: true });

// ï¼ˆå¯é¸ï¼‰æŒ‰ Esc é—œæ‰ç›®å‰æ‰€æœ‰é–‹è‘—çš„ modal
document.addEventListener('keydown', function(e){
  if (e.key !== 'Escape') return;
  document.querySelectorAll('.modal').forEach(m=>{
    if (getComputedStyle(m).display !== 'none') closeModal(m.id);
  });
});

function hideEmptySectionsAfterFilter(){
  const sections = document.querySelectorAll('#section-container .section');
  sections.forEach(sec => {
    const hasVisibleTask = Array.from(sec.querySelectorAll('.task'))
      .some(el => getComputedStyle(el).display !== 'none');
    sec.style.display = hasVisibleTask ? '' : 'none';
  });
}



let __autoLoginShownAt = 0;

function showAutoLoginOverlay(){
  const el = document.getElementById('autologin-overlay');
  if (!el) return;

  // ç­‰å…©å€‹ frameï¼Œç¢ºä¿ç€è¦½å™¨çœŸçš„å…ˆæŠŠ overlay ç•«å‡ºä¾†
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      __autoLoginShownAt = performance.now();
      el.classList.add('show');
      el.setAttribute('aria-hidden','false');

      // å¼·åˆ¶ä¸€æ¬¡ reflowï¼Œé¿å…åŒå¹€è¢«åˆä½µ
      // ï¼ˆæœ‰äº›ç€è¦½å™¨åœ¨æ¥µå¿«åˆ‡æ›æ™‚éœ€è¦ï¼‰
      void el.offsetHeight;
    });
  });
}

function hideAutoLoginOverlay(){
  const el = document.getElementById('autologin-overlay');
  if (!el) return;

  const minStay = 600; // è‡³å°‘é¡¯ç¤º 600msï¼Œæ¯” 300ms å†æ˜é¡¯ä¸€äº›
  const elapsed = performance.now() - __autoLoginShownAt;
  const delay = Math.max(0, minStay - elapsed);

  setTimeout(()=>{
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
  }, delay);
}

// ===== è‡ªå‹•ç™»å…¥çœ‹é–€ç‹—ï¼šè¶…æ™‚è‡ªæ•‘ =====
let autoLoginWD = null;

function startAutoLoginWatchdog(){
  stopAutoLoginWatchdog();
  autoLoginWD = setTimeout(runAutoLoginRescue, 2000); // 8 ç§’é‚„æ²’å¥½å°±æ•‘æ´
}

function stopAutoLoginWatchdog(){
  if (autoLoginWD){ clearTimeout(autoLoginWD); autoLoginWD = null; }
}

async function runAutoLoginRescue(){
  try {
    // === Soft retryï¼ˆæº«å’Œé‡è©¦ï¼‰===
    await waitOnline();
    try { if (auth.currentUser) await auth.signOut(); } catch(_){}
    try {
      // ä¾ç•¶ä¸‹ç’°å¢ƒå®‰å…¨è¨­å®šæŒä¹…æ€§
      const idbOK = await testIndexedDB();
      const mode = (isStandalone && idbOK)
        ? firebase.auth.Auth.Persistence.LOCAL
        : firebase.auth.Auth.Persistence.NONE;
      await auth.setPersistence(mode);
    } catch(_){}
    // 5 ç§’ä¿è­·è¶…æ™‚
    await Promise.race([
      auth.signInAnonymously(),
      new Promise((_, rej)=>setTimeout(()=>rej(new Error('soft-timeout')), 5000))
    ]);
    return; // æˆåŠŸå°±äº¤çµ¦ onAuthStateChanged å¾ŒçºŒåˆ‡ç•«é¢
  } catch(_e1) {
    // ç¹¼çºŒä¸‹é¢ Hard reset
  }

  try {
    // === Hard resetï¼ˆå¼·åˆ¶é‡é–‹ Firebase Appï¼‰===
    try { if (auth.currentUser) await auth.signOut(); } catch(_){}
    try { await firebase.app().delete(); } catch(_){}
    // é‡æ–°åˆå§‹åŒ–
    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db   = firebase.database();

    try {
      const idbOK = await testIndexedDB();
      const mode = (isStandalone && idbOK)
        ? firebase.auth.Auth.Persistence.LOCAL
        : firebase.auth.Auth.Persistence.NONE;
      await auth.setPersistence(mode);
    } catch(_){}

    await Promise.race([
      auth.signInAnonymously(),
      new Promise((_, rej)=>setTimeout(()=>rej(new Error('hard-timeout')), 5000))
    ]);
    return;
  } catch(_e2) {
    // === æœ€çµ‚ä¿åº•ï¼šçµ¦ä½¿ç”¨è€…æ‰‹å‹•ç™»å…¥ ===
    hideAutoLoginOverlay();
    document.documentElement.classList.remove('show-app');
    document.documentElement.classList.add('show-login');
    alert('è‡ªå‹•ç™»å…¥é€¾æ™‚ï¼Œè«‹æ‰‹å‹•ç™»å…¥ä¸€æ¬¡ï¼ˆå·²è‡ªå‹•é‡è¨­é€£ç·šï¼‰ã€‚');
  }
}

// ===== Section ç©ºç™½è™•ï¼šé•·æŒ‰æ–°å¢ï¼ˆä¸é˜»æ“‹æ²å‹•ï¼‰ï¼‹ è¼•é»å½ˆè·³ =====
(function enableCleanLongPressNewTask(){
  const PRESS_MS = 900;      // é•·æŒ‰é–€æª»ï¼ˆå¯èª¿ 700~1000ï¼‰
  const MOVE_TOL = 10;       // ä½ç§»é–€æª»ï¼ˆpxï¼‰
  const PRESS_VISUAL_DELAY = 100; // è¦–è¦ºå£“ä¸‹å»¶é²ï¼Œé¿å…ä¸€æ»‘å°±ç¸®

  const container = document.getElementById('section-container');
  if (!container) return;

  let timer = null, visualTimer = null;
  let startX = 0, startY = 0;
  let moved = false, longPressed = false;
  let pressSection = null;

  function isEligibleTarget(e){
    if (isEditing) return false;
    if (statusFilter === 'done') return false;
    const sec = e.target.closest('.section');
    if (!sec) return false;
    if (e.target.closest('.task')) return false;
    if (e.target.closest('.drag-handle')) return false;
    return sec;
  }

  function clearTimers(){
    if (timer){ clearTimeout(timer); timer = null; }
    if (visualTimer){ clearTimeout(visualTimer); visualTimer = null; }
  }

  function removePressVisual(){
    if (pressSection) pressSection.classList.remove('__pressed');
  }

  function pointerDown(e){
    const sec = isEligibleTarget(e);
    if (!sec) return;

    // ä¸è¦ preventDefaultï¼Œè®“ç€è¦½å™¨è‡ªç„¶åˆ¤æ–·è¦ä¸è¦æ²å‹•
    pressSection = sec;
    longPressed = false;
    moved = false;

    const p = e.touches ? e.touches[0] : e;
    startX = p.clientX; startY = p.clientY;

    clearTimers();

    // è¦–è¦ºå£“ä¸‹ï¼šå»¶é²ä¸€é»ï¼Œé¿å…ä¸€é–‹å§‹å°±ç¸®è€Œé€ æˆã€Œå¡ã€çš„éŒ¯è¦º
    visualTimer = setTimeout(()=>{
      pressSection && pressSection.classList.add('__pressed');
    }, PRESS_VISUAL_DELAY);

    // é•·æŒ‰è¨ˆæ™‚
    timer = setTimeout(()=>{
      longPressed = true;
      removePressVisual();
      clearTimers();
      if (!isEditing && statusFilter !== 'done') {
        try { closeFabMenu(); } catch(_){}
        openModal(pressSection?.id); // â˜… æŠŠè¢«é•·æŒ‰çš„ section é é¸é€²å»
      }
    }, PRESS_MS);
  }

  function pointerMove(e){
    if (!timer && !visualTimer) return;

    const p = e.touches ? e.touches[0] : e;
    const dx = Math.abs(p.clientX - startX);
    const dy = Math.abs(p.clientY - startY);

    // åªè¦ç§»å‹•è¶…éé–€æª»ï¼Œæˆ–æ˜é¡¯æ˜¯ã€Œå‚ç›´æ»‘å‹•ã€â†’ å–æ¶ˆé•·æŒ‰ï¼Œè®“æ²å‹•ç‚ºä¸»
    const verticalIntent = dy > dx + 2;
    if (dx > MOVE_TOL || dy > MOVE_TOL || verticalIntent){
      moved = true;
      clearTimers();
      removePressVisual();
    }
  }

  function pointerUpOrCancel(e){
    const wasLong = longPressed;
    clearTimers();
    // è‹¥çŸ­æŒ‰ä¸”æ²’ç§»å‹•å¤ªå¤š â†’ å°å½ˆè·³
    if (pressSection && !wasLong && !moved){
      // æŒ‰åˆ°çš„é‚„æ˜¯åŒä¸€å€‹ section æ‰å›é¥‹
      const stillOk = isEligibleTarget(e) === pressSection;
      if (stillOk){
        pressSection.classList.add('__bump');
        setTimeout(()=> pressSection && pressSection.classList.remove('__bump'), 200);
      }
    }
    removePressVisual();
    pressSection = null;
    moved = false;
    longPressed = false;
  }

  // ä¸å†æ”” contextmenuï¼›è‹¥ä½ çœŸçš„è¦å®Œå…¨é—œï¼Œå¯ä¿ç•™ä¸‹ä¸€è¡Œ
  // container.addEventListener('contextmenu', e => { if (isEligibleTarget(e)) e.preventDefault(); });

  // ç¶å®šï¼ˆæ»‘é¼  + è§¸æ§ï¼‰ï¼Œè§¸æ§ç›£è½æ”¹ç‚º passive:true ä»¥æå‡æ²å‹•é †æš¢
  container.addEventListener('mousedown', pointerDown);
  container.addEventListener('mousemove', pointerMove);
  document.addEventListener('mouseup', pointerUpOrCancel);

  container.addEventListener('touchstart', pointerDown, {passive:true});
  container.addEventListener('touchmove',  pointerMove, {passive:true});
  container.addEventListener('touchend',   pointerUpOrCancel, {passive:true});
  container.addEventListener('touchcancel',pointerUpOrCancel, {passive:true});
})();

function taskCardHTML(task, displayDays) {
  return `
    <div class="swipe-bar right"><span class="label">âœ… å·²å®Œæˆ</span></div>
    <div class="swipe-bar left"><span class="label">ğŸ—‘ ç§»é™¤</span></div>
    <div class="task-content">
      <div class="task-title">${getTitleWithFlag(task)}</div>
    </div>
    <div class="task-days">${displayDays}</div>
  `;
}

const V_SLOPE = 1.2;

function bindSwipeToTasks() {
  if (statusFilter === 'done') return;

  const BOUND = 0.75, H_START = 16, V_CANCEL = 10, DOMINANCE = 1.3, MAX_TILT = 3;

  document.querySelectorAll('.task').forEach(task => {
    if (task.dataset.swipeBound === '1') return;
    task.dataset.swipeBound = '1';

    // ä¸ç”¨ click é–‹è©³æƒ…ï¼Œä¿éšªèµ·è¦‹ä¹Ÿæ¸…æ‰
    task.onclick = null;

    const barR = task.querySelector('.swipe-bar.right'); // âœ… å·²å®Œæˆ
    const barL = task.querySelector('.swipe-bar.left');  // ğŸ—‘ ç§»é™¤
    const labR = barR?.querySelector('.label');
    const labL = barL?.querySelector('.label');

    let startX=0, startY=0, dx=0, dy=0, width=0;
    let mode = 'pending';   // 'pending' | 'swipe' | 'scroll'
    let isDown = false;
    let activePid = null;

    task.addEventListener('pointerdown', onDown);
    task.addEventListener('pointermove', onMove);
    task.addEventListener('pointerup', onUp);
    task.addEventListener('pointercancel', onCancel);
    task.addEventListener('lostpointercapture', onCancel);

    // åŒæ™‚ï¼ŒæŠŠä»»ä½• click éƒ½åæ‰ï¼ˆæˆ‘å€‘ä¸ç”¨ click äº†ï¼‰
    task.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopImmediatePropagation();
    }, true);

    function onDown(e){
      if (statusFilter === 'done') return;
      if (e.target.closest('button, input, select, textarea')) return;

      isDown = true;
      activePid = e.pointerId;
      startX = e.clientX;
      startY = e.clientY;
      dx = dy = 0;
      width = task.offsetWidth || 1;
      mode = 'pending';
      task.style.transition = 'none';
      try { task.setPointerCapture(e.pointerId); } catch(_) {}
    }

    function onMove(e){
      if (!isDown || e.pointerId !== activePid) return;
      if (mode === 'scroll') return;

      dx = e.clientX - startX;
      dy = e.clientY - startY;

      // æ˜é¡¯å‚ç›´ â†’ ç•¶æ²å‹•
   // åªåœ¨ã€Œå°šæœªæ±ºå®šã€ç‹€æ…‹æ‰å…è¨±è¢«åˆ¤å®šæˆæ²å‹•ï¼›ä¸€æ—¦é€²å…¥ swipe å°±ä¸è¢«ç¸±å‘æ‰“æ–·
if (mode === 'pending') {
  const adx = Math.abs(dx), ady = Math.abs(dy);
  // ç¸±å‘ä½ç§»è¶…éé–€æª»ï¼Œä¸”æ–œç‡çœ‹èµ·ä¾†æ¯”è¼ƒåƒåœ¨å‚ç›´æ²å‹•ï¼Œæ‰åˆ‡æˆ scroll
  if (ady > V_CANCEL && ady > adx * V_SLOPE) {
    mode = 'scroll';
    resetBars();
    task.style.transform = '';
    return;
  }
}

      if (mode === 'pending') {
        // é‚„æ²’é”åˆ°æ°´å¹³å•Ÿå‹•è·é›¢
        if (Math.abs(dx) < H_START) return;

        // æ°´å¹³å„ªå‹¢æ‰é€²å…¥ swipe
        if (Math.abs(dx) > Math.abs(dy) * DOMINANCE) {
          mode = 'swipe';
        } else {
          mode = 'scroll';
          return;
        }
      }

      if (mode !== 'swipe') return;

      const adx = Math.abs(dx);
      const pct = Math.min(1, adx / width);
      const tilt = (dx / width) * MAX_TILT;
      task.style.transform = `translateX(${Math.round(dx)}px) rotate(${tilt}deg)`;

      if (dx > 0) {
        if (barR) barR.style.width = (pct * 100) + '%';
        if (barL) barL.style.width = '0%';
        if (labR){ labR.style.opacity = Math.min(1, pct * 1.2); labR.style.transform = `translateX(${pct>0.05?0:-6}px)`; }
        if (labL){ labL.style.opacity = 0; labL.style.transform = 'translateX(6px)'; }
      } else if (dx < 0) {
        if (barL) barL.style.width = (pct * 100) + '%';
        if (barR) barR.style.width = '0%';
        if (labL){ labL.style.opacity = Math.min(1, pct * 1.2); labL.style.transform = `translateX(${pct>0.05?0:6}px)`; }
        if (labR){ labR.style.opacity = 0; labR.style.transform = 'translateX(-6px)'; }
      } else {
        resetBars();
      }
    }

    function onUp(e){ finish(e, false); }
    function onCancel(e){ finish(e, true); }

    function finish(e, cancel){
      const wasSwipe = (mode === 'swipe');
      const tapLike  = Math.abs(dx) < 4 && Math.abs(dy) < 4 && mode !== 'scroll';

      mode = 'pending';
      isDown = false;
      activePid = null;

      task.style.transition = 'transform .18s ease';
      task.style.transform = '';
      resetBars();

      // 1) çœŸæ­£çš„ã€Œé»ä¸€ä¸‹ã€æ‰é–‹è©³æƒ…ï¼ˆå®Œå…¨ä¸ç”¨ clickï¼‰
      if (!wasSwipe && !cancel && tapLike) {
        const id = task.dataset.id;
        if (id) openDetail(id);
        cleanup();
        return;
      }

      // 2) æœ‰æ»‘å‹•æ‰é€²å…¥é€™æ®µ
      if (!wasSwipe || cancel) { cleanup(); return; }

      const adx = Math.abs(dx);
      const passed = adx >= width * BOUND;
      const toRight = dx > 0;

if (passed) {
   const id = task.dataset.id;
   selectedTaskId = id; // ä¿ç•™ï¼ˆè©³æƒ…æ¨¡å¼ç”¨å¾—åˆ°ï¼‰
   setTimeout(() => {
     if (toRight) completeTask(id);
     else deleteTask();
   }, 10);
 }
      cleanup();
    }

    function cleanup(){
      dx = dy = 0;
      try { task.releasePointerCapture?.(activePid); } catch(_) {}
    }

    function resetBars(){
      if (barR) { barR.style.width = '0%'; if (labR){ labR.style.opacity = 0; labR.style.transform = 'translateX(-6px)'; } }
      if (barL) { barL.style.width = '0%'; if (labL){ labL.style.opacity = 0; labL.style.transform = 'translateX(6px)'; } }
    }
  });
}

(function mountTodayBadge(){
  const el = document.getElementById('today-badge');
  if (!el) return;

  const WEEK = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

  function fmtToday(){
    const now = new Date();
    const m = String(now.getMonth()+1);
    const d = String(now.getDate());
    const w = WEEK[now.getDay()];
    // æ¥µç°¡ã€ä¸çªå…€ï¼š8/11ï¼ˆé€±ä¸€ï¼‰
    return `${m}/${d}ï¼ˆ${w}ï¼‰`;
  }

  function render(){
    el.textContent = fmtToday();
  }

  function scheduleMidnightTick(){
    const now = new Date();
    const midnight = new Date(now);
    midnight.setHours(24,0,0,0);
    setTimeout(()=>{ render(); scheduleMidnightTick(); }, midnight - now);
  }

  render();
  scheduleMidnightTick();
})();

function setAppBgColor(color) {
        const body = document.body;
        if (color === "metal") {
          body.classList.add("bg-metal");
          document.documentElement.style.setProperty("--app-bg", "#ececec");
        } else {
          body.classList.remove("bg-metal");
          document.documentElement.style.setProperty("--app-bg", color);
        }
        try {
          localStorage.setItem("app_bg_fixed", color);
        } catch (_) {}
      }

function applySavedBgColor() {
  try {
    const saved = localStorage.getItem('app_bg_fixed');
    if (saved) setAppBgColor(saved);
  } catch(_) {}
}

document.addEventListener('DOMContentLoaded', applySavedBgColor);

document.addEventListener('click', function(e){
  if (e.target.classList.contains('color-btn')) {
    const color = e.target.dataset.color;
    setAppBgColor(color);
  }
});

let __expandedFieldId = null;

function toggleDetailExpand(fieldId, title){
  const form   = document.getElementById('detailForm');
  const viewer = document.getElementById('detailViewer');
  const vTitle = document.getElementById('viewerTitle');
  const vBody  = document.getElementById('viewerBody');

  // å…ˆç§»é™¤èˆŠç›£è½
  if (__expandedFieldId){
    const prev = document.getElementById(__expandedFieldId);
    if (prev && prev.__viewerSync){
      prev.removeEventListener('input', prev.__viewerSync);
      vBody.removeEventListener('input', vBody.__formSync);
      prev.__viewerSync = null;
      vBody.__formSync = null;
    }
  }

  // è‹¥å·²å±•é–‹ï¼Œå†å‘¼å« = ç¸®å°
  const willCollapse = (__expandedFieldId && (!fieldId || fieldId === __expandedFieldId));
  if (willCollapse){
    form.classList.remove('hide');
    viewer.classList.remove('show');
    __expandedFieldId = null;
    return;
  }

  // å±•é–‹ä¸¦å¡«å…¥å…§å®¹
  const src = document.getElementById(fieldId);
  vTitle.textContent = title || '';
  vBody.value = src ? (src.value || '') : '';
  viewer.classList.add('show');
  form.classList.add('hide');
  __expandedFieldId = fieldId;

  // é›™å‘åŒæ­¥
  if (src){
    // è¡¨å–® -> é–±è®€ç·¨è¼¯å™¨
    src.__viewerSync = () => { vBody.value = src.value || ''; };
    src.addEventListener('input', src.__viewerSync);

    // é–±è®€ç·¨è¼¯å™¨ -> è¡¨å–®
    vBody.__formSync = () => { src.value = vBody.value || ''; };
    vBody.addEventListener('input', vBody.__formSync);
  }
  // â˜… æ–°å¢ï¼ˆæ­·ç¨‹ï¼‰ï¼šåˆå§‹åŒ– undo/redo å †ç–Šï¼Œä¸¦ç›£è½è¼¸å…¥æ¨å…¥æ­·ç¨‹
  __viewerHistory = [vBody.value || ''];
  __viewerRedoStack = [];
  updateViewerToolbar();

  // å»æŠ–ï¼šé¿å…æ¯å€‹ key éƒ½ pushï¼ˆé€™è£¡ç”¨ç°¡æ˜“ç‰ˆï¼‰
  if (vBody.__histHandler) vBody.removeEventListener('input', vBody.__histHandler);
  let __histTimer = null;
  vBody.__histHandler = () => {
    clearTimeout(__histTimer);
    __histTimer = setTimeout(()=> pushViewerHistory(vBody.value || ''), 180);
  };
  vBody.addEventListener('input', vBody.__histHandler);
}

// === å®‰å…¨ no-opï¼Œé¿å…å‘¼å«æ™‚ç‚¸æ‰ ===
function bindDetailLiveSync(/* task */) { /* no-op: å…ˆä¸åšå³æ™‚åŒæ­¥ */ }
function unbindDetailLiveSync() { /* no-op */ }


function resetDetailPanels(){
  const form   = document.getElementById('detailForm');
  const viewer = document.getElementById('detailViewer');
  const vTitle = document.getElementById('viewerTitle');
  const vBody  = document.getElementById('viewerBody');

  // è§£é™¤å…ˆå‰å±•é–‹ç‹€æ…‹çš„é›™å‘åŒæ­¥ç›£è½
  if (window.__expandedFieldId){
    const prev = document.getElementById(__expandedFieldId);
    if (prev && prev.__viewerSync){
      prev.removeEventListener('input', prev.__viewerSync);
      prev.__viewerSync = null;
    }
    if (vBody && vBody.__formSync){
      vBody.removeEventListener('input', vBody.__formSync);
      vBody.__formSync = null;
    }
  }

  // â˜…â˜…â˜… æ–°å¢ï¼šæŠŠé–±è®€è¦–åœ–çš„ã€Œæ­·ç¨‹ç›£è½ã€èˆ‡å †ç–Šä¸€ä½µæ¸…æ‰ï¼Œä¸¦åˆ·æ–°å·¥å…·åˆ—æŒ‰éˆ•ç‹€æ…‹
  if (vBody && vBody.__histHandler){
    vBody.removeEventListener('input', vBody.__histHandler);
    vBody.__histHandler = null;
  }
  // é€™å…©å€‹è‹¥æ²’å®£å‘Šéï¼Œè«‹è¦‹ä¸‹æ–¹ã€Œå°è£œå……ã€
  __viewerHistory = [];
  __viewerRedoStack = [];
  updateViewerToolbar?.();

  // é—œé–‰é–±è®€è¦–åœ–ã€æ¢å¾©è¡¨å–®
  viewer?.classList.remove('show');
  form?.classList.remove('hide');

  // æ¸…ç©ºé–±è®€é¢æ¿å…§å®¹ï¼Œé¿å…æ®˜ç•™ä¸Šä¸€æ¬¡çš„æ–‡å­—
  if (vTitle) vTitle.textContent = '';
  if (vBody)  vBody.value = '';

  // æ¸…æ‰å±•é–‹ä¸­çš„æ¬„ä½è¨˜éŒ„
  window.__expandedFieldId = null;

  // æ»‘æ¡¿ä¹Ÿå›åˆ°åˆå§‹ï¼ˆé¿å…ä¸Šæ¬¡åœåœ¨ done ç‹€æ…‹ï¼‰
  if (window.__resetSlideComplete) window.__resetSlideComplete();
}
// â€”â€” èª¿è‰²ç›¤äº’å‹• â€”â€” //
let pendingColor = null;

function openPaletteModal(){
  // é–‹å•Ÿå‰å…ˆæ¸…é¸å–ã€ä¸¦ä¾ç›®å‰è¨­å®šé é¸
  const modal = document.getElementById('paletteModal');
  const tiles = modal.querySelectorAll('.palette-choice');
  tiles.forEach(t => t.classList.remove('selected'));

  // è®€å·²å„²å­˜é¡è‰²ï¼ˆèˆ‡ä½  setAppBgColor åŒæ­¥ï¼‰
  let cur = null;
  try { cur = localStorage.getItem('app_bg_fixed') || null; } catch(_){}
  // é‡‘å±¬æ¨¡å¼ä»¥ 'metal' å­˜ï¼Œå…¶ä»–ç‚ºè‰²ç¢¼ï¼›æ‰¾å¾—åˆ°å°±é é¸
  if (cur){
    const pre = Array.from(tiles).find(t => t.dataset.color === cur);
    if (pre) { pre.classList.add('selected'); pendingColor = cur; }
    else { pendingColor = cur; }
  } else {
    pendingColor = null;
  }

  modal.style.display = 'flex';
}

// æ‰“é–‹èª¿è‰²ç›¤
document.getElementById('openPaletteBtn')?.addEventListener('click', ()=>{
  openPaletteModal();
});

// é»è‰²å¡Šï¼šåªåˆ‡æ›é¸å–ï¼Œä¸ç«‹å³å¥—ç”¨
document.addEventListener('click', function(e){
  const btn = e.target.closest('.palette-choice');
  if (!btn) return;

  // äº’æ–¥é¸å–
  const wrap = document.getElementById('paletteModal');
  wrap.querySelectorAll('.palette-choice').forEach(t=>t.classList.remove('selected'));
  btn.classList.add('selected');
  pendingColor = btn.dataset.color || null;
});

// ç¢ºèªï¼šé€™æ™‚æ‰å¥—ç”¨é¡è‰²ï¼ˆå¾©ç”¨ä½ ç¾æˆçš„ setAppBgColorï¼‰
document.getElementById('paletteConfirmBtn')?.addEventListener('click', ()=>{
  if (pendingColor){
    setAppBgColor(pendingColor); // ä½ çš„å‡½å¼å·²æœƒåŒæ­¥è¨˜åˆ° localStorage
  }
  closeModal('paletteModal');
});

// ç”¨äº‹ä»¶å§”æ´¾ä¾†ç¶ï¼ˆä¸æ€•å…ƒç´ é‚„æ²’åœ¨ DOM è£¡ï¼‰
document.addEventListener('click', function(e){
  // æ‰“é–‹èª¿è‰²ç›¤
  if (e.target.id === 'openPaletteBtn') {
    openPaletteModal();
  }

  // ç¢ºèªé¸è‰²
  if (e.target.id === 'paletteConfirmBtn') {
    if (pendingColor) setAppBgColor(pendingColor);
    closeModal('paletteModal');
  }
});
function applyImportantFilter(){
  // åªåœ¨é–‹å•Ÿæ™‚ä½œç”¨ï¼›é—œé–‰æ™‚ä¸€å¾‹ç”± refreshCurrentView é‚„åŸ
  if (!importantOnly) return;

  // é€å¼µä»»å‹™å¡ï¼Œçœ‹å°æ‡‰è³‡æ–™æ˜¯ä¸æ˜¯ important
  document.querySelectorAll('#section-container .task').forEach(el => {
    const id = el.dataset.id;
    // å…ˆåœ¨é€²è¡Œä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°å†åˆ°å®Œæˆæ¸…å–®æ‰¾
    let t = tasks.find(x => x.id === id);
    if (!t) t = completedTasks.find(x => x.id === id);

    const isImportant = !!(t && t.important);
    // åªä¿ç•™é‡è¦ï¼›éé‡è¦å°±éš±è—ï¼ˆä¸å‹•åŸæœ¬æ’åº/é¡è‰²/å¤©æ•¸ï¼‰
    el.style.display = isImportant ? '' : 'none';
  });

  // å¥—å®Œæœ€å¾Œä¸€å±¤å¾Œï¼ŒæŠŠç©ºåˆ†é¡è—èµ·ä¾†ï¼ˆæ²¿ç”¨ä½ æ—¢æœ‰çš„è¦å‰‡ï¼‰
  hideEmptySectionsAfterFilter();
}

  </script>

<div id="check-success">
  <svg viewBox="0 0 52 52">
    <!-- æ–°å¢çš„ç™½åº• -->
    <circle cx="26" cy="26" r="25" fill="#fff"/>
    <!-- åŸæœ¬çš„å‹•ç•«åœˆèˆ‡å‹¾å‹¾ -->
    <circle class="circle" cx="26" cy="26" r="18" fill="none"/>
    <path class="check" fill="none" d="M14 27l7 7 16-16"/>
  </svg>
</div>


<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3 style="text-align: center;">æ˜¯å¦ç¢ºèªç§»é™¤æ­¤ä»»å‹™ï¼Ÿ</h3>
    <div class="confirm-buttons">
      <button class="confirm-btn" onclick="deleteTask()">ç¢ºèª</button>
      <button class="cancel-btn" onclick="closeModal('confirmModal')">è¿”å›</button>
    </div>
  </div>
</div>

<!-- âœ… ç™»å‡ºç¢ºèª modal è¦å’Œä¸Šé¢åŒä¸€å±¤ï¼Œåƒè¬ä¸è¦æ”¾åœ¨ confirmModal è£¡ -->
<div class="modal" id="logoutModal">
  <div class="modal-content">
    <h3 style="text-align:center;">æ˜¯å¦ç¢ºèªç™»å‡ºï¼Ÿ</h3>
    <div class="confirm-buttons">
      <button class="confirm-btn" onclick="doLogout()">ç¢ºèª</button>
      <button class="cancel-btn" onclick="closeModal('logoutModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div class="modal" id="categoryModal">
  <div class="modal-content">
<h3 style="text-align: center;">æ–°å¢åˆ†é¡</h3>
<input type="text" id="newCategoryName" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
    <div class="confirm-buttons">
      <button class="confirm-btn" onclick="addCategory()">ç¢ºèª</button>
      <button class="cancel-btn" onclick="closeModal('categoryModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>
<!-- é‡å‘½ååˆ†é¡ Modal -->
<div class="modal" id="renameModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('renameModal')">âœ•</button>
    <h3 style="text-align:center;">é‡æ–°å‘½ååˆ†é¡</h3>
    <input type="text" id="renameInput" placeholder="è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±" />
    <div class="confirm-buttons">
      <button class="confirm-btn" onclick="confirmRename()">ç¢ºèª</button>
      <button class="cancel-btn" onclick="closeModal('renameModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>




<!-- æ›´å¤šåŠŸèƒ½ Modal -->
<div class="modal" id="moreModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('moreModal')">âœ•</button>
    <h3>ç¯©é¸å‰©é¤˜å¤©æ•¸</h3>
<div class="filter-days">
  <label><input type="radio" name="daysFilter" value="1"> 1</label>
  <label><input type="radio" name="daysFilter" value="3"> 3</label>
  <label><input type="radio" name="daysFilter" value="5"> 5</label>
  <label><input type="radio" name="daysFilter" value="all"> ä¸é™</label>
  <label><input type="radio" name="daysFilter" value="default" checked> é è¨­</label>
</div>
<h3>ä»»å‹™ç‹€æ…‹</h3>
<div class="filter-status">
  <label><input type="radio" name="statusFilter" value="ongoing" checked> é€²è¡Œä¸­</label>
  <label><input type="radio" name="statusFilter" value="done"> å·²å®Œæˆ</label>
  <!-- âœ… æ–°å¢ï¼šé‡è¦é–‹é—œï¼ˆæœ€å¾Œä¸€å±¤ç¯©é¸ï¼‰ -->
  <label class="important-only" title="åªçœ‹â—é‡è¦">
    <input type="checkbox" id="importantOnly"> â—
  </label>
</div>
<h3>å¤©æ•¸è¨­å®š</h3>
<div class="filter-mode">
  <label><input type="radio" name="dayMode" value="work" checked> å·¥ä½œå¤©</label>
  <label><input type="radio" name="dayMode" value="calendar"> æ—¥æ›†å¤©</label>
</div>
<h3>æ›´æ›åº•è‰²</h3>
<button id="openPaletteBtn" class="palette-btn">ğŸ¨ èª¿è‰²ç›¤</button>
<hr style="margin:1rem 0;border:none;border-top:1px solid #eee;">
<button class="logout-btn" style="font-weight:bold;" onclick="openLogoutModal()">ç™»å‡º</button>

  </div>
</div>

<!-- è‡ªå‹•ç™»å…¥è¼‰å…¥ä¸­ -->
<div id="autologin-overlay" aria-hidden="true">
  <div class="autologin-box">
    <div class="autologin-loader"></div>
    <div class="autologin-text">è‡ªå‹•ç™»å…¥ä¸­â€¦</div>
  </div>
</div>
<div class="modal" id="welcomeModal">
  <div class="modal-content" style="text-align:left; line-height:1.6;">
    <h3 style="text-align:center;">ğŸ‘‹ æ­¡è¿ä½¿ç”¨ MyTask</h3>
    <ol style="padding-left:1.2rem; margin-top:0.8rem;">
      <li>å³ä¸‹ã€Œï¼‹ã€æ–°å¢ä»»å‹™æˆ–åˆ†é¡</li>
      <li>é•·æŒ‰åˆ†é¡ç©ºç™½è™•ï¼Œå¯å¿«é€Ÿæ–°å¢</li>
      <li>é»ã€Œä»»å‹™ã€å¯æŸ¥çœ‹/ç·¨è¼¯å…§å®¹</li>
      <li>å³æ»‘ã€Œä»»å‹™ã€å¿«é€Ÿå®Œæˆ/å·¦æ»‘ç§»é™¤</li>
      <li>å·¦ä¸Šã€Œâ‹¯ã€å¯åˆ‡æ›ç¯©é¸æ¢ä»¶ç­‰åŠŸèƒ½</li>
      <li style="font-weight:bold; color:#ff5121;">é»æ“Šã€ŒMyTaskã€åˆ‡æ›ã€Œå‚™å¿˜æ¨¡å¼ã€</li>
<li style="font-weight:bold; color:#007BFF;">æ–°å¢ç¬¬ä¸€å€‹ã€Œåˆ†é¡ã€é–‹å§‹ä½¿ç”¨ï¼</li>
    </ol>
    <button class="confirm-btn" style="margin-top:1rem; width:100%;" onclick="closeModal('welcomeModal')">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<!-- èª¿è‰²ç›¤ Modal -->
<div class="modal" id="paletteModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('paletteModal')">âœ•</button>
    <h3 style="text-align:center;">é¸æ“‡åº•è‰²</h3>

    <div class="palette-grid" id="paletteGrid" style="margin-top:.5rem;">
      <!-- æ¯å€‹è‰²å¡Šç”¨ data-color æ¨™è¨˜ -->
      <button class="palette-choice" data-color="#f6fbfe" title="é è¨­"></button>
      <button class="palette-choice" data-color="#f3fcf8" title="æ·ºç¶ "></button>
      <button class="palette-choice" data-color="#fffcf3" title="æ·ºé»ƒ"></button>
      <button class="palette-choice" data-color="#fef6f9" title="æ·ºç²‰"></button>
      <button class="palette-choice" data-color="#f9f8fd" title="æ·¡ç´«"></button>
      <button class="palette-choice" data-color="#ffeded" title="æ·ºæ£•"></button>
      <button class="palette-choice" data-color="#fff8f5" title="æ·ºæ©˜"></button>
      <button class="palette-choice" data-color="#fdfcf9" title="ç±³ç™½"></button>
      <button class="palette-choice" data-color="metal"  title="éµç°ï¼ˆé‡‘å±¬ï¼‰">
        <span class="metal-sheen"></span>
      </button>
    </div>

    <div class="confirm-buttons" style="margin-top:1rem;">
      <button class="confirm-btn" id="paletteConfirmBtn">ç¢ºèª</button>
      <button class="cancel-btn" onclick="closeModal('paletteModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>
</body>
</html>