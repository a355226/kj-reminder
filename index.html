<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<!-- Firebase SDK (compat ç‰ˆï¼Œæœ€ç°¡å–®æ¥) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
Â Â <meta charset="UTF-8">
Â Â <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="reminder.png">
<link rel="apple-touch-icon" sizes="180x180" href="reminder.png">
<link rel="manifest" href="manifest.json">

Â Â <title>MyTask</title>
Â Â <style>
/* å…¨åŸŸè¼¸å…¥å…ƒä»¶å­—é«”å¤§å° */
input, select, textarea, option {
Â Â font-size: 16px; Â  Â  /* æ¨è–¦æ‰‹æ©Ÿå®‰å…¨å­—é«”å¤§å°ï¼Œé¿å… iOS è‡ªå‹•æ”¾å¤§ */
Â Â line-height: 1.4;Â  Â  /* è¡Œé«˜ç¨å¾®åŠ é«˜ä¸€é»ï¼Œé–±è®€æ›´èˆ’æœ */
}
button {
Â Â font-size: 15px;
}

Â Â Â Â :root {
Â Â Â Â Â Â --blue-light: #ebf5fc;
Â Â Â Â Â Â --green-light: #e6f9f0;
Â Â Â Â Â Â --yellow-light: #fffbe6;
Â Â Â Â Â Â --white: #ffffff;
Â Â Â Â Â Â --gray-text: #444;
Â Â Â Â Â Â --urgent-color: #ffeaea;
Â Â Â Â }
Â Â Â Â * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
Â Â Â Â body {
Â Â Â Â Â Â margin: 0; padding: 1rem; background-color: var(--blue-light);
Â Â Â Â Â Â color: var(--gray-text); display: flex; justify-content: center;
Â Â Â Â }
Â Â Â Â .container { width: 100%; max-width: 480px; position: relative; }
Â Â Â Â h1 { text-align: center; margin-bottom: 1rem; }
Â Â Â Â .section {
Â Â Â Â Â Â background-color: #fcffff; border-radius: 12px;
Â Â Â Â Â Â box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
Â Â Â Â Â Â padding: 1rem; margin-bottom: 1rem;
Â Â Â Â }
Â Â Â Â .section-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
Â Â Â Â .task {
Â Â Â Â Â Â display: flex; justify-content: space-between; align-items: center;
Â Â Â Â Â Â background-color: var(--yellow-light); padding: 0.75rem 1rem;
Â Â Â Â Â Â border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;
Â Â Â Â }
Â Â Â Â .task-content { flex: 1; }
Â Â Â Â .task-title { font-size: 1.2rem;font-weight: 600; margin-bottom: 0.25rem; }
Â Â Â Â .task-due { font-size: 0.85rem; color: #888; }
Â Â Â Â .task-days {
Â Â Â Â Â Â background-color: var(--yellow-light); color: brown;
Â Â Â Â Â Â border-radius: 50%; padding: 0.4rem 0.6rem; font-size: 0.85rem;
Â Â Â Â Â Â font-weight: bold; flex-shrink: 0; text-align: center; margin-left: 1rem;
Â Â Â Â }
Â Â Â Â .fab {
Â Â Â Â Â Â position: fixed; bottom: 24px; right: 24px; width: 40px; height: 40px;
Â Â Â Â Â Â background-color: #00aaff; color: white; border-radius: 50%; font-size: 32px;
Â Â Â Â Â Â display: flex; align-items: center; justify-content: center;
Â Â Â Â Â Â cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 10;
Â Â Â Â }
Â Â Â Â .menu {
Â Â Â Â Â Â position: fixed; bottom: 90px; right: 24px; background-color: white;
Â Â Â Â Â Â border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
Â Â Â Â Â Â display: none; flex-direction: column; z-index: 9;
Â Â Â Â }
Â Â Â Â .menu button {
Â Â Â Â Â Â border: none; background: none; padding: 12px 16px;
Â Â Â Â Â Â font-size: 14px; text-align: left; cursor: pointer;
Â Â Â Â }

Â Â Â Â .modal {
Â Â Â Â Â Â position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
Â Â Â Â Â Â background-color: rgba(0, 0, 0, 0.3); display: none;
Â Â Â Â Â Â justify-content: center; align-items: center; z-index: 20;
Â Â Â Â }
Â Â Â Â .modal-content {
Â Â Â Â Â Â background-color: white; padding: 1rem; border-radius: 12px;
Â Â Â Â Â Â width: 90%; max-width: 400px; position: relative;
Â Â Â Â }
Â Â Â Â .modal-content label { display: block; margin-top: 0.5rem; font-size: 0.9rem; }
/* åªçµ¦è¼¸å…¥æ¡†/ä¸‹æ‹‰/æ–‡å­—å€ï¼Œæ’é™¤ radio & checkbox */
.modal-content input:not([type="radio"]):not([type="checkbox"]),
.modal-content select,
.modal-content textarea {
Â Â width: 100%;
Â Â padding: 0.5rem;
Â Â margin-top: 0.25rem;
Â Â border: 1px solid #ccc;
Â Â border-radius: 6px;
}

//å„²å­˜æŒ‰éˆ•
.save-btn {
Â Â background-color: #009973;
Â Â color: white;
Â Â border: none;
Â Â padding: 0.5rem;
Â Â border-radius: 6px;
Â Â cursor: pointer;
Â Â margin-bottom: 0.5rem;
Â Â width: 100%;
}
.save-btn:hover {
Â Â background-color: #008060;
}

.modal-content > button {
Â Â margin-top: 1rem;
Â Â width: 100%;
Â Â padding: 0.5rem;
Â Â background-color: #00aaff;
Â Â color: white;
Â Â border: none;
Â Â border-radius: 6px;
Â Â cursor: pointer;
}


.save-btn-half, .delete-btn-half {
Â Â flex: 1;
Â Â padding: 0.5rem;
Â Â border-radius: 6px;
Â Â cursor: pointer;
Â Â width: 50%;
Â Â border: none;
}

.save-btn-half {
Â Â background-color: #77d4bc;
Â Â color: white;
}
.save-btn-half:hover {
Â Â background-color: #008060;
}

.delete-btn-half {
Â Â background-color: #fc9a9a;
Â Â color: white;
}
.delete-btn-half:hover {
Â Â background-color: #cc3333;
}

.close-btn {
Â Â position: absolute;
Â Â top: 12px;
Â Â right: 12px;
Â Â width: 28px;
Â Â height: 28px;
Â Â padding: 0;
Â Â margin: 0;
Â Â border: none;
Â Â border-radius: 50%;
Â Â background-color: #eee;
Â Â color: #333;
Â Â font-size: 16px;
Â Â font-weight: bold;
Â Â display: flex;
Â Â align-items: center;
Â Â justify-content: center;
Â Â cursor: pointer;
}

.modal-content > .close-btn {
Â Â width: auto;
}

#check-success {
Â Â position: fixed;
Â Â top: 50%;
Â Â left: 50%;
Â Â transform: translate(-50%, -50%);
Â Â z-index: 9999;
Â Â width: 100px;
Â Â height: 100px;
Â Â opacity: 0;
Â Â pointer-events: none;
}

#check-success.show {
Â Â animation: pop-in 1.5s ease forwards;
}

#check-success svg {
Â Â width: 100px;
Â Â height: 100px;
}

.circle {
Â Â stroke: #a2f4c5;
Â Â stroke-width: 4;
Â Â stroke-dasharray: 157;
Â Â stroke-dashoffset: 157;
Â Â animation: draw-circle 0.5s ease-out forwards;
}

.check {
Â Â stroke: #2ecc71;
Â Â stroke-width: 5;
Â Â stroke-linecap: round;
Â Â stroke-linejoin: round;
Â Â stroke-dasharray: 30;
Â Â stroke-dashoffset: 30;
Â Â animation: draw-check 0.3s 0.5s ease-out forwards;
}

@keyframes draw-circle {
Â Â to {
Â Â Â Â stroke-dashoffset: 0;
Â Â }
}

@keyframes draw-check {
Â Â to {
Â Â Â Â stroke-dashoffset: 0;
Â Â }
}

@keyframes pop-in {
Â Â 0% {
Â Â Â Â opacity: 0;
Â Â Â Â transform: translate(-50%, -50%) scale(0.5);
Â Â Â Â filter: blur(4px);
Â Â }
Â Â 40% {
Â Â Â Â opacity: 1;
Â Â Â Â transform: translate(-50%, -50%) scale(1.1);
Â Â Â Â filter: blur(0);
Â Â }
Â Â 80% {
Â Â Â Â transform: translate(-50%, -50%) scale(1);
Â Â }
Â Â 100% {
Â Â Â Â opacity: 0;
Â Â Â Â transform: translate(-50%, -50%) scale(0.8);
Â Â }
}
.confirm-buttons {
Â Â display: flex;
Â Â gap: 0.75rem;
Â Â margin-top: 1.5rem;
}

.confirm-buttons button {
Â Â flex: 1;
Â Â padding: 0.6rem;
Â Â font-size: 1rem;
Â Â font-weight: bold;
Â Â border: none;
Â Â border-radius: 6px;
Â Â cursor: pointer;
Â Â transition: all 0.2s ease;
}

.confirm-btn {
Â Â background-color: #fc9a9a;
Â Â color: white;
}
.confirm-btn:hover {
Â Â background-color: #cc4444;
}

.cancel-btn {
Â Â background-color: #f0f0f0;
Â Â color: #333;
}
.cancel-btn:hover {
Â Â background-color: #ddd;
}

//ç·¨è¼¯åˆ†é¡ç”¨
.section.edit-mode {
Â Â position: relative;
Â Â padding-left: 2.5rem;
}

.section-title {
Â Â position: relative; /* æ–°å¢é€™ä¸€è¡Œè®“å…§éƒ¨çµ•å°å®šä½ç”Ÿæ•ˆ */
Â Â font-size: 1.2rem;
Â Â font-weight: bold;
Â Â margin-bottom: 0.5rem;
}

.drag-handle {
Â Â display: inline-block;
Â Â margin-right: 0.5rem;
Â Â font-size: 1.2rem;
Â Â cursor: grab;
Â Â color: #888;
Â Â vertical-align: middle;
}


.delete-btn {
Â Â position: absolute;
Â Â top: 0;
Â Â right: 0;
Â Â background-color: transparent;
Â Â border: none;
Â Â font-size: 1rem;
Â Â color: #999;
Â Â cursor: pointer;
Â Â display: none;
}
.section.edit-mode .delete-btn {
Â Â display: block;
}

.section.dragging {
Â Â opacity: 0.5;
Â Â background-color: transparent !important;
}

.dragging {
Â Â opacity: 0.6;
Â Â background: #eef8ff;
}


/* é‡å‘½åæŒ‰éˆ• */
/* è®“æ¨™é¡Œæˆä¸€è¡Œæ’åˆ—ï¼šâ˜°ã€æ¨™é¡Œæ–‡å­—ã€âœï¼ˆåˆªé™¤éµä¾ç„¶åœ¨å³ä¸Šè§’çµ•å°å®šä½ï¼‰ */
.section-title {
Â Â display: flex;
Â Â align-items: center;
Â Â gap: 0.5rem;
}

/* é‰›ç­†è·Ÿåœ¨æ¨™é¡Œæ–‡å­—å¾Œæ–¹ï¼ˆä¸è¦çµ•å°å®šä½ï¼‰ */
.rename-btn {
Â Â position: static; Â  Â  Â  Â  Â  /* é‡è¦ï¼šå–æ¶ˆåŸæœ¬çš„ absolute */
Â Â display: none;Â  Â  Â  Â  Â  Â  Â  /* åªæœ‰ç·¨è¼¯æ¨¡å¼æ‰é¡¯ç¤º */
Â Â background: transparent;
Â Â border: none;
Â Â font-size: 1rem;
Â Â color: #999;
Â Â cursor: pointer;
Â Â margin-left: 0.8rem;
transform: translateY(-2.2px); /* â¬† å¾€ä¸Š 2pxï¼Œå¯è‡ªè¡Œèª¿æ•´ */
Â Â padding: 0; Â  Â  Â  Â  Â  Â  Â  Â  /* å–æ¶ˆå°æ–¹å¡Šå¤–æ¡†æ„Ÿ */
}
.section.edit-mode .rename-btn { display: inline-flex; }

/* æ›´å¤šåŠŸèƒ½ï¼ˆä¿®æ­£å¾Œï¼‰*/
/* å³ä¸Šè§’ ... æŒ‰éˆ• */
.more-btn {
Â Â position: fixed;
Â Â top: 12px;
Â Â right: 12px;
Â Â width: 32px;Â  Â  Â  /* ç¸®å°å¯¬ */
Â Â height: 32px; Â  Â  /* ç¸®å°é«˜ */
Â Â border-radius: 50%;
Â Â background: #fff;
Â Â color: #555;
Â Â font-size: 18px;Â  /* å­—é«”ä¹Ÿç¸®å° */
Â Â font-weight: bold;
Â Â display: flex;
Â Â align-items: center;Â  Â  /* å‚ç›´ç½®ä¸­ */
Â Â justify-content: center;/* æ°´å¹³ç½®ä¸­ */
Â Â box-shadow: 0 2px 6px rgba(0,0,0,0.15);
Â Â cursor: pointer;
Â Â z-index: 100;
Â Â line-height: 1; Â  Â  Â  Â  /* ç¢ºä¿æ–‡å­—å‚ç›´å±…ä¸­ */
}



/* æ›´å¤šåŠŸèƒ½ Modal */
#moreModal .modal-content {
Â Â max-width: 300px;
}
.filter-days {
Â Â display: flex;
Â Â flex-wrap: wrap;
Â Â gap: 0.5rem;
Â Â margin-top: -1rem;
}
.filter-days label {
Â Â display: flex;
Â Â align-items: center;
Â Â gap: 0.3rem;
Â Â font-size: 0.9rem;
}

/* æ­·å²ç´€éŒ„ */
.filter-status {
Â Â display: flex;
Â Â gap: 1rem;Â Â Â Â 
Â Â margin-top: -1rem; Â  Â  Â  Â  Â  /* å…©å€‹é¸é …ä¹‹é–“çš„è·é›¢ */
}

.filter-status label {
Â Â display: inline-flex;Â  Â  /* é—œéµï¼šè®“â—‹å’Œæ–‡å­—åœ¨åŒä¸€è¡Œ */
Â Â align-items: center;
Â Â gap: 0.25rem;Â  Â  Â  Â  Â  Â  /* â—‹ å’Œæ–‡å­—è·é›¢ */
Â Â white-space: nowrap; Â  Â  /* ç¦æ­¢æ–‡å­—æ›è¡Œ */
}

/* å¤©æ•¸è¨­å®š */
.filter-mode {
Â Â display: flex;
Â Â gap: 1rem;Â  Â  Â  Â  Â  /* é¸é …ä¹‹é–“è·é›¢ */
Â Â margin-top: -1rem;Â  /* è·Ÿä¸Šæ–¹æ¨™é¡Œçš„è·é›¢å¯ä¾éœ€æ±‚èª¿æ•´ */
}

.filter-mode label {
Â Â display: inline-flex; Â  Â  /* â—‹ å’Œæ–‡å­—åŒä¸€è¡Œ */
Â Â align-items: center;
Â Â gap: 0.25rem; Â  Â  Â  Â  Â  Â  /* â—‹ å’Œæ–‡å­—è·é›¢ */
Â Â white-space: nowrap;Â  Â  Â  /* ç¦æ­¢æ›è¡Œ */
}

.logout-btn{
Â Â width:100%;
font-size:15px;
Â Â padding:0.6rem;
Â Â background:#f5f5f5;
Â Â color:#333;
Â Â border:none;
Â Â border-radius:6px;
Â Â cursor:pointer;
}
.logout-btn:hover{ background:#eee; }

/* çµ±ä¸€æŠŠæ‰€æœ‰ modal è“‹åœ¨é é¢ä¸Š */
.modal { z-index: 200; }

/* â‹¯ é¸å–®çš„å±¤ç´šç¨ä½ä¸€é» */
#moreModal { z-index: 180; }

/* ç™»å‡ºç¢ºèªå†é«˜ä¸€é»ï¼Œç¢ºä¿æ°¸é åœ¨æœ€ä¸Šé¢ */
#logoutModal { z-index: 220; }

/* ç™»å…¥CSS */
#loginPage{
Â Â display:flex;
Â Â flex-direction:column;
Â Â align-items:center;
Â Â justify-content:center;
Â Â min-height:100vh;
Â Â background:var(--blue-light);
}

/* ç™½è‰²å¡ç‰‡ï¼šé€™è£¡æ§åˆ¶å¯¬åº¦ã€åœ“è§’ã€é™°å½±ã€å…§è· */
#loginCard{
Â Â position: absolute !important; /* ç„¡è¦–å‰é¢è¨­å®š */
Â Â top: 80px;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* å¾€ä¸Š 20pxï¼Œä½ å¯ä»¥æ”¹ */
Â Â left: 50%;
Â Â transform: translateX(-50%);Â  Â  /* æ°´å¹³ç½®ä¸­ */
Â Â background:var(--white);
Â Â border-radius:12px;Â  Â  Â  Â  Â  /* â† å¡ç‰‡åœ“è§’ */
Â Â box-shadow:0 2px 6px rgba(0,0,0,0.08); /* â† å¡ç‰‡é™°å½± */
Â Â padding:2rem;Â  Â  Â  Â  Â  Â  Â  Â  /* â† å¡ç‰‡å…§è· */
Â Â width:95%;
Â Â max-width:450px;
min-height: 500px; /* æœ€å°é«˜åº¦ï¼Œå…§å®¹è¶…éæ™‚æœƒè‡ªå‹•è®Šé«˜ */

}

/* æ¨™é¡Œ */
.login-title{
Â Â text-align:center;
Â Â margin:0 0 1.5rem;
Â Â font-size:28px;Â  Â  Â  Â  Â  Â  Â  /* â† æ¨™é¡Œå¤§å° */
Â Â font-weight:800;
}

/* label èˆ‡æ¬„ä½çš„é–“è· */
.login-label{
Â Â font-weight:600;
Â Â margin:0.4rem 0 0.4rem;
}

/* è¼¸å…¥æ¡†å¤–è§€ï¼šé«˜åº¦ã€å­—é«”ã€åœ“è§’ã€é‚Šæ¡† */
.login-input{
Â Â width:100%;
Â Â height:44px; Â  Â  Â  Â  Â  Â  Â  Â  /* â† æ¬„ä½é«˜åº¦ */
Â Â padding:0 12px;Â  Â  Â  Â  Â  Â  Â  /* â† æ–‡å­—å·¦å³å…§è· */
Â Â border:1px solid #ccc;
Â Â border-radius:8px; Â  Â  Â  Â  Â  /* â† æ¬„ä½åœ“è§’ */
Â Â font-size:16px;Â  Â  Â  Â  Â  Â  Â  /* â† æ¬„ä½å­—é«”å¤§å° */
Â Â margin:0 0 1rem;
margin-top:0.8rem;
Â Â outline:none;
}
.login-input:focus{
Â Â border-color:#95d3ff;
Â Â box-shadow:0 0 0 3px rgba(0,170,255,.15);
}

/* å‹¾é¸åˆ—ï¼ˆcheckbox èˆ‡æ–‡å­—åœ¨åŒä¸€è¡Œï¼‰ */
.login-checkrow{
Â Â display:flex;
Â Â align-items:center;
Â Â gap:.4rem;
Â Â margin:0 0 1rem;
}

/* ç™»å…¥æŒ‰éˆ•å¤–è§€èˆ‡äº’å‹• */
.login-btn{
Â Â width:100%;
Â Â height:46px; Â  Â  Â  Â  Â  Â  Â  Â  /* â† æŒ‰éˆ•é«˜åº¦ */
Â Â background:#00aaff;Â  Â  Â  Â  Â  /* â† æŒ‰éˆ•ä¸»è‰² */
Â Â color:#fff;
Â Â border:none;
Â Â border-radius:8px; Â  Â  Â  Â  Â  /* â† æŒ‰éˆ•åœ“è§’ */
Â Â font-size:16px;
Â Â cursor:pointer;
}
.login-btn:hover{ background:#0791e6; }
.login-btn:active{ transform:translateY(1px); }

/* åº•ä¸‹ç´…è‰²æç¤º */
.login-tip{
Â Â margin-top:1rem;
Â Â color:#cc4444;
Â Â font-size:0.85rem; Â  Â  Â  Â  Â  /* â† æç¤ºæ–‡å­—å¤§å° */
Â Â text-align:center;
}

/* å¯é¸ï¼šå°è¢å¹•å†ç¸®ä¸€é» padding */
@media (max-width:360px){
Â Â #loginCard{ padding:1.25rem; }
}

/* å€å¡Šåˆ†é¡ + é‡è¦ å‹¾é¸ åŒè¡Œæ’ç‰ˆ */
.inline-row {
Â Â display: flex;
Â Â align-items: center;
Â Â gap: .75rem;
Â Â margin-top: .25rem; Â  Â  /* èˆ‡ä¸Šæ–¹ label çš„è·é›¢ */
}

/* ä¸‹æ‹‰é¸å–®ç¸®åˆ°ä¸€åŠå¯¬ã€é å·¦ */
.inline-row .half {
Â Â width: 50%;
Â Â min-width: 160px; Â  Â  Â  /* è¦–éœ€è¦å¯èª¿æˆ–æ‹¿æ‰ */
}

/* å‹¾é¸çš„å¤–è§€ */
.important-flag {
Â Â display: inline-flex;
Â Â align-items: center;
Â Â gap: .35rem;
Â Â white-space: nowrap;
Â Â font-size: 0.95rem;
}
.drag-handle{
Â Â cursor: grab;
Â Â touch-action: none;Â  Â  Â  Â  Â  /* é‡é»ï¼šé˜»æ­¢é è¨­æ²å‹• */
Â Â -webkit-user-select: none; Â  /* iOS ä¸è¦é¸å­— */
Â Â user-select: none;
Â Â -webkit-user-drag: none;
}
/* å¯é¸ï¼šå…§å®¹å€ä»å¯ä¸Šä¸‹æ²å‹• */
.section { touch-action: pan-y; }


/* æ»‘å‹•å®Œæˆï¼ˆè—è‰²åŸºåº•ï¼‰ */
.slide-complete {
Â Â margin-top: .75rem;
}

.slide-track {
Â Â position: relative;
Â Â height: 44px;
Â Â border-radius: 999px;
Â Â background: linear-gradient(0deg, #e8f4ff, #f4faff);
Â Â border: 1px solid #d6eaff;
Â Â overflow: hidden;
Â Â box-shadow: inset 0 1px 2px rgba(0,0,0,.05);
Â Â -webkit-user-select: none;
Â Â user-select: none;
Â Â touch-action: none;
}

.slide-fill {
Â Â position: absolute;
Â Â inset: 0 auto 0 0;
Â Â width: 0%;
Â Â background: linear-gradient(90deg, #77c7ff, #00aaff);
Â Â opacity: .25;
Â Â transition: width .25s ease;
Â Â pointer-events: none;
}

.slide-hint {
Â Â position: absolute;
Â Â inset: 0;
Â Â display: flex;
Â Â align-items: center;
Â Â justify-content: center;
Â Â color: #449ad6;
Â Â font-weight: 600;
Â Â letter-spacing: .5px;
Â Â pointer-events: none;
}

.slide-handle {
Â Â position: absolute;
Â Â top: 3px;
Â Â left: 3px;
Â Â width: 38px;
Â Â height: 38px;
Â Â border-radius: 50%;
Â Â background: radial-gradient(circle at 30% 30%, #ffffff, #e6f3ff);
Â Â border: 1px solid #cfe6ff;
Â Â box-shadow: 0 2px 6px rgba(0,0,0,.15);
Â Â cursor: grab;
Â Â transition: transform .2s ease;
}
.slide-handle:active { cursor: grabbing; }

.slide-track.done .slide-hint {
Â Â color: #2f9e44;
}
.slide-track.done .slide-fill {
Â Â background: linear-gradient(90deg, #7ee8b5, #2ecc71);
Â Â opacity: .35;
}

/* åªåœ¨ç·¨è¼¯ç‹€æ…‹é¡¯ç¤ºæ»‘æ¡¿ï¼›å®Œæˆæª¢è¦–(readonly)éš±è— */
#detailModal.readonly .slide-complete { display: none; }

/* æ·ºè‰²ç‰ˆï¼šå„²å­˜ & ç§»é™¤ */
.save-btn-half,
.delete-btn-half {
Â Â border: 1px solid transparent;
Â Â font-weight: 600;
Â Â box-shadow: 0 1px 2px rgba(0,0,0,.06);
Â Â transition: background-color .15s ease, box-shadow .15s ease, transform .02s ease;
}

/* å„²å­˜ï¼šè–„è–„ç¶ è— */
.save-btn-half {
Â Â background: linear-gradient(0deg, #eefbf6, #f6fdf9);
Â Â border-color: #ccefe2;
Â Â color: #176d59; Â  Â  Â  Â  Â  /* æ·±ä¸€é»ï¼Œæ˜“è®€ */
}
.save-btn-half:hover {
Â Â background: #e8faf3;
Â Â box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.save-btn-half:active { transform: translateY(1px); }

/* ç§»é™¤ï¼šè–„è–„çŠç‘šç²‰ */
.delete-btn-half {
Â Â background: linear-gradient(0deg, #fff3f3, #fff7f7);
Â Â border-color: #ffd8d8;
Â Â color: #b23b3b; Â  Â  Â  Â  Â  /* æ·±ä¸€é»ï¼Œæ˜“è®€ */
}
.delete-btn-half:hover {
Â Â background: #ffeef0;
Â Â box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.delete-btn-half:active { transform: translateY(1px); }

/* å…¨å¹…å„²å­˜ï¼ˆè‹¥ä½ ä¹Ÿæƒ³åŒæ­¥è®Šæ·ºï¼‰ */
.save-btn {
Â Â background: linear-gradient(0deg, #eefbf6, #f6fdf9);
Â Â border: 1px solid #ccefe2;
Â Â color: #176d59;
}
.save-btn:hover { background:#e8faf3; }

/* FABï¼šé–‹åˆæ™‚æ—‹è½‰ã€é™°å½±æ›´æŸ”å’Œ */
.fab{
Â Â position: fixed; bottom: 24px; right: 24px;
Â Â width: 48px; height: 48px; border-radius: 50%;
Â Â display:flex; align-items:center; justify-content:center;
Â Â background:#00aaff; color:#fff; font-size:28px; font-weight:700;
Â Â box-shadow: 0 10px 22px rgba(0,0,0,.18);
Â Â cursor:pointer; z-index: 110;
Â Â transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
}
.fab:active{ transform: scale(.98); }
.fab.open{ transform: rotate(45deg); } Â  /* æ‰“é–‹æ™‚è®Šæˆ Ã— çš„æ„Ÿè¦º */

/* æ–°ï¼šæ¥µç°¡ç»ç’ƒå¡ç‰‡æµ®å±¤ */
.menu{
Â Â position: fixed; bottom: 88px; right: 24px;
Â Â min-width: 100px;
Â Â padding: 8px;
Â Â border-radius: 14px;
Â Â background: rgba(255,255,255,.72);
Â Â backdrop-filter: blur(10px);
Â Â -webkit-backdrop-filter: blur(10px);
Â Â border: 1px solid rgba(180, 210, 255, .35);
Â Â box-shadow: 0 12px 28px rgba(0, 60, 130, .12);
Â Â display: block; Â  Â  Â  Â  Â  Â  Â  /* ç”¨é€æ˜æ§åˆ¶é¡¯ç¤º */
Â Â opacity: 0; transform: translateY(8px) scale(.98);
Â Â pointer-events: none;
Â Â z-index: 105;
}

/* æ‰“é–‹ç‹€æ…‹ */
.menu.show{
Â Â opacity: 1; transform: translateY(0) scale(1);
Â Â pointer-events: auto;
Â Â transition: opacity .18s ease, transform .18s ease;
}

/* å°åœ“è§’åˆ†éš” + å“ç‰Œè‰²ç³»æŒ‰éˆ• */
.menu button{
Â Â display:flex; align-items:center; gap:.5rem;
Â Â width:100%;
Â Â background: transparent;
Â Â border: 0;
Â Â padding: 10px 12px;
Â Â border-radius: 10px;
Â Â font-size: 15px; font-weight: 600;
Â Â color: #176dff; Â  Â  Â  Â  Â  Â  Â  Â  /* æ·ºè—ç³»ä¸»è‰²ï¼Œèˆ‡ä¸»è¦–è¦ºå”èª¿ */
Â Â letter-spacing:.2px;
Â Â cursor:pointer;
}

/* hover / active çš„è¼•å¾®å›é¥‹ï¼ˆæ‰‹æ©Ÿä¹Ÿå¥½é»ï¼‰ */
.menu button:hover{
Â Â background: linear-gradient(0deg,#eef6ff,#f7fbff);
}
.menu button:active{
Â Â transform: translateY(1px);
}

/* é …ç›®ä¹‹é–“åŠ ä¸€é»é–“è· */
.menu button + button{ margin-top: 4px; }

/* æŒ‡å‘ FAB çš„å°å°¾å·´ */
.menu::after{
Â Â content:"";
Â Â position:absolute;
Â Â right: 12px; bottom: -6px;
Â Â width: 12px; height:12px;
Â Â background: rgba(255,255,255,.72);
Â Â border: 1px solid rgba(180,210,255,.35);
Â Â border-top: none; border-left: none;
Â Â transform: rotate(45deg);
Â Â box-shadow: 4px 4px 10px rgba(0,60,130,.06);
}

/* åœ¨ã€Œå·²å®Œæˆã€æ™‚ç¦ç”¨ï¼ˆä½ å‰é¢å·²åš pointer-events/opactiyï¼Œä¹Ÿå¯æ²¿ç”¨ï¼‰ */
.fab[aria-disabled="true"]{
Â Â pointer-events: none; opacity:.5; box-shadow: none;
}
/* é è¨­éƒ½ä¸é¡¯ç¤ºï¼Œé¿å…é–ƒçˆ */
#loginPage { display: none; }
.container { display: none !important; }

/* åªåœ¨ç¢ºå®šè¦é¡¯ç¤ºæ™‚ï¼Œæ‰æ‰“é–‹å°æ‡‰å€å¡Š */
html.show-login #loginPage { display: flex; }Â  Â  Â  /* é¡¯ç¤ºç™»å…¥é  */
html.show-app Â  .container { display: block !important; } /* é¡¯ç¤ºä¸»ç•«é¢ */

/* ===== è‡ªå‹•ç™»å…¥è¼‰å…¥å±¤ ===== */
#autologin-overlay{
Â Â position: fixed; inset: 0;
Â Â display: none;Â  Â  Â  Â  Â  Â  Â  Â  Â  /* é è¨­ä¸é¡¯ç¤º */
Â Â align-items: center;
Â Â justify-content: center;
Â Â background: rgba(255,255,255,.72);
Â Â backdrop-filter: blur(6px);
Â Â -webkit-backdrop-filter: blur(6px);
Â Â z-index: 260; Â  Â  Â  Â  Â  Â  Â  Â  Â  /* é«˜æ–¼ modal(200) ä½†ä¸æ“‹ä½ ç™»å‡ºç¢ºèª(220) çš„è©±å¯èª¿é«˜åˆ° 260 */
}
#autologin-overlay.show{ display:flex; }

.autologin-box{
Â Â display:flex; flex-direction:column; align-items:center; gap:.75rem;
Â Â padding: 16px 18px;
Â Â border-radius: 14px;
Â Â background: rgba(255,255,255,.9);
Â Â border: 1px solid rgba(180,210,255,.35);
Â Â box-shadow: 0 12px 28px rgba(0,60,130,.12);
Â Â transform: translateY(6px);
Â Â animation: al-pop .2s ease-out forwards;
}

.autologin-loader{
Â Â width: 42px; height: 42px; border-radius: 50%;
Â Â border: 3px solid #e6f4ff;
Â Â border-top-color: #00aaff; Â  Â  /* è·Ÿä¸»è‰²ä¸€è‡´ */
Â Â animation: al-spin .8s linear infinite;
Â Â box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
}

.autologin-text{
Â Â font-weight: 700;
Â Â letter-spacing: .3px;
Â Â color: #176dff; Â  Â  Â  Â  Â  Â  Â  Â  /* æ·ºè—ç³»å­—è‰² */
Â Â font-size: 14px;
}

@keyframes al-spin { to { transform: rotate(360deg); } }
@keyframes al-pop {
Â Â from { opacity: 0; transform: translateY(10px) scale(.98); }
Â Â to Â  { opacity: 1; transform: translateY(0)Â  Â  scale(1); }
}
/* Section å€ï¼šé—œé–‰æ–‡å­—é¸å–ã€iOS é•·æŒ‰å‘¼å«èœå–®ã€é»æ“Šé«˜äº® */
#section-container {
Â Â -webkit-user-select: none;
Â Â user-select: none;
Â Â -webkit-touch-callout: none;
}
#section-container .section {
Â Â -webkit-tap-highlight-color: transparent;
Â Â will-change: transform;
Â Â transition: transform 120ms ease;
}

/* é»æ“Š/æŒ‰å£“çš„è¦–è¦ºå›é¥‹ */
.section.__pressed { transform: scale(0.985); }
@keyframes __bump {
Â Â 0% { transform: scale(1); }
Â Â 50%{ transform: scale(0.985); }
Â Â 100%{ transform: scale(1); }
}
.section.__bump { animation: __bump .18s ease; }

#section-container { touch-action: pan-y; }
Â Â </style>
</head>
<body>
<!-- ç™»éŒ„é é¢ -->
<div id="loginPage">
Â Â <div id="loginCard">
Â Â Â <h1 style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 24px;">
Â Â <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png" alt="icon" width="40" style="position: relative; top: 1px;">
Â Â MyTask
</h1>

Â Â Â Â <label class="login-label">è‡ªè¨‚å¸³è™Ÿ</label>
Â Â Â Â <input type="text" id="login-username" class="login-input" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">

Â Â Â Â <label class="login-label">è‡ªè¨‚å¯†ç¢¼</label>
Â Â Â Â <input type="password" id="login-password" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">

Â Â Â Â <label class="login-checkrow">
Â Â Â Â Â Â <input type="checkbox" id="auto-login">
Â Â Â Â Â Â <span>è‡ªå‹•ç™»å…¥</span>
Â Â Â Â </label>

Â Â Â Â <button id="login-btn" class="login-btn">ç™»å…¥</button>

Â Â Â Â <p class="login-tip">å¹³å°å…è¨»å†Šï¼Œè‡ªè¨‚å¸³è™Ÿå¯†ç¢¼å³å¯ç™»éŒ„</p>
Â Â </div>
</div>



Â Â <div class="container" style="display:none">
Â Â Â Â <h1 style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 24px;">
Â Â <img src="https://cdn.jsdelivr.net/gh/a355226/kj-reminder/reminder.png"
Â Â Â Â Â Â Â alt="icon" width="40" style="transform: translateY(2px);">
Â Â MyTask
</h1>

<!-- å³ä¸Šè§’ ... æŒ‰éˆ• -->
<div class="more-btn" onclick="openModalById('moreModal')">â‹¯</div>
<div id="section-container">
<div id="doneMore" style="display:none; text-align:right; margin:0.25rem 0;">
Â Â <button id="doneMoreBtn" style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">æ›´å¤šâ€¦</button>
Â Â <div id="doneMonthMenu" style="display:none; position:absolute; right:16px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;"></div>
</div>

Â Â Â Â <div class="section" id="ç…§é¡§æœå‹™">
Â Â Â Â Â Â <div class="section-title">ç…§é¡§æœå‹™</div>
Â Â Â Â </div>
Â Â Â Â <div class="section" id="å°ˆæ¥­æœå‹™">
Â Â Â Â Â Â <div class="section-title">å°ˆæ¥­æœå‹™</div>
Â Â Â Â </div>
Â Â Â Â <div class="section" id="äº¤é€šæ¥é€">
Â Â Â Â Â Â <div class="section-title">äº¤é€šæ¥é€</div>
Â Â Â Â </div>
Â Â Â Â <div class="section" id="å–˜æ¯æœå‹™">
Â Â Â Â Â Â <div class="section-title">å–˜æ¯æœå‹™</div>
Â Â Â Â </div>
Â Â Â Â <div class="section" id="è¼”å…·ç”³è«‹">
Â Â Â Â Â Â <div class="section-title">è¼”å…·ç”³è«‹</div>
Â Â Â Â </div>
Â Â Â Â <div class="section" id="å…¶å®ƒ">
Â Â Â Â Â Â <div class="section-title">å…¶å®ƒ</div>
Â Â Â Â </div>

Â Â </div>

Â Â <div class="fab" onclick="toggleMenu()">ï¼‹</div>
<div class="menu" id="menu">
<button onclick="openModal()"Â 
Â Â Â Â Â Â Â Â style="background:#e6f6fc; color:#0091cc; font-weight:600;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â padding:8px 16px; border:none; border-radius:8px;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â margin-bottom:12px;">
Â Â æ–°å¢ä»»å‹™
</button>

<button onclick="openCategoryModal()"Â 
Â Â Â Â Â Â Â Â style="background:#e9f9f1; color:#1fa87a; font-weight:600;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â padding:8px 16px; border:none; border-radius:8px;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â margin-bottom:12px;">
Â Â æ–°å¢åˆ†é¡
</button>

<button onclick="enterEditMode()"Â 
Â Â Â Â Â Â Â Â style="background:#fff6e6; color:#d98a00; font-weight:600;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â padding:8px 16px; border:none; border-radius:8px;Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â box-shadow:0 2px 4px rgba(0,0,0,.08); cursor:pointer;">
Â Â ç·¨è¼¯åˆ†é¡
</button>
</div>

<!-- âœ… æ–°å¢çš„æŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…å®Œæˆç·¨è¼¯åˆ†é¡ -->
<button id="exitEditBtn" onclick="exitEditMode()" style="
Â Â display: none;
Â Â position: fixed;
Â Â bottom: 20px;
Â Â left: 50%;
Â Â transform: translateX(-50%);
Â Â background: #e3ffe8;
Â Â color: white;
Â Â border: none;
Â Â border-radius: 8px;
Â Â padding: 6px 14px;
Â Â font-size: 13px;
Â Â font-weight: bold;
Â Â cursor: pointer;
Â Â z-index: 10;
Â Â box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
">âœ…</button>


Â Â <!-- æ–°å¢ä»»å‹™è¦–çª— -->
Â Â <div class="modal" id="taskModal">
Â Â Â Â <div class="modal-content">
Â Â Â Â Â Â <button class="close-btn" onclick="closeModal('taskModal')">âœ•</button>
Â Â Â Â Â Â <h3>æ–°å¢ä»»å‹™</h3>
Â Â Â Â <label>ä»»å‹™åˆ†é¡</label>
Â Â Â Â <div class="inline-row">
Â Â Â Â Â Â <!-- é€™è£¡è¦ç”¨ taskSectionï¼ˆä¸æ˜¯ detailSectionï¼‰-->
Â Â Â Â Â Â <select id="taskSection" class="half">
Â Â Â Â Â Â </select>

Â Â Â Â Â Â <!-- é€™è£¡è¦ç”¨ taskImportantï¼ˆä¸æ˜¯ detailImportantï¼‰-->
Â Â Â Â Â Â <label class="important-flag">
Â Â Â Â Â Â Â Â <input type="checkbox" id="taskImportant">
Â Â Â Â Â Â Â Â é‡è¦
Â Â Â Â Â Â </label>
Â Â Â Â </div>

Â Â Â Â Â Â <label>ä»»å‹™æ¨™é¡Œ(å¿…å¡«)</label>
Â Â Â Â Â Â <input type="text" id="taskTitle">
Â Â Â Â Â Â <label>ä»»å‹™å…§å®¹</label>
Â Â Â Â Â Â <textarea id="taskContent"></textarea>
Â Â Â Â Â Â <label>é å®šå®Œæˆæ—¥</label>
Â Â Â Â Â Â <input type="date" id="taskDate">
Â Â Â Â Â Â <label>è™•ç†æƒ…å½¢</label>
Â Â Â Â Â Â <textarea id="taskNote"></textarea>
Â Â Â Â Â Â <button onclick="addTask()" style="font-weight:bold;">æ–°å¢</button>
Â Â Â Â </div>
Â Â </div>

Â Â <!-- ä»»å‹™å…§å®¹æª¢è¦–è¦–çª— -->
Â Â <div class="modal" id="detailModal">
Â Â Â Â <div class="modal-content">
Â Â Â Â Â Â <button class="close-btn" onclick="closeModal('detailModal')">âœ•</button>
Â Â Â Â Â Â <h3>ä»»å‹™å…§å®¹</h3>
<label>ä»»å‹™åˆ†é¡</label>
<div class="inline-row">
Â Â <select id="detailSection" class="half">
Â Â </select>

Â Â <label class="important-flag">
Â Â Â Â <input type="checkbox" id="detailImportant">
Â Â Â Â é‡è¦
Â Â </label>
</div>

Â Â Â Â Â Â <label>ä»»å‹™æ¨™é¡Œ</label>
Â Â Â Â Â Â <input type="text" id="detailTitle">
Â Â Â Â Â Â <label>ä»»å‹™å…§å®¹</label>
Â Â Â Â Â Â <textarea id="detailContent"></textarea>
Â Â Â Â Â Â <label>é å®šå®Œæˆæ—¥</label>
Â Â Â Â Â Â <input type="date" id="detailDate">
Â Â Â Â Â Â <label>è™•ç†æƒ…å½¢</label>
Â Â Â Â Â Â <textarea id="detailNote"></textarea>
<div style="display: flex; gap: 0.5rem;">
Â Â <button class="save-btn-half" onclick="saveTask()">ğŸ’¾ å„²å­˜</button>
Â Â <button class="delete-btn-half" onclick="confirmDelete()">ğŸ—‘ï¸ ç§»é™¤</button>
</div>
<!-- æ»‘å‹•å®Œæˆ -->
<div class="slide-complete" id="slideComplete">
Â Â <div class="slide-track">
Â Â Â Â <div class="slide-hint">â¡ å¾€å³æ‹–æ‹‰å®Œæˆ</div>
Â Â Â Â <div class="slide-fill" id="slideFill"></div>
Â Â Â Â <div class="slide-handle" id="slideHandle" aria-label="å¾€å³æ‹–æ‹‰å®Œæˆ"></div>
Â Â </div>
</div>

Â Â Â Â </div>
Â Â </div>

Â Â <script>
let isEditing = false; Â  // ç›®å‰æ˜¯å¦åœ¨ç·¨è¼¯åˆ†é¡æ¨¡å¼
Â Â // âœ… åˆ†é¡åœ¨é€™è£¡ç¶­è­·ï¼ˆæœ‰é †åºï¼‰
let categoriesLoaded = false;Â  // åˆ†é¡æ˜¯å¦å·²å¾é›²ç«¯è¼‰å…¥
let categories = [];
let sectionSortable = null;Â  // å­˜ä½ Sortable å¯¦ä¾‹
// âœ… é‡æ–°ç•«å‡ºæ‰€æœ‰åˆ†é¡å€å¡Šï¼ˆä¾ç…§ categories é †åºï¼‰
function refreshCurrentView(){
Â Â if (statusFilter === 'done') {
Â Â Â Â buildDoneMonthMenu();
Â Â Â Â renderCompletedTasks();
Â Â } else {
Â Â Â Â showOngoing();
Â Â }
}
// âœ… åªå­˜åˆ†é¡ï¼ˆä¸è¦å†å¾ tasks æ¨å›å»ï¼‰
function saveCategoriesToFirebase(){
Â Â if(!roomPath) return;
Â Â db.ref(`${roomPath}/categories`).set(categories);
}
// === Firebase åˆå§‹åŒ–ï¼ˆæ”¾åœ¨é€™æ”¯ <script> çš„æœ€ä¸Šé¢ï¼‰===
const firebaseConfig = {
Â Â apiKey: "AIzaSyBs9sWJ2WHIuTmU0Jw7U_120uMManBES1E",
Â Â authDomain: "kjreminder-24d74.firebaseapp.com",
Â Â projectId: "kjreminder-24d74",
Â Â storageBucket: "kjreminder-24d74.firebasestorage.app",
Â Â messagingSenderId: "176371952161",
Â Â appId: "1:176371952161:web:948121be209cd2e4181160",
Â Â databaseURL: "https://kjreminder-24d74-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();


// å»ºè­°ï¼šæ˜ç¢ºæŒ‡å®šæŒä¹…æ€§ï¼ˆiOS/Safari æ¯”è¼ƒä¸æœƒæ€ªï¼‰
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});
// æª¢æŸ¥æ˜¯å¦åœ¨ä¸»ç•«é¢ / PWA ç¨ç«‹æ¨¡å¼
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// ç­‰ç¶²è·¯èµ·ä¾†
function waitOnline() {
Â Â if (navigator.onLine) return Promise.resolve();
Â Â return new Promise(res => window.addEventListener('online', res, { once: true }));
}

// æ¸¬è©¦ IndexedDB æ˜¯å¦å¯ç”¨ï¼ˆiOS PWA å†·å•Ÿæœ‰æ™‚æœƒç‚¸ï¼‰
function testIndexedDB() {
Â Â return new Promise((resolve) => {
Â Â Â Â try {
Â Â Â Â Â Â const req = indexedDB.open('kjreminder-idb-test', 1);
Â Â Â Â Â Â req.onsuccess = () => { try { req.result.close(); } catch(_){} resolve(true); };
Â Â Â Â Â Â req.onerror Â  = () => resolve(false);
Â Â Â Â Â Â req.onblocked = () => resolve(false);
Â Â Â Â } catch(_) { resolve(false); }
Â Â });
}

// PWA å•Ÿå‹•æ™‚ï¼Œç¨ç­‰ä¸€ä¸‹è®“å­˜å„²èˆ‡ç¶²è·¯å°±ç·’ï¼Œä¸¦é¸æ“‡å®‰å…¨çš„æŒä¹…æ€§
async function pwaAuthWarmup() {
Â Â // å…ˆç­‰ DOM å¦¥ç•¶
Â Â await new Promise(r => setTimeout(r, 120));

Â Â // ç­‰ç¶²è·¯
Â Â await waitOnline();

Â Â // iOS PWA å†·å•Ÿï¼šIndexedDB å¸¸å¸¸ 0.x ç§’å…§ä¸å¯ç”¨ï¼Œç¨ç­‰ä¸€é»å†æ¸¬
Â Â await new Promise(r => setTimeout(r, 120));

Â Â const idbOK = await testIndexedDB();

Â Â try {
Â Â Â Â if (idbOK) {
Â Â Â Â Â Â // æ­£å¸¸ç”¨ LOCALï¼ˆèƒ½è¨˜ä½ç™»å…¥ï¼‰
Â Â Â Â Â Â await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
Â Â Â Â } else {
Â Â Â Â Â Â // é€€è€Œæ±‚å…¶æ¬¡ï¼šä¸æŒä¹…ï¼ˆæœ¬æ¬¡é–‹å•Ÿæœ‰æ•ˆï¼Œé¿å…å¡åœ¨æŒä¹…å±¤ï¼‰
Â Â Â Â Â Â await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);
Â Â Â Â }
Â Â } catch(_) {
Â Â Â Â // å°±ç®— setPersistence å¤±æ•—ä¹Ÿåˆ¥æ“‹æµç¨‹
Â Â }
}

// ä½ çš„ä¸€éµé–‹æ©Ÿï¼ˆå¦‚æœä½ å·²ç¶“åšäº† bootAuth/ensureSignedInï¼Œå°±åœ¨è£¡é¢å‘¼å« pwaAuthWarmupï¼‰
async function bootAuth() {
Â Â if (bootAuth.__busy) return;
Â Â bootAuth.__busy = true;
Â Â setLoginBusy(true);

Â Â // å…ˆæŠŠé¡¯ç¤ºç‹€æ…‹æ¸…æ‰ï¼Œé¿å…é–ƒçˆ
Â Â document.documentElement.classList.remove('show-login', 'show-app');

Â Â // PWA å…ˆç†±èº«ï¼ˆç¶²è·¯/å„²å­˜å°±ç·’ & è¨­å®šæŒä¹…æ€§ï¼‰
Â Â if (isStandalone) {
Â Â Â Â await pwaAuthWarmup();
Â Â } else {
Â Â Â Â try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_) {}
Â Â }

Â Â // è®€ sessionStorage æˆ– localStorageï¼Œç®—å‡º roomPath
Â Â hydrateRoomPath();

Â Â if (!roomPath) {
Â Â Â Â // æ²’æ†‘è­‰ï¼šåœåœ¨ç™»å…¥é ï¼Œä¸¦ç¢ºä¿æ²’æœ‰æ®˜ç•™ç™»å…¥ç‹€æ…‹
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
Â Â Â Â document.documentElement.classList.add('show-login');
Â Â Â Â setLoginBusy(false);
Â Â Â Â bootAuth.__busy = false;
Â Â Â Â return;
Â Â }

Â Â // æœ‰æ†‘è­‰ï¼šä¹¾æ·¨ç™»å…¥ + è¶…æ™‚å‚™æ´
Â Â try {
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_) {}

Â Â Â Â const timeout = new Promise((_, rej) =>
Â Â Â Â Â Â setTimeout(() => rej(new Error('timeout')), 7000)
Â Â Â Â );
Â Â Â Â await Promise.race([auth.signInAnonymously(), timeout]);

Â Â Â Â // æˆåŠŸ â†’ é¡¯ç¤ºä¸»ç•«é¢
Â Â Â Â document.documentElement.classList.add('show-app');
Â Â Â Â loadTasksFromFirebase();
Â Â Â Â updateSectionOptions();
Â Â } catch (e) {
Â Â Â Â // å¤±æ•— â†’ åœåœ¨ç™»å…¥é 
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
Â Â Â Â document.documentElement.classList.add('show-login');
Â Â } finally {
Â Â Â Â setLoginBusy(false);
Â Â Â Â bootAuth.__busy = false;
Â Â }
}

// äº‹ä»¶ï¼šé–‹é ã€å›å‰æ™¯ã€èšç„¦æ™‚éƒ½è£œå‘¼å«ä¸€æ¬¡


// ===== å…±ç”¨çš„ã€Œç¢ºä¿ç™»å…¥ã€æµç¨‹ï¼ˆæœ‰é‡è©¦/è¶…æ™‚ä¿è­·ï¼‰=====
const AUTH_TIMEOUT_MS = 6000;
let authBusy = false;
let authTimer = null;

async function ensureSignedIn() {
Â Â if (authBusy) return;
Â Â authBusy = true;
Â Â setLoginBusy(true);

Â Â // å…ˆå¾ localStorage æ‹¿ savedï¼ˆåˆ¤æ–·æ˜¯å¦æœ‰ã€Œè‡ªå‹•ç™»å…¥ã€è³‡æ–™ï¼‰
Â Â let saved = null;
Â Â try { saved = localStorage.getItem('todo_room_info'); } catch(_) {}

Â Â // âœ… æƒ…æ³ 1ï¼šæ²’æœ‰å„²å­˜å¸³å¯† â†’ ä¸è¦è‡ªå‹•ç™»å…¥ï¼ç›´æ¥é¡¯ç¤ºç™»å…¥é 
Â Â if (!saved) {
Â Â Â Â authBusy = false;
Â Â Â Â setLoginBusy(false);
Â Â Â Â // é¡¯ç¤ºç™»å…¥é 
document.documentElement.classList.remove('show-app');
document.documentElement.classList.add('show-login');

Â Â Â Â // ç‚ºäº†ä¿éšªï¼šè‹¥ç€è¦½å™¨é‚„ç•™è‘—èˆŠçš„åŒ¿åä½¿ç”¨è€…ï¼Œç™»å‡ºä¸€æ¬¡ï¼Œé¿å…ä¹‹å¾Œ onAuthStateChanged äº‚åˆ‡ç•«é¢
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(e) {}
Â Â Â Â return;
Â Â }

Â Â // âœ… æƒ…æ³ 2ï¼šæœ‰å„²å­˜å¸³å¯† â†’ æ­£å¸¸è‡ªå‹•ç™»å…¥æµç¨‹
Â Â hydrateRoomPath(); // çµ„å¥½ roomPath

showAutoLoginOverlay();
startAutoLoginWatchdog();

Â Â try {
Â Â Â Â // A. è‹¥å·²ç¶“æœ‰ user ä¸”æœ‰ roomPathï¼Œç›´æ¥é€²ä¸»ç•«é¢
Â Â Â Â if (auth.currentUser && roomPath) {
Â Â Â Â Â Â document.getElementById('loginPage').style.display = 'none';
Â Â Â Â Â Â document.querySelector('.container').style.display = 'block';
Â Â Â Â Â Â loadTasksFromFirebase();
Â Â Â Â Â Â updateSectionOptions();
hideAutoLoginOverlay();
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â // B. ç¢ºä¿ä¹¾æ·¨ç‹€æ…‹å†ç™»å…¥ï¼ˆé¿å…æ®˜ç•™ sessionï¼‰
Â Â Â Â if (auth.currentUser) await auth.signOut();

Â Â Â Â // C. åŠ è¶…æ™‚ä¿è­·ï¼š6 ç§’é‚„æ²’å›æ‡‰å°±é‡è©¦ä¸€æ¬¡åŒ¿åç™»å…¥
Â Â Â Â authTimer = setTimeout(async () => {
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â if (auth.currentUser) await auth.signOut();
Â Â Â Â Â Â Â Â await auth.signInAnonymously();
Â Â Â Â Â Â } catch(e) {/* å¿½ç•¥ */}
Â Â Â Â }, AUTH_TIMEOUT_MS);

Â Â Â Â await auth.signInAnonymously();
Â Â } catch (e) {
Â Â Â Â alert('è‡ªå‹•ç™»å…¥å¤±æ•—ï¼š' + (e?.message || e));
hideAutoLoginOverlay();
Â Â } finally {
Â Â Â Â authBusy = false;
Â Â Â Â // å…¶é¤˜åˆ‡ç•«é¢ç”± onAuthStateChanged çµ±ä¸€è™•ç†
Â Â }
}

let roomPath = ""; // â† æ”¾é€™è£¡ï¼å…¨æª”åªå‡ºç¾ä¸€æ¬¡
let tasksRef = null;
let completedRef = null; // ä¹‹å¾Œä½ æœ‰åš completedTasks å³å¯ç”¨åˆ°

const DEFAULT_CATEGORIES = ['ç…§é¡§æœå‹™','å°ˆæ¥­æœå‹™','äº¤é€šæ¥é€','å–˜æ¯æœå‹™','è¼”å…·ç”³è«‹','å…¶å®ƒ'];

// å°å·¥å…·ï¼šæŠŠä¸åˆæ³•å­—å…ƒæ›æ‰ï¼ˆFirebase è·¯å¾‘ä¸èƒ½æœ‰ . # $ [ ] /ï¼‰
function sanitizeKey(s){
Â Â return String(s).replace(/[.#$/\[\]\/]/g, '_');
}


// 1) å…¨åŸŸç‹€æ…‹ï¼ˆæ”¾åœ¨ä½ çš„å…¨åŸŸè®Šæ•¸å€ï¼‰
let dayMode = 'work'; // 'work' å·¥ä½œå¤©(é è¨­) / 'calendar' æ—¥æ›†å¤©
Â Â Â Â let tasks = [];
Â Â Â Â let selectedTaskId = null;

function hydrateRoomPath(){
Â Â // å¾ localStorage è£¡æŠŠæˆ¿é–“è³‡è¨Šé‚„åŸå› roomPathï¼ˆå¦‚æœæœ‰ï¼‰
Â Â try {
Â Â Â Â const saved = localStorage.getItem('todo_room_info');
Â Â Â Â if (!saved) return;
Â Â Â Â const { username, password } = JSON.parse(saved);
Â Â Â Â roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
Â Â } catch (e) {
Â Â Â Â console.warn('hydrateRoomPath å¤±æ•—ï¼š', e);
Â Â }
}

function openModal(prefSectionId) {
Â Â updateSectionOptions(); Â  Â  Â  Â  Â  Â  Â  Â  // â˜… å…ˆåŒæ­¥é¸é …
Â Â if (prefSectionId) {
Â Â Â Â const sel = document.getElementById('taskSection');
Â Â Â Â if (sel) {
Â Â Â Â Â Â // æœ‰å°æ‡‰é¸é …å°±é é¸ï¼›æ²’æœ‰å°±ç¶­æŒåŸç‹€
Â Â Â Â Â Â const opt = sel.querySelector(`option[value="${prefSectionId}"]`);
Â Â Â Â Â Â if (opt) sel.value = prefSectionId;
Â Â Â Â }
Â Â }
Â Â document.getElementById('taskModal').style.display = 'flex';
Â Â closeFabMenu();
}


Â Â Â Â function closeModal(id) {
Â Â Â Â Â Â document.getElementById(id).style.display = 'none';
Â Â Â Â }

//å‰©é¤˜å¤©æ•¸é‚è¼¯
// 2) å–ä»£ä½ ç›®å‰çš„ getRemainingDaysï¼ˆæ”¯æ´å…©ç¨®æ¨¡å¼ï¼‰
function getRemainingDays(dateStr) {
Â Â if (!dateStr) return null;
Â Â const today = new Date(); today.setHours(0,0,0,0);
Â Â const target = new Date(dateStr); target.setHours(0,0,0,0);

Â Â if (dayMode === 'calendar') {
Â Â Â Â // æ—¥æ›†å¤©ï¼šå«å…­æ—¥ï¼›ä»Šå¤©=0ã€æ˜å¤©=+1ã€æ˜¨å¤©=-1
Â Â Â Â const ms = target.getTime() - today.getTime();
Â Â Â Â return Math.round(ms / 86400000);
Â Â }

Â Â // å·¥ä½œå¤©ï¼šæ’é™¤å…­æ—¥ï¼›ä»Šå¤©=0ï¼›æœªä¾†/éå»éƒ½ä»¥å·¥ä½œå¤©è¨ˆ
Â Â if (target.getTime() === today.getTime()) return 0;
Â Â const forward = target > today;
Â Â let start = new Date(forward ? today : target);
Â Â let end Â  = new Date(forward ? target : today);

Â Â let count = 0, cur = new Date(start);
Â Â while (cur <= end) {
Â Â Â Â const d = cur.getDay();
Â Â Â Â if (d !== 0 && d !== 6) count++; Â  Â  // åªç®—é€±ä¸€ï½é€±äº”
Â Â Â Â cur.setDate(cur.getDate() + 1);
Â Â }Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ä¸å«èµ·å§‹æ—¥
Â Â return forward ? count : -count;
}



Â Â Â Â function getColorByDays(days) {
Â Â Â Â Â Â if (days == null) return 'var(--green-light)';
Â Â Â Â Â Â if (days >= 7) return 'var(--green-light)';
Â Â Â Â Â Â if (days >= 4) return '#ffeaea';
Â Â Â Â Â Â if (days >= 1) return '#ffb3b3';
Â Â Â Â Â Â return '#ff8080';
Â Â Â Â }

Â Â Â Â function addTask() {
Â Â const section = document.getElementById('taskSection').value;
Â Â const title Â  = document.getElementById('taskTitle').value;
Â Â const content = document.getElementById('taskContent').value;
Â Â const dateÂ  Â  = document.getElementById('taskDate').value;
Â Â const noteÂ  Â  = document.getElementById('taskNote').value;

Â Â if (!title) return;

Â Â // è®€ã€Œé‡è¦ã€å‹¾é¸ï¼ˆæ²’æœ‰é€™å€‹æ¬„ä½å°±å…ˆè¨­ falseï¼‰
Â Â const importantEl = document.getElementById('taskImportant');
Â Â const important Â  = importantEl ? importantEl.checked : false;

Â Â const id = `task-${Date.now()}`;
Â Â const task = { id, section, title, content, date, note, important };
Â Â tasks.push(task);

Â Â const days = getRemainingDays(date);
Â Â const bg = getColorByDays(days);
Â Â const displayDays = (days == null) ? 'ç„¡' : days;

Â Â const el = document.createElement('div');
Â Â el.className = 'task';
Â Â el.dataset.id = id;
Â Â el.style.backgroundColor = bg;
Â Â el.innerHTML = `
Â Â Â Â <div class="task-content">
Â Â Â Â Â Â <div class="task-title">${getTitleWithFlag(task)}</div>
Â Â Â Â </div>
Â Â Â Â <div class="task-days">${displayDays}</div>
Â Â `;
Â Â el.onclick = () => openDetail(id);

Â Â document.getElementById(section).appendChild(el);
Â Â sortTasks(section);

// é—œé–‰è¦–çª—ï¼ˆåŠ å›é€™è¡Œï¼‰
closeModal('taskModal');

Â Â // æ¸…ç©ºè¡¨å–®
Â Â document.getElementById('taskTitle').value = '';
Â Â document.getElementById('taskContent').value = '';
Â Â document.getElementById('taskDate').value = '';
Â Â document.getElementById('taskNote').value = '';
Â Â if (importantEl) importantEl.checked = false; Â  // â† æŠŠã€Œé‡è¦ã€å‹¾é¸æ¸…æ‰

Â Â applyDayFilter();
Â Â saveTasksToFirebase();
}


//æ’åºé‚è¼¯ç”¨
function sortTasks(section) {
Â Â const container = document.getElementById(section);
Â Â const tasksInSection = Array.from(container.querySelectorAll('.task'));

Â Â tasksInSection.sort((a, b) => {
Â Â Â Â const taskA = tasks.find(t => t.id === a.dataset.id);
Â Â Â Â const taskB = tasks.find(t => t.id === b.dataset.id);

Â Â Â Â const daysA = getRemainingDays(taskA.date);
Â Â Â Â const daysB = getRemainingDays(taskB.date);

Â Â Â Â // ç©ºæ—¥æœŸè¦–ç‚ºæœ€å¤§å¤©æ•¸ï¼ˆæ’åºåˆ°æœ€ä¸‹é¢ï¼‰
Â Â Â Â const safeDaysA = daysA == null ? Infinity : daysA;
Â Â Â Â const safeDaysB = daysB == null ? Infinity : daysB;

Â Â Â Â return safeDaysA - safeDaysB;
Â Â });

Â Â // æ¸…ç©ºå¾Œä¾æ’åºçµæœé‡æ–°åŠ å…¥
Â Â tasksInSection.forEach(taskEl => container.appendChild(taskEl));
}


Â Â Â Â function openDetail(id) {
Â Â Â Â Â Â selectedTaskId = id;
Â Â Â Â Â Â const task = tasks.find(t => t.id === id);
Â Â Â Â Â Â if (!task) return;

Â Â Â Â Â Â document.getElementById('detailSection').value = task.section;
Â Â Â Â Â Â document.getElementById('detailTitle').value = task.title;
Â Â Â Â Â Â document.getElementById('detailContent').value = task.content;
Â Â Â Â Â Â document.getElementById('detailDate').value = task.date;
Â Â Â Â Â Â document.getElementById('detailNote').value = task.note;

Â Â Â Â Â Â document.getElementById('detailModal').style.display = 'flex';
setDetailReadonly(false); Â  // åŠ åœ¨ openDetail() å¡«å€¼å¾Œ
document.getElementById('detailImportant').checked = !!task.important;
if (window.__resetSlideComplete) window.__resetSlideComplete();

Â Â Â Â }


//å„²å­˜åŠŸèƒ½
function saveTask() {
Â Â if (!selectedTaskId) return;

Â Â const task = tasks.find(t => t.id === selectedTaskId);
Â Â if (!task) return;

Â Â task.section = document.getElementById('detailSection').value;
Â Â task.title = document.getElementById('detailTitle').value;
Â Â task.content = document.getElementById('detailContent').value;
Â Â task.date = document.getElementById('detailDate').value;
Â Â task.note = document.getElementById('detailNote').value;
task.important = document.getElementById('detailImportant').checked; Â  // â˜…æ–°å¢

Â Â const oldEl = document.querySelector(`[data-id='${task.id}']`);
Â Â if (oldEl) oldEl.remove();

Â Â const days = getRemainingDays(task.date);
Â Â const bg = getColorByDays(days);
Â Â const displayDays = (days == null) ? 'ç„¡' : days;

Â Â const el = document.createElement('div');
Â Â el.className = 'task';
Â Â el.dataset.id = task.id;
Â Â el.style.backgroundColor = bg;
el.innerHTML = `
Â Â <div class="task-content">
Â Â Â Â <div class="task-title">${getTitleWithFlag(task)}</div>
Â Â </div>
Â Â <div class="task-days">${displayDays}</div>
`;

Â Â el.onclick = () => openDetail(task.id);

Â Â document.getElementById(task.section).appendChild(el);
Â Â sortTasks(task.section);

Â Â closeModal('detailModal'); // âœ… æ–°å¢é€™ä¸€è¡Œ
applyDayFilter();
saveTasksToFirebase();


}

//ç§»é™¤åŠŸèƒ½
function confirmDelete() {
Â Â document.getElementById('confirmModal').style.display = 'flex';
}

function deleteTask() {
Â Â if (!selectedTaskId) return;

Â Â const el = document.querySelector(`[data-id='${selectedTaskId}']`);
Â Â if (el) el.remove();

Â Â tasks = tasks.filter(t => t.id !== selectedTaskId);

Â Â closeModal('confirmModal');
Â Â closeModal('detailModal');
saveTasksToFirebase();Â  // â† åŠ é€™è¡Œ

}
//æ–°å¢åˆ†é¡åŠŸèƒ½
function openCategoryModal() {
Â Â document.getElementById('newCategoryName').value = '';
Â Â document.getElementById('categoryModal').style.display = 'flex';
Â Â closeFabMenu(); // âœ… è‡ªå‹•é—œé–‰é¸å–®
}

function addCategory() {
Â Â const name = document.getElementById('newCategoryName').value.trim();
Â Â if (!name) return;
Â Â if (categories.includes(name)) { alert("æ­¤åˆ†é¡å·²å­˜åœ¨ï¼"); return; }

Â Â // âœ… æ›´æ–°é™£åˆ—ã€å­˜é›²ã€é‡ç•«
Â Â categories.push(name);
Â Â saveCategoriesToFirebase();
Â Â renderSections(categories);
refreshCurrentView();Â Â 
Â Â closeModal('categoryModal');
}



//é˜²é›™æ“Š
Â Â let lastTouchTime = 0;
Â Â document.addEventListener('touchend', function (event) {
Â Â Â Â const now = new Date().getTime();
Â Â Â Â if (now - lastTouchTime <= 300) {
Â Â Â Â Â Â event.preventDefault(); // é˜»æ­¢ç¬¬äºŒæ¬¡é»æ“Šå°è‡´æ”¾å¤§
Â Â Â Â }
Â Â Â Â lastTouchTime = now;
Â Â }, false);


//ç·¨è¼¯åˆ†é¡åŠŸèƒ½

let pendingRenameId = null;

function enterEditMode() {
Â Â isEditing = true;
Â Â decorateSectionsForEdit();
Â Â closeFabMenu();
Â Â const exitBtn = document.getElementById('exitEditBtn');
if (exitBtn) exitBtn.style.display = 'block';
}
// åˆªé™¤åˆ†é¡å½ˆçª—
function confirmDeleteCategory(id) {
Â Â const category = document.getElementById(id);
Â Â if (!category) return;

Â Â // å»ºç«‹ç¢ºèªè¦–çª—
Â Â const confirmBox = document.createElement('div');
Â Â confirmBox.className = 'modal';
Â Â confirmBox.style.display = 'flex';
Â Â confirmBox.innerHTML = `
Â Â Â Â <div class="modal-content">
Â Â Â Â Â Â <h3 style="text-align: center;">æ˜¯å¦ç¢ºèªåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ</h3>
Â Â Â Â Â Â <div class="confirm-buttons">
Â Â Â Â Â Â Â Â <button class="confirm-btn">ç¢ºèª</button>
Â Â Â Â Â Â Â Â <button class="cancel-btn">å–æ¶ˆ</button>
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â `;

Â Â // ç¶å®šæŒ‰éˆ•äº‹ä»¶
confirmBox.querySelector('.confirm-btn').onclick = () => {
Â Â // âœ… å…ˆè™•ç†ä»»å‹™ï¼šæŠŠåœ¨é€™å€‹åˆ†é¡çš„ä»»å‹™ï¼Œç§»å»ä¸€å€‹å®‰å…¨åˆ†é¡
Â Â const fallback = categories.find(c => c !== id) || 'å…¶å®ƒ';
Â Â tasks.forEach(t => { if (t.section === id) t.section = fallback; });
Â Â completedTasks.forEach(t => { if (t.section === id) t.section = fallback; });
Â Â saveTasksToFirebase(); // ä»»å‹™æœ‰å‹•åˆ°å°±å­˜ä¸€ä¸‹

Â Â // âœ… æ›´æ–°åˆ†é¡é™£åˆ—
Â Â categories = categories.filter(c => c !== id);
Â Â saveCategoriesToFirebase();

Â Â // âœ… é‡ç•«åˆ†é¡èˆ‡ä»»å‹™
Â Â renderSections(categories);
Â Â if (statusFilter === 'done') renderCompletedTasks(); else showOngoing();

Â Â confirmBox.remove();
};
Â Â confirmBox.querySelector('.cancel-btn').onclick = () => {
Â Â Â Â confirmBox.remove();
Â Â };

Â Â document.body.appendChild(confirmBox);

// âœ… åŒæ­¥å¾æ‰€æœ‰ select ä¸­ç§»é™¤é€™å€‹åˆ†é¡é¸é …
const selects = [document.getElementById('taskSection'), document.getElementById('detailSection')];
selects.forEach(select => {
Â Â const option = select.querySelector(`option[value="${id}"]`);
Â Â if (option) option.remove();
});
}




//ç¢ºèªå®Œæˆç·¨è¼¯
function exitEditMode() {
Â Â // é—œé–‰ç·¨è¼¯ç‹€æ…‹
Â Â isEditing = false;

Â Â // æ¸…æ‰ç·¨è¼¯é…ä»¶èˆ‡æ¨£å¼
Â Â document.querySelectorAll('.section').forEach(section => {
Â Â Â Â section.classList.remove('edit-mode');

Â Â Â Â const titleBar = section.querySelector('.section-title');
Â Â Â Â if (titleBar) {
Â Â Â Â Â Â // é‚„åŸåªé¡¯ç¤ºåç¨±
Â Â Â Â Â Â titleBar.innerHTML = section.id;
Â Â Â Â }
Â Â });

Â Â // éš±è—åº•éƒ¨ã€Œå®Œæˆç·¨è¼¯ã€éˆ•
Â Â const exitBtn = document.getElementById('exitEditBtn');
Â Â if (exitBtn) exitBtn.style.display = 'none';

Â Â // ï¼ˆå¯é¸ï¼‰ç¢ºä¿æ‹–æ‹‰å¯¦ä¾‹ä¹¾æ·¨
Â Â if (sectionSortable && sectionSortable.destroy) {
Â Â Â Â sectionSortable.destroy();
Â Â Â Â sectionSortable = null;
Â Â }
Â Â // é‡æ–°åˆå§‹åŒ–æ‹–æ‹‰ï¼ˆéç·¨è¼¯æ¨¡å¼ä¸‹æœ‰æŠŠæ‰‹å°±èƒ½æ‹–ï¼Œæ²’æŠŠæ‰‹å°±ä¸æœƒå‹•ï¼‰
Â Â initSectionSortable();

Â Â // ç·¨è¼¯çµæŸå¾Œï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®
Â Â updateSectionOptions();
}

//æ‰‹æ©Ÿæ‹–æ‹‰
function initSectionSortable(){
Â Â const el = document.getElementById('section-container');
Â Â if (!el) return;

Â Â // å…ˆéŠ·æ¯€èˆŠçš„ï¼Œé¿å…å¤šæ¬¡åˆå§‹åŒ–è¡çª
Â Â if (sectionSortable && sectionSortable.destroy) {
Â Â Â Â sectionSortable.destroy();
Â Â }

sectionSortable = new Sortable(el, {
Â Â animation: 150,
Â Â handle: '.drag-handle',
Â Â draggable: '.section',
Â Â ghostClass: 'dragging',

Â Â // â¬‡ï¸ ç«‹åˆ»æ‹–ï¼šå–æ¶ˆé•·æŒ‰å»¶é²èˆ‡é–€æª»
Â Â forceFallback: true,
Â Â fallbackOnBody: true,
Â Â delay: 0, Â  Â  Â  Â  Â  Â  Â  Â  // ç«‹åˆ»é–‹å§‹
Â Â delayOnTouchOnly: false,Â  // ä¸éœ€è¦é•·æŒ‰é‚è¼¯
Â Â touchStartThreshold: 0, Â  // è§¸ç¢°å°±æ‹–

Â Â onEnd: () => {
Â Â Â Â categories = Array.from(document.querySelectorAll('#section-container .section'))
Â Â Â Â Â Â .map(sec => sec.id);
Â Â Â Â saveCategoriesToFirebase();
Â Â }
});
}
function openRenameModal(sectionId) {
Â Â pendingRenameId = sectionId;
Â Â document.getElementById('renameInput').value = sectionId;
Â Â document.getElementById('renameModal').style.display = 'flex';
}

function confirmRename() {
Â Â const oldId = pendingRenameId;
Â Â const newName = document.getElementById('renameInput').value.trim();
Â Â if (!newName || document.getElementById(newName)) {
Â Â Â Â alert('åç¨±ä¸å¯ç‚ºç©ºæˆ–å·²å­˜åœ¨ï¼');
Â Â Â Â return;
Â Â }

Â Â // é€²è¡Œä¸­ä»»å‹™ï¼šæ”¹ section
Â Â tasks.forEach(t => { if (t.section === oldId) t.section = newName; });

Â Â // å·²å®Œæˆä»»å‹™ï¼šä¹Ÿè¦æ”¹ section
Â Â completedTasks.forEach(t => { if (t.section === oldId) t.section = newName; });

Â Â // âœ… æŠŠ categories é™£åˆ—è£¡çš„èˆŠåæ›æ–°å
Â Â categories = categories.map(c => c === oldId ? newName : c);
Â Â saveCategoriesToFirebase(); Â  // å­˜åˆ†é¡
Â Â saveTasksToFirebase();Â  Â  Â  Â  // å­˜ä»»å‹™

Â Â // âœ… é‡ç•« + ä¾ç•¶å‰é ç±¤åˆ·æ–°
Â Â renderSections(categories);
Â Â if (statusFilter === 'done') {
Â Â Â Â renderCompletedTasks();
Â Â } else {
Â Â Â Â showOngoing();
Â Â }

Â Â closeModal('renameModal');
Â Â pendingRenameId = null;
}




//æ–°å¢åˆ†é¡
function updateSectionOptions() {
Â Â const sections = document.querySelectorAll('.section');
Â Â const options = Array.from(sections).map(section => {
Â Â Â Â const id = section.id;
Â Â Â Â return `<option value="${id}">${id}</option>`;
Â Â }).join('');

Â Â document.getElementById('taskSection').innerHTML = options;
Â Â document.getElementById('detailSection').innerHTML = options;
}

//æ›´å¤šåŠŸèƒ½-ç¯©é¸å‰©é¤˜æ—¥
let filterDay = "all"; // é è¨­å…¨éƒ¨

document.addEventListener("change", function(e) {
Â Â if (e.target.matches('.filter-days input[type="radio"]')) {
Â Â Â Â filterDay = e.target.value; Â  // ç›´æ¥åˆ‡æ›
Â Â Â Â applyDayFilter();
Â Â }
});

function applyDayFilter() {
Â Â document.querySelectorAll(".task").forEach(taskEl => {
Â Â Â Â const task = tasks.find(t => t.id === taskEl.dataset.id);
Â Â Â Â if (!task) return;

Â Â Â Â const days = getRemainingDays(task.date);
Â Â Â Â let show = true;

Â Â Â Â if (filterDay !== "all") {
Â Â Â Â Â Â const v = parseInt(filterDay, 10); Â  // 0/1/2/3
Â Â Â Â Â Â // ç„¡æ—¥æœŸ -> ä¸é¡¯ç¤ºï¼›é¸ 0 è¡¨ç¤º <=0ï¼ˆå«è² æ•¸ï¼‰ï¼Œå…¶é¤˜ N è¡¨ç¤º <=N
Â Â Â Â Â Â show = (days !== null) && (days <= v);
Â Â Â Â }

Â Â Â Â taskEl.style.display = show ? "" : "none";
Â Â });
Â // â¬‡ï¸ åªæœ‰å•Ÿç”¨ç¯©é¸æ™‚æ‰éš±è—æ²’å‘½ä¸­çš„åˆ†é¡ï¼›ã€Œå…¨éƒ¨ã€æ™‚å…¨éƒ¨é¡¯ç¤º
Â Â if (filterDay === 'all') {
Â Â Â Â document.querySelectorAll('#section-container .section').forEach(sec => sec.style.display = '');
Â Â } else {
Â Â Â Â hideEmptySectionsAfterFilter();
Â Â }
}



function openModalById(id) {
Â Â document.getElementById(id).style.display = 'flex';
}

//æ­·å²ç´€éŒ„
// ====== æ–°å¢çš„å…¨åŸŸç‹€æ…‹ ======
let completedTasks = [];Â  Â  Â  Â  Â  // æ­¸æª”çš„å®Œæˆä»»å‹™
let statusFilter = "ongoing"; Â  Â  // é€²è¡Œä¸­ / å·²å®Œæˆ
let completedMonthFilter = "recent15"; // recent15 æˆ– '11407' é€™ç¨®æœˆä»½

// å–®é¸ï¼šä»»å‹™ç‹€æ…‹ï¼ˆå³æ™‚åˆ‡æ›ï¼‰
document.addEventListener("change", function(e){
Â Â if (e.target.matches('.filter-status input[type="radio"]')) {
Â Â Â Â statusFilter = e.target.value;Â  Â  Â  Â  Â  Â  Â  // 'ongoing' or 'done'
Â if (statusFilter === 'done') {
Â Â // ç¦ç”¨å³ä¸‹ï¼‹æŒ‰éˆ•
Â Â const fab = document.querySelector('.fab');
Â Â if (fab) {
Â Â Â Â fab.style.pointerEvents = 'none'; Â  // ä¸å¯é»
Â Â Â Â fab.style.opacity = '0.5';Â  Â  Â  Â  Â  // è®Šæ·¡
Â Â }

Â Â completedMonthFilter = "recent15";
Â Â buildDoneMonthMenu();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â document.getElementById('doneMore').style.display = 'block';
Â Â renderCompletedTasks();
} else {
Â Â // æ¢å¾©å³ä¸‹ï¼‹æŒ‰éˆ•
Â Â const fab = document.querySelector('.fab');
Â Â if (fab) {
Â Â Â Â fab.style.pointerEvents = 'auto'; Â  // å¯é»
Â Â Â Â fab.style.opacity = '1';Â  Â  Â  Â  Â  Â  // é‚„åŸ
Â Â }

Â Â document.getElementById('doneMore').style.display = 'none';
Â Â showOngoing();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
}
Â Â }
});
// 3) ç›£è½ã€Œå¤©æ•¸è¨­å®šã€åˆ‡æ›ï¼ˆåœ¨ä½ çš„ document.addEventListener å€å¡ŠåŠ é€™æ®µï¼‰
document.addEventListener("change", function(e){
Â Â if (e.target.matches('.filter-mode input[type="radio"]')) {
Â Â Â Â dayMode = e.target.value; Â  Â  Â  Â  Â  Â  Â  Â  // 'work' or 'calendar'
Â Â Â Â if (statusFilter === 'done') {
Â Â Â Â Â Â renderCompletedTasks(); Â  Â  Â  Â  Â  Â  Â  Â  // å®Œæˆè¦–åœ–ä¸åƒå¤©æ•¸ï¼Œä½†ä¿æŒä¸€è‡´åˆ·æ–°
Â Â Â Â } else {
Â Â Â Â Â Â showOngoing();Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // é‡æ–°è¨ˆç®—å¤©æ•¸/é¡è‰²/æ’åºä¸¦å¥—ç”¨ç¯©é¸
Â Â Â Â }
Â Â }
});


// å®ŒæˆæŒ‰éˆ•ï¼šæ”¹ç‚ºæ­¸æª”ï¼ˆè¦†è“‹ä½ çš„ completeTaskï¼‰
function completeTask() {
Â Â if (!selectedTaskId) return;

Â Â const idx = tasks.findIndex(t => t.id === selectedTaskId);
Â Â if (idx === -1) return;

Â Â // ç”¨ timestampï¼ˆnumberï¼‰å­˜åˆ°é›²ç«¯æœ€ç©©
Â Â const finished = { ...tasks[idx], completedAt: Date.now() };

Â Â tasks.splice(idx, 1);
Â Â const el = document.querySelector(`[data-id='${selectedTaskId}']`);
Â Â if (el) el.remove();
Â Â closeModal('detailModal');

Â Â completedTasks.push(finished);

Â Â // å„²å­˜å·²å®Œæˆä»»å‹™åˆ° Firebase
Â Â saveTasksToFirebase();

Â Â // å‹•ç•«
Â Â const checkmark = document.getElementById('check-success');
Â Â checkmark.classList.add('show');
Â Â setTimeout(() => checkmark.classList.remove('show'), 1500);

Â Â if (statusFilter === 'done') {
Â Â Â Â buildDoneMonthMenu();
Â Â Â Â renderCompletedTasks();
Â Â }
}


// ====== æ¸²æŸ“é‚è¼¯ ======
function clearAllSections() {
Â Â document.querySelectorAll('.section').forEach(sec => {
Â Â Â Â // ä¿ç•™ section-titleï¼Œæ¸…æ‰ä»»å‹™å¡
Â Â Â Â Array.from(sec.querySelectorAll('.task')).forEach(t => t.remove());
Â Â });
}

function showOngoing() {
Â Â clearAllSections();
// æŠŠä»»å‹™è£¡ç”¨åˆ°çš„åˆ†é¡è£œé€² categoriesï¼ˆé¿å…æœ‰ä»»å‹™ä½†æ²’æœ‰åˆ†é¡ï¼‰
// æŠŠä»»å‹™è£¡ç”¨åˆ°çš„åˆ†é¡è£œé€² categoriesï¼ˆé¿å…æœ‰ä»»å‹™ä½†æ²’æœ‰åˆ†é¡ï¼‰
const needed = Array.from(new Set(tasks.map(t => t.section).filter(Boolean)));
const merged = Array.from(new Set([...(categories || []), ...needed]));

if (merged.length !== (categories || []).length) {
Â Â categories = merged;
Â Â if (categoriesLoaded) {Â  Â  Â  Â  Â  // â˜…â˜…â˜… åˆ†é¡è¼‰å¥½å¾Œæ‰å…è¨±å­˜é›²ç«¯
Â Â Â Â saveCategoriesToFirebase();
Â Â }
Â Â renderSections(categories); Â  Â  Â  // é‡ç•«åˆ†é¡
}
Â Â // é‡æ–°æŠŠé€²è¡Œä¸­ tasks ä¾ section æ¸²æŸ“
Â Â tasks.forEach(t => {
Â Â Â Â const days = getRemainingDays(t.date);
Â Â Â Â const bg = getColorByDays(days);
Â Â Â Â const displayDays = (days == null) ? 'ç„¡' : days;

Â Â Â Â const el = document.createElement('div');
Â Â Â Â el.className = 'task';
Â Â Â Â el.dataset.id = t.id;
Â Â Â Â el.style.backgroundColor = bg;
Â Â Â Â el.innerHTML = `
Â Â Â Â Â Â <div class="task-content">
Â Â Â Â Â Â Â Â <div class="task-title">${getTitleWithFlag(t)}</div>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="task-days">${displayDays}</div>
Â Â Â Â `;
Â Â Â Â el.onclick = () => openDetail(t.id);
Â Â Â Â const sec = document.getElementById(t.section);
Â Â Â Â if (sec) sec.appendChild(el);
Â Â });

Â Â // ä¾ä½ åŸæœ¬é‚è¼¯æ’åº
Â Â const sections = new Set(tasks.map(t => t.section));
Â Â sections.forEach(sortTasks);

Â Â // é€²è¡Œä¸­ä¹Ÿè¦å¥—ç”¨ä½ ç›®å‰çš„ã€Œå‰©é¤˜å¤©æ•¸ã€ç¯©é¸
Â Â applyDayFilter();
}

// è½‰æ°‘åœ‹å¹´æœˆï¼ˆå›å‚³å¦‚ "11407"ï¼‰
function toRocYM(input) {
Â Â // å…è¨±å‚³é€²ä¾†æ˜¯å­—ä¸²æˆ– Date
Â Â const d = (input instanceof Date) ? input : new Date(input);

Â Â // æ²’å¡«æ—¥æœŸ or ç„¡æ•ˆæ—¥æœŸ â†’ ç›´æ¥æ­¸åˆ°ã€Œç„¡ã€
Â Â if (!input || isNaN(d.getTime())) return 'ç„¡';

Â Â const yy = d.getFullYear() - 1911;
Â Â const mm = String(d.getMonth() + 1).padStart(2, '0');
Â Â return `${yy}${mm}`;
}

// ç”Ÿæˆæœˆä»½æ¸…å–®ï¼ˆåƒ…åˆ—å‡º >15 å¤©çš„æœˆä»½ï¼Œä¸”æœ‰è³‡æ–™çš„ï¼‰
function buildDoneMonthMenu() {
Â Â const menu = document.getElementById('doneMonthMenu');
Â Â if (!menu) return;
Â Â menu.innerHTML = '';

Â Â // ç½®é ‚ï¼šè¿‘5æ—¥
Â Â const recentBtn = document.createElement('button');
Â Â recentBtn.textContent = 'è¿‘5æ—¥';
Â Â recentBtn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;font-weight:600;';
Â Â recentBtn.onclick = () => {
Â Â Â Â completedMonthFilter = 'recent15';
Â Â Â Â menu.style.display = 'none';
Â Â Â Â renderCompletedTasks();
Â Â };
Â Â menu.appendChild(recentBtn);

Â Â const monthSet = new Set();
Â Â 
Â Â completedTasks.forEach(t => {
Â Â Â Â const d = new Date(t.date);Â  // â† æ”¹ç”¨é å®šå®Œæˆæ—¥æœŸ
Â Â Â Â const rocYM = toRocYM(d);
Â Â Â Â console.log('Adding month:', rocYM);Â  // èª¿è©¦ï¼Œæª¢æŸ¥æ¯å€‹ä»»å‹™çš„å¹´æœˆæ˜¯å¦æ­£ç¢º
Â Â Â Â monthSet.add(rocYM);
Â Â });

Â Â if (monthSet.size === 0) {
Â Â Â Â const empty = document.createElement('div');
Â Â Â Â empty.textContent = 'ç„¡æ›´å¤šæœˆä»½';
Â Â Â Â menu.appendChild(empty);
Â Â Â Â return;
Â Â }

Â Â // å°‡æœˆä»½æŒ‰å­—æ¯æ’åºä¸¦ç”ŸæˆæŒ‰éˆ•
Â Â Array.from(monthSet).sort((a, b) => b.localeCompare(a)).forEach(ym => {
Â Â Â Â const btn = document.createElement('button');
Â Â Â Â btn.textContent = ym;
Â Â Â Â btn.style.cssText = 'display:block;border:0;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;width:100%;text-align:left;';
Â Â Â Â btn.onclick = () => {
Â Â Â Â Â Â completedMonthFilter = ym;
Â Â Â Â Â Â menu.style.display = 'none';
Â Â Â Â Â Â renderCompletedTasks();
Â Â Â Â };
Â Â Â Â menu.appendChild(btn);
Â Â });
}

// é»ã€Œæ›´å¤šâ€¦ã€å±•é–‹æœˆä»½æ¸…å–®
document.getElementById('doneMoreBtn')?.addEventListener('click', () => {
Â Â const menu = document.getElementById('doneMonthMenu');
Â Â if (!menu) return;
Â Â menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
});

// æ¸²æŸ“å·²å®Œæˆï¼ˆé è¨­é¡¯ç¤º 15 æ—¥å…§ï¼›é»æœˆä»½å‰‡é¡¯ç¤ºè©²æœˆä»½ï¼‰
function renderCompletedTasks() {
Â Â clearAllSections();
// æŠŠå·²å®Œæˆä»»å‹™ç”¨åˆ°çš„åˆ†é¡ä¹Ÿè£œå› categories
// æŠŠå·²å®Œæˆä»»å‹™ç”¨åˆ°çš„åˆ†é¡ä¹Ÿè£œå› categories
const needFromDone = Array.from(new Set(completedTasks.map(t => t.section).filter(Boolean)));
const merged2 = Array.from(new Set([...(categories || []), ...needFromDone]));

if (merged2.length !== (categories || []).length) {
Â Â categories = merged2;
Â Â if (categoriesLoaded) {Â  Â  Â  Â  Â  // â˜…â˜…â˜… åˆ†é¡è¼‰å¥½å¾Œæ‰å…è¨±å­˜é›²ç«¯
Â Â Â Â saveCategoriesToFirebase();
Â Â }
Â Â renderSections(categories);
}

Â Â const now = new Date();
Â Â const list = completedTasks.filter(t => {
Â Â Â Â const d = new Date(t.date);Â  // â† æ”¹ç”¨é å®šå®Œæˆæ—¥æœŸ
Â Â Â Â const rocYM = toRocYM(d);Â  // è½‰æ›ç‚º ROC å¹´æœˆ

Â Â Â Â console.log('Task completedAt:', t.completedAt, 'Converted to ROC YM:', rocYM); // èª¿è©¦ï¼Œç¢ºèªæ¯å€‹ä»»å‹™çš„æ™‚é–“æˆ³èˆ‡è½‰æ›çµæœ

if (completedMonthFilter === 'recent15') {
Â Â const completedDate = new Date(t.completedAt);Â  // â† ç”¨å¯¦éš›å®Œæˆæ—¥æœŸ
Â Â const diff = Math.floor((Date.now() - completedDate.getTime()) / 86400000);
Â Â return diff <= 5;Â  // åªé¡¯ç¤ºæœ€è¿‘ 5 å¤©å®Œæˆçš„ä»»å‹™
} else {
Â Â return rocYM === completedMonthFilter;Â  // æœˆä»½æ­¸é¡ç”¨é å®šå®Œæˆæ—¥æœŸ
}
Â Â });

Â Â list.forEach(t => {
Â Â Â Â const el = document.createElement('div');
Â Â Â Â el.className = 'task';
Â Â Â Â el.dataset.id = t.id;
Â Â Â Â el.style.backgroundColor = 'var(--green-light)'; // å®Œæˆç”¨æ·¡ç¶ è‰²èƒŒæ™¯
Â Â Â Â el.innerHTML = `
Â Â Â Â Â Â <div class="task-content">
Â Â Â Â Â Â Â Â <div class="task-title">âœ… ${t.important ? 'â— ' : ''}${t.title}</div>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="task-days">å®Œ</div>
Â Â Â Â `;
Â Â Â Â el.onclick = () => openCompletedDetail(t.id);
Â Â Â Â const sec = document.getElementById(t.section);
Â Â Â Â if (sec) sec.appendChild(el);
Â Â });
}




//å·²å®Œæˆè¦–çª—ç´°ç¯€
function setDetailReadonly(ro) {

const modal = document.getElementById('detailModal');
if (modal) modal.classList.toggle('readonly', !!ro);
Â Â ['detailSection','detailTitle','detailContent','detailDate','detailNote']
Â Â Â Â .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = ro; });

Â Â const saveBtn = document.querySelector('#detailModal .save-btn-half');
Â Â const delBtnÂ  = document.querySelector('#detailModal .delete-btn-half');
Â Â const completeBtn = Array.from(document.querySelectorAll('#detailModal button'))
Â Â Â Â .find(b => b.textContent.includes('å·²å®Œæˆ'));


Â Â if (ro) {
Â Â Â Â if (saveBtn) { saveBtn.textContent = 'æˆ‘äº†è§£äº†ï¼'; saveBtn.onclick = () => closeModal('detailModal'); }
Â Â Â Â if (delBtn)Â  { delBtn.onclick = confirmDeleteCompleted; } // â† æ”¹å«ã€Œç¢ºèªåˆªé™¤(å®Œæˆ)ã€

Â Â Â Â if (completeBtn) completeBtn.style.display = 'none';
Â Â } else {
Â Â Â Â if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ å„²å­˜'; saveBtn.onclick = saveTask; }
Â Â Â Â if (delBtn)Â  { delBtn.onclick = confirmDelete; }
Â Â Â Â if (completeBtn) completeBtn.style.display = '';
Â Â }

Â Â // â˜… æ–°å¢ï¼šé–ä½/è§£é–ã€Œé‡è¦ã€checkbox
Â Â const importantEl = document.getElementById('detailImportant');
Â Â if (importantEl) importantEl.disabled = ro;

}

let selectedCompletedId = null;
function openCompletedDetail(id) {
Â Â selectedCompletedId = id;
Â Â const t = completedTasks.find(x => x.id === id);
Â Â if (!t) return;

Â Â // å¡«å€¼
Â Â document.getElementById('detailSection').value = t.section;
Â Â document.getElementById('detailTitle').value Â  = t.title;
Â Â document.getElementById('detailContent').value = t.content || '';
Â Â document.getElementById('detailDate').valueÂ  Â  = t.date || '';
Â Â document.getElementById('detailNote').valueÂ  Â  = t.note || '';

Â Â setDetailReadonly(true);
Â Â document.getElementById('detailModal').style.display = 'flex';
}

function deleteCompleted() {
Â Â if (!selectedCompletedId) return;
Â Â const idx = completedTasks.findIndex(x => x.id === selectedCompletedId);
Â Â if (idx >= 0) completedTasks.splice(idx, 1);
Â Â closeModal('detailModal');
Â Â renderCompletedTasks();
}

function confirmDeleteCompleted() {
Â Â const modal = document.getElementById('confirmModal');
Â Â const confirmBtn = modal.querySelector('.confirm-btn');

Â Â const oldHandler = confirmBtn.onclick; Â  Â  // æš«å­˜åŸæœ¬ï¼ˆé€²è¡Œä¸­åˆªé™¤ï¼‰çš„ handler
Â Â confirmBtn.onclick = () => {Â  Â  Â  Â  Â  Â  Â  Â  // æš«æ™‚æ”¹æˆåˆªã€Œå·²å®Œæˆã€
Â Â Â Â deleteCompletedConfirmed();
Â Â Â Â confirmBtn.onclick = oldHandler;Â  Â  Â  Â  Â  // åˆªå®Œé‚„åŸ
Â Â };

Â Â modal.style.display = 'flex';
}

function deleteCompletedConfirmed() {
Â Â if (!selectedCompletedId) return;
Â Â const idx = completedTasks.findIndex(x => x.id === selectedCompletedId);
Â Â if (idx >= 0) completedTasks.splice(idx, 1);

Â Â // âœ… é€™è¡Œä¸€å®šè¦
Â Â saveTasksToFirebase();

Â Â closeModal('confirmModal');
Â Â closeModal('detailModal');
Â Â renderCompletedTasks();
}
//ç™»å…¥

let loggingIn = false;

function setLoginBusy(busy){
Â Â const btn = document.getElementById('login-btn');
Â Â if (!btn) return;
Â Â btn.disabled = busy;
Â Â btn.textContent = busy ? 'ç™»å…¥ä¸­â€¦' : 'ç™»å…¥';
}

auth.onAuthStateChanged(async (user) => {
Â Â try {
Â Â Â Â if (authTimer) { clearTimeout(authTimer); authTimer = null; }

Â Â Â Â hydrateRoomPath();

Â Â Â Â // å…ˆæ¸…ä¹¾æ·¨
Â Â Â Â document.documentElement.classList.remove('show-login', 'show-app');

Â Â Â Â if (user && roomPath) {
Â Â Â Â Â Â // é¡¯ç¤ºä¸»ç•«é¢ï¼ˆç”¨ classï¼‰
Â Â Â Â // é¡¯ç¤ºä¸»ç•«é¢ï¼ˆç”¨ classï¼‰
document.documentElement.classList.add('show-app');

// ğŸ”§ é‡è¦ï¼šæŠŠèˆŠçš„ inline é¡¯ç¤ºå€¼æ¸…æ‰ï¼Œé¿å…é‡ç–Š
const lpÂ  = document.getElementById('loginPage');
const app = document.querySelector('.container');
if (lp)Â  lp.style.displayÂ  = ''; Â  // æ¸…é™¤ "display:flex"
if (app) app.style.display = ''; Â  // æ¸…é™¤ä»»ä½• inline display

Â Â Â Â Â Â // åˆå§‹åŒ–è³‡æ–™
Â Â Â Â Â Â loadTasksFromFirebase();
Â Â Â Â Â Â updateSectionOptions();
Â Â Â Â } else {
Â Â Â Â Â Â // æ²’ç™»å…¥æˆ–æ²’ roomPath -> å›ç™»å…¥é 
Â Â Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(e) {}
Â Â Â Â Â Â document.documentElement.classList.add('show-login');
Â Â Â Â }
Â Â } catch (e) {
Â Â Â Â console.error('onAuthStateChanged éŒ¯èª¤ï¼š', e);
Â Â Â Â alert('ç•«é¢åˆå§‹åŒ–å¤±æ•—ï¼š' + (e?.message || e));
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_) {}
Â Â Â Â document.documentElement.classList.remove('show-app');
Â Â Â Â document.documentElement.classList.add('show-login');
Â Â } finally {
hideAutoLoginOverlay();
stopAutoLoginWatchdog();Â  Â  // â† æ–°å¢ï¼šç™»å…¥å®Œæˆæˆ–åˆ‡é éƒ½é—œæ‰çœ‹é–€ç‹—
setLoginBusy(false);
Â Â Â Â loggingIn = false;
Â Â }
});

document.getElementById('login-btn').addEventListener('click', async function(){
Â Â if (loggingIn) return; // é˜²æ­¢é‡è¤‡é»
Â Â const username = document.getElementById('login-username').value.trim();
Â Â const password = document.getElementById('login-password').value.trim();
Â Â const autoLogin = document.getElementById('auto-login').checked;

Â Â if(!username || !password){
Â Â Â Â alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼');
Â Â Â Â return;
Â Â }

Â Â roomPath = `rooms/${sanitizeKey(username)}-${sanitizeKey(password)}`;
Â Â if(autoLogin){
Â Â Â Â localStorage.setItem('todo_room_info', JSON.stringify({username, password}));
Â Â } else {
Â Â Â Â localStorage.removeItem('todo_room_info');
Â Â }

Â Â loggingIn = true;
Â Â setLoginBusy(true);

Â try {
Â Â // å…ˆç™»å‡ºèˆŠçš„åŒ¿åä½¿ç”¨è€…ï¼ˆåŠ åœ¨é€™è£¡ï¼ï¼‰
Â Â if (auth.currentUser) {
Â Â Â Â await auth.signOut();
Â Â }
Â Â Â Â // è¨­ä¸€å€‹ 8 ç§’çš„ä¿è­·æ™‚é–“ï¼Œé¿å…å¡æ­»
Â Â Â Â const loginPromise = auth.signInAnonymously();
Â Â Â Â await Promise.race([
Â Â Â Â Â Â loginPromise,
Â Â Â Â Â Â new Promise((_, rej)=>setTimeout(()=>rej(new Error('ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡è©¦')), 8000))
Â Â Â Â ]);
Â Â Â Â // ä¸åœ¨é€™è£¡åˆ‡ç•«é¢ï¼Œç­‰ onAuthStateChanged è‡ªå‹•åˆ‡
Â Â } catch (e) {
Â Â Â Â loggingIn = false;
Â Â Â Â setLoginBusy(false);
Â Â Â Â alert('ç™»å…¥å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
Â Â }
});

Â Â // å¾é›²ç«¯è¼‰è³‡æ–™
Â Â loadTasksFromFirebase();

// === è‡ªå‹•ç™»å…¥ï¼ˆæœ‰è¨˜éŒ„æˆ¿é–“å°±ç›´æ¥é€²ï¼‰ ===
// âœ… æœ€ç°¡å–®çš„ã€Œä¸€å®šæœƒè‡ªå‹•ç™»å…¥ã€ç‰ˆæœ¬


// === è‡ªå‹•ç™»å…¥ï¼ˆçµ±ä¸€èµ° ensureSignedInï¼‰ ===
document.addEventListener('DOMContentLoaded', ensureSignedIn);
window.addEventListener('pageshow', ensureSignedIn);
// === å¾é›²ç«¯è¼‰å…¥ï¼ˆå…ˆåšé€²è¡Œä¸­ tasksï¼›completed ä¹‹å¾Œå†æ¥ï¼‰===
function loadTasksFromFirebase() {
Â Â if (!roomPath || !auth.currentUser) return;

Â Â // å…ˆå–æ¶ˆèˆŠç›£è½ï¼Œé¿å…é‡è¤‡ç¶
Â Â if (tasksRef) tasksRef.off();
Â Â if (completedRef) completedRef.off();

Â Â tasksRef = db.ref(`${roomPath}/tasks`);
Â Â completedRef = db.ref(`${roomPath}/completedTasks`);
Â Â const categoriesRef = db.ref(`${roomPath}/categories`);

Â Â tasksRef.on('value', (snap) => {
Â Â Â Â const data = snap.val() || {};
Â Â Â Â tasks = Object.values(data);
Â Â Â Â showOngoing();
Â Â });

Â Â completedRef.on('value', (snap) => {
Â Â Â Â const data = snap.val() || {};
Â Â Â Â completedTasks = Object.values(data);
Â Â Â Â if (statusFilter === 'done') renderCompletedTasks();
Â Â });

Â Â // è¼‰å…¥åˆ†é¡åç¨±
categoriesRef.on('value', (snap) => {
Â Â const cloud = snap.val();

Â Â if (Array.isArray(cloud) && cloud.length > 0) {
Â Â Â Â // ç”¨é›²ç«¯çš„
Â Â Â Â categories = cloud.slice();
Â Â } else {
Â Â Â Â // é›²ç«¯æ˜¯ç©ºçš„ â†’ ç”¨é è¨­æ¸…å–®è£œå›å»
Â Â Â Â categories = DEFAULT_CATEGORIES.slice();
Â Â Â Â saveCategoriesToFirebase(); // å­˜å›é›²ç«¯
Â Â }

categoriesLoaded = true;

Â Â // å…ˆç•«åˆ†é¡ï¼Œå†ç•«ä»»å‹™
Â Â renderSections(categories);
Â Â if (statusFilter === 'done') {
Â Â Â Â renderCompletedTasks();
Â Â } else {
Â Â Â Â showOngoing();
Â Â }
});
}


// === å¯«å›é›²ç«¯ï¼ˆå…ˆå¯« tasksï¼›completed ä¹‹å¾Œå†æ¥ï¼‰===
function saveTasksToFirebase() {
Â Â const obj = {};
Â Â tasks.forEach(t => obj[t.id] = t);

Â Â const doneObj = {};
Â Â completedTasks.forEach(t => doneObj[t.id] = t);

Â Â // å„²å­˜ä»»å‹™è³‡æ–™
Â Â db.ref(`${roomPath}/tasks`).set(obj);
Â Â db.ref(`${roomPath}/completedTasks`).set(doneObj);

Â Â // å„²å­˜åˆ†é¡è³‡æ–™
}

//ç™»å‡º

function openLogoutModal(){
Â Â document.getElementById('logoutModal').style.display = 'flex';
}

async function doLogout(){
Â Â // é—œé–‰ DB ç›£è½
Â Â try {
Â Â Â Â if (tasksRef) { tasksRef.off(); tasksRef = null; }
Â Â Â Â if (completedRef) { completedRef.off(); completedRef = null; }
Â Â } catch(e){ console.warn(e); }

Â Â // æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™
Â Â tasks = [];
Â Â completedTasks = [];
Â Â selectedTaskId = null;
Â Â clearAllSections();

Â Â // æ¸…æ‰è‡ªå‹•ç™»å…¥èˆ‡æˆ¿é–“
Â Â localStorage.removeItem('todo_room_info');
Â Â roomPath = "";

Â Â // å˜—è©¦ç™»å‡ºï¼ˆè‹¥æ²’é–‹ Auth ä¹Ÿæ²’é—œä¿‚ï¼‰
Â Â try { if (firebase.auth) await auth.signOut(); } catch(e){ /* å¿½ç•¥ */ }

Â Â // åˆ‡å›ç™»å…¥é 
document.documentElement.classList.remove('show-app');
document.documentElement.classList.add('show-login');

Â Â closeModal('logoutModal');
Â Â closeModal('moreModal'); // é—œæ‰ã€Œâ‹¯ã€é¸å–®
}


Â Â //å¿«å–
const v = Date.now(); // æ¯æ¬¡åˆ·æ–°éƒ½å¸¶å…¥å”¯ä¸€å€¼ï¼Œé¿é–‹å¿«å–
document.querySelectorAll('link[rel="icon"], link[rel="manifest"]').forEach(el => {
Â Â if (el.href) {
Â Â Â Â el.href += (el.href.includes('?') ? '&' : '?') + 'v=' + v;
Â Â }
});
if ('serviceWorker' in navigator) {
Â Â navigator.serviceWorker.register('/service-worker.js?v=' + v)
Â Â Â Â .then(reg => console.log('SW è¨»å†ŠæˆåŠŸ', reg.scope))
Â Â Â Â .catch(err => console.log('SW è¨»å†Šå¤±æ•—', err));
}

function getTitleWithFlag(t){
Â Â return (t.important ? 'â— ' : '') + (t.title || '');
}

function renderSections(list){
Â Â const wrap = document.getElementById('section-container');
Â Â // å…ˆé‡å»º doneMoreï¼ˆå›ºå®šåœ¨æœ€ä¸Šé¢ï¼‰
Â Â wrap.innerHTML = `
Â Â Â Â <div id="doneMore" style="display:none; text-align:right; margin:0.25rem 0;">
Â Â Â Â Â Â <button id="doneMoreBtn" style="border:0; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">æ›´å¤šâ€¦</button>
Â Â Â Â Â Â <div id="doneMonthMenu" style="display:none; position:absolute; right:16px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:6px; z-index:50;"></div>
Â Â Â Â </div>
Â Â `;

Â Â // ä¾ categories ç•«å‡ºå„åˆ†é¡
Â Â list.forEach(name => {
Â Â Â Â const sec = document.createElement('div');
Â Â Â Â sec.className = 'section';
Â Â Â Â sec.id = name;
Â Â Â Â sec.innerHTML = `<div class="section-title">${name}</div>`;
Â Â Â Â wrap.appendChild(sec);
Â Â });

Â Â updateSectionOptions();
Â Â initSectionSortable();Â  Â  Â  // ä½ å·²æœ‰çš„å‡½å¼

Â Â // é‡æ–°æ›ã€Œæ›´å¤šâ€¦ã€æŒ‰éˆ•çš„äº‹ä»¶ï¼ˆå› ç‚º innerHTML æœƒæ¸…æ‰èˆŠçš„äº‹ä»¶ï¼‰
Â Â const btn = document.getElementById('doneMoreBtn');
Â Â if (btn) btn.onclick = () => {
Â Â Â Â const menu = document.getElementById('doneMonthMenu');
Â Â Â Â if (menu) menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
Â Â };

Â Â // âœ… å¦‚æœé‚„åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé‡ç•«å¾Œé¦¬ä¸Šå¥—å›ç·¨è¼¯é…ä»¶
Â Â if (isEditing) {
Â Â Â Â decorateSectionsForEdit();
Â Â }
}

function decorateSectionsForEdit() {
Â Â const sections = document.querySelectorAll('.section');
Â Â sections.forEach(section => {
Â Â Â Â section.classList.add('edit-mode');

Â Â Â Â const titleBar = section.querySelector('.section-title');
Â Â Â Â const currentName = section.id;

Â Â Â Â // å…ˆæ¸…ä¹¾æ·¨é¿å…é‡è¤‡ç–Š
Â Â Â Â titleBar.innerHTML = '';

Â Â Â Â // æ‹–æ‹‰æŠŠæ‰‹
Â Â Â Â const drag = document.createElement('span');
Â Â Â Â drag.className = 'drag-handle';
Â Â Â Â drag.innerHTML = 'â˜°';
Â Â Â Â titleBar.appendChild(drag);

Â Â Â Â // åç¨±
Â Â Â Â const nameSpan = document.createElement('span');
Â Â Â Â nameSpan.className = 'section-name';
Â Â Â Â nameSpan.style.marginLeft = '0.5rem';
Â Â Â Â nameSpan.textContent = currentName;
Â Â Â Â titleBar.appendChild(nameSpan);

Â Â Â Â // é‡å‘½åï¼ˆâœï¼‰
Â Â Â Â const renameBtn = document.createElement('button');
Â Â Â Â renameBtn.className = 'rename-btn';
Â Â Â Â renameBtn.innerHTML = 'âœ';
Â Â Â Â renameBtn.onclick = () => openRenameModal(section.id);
Â Â Â Â titleBar.appendChild(renameBtn);

Â Â Â Â // åˆªé™¤ï¼ˆâœ•ï¼‰
Â Â Â Â const delBtn = document.createElement('button');
Â Â Â Â delBtn.className = 'delete-btn';
Â Â Â Â delBtn.innerHTML = 'âœ•';
Â Â Â Â delBtn.onclick = () => confirmDeleteCategory(section.id);
Â Â Â Â titleBar.appendChild(delBtn);
Â Â });

Â Â // é‡æ–°æ›æ‹–æ‹‰
Â Â initSectionSortable();

Â Â // é¡¯ç¤ºåº•éƒ¨ã€Œå®Œæˆç·¨è¼¯ã€æŒ‰éˆ•
Â Â const exitBtn = document.getElementById('exitEditBtn');
Â Â if (exitBtn) exitBtn.style.display = 'block';
}

// ===== æ»‘å‹•å®Œæˆï¼šç«‹å³å¯ç”¨ =====
(function initSlideToComplete(){
Â Â const track = document.getElementById('slideComplete')?.querySelector('.slide-track')Â 
Â Â Â Â || (function(){
Â Â Â Â Â Â // å¦‚æœé‚„æ²’æ¸²æŸ“ detailModal å°±å…ˆç­‰ä¸€ä¸‹
Â Â Â Â Â Â document.addEventListener('DOMContentLoaded', initSlideToComplete);
Â Â Â Â Â Â return null;
Â Â Â Â })();
Â Â if (!track) return;

Â Â const handle = document.getElementById('slideHandle');
Â Â const fill = document.getElementById('slideFill');

Â Â let dragging = false;
Â Â let startX = 0;
Â Â let startLeft = 0;

Â Â function maxLeft() {
Â Â Â Â // å¯æ»‘å‹•ç¯„åœï¼ˆå®¹å™¨å¯¬ - æŠŠæ‰‹å¯¬ - å…©å´é‚Šè· 3px*2ï¼‰
Â Â Â Â const W = track.clientWidth;
Â Â Â Â const hw = handle.clientWidth;
Â Â Â Â return Math.max(0, W - hw - 6);
Â Â }

Â Â function setLeft(px) {
Â Â Â Â const lim = maxLeft();
Â Â Â Â const x = Math.max(0, Math.min(px, lim));
Â Â Â Â handle.style.transform = `translateX(${x}px)`;
Â Â Â Â const percent = Math.round((x / lim) * 100);
Â Â Â Â fill.style.width = `${percent}%`;
Â Â Â Â return percent;
Â Â }

Â Â function pointerDown(e){
Â Â Â Â dragging = true;
Â Â Â Â const p = e.touches ? e.touches[0] : e;
Â Â Â Â startX = p.clientX;
Â Â Â Â // è§£æç›®å‰ translateX
Â Â Â Â const cur = handle.style.transform.match(/translateX\(([-\d.]+)px\)/);
Â Â Â Â startLeft = cur ? parseFloat(cur[1]) : 0;
Â Â Â Â e.preventDefault();
Â Â }

Â Â function pointerMove(e){
Â Â Â Â if (!dragging) return;
Â Â Â Â const p = e.touches ? e.touches[0] : e;
Â Â Â Â const dx = p.clientX - startX;
Â Â Â Â setLeft(startLeft + dx);
Â Â Â Â e.preventDefault();
Â Â }

Â Â function pointerUp(){
Â Â Â Â if (!dragging) return;
Â Â Â Â dragging = false;
Â Â Â Â const lim = maxLeft();
Â Â Â Â // è®€ç›®å‰ translateX
Â Â Â Â const cur = handle.style.transform.match(/translateX\(([-\d.]+)px\)/);
Â Â Â Â const x = cur ? parseFloat(cur[1]) : 0;
Â Â Â Â const percent = lim === 0 ? 0 : (x / lim);

Â Â Â Â // åˆ° 90% ä»¥ä¸Šè¦–ç‚ºå®Œæˆ
Â Â Â Â if (percent >= 0.9) {
Â Â Â Â Â Â track.classList.add('done');
Â Â Â Â Â Â setLeft(lim);
Â Â Â Â Â Â // ç¨ç­‰ä¸€ä¸‹è®“å‹•ç•«æœ‰æ„Ÿè¦º
Â Â Â Â Â Â setTimeout(() => {
Â Â Â Â Â Â Â Â // å‘¼å«ä½ ç¾æœ‰çš„å®Œæˆæµç¨‹
Â Â Â Â Â Â Â Â completeTask();
Â Â Â Â Â Â Â Â // é‡ç½®å¤–è§€ï¼ˆä¸‹æ¬¡å†æ‰“é–‹ modal æ™‚æ˜¯åˆå§‹ç‹€æ…‹ï¼‰
Â Â Â Â Â Â Â Â resetSlider();
Â Â Â Â Â Â }, 200);
Â Â Â Â } else {
Â Â Â Â Â Â // å›å½ˆ
Â Â Â Â Â Â handle.style.transition = 'transform .25s ease';
Â Â Â Â Â Â fill.style.transition = 'width .25s ease';
Â Â Â Â Â Â setLeft(0);
Â Â Â Â Â Â setTimeout(() => {
Â Â Â Â Â Â Â Â handle.style.transition = '';
Â Â Â Â Â Â Â Â fill.style.transition = 'width .25s ease'; // ä¿ç•™ fill çš„å°éæ¸¡
Â Â Â Â Â Â }, 260);
Â Â Â Â }
Â Â }

Â Â function resetSlider(){
Â Â Â Â track.classList.remove('done');
Â Â Â Â handle.style.transition = 'transform .2s ease';
Â Â Â Â fill.style.transition = 'width .25s ease';
Â Â Â Â setLeft(0);
Â Â Â Â setTimeout(() => {
Â Â Â Â Â Â handle.style.transition = '';
Â Â Â Â }, 220);
Â Â }

Â Â // å°å¤–æš´éœ²ï¼Œè®“ openDetail æ™‚å¯ä»¥é‡ç½®
Â Â window.__resetSlideComplete = resetSlider;

Â Â // ç¶å®šäº‹ä»¶ï¼ˆæ»‘é¼  + è§¸æ§ï¼‰
Â Â handle.addEventListener('mousedown', pointerDown);
Â Â document.addEventListener('mousemove', pointerMove);
Â Â document.addEventListener('mouseup', pointerUp);

Â Â handle.addEventListener('touchstart', pointerDown, {passive:false});
Â Â document.addEventListener('touchmove', pointerMove, {passive:false});
Â Â document.addEventListener('touchend', pointerUp);
})();

function closeFabMenu(){
Â Â const m = document.getElementById('menu');
Â Â const fab = document.querySelector('.fab');
Â Â if (!m) return;
Â Â m.classList.remove('show');
Â Â if (fab) fab.classList.remove('open');
}

function toggleMenu(){
Â Â const m = document.getElementById('menu');
Â Â const fab = document.querySelector('.fab');
Â Â if (!m || !fab) return;
Â Â const willOpen = !m.classList.contains('show');
Â Â m.classList.toggle('show', willOpen);
Â Â fab.classList.toggle('open', willOpen);
}

// ğŸ”» å…¨åŸŸé»æ“Šï¼šé»åˆ° menu ä»¥å¤–ï¼Œå°±è‡ªå‹•é—œ
document.addEventListener('click', function(e){
Â Â const menu = document.getElementById('menu');
if (!menu || !menu.classList.contains('show')) return;

Â Â const fab = document.querySelector('.fab');
Â Â const clickInsideMenu = menu.contains(e.target);
Â Â const clickOnFab = fab && fab.contains(e.target);

Â Â if (!clickInsideMenu && !clickOnFab) {
Â Â Â Â closeFabMenu();
Â Â }
});

// ï¼ˆå¯é¸ä½†æ¨è–¦ï¼‰è§¸æ§æ›´éˆæ•ï¼šæ‰‹æ©Ÿå…ˆé—œ
document.addEventListener('touchstart', function(e){
Â Â const menu = document.getElementById('menu');
Â Â if (!menu || menu.style.display !== 'flex') return;

Â Â const fab = document.querySelector('.fab');
Â Â const touchInsideMenu = menu.contains(e.target);
Â Â const touchOnFab = fab && fab.contains(e.target);

Â Â if (!touchInsideMenu && !touchOnFab) {
Â Â Â Â closeFabMenu();
Â Â }
}, {passive:true});

// ï¼ˆå¯é¸ï¼‰æŒ‰ ESC é—œ
document.addEventListener('keydown', function(e){
Â Â if (e.key === 'Escape') closeFabMenu();
});

// âœ… äº‹ä»¶å§”æ´¾ï¼šé»åˆ°ä»»ä½•é–‹è‘—çš„ modal çš„ã€ŒèƒŒæ™¯å€ã€å°±é—œé–‰
document.addEventListener('click', function(e){
Â Â // åªè™•ç†é»åœ¨ .modal ç¯„åœå…§çš„äº‹ä»¶
Â Â const modal = e.target.closest('.modal');
Â Â if (!modal) return;

Â Â // åªé—œã€Œæœ‰é–‹è‘—ã€çš„ modalï¼ˆdisplay !== 'none'ï¼‰
Â Â if (getComputedStyle(modal).display === 'none') return;

Â Â const content = modal.querySelector('.modal-content');
Â Â // é»åˆ°å…§å®¹æ¡†å¤–ï¼ˆ=èƒŒæ™¯é®ç½©ï¼‰æ‰é—œ
Â Â if (!content || !content.contains(e.target)) {
Â Â Â Â closeModal(modal.id);
Â Â }
}, { passive: true });

// ï¼ˆå¯é¸ï¼‰æŒ‰ Esc é—œæ‰ç›®å‰æ‰€æœ‰é–‹è‘—çš„ modal
document.addEventListener('keydown', function(e){
Â Â if (e.key !== 'Escape') return;
Â Â document.querySelectorAll('.modal').forEach(m=>{
Â Â Â Â if (getComputedStyle(m).display !== 'none') closeModal(m.id);
Â Â });
});

function hideEmptySectionsAfterFilter(){
Â Â const sections = document.querySelectorAll('#section-container .section');
Â Â sections.forEach(sec => {
Â Â Â Â // åªç®—ã€Œä»ç„¶å¯è¦‹ã€çš„ä»»å‹™å¡
Â Â Â Â const hasVisibleTask = Array.from(sec.querySelectorAll('.task'))
Â Â Â Â Â Â .some(el => getComputedStyle(el).display !== 'none');
Â Â Â Â sec.style.display = hasVisibleTask ? '' : 'none';
Â Â });
}

let __autoLoginShownAt = 0;

function showAutoLoginOverlay(){
Â Â const el = document.getElementById('autologin-overlay');
Â Â if (!el) return;

Â Â // ç­‰å…©å€‹ frameï¼Œç¢ºä¿ç€è¦½å™¨çœŸçš„å…ˆæŠŠ overlay ç•«å‡ºä¾†
Â Â requestAnimationFrame(() => {
Â Â Â Â requestAnimationFrame(() => {
Â Â Â Â Â Â __autoLoginShownAt = performance.now();
Â Â Â Â Â Â el.classList.add('show');
Â Â Â Â Â Â el.setAttribute('aria-hidden','false');

Â Â Â Â Â Â // å¼·åˆ¶ä¸€æ¬¡ reflowï¼Œé¿å…åŒå¹€è¢«åˆä½µ
Â Â Â Â Â Â // ï¼ˆæœ‰äº›ç€è¦½å™¨åœ¨æ¥µå¿«åˆ‡æ›æ™‚éœ€è¦ï¼‰
Â Â Â Â Â Â void el.offsetHeight;
Â Â Â Â });
Â Â });
}

function hideAutoLoginOverlay(){
Â Â const el = document.getElementById('autologin-overlay');
Â Â if (!el) return;

Â Â const minStay = 600; // è‡³å°‘é¡¯ç¤º 600msï¼Œæ¯” 300ms å†æ˜é¡¯ä¸€äº›
Â Â const elapsed = performance.now() - __autoLoginShownAt;
Â Â const delay = Math.max(0, minStay - elapsed);

Â Â setTimeout(()=>{
Â Â Â Â el.classList.remove('show');
Â Â Â Â el.setAttribute('aria-hidden','true');
Â Â }, delay);
}

// ===== è‡ªå‹•ç™»å…¥çœ‹é–€ç‹—ï¼šè¶…æ™‚è‡ªæ•‘ =====
let autoLoginWD = null;

function startAutoLoginWatchdog(){
Â Â stopAutoLoginWatchdog();
Â Â autoLoginWD = setTimeout(runAutoLoginRescue, 2000); // 8 ç§’é‚„æ²’å¥½å°±æ•‘æ´
}

function stopAutoLoginWatchdog(){
Â Â if (autoLoginWD){ clearTimeout(autoLoginWD); autoLoginWD = null; }
}

async function runAutoLoginRescue(){
Â Â try {
Â Â Â Â // === Soft retryï¼ˆæº«å’Œé‡è©¦ï¼‰===
Â Â Â Â await waitOnline();
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_){}
Â Â Â Â try {
Â Â Â Â Â Â // ä¾ç•¶ä¸‹ç’°å¢ƒå®‰å…¨è¨­å®šæŒä¹…æ€§
Â Â Â Â Â Â const idbOK = await testIndexedDB();
Â Â Â Â Â Â const mode = (isStandalone && idbOK)
Â Â Â Â Â Â Â Â ? firebase.auth.Auth.Persistence.LOCAL
Â Â Â Â Â Â Â Â : firebase.auth.Auth.Persistence.NONE;
Â Â Â Â Â Â await auth.setPersistence(mode);
Â Â Â Â } catch(_){}
Â Â Â Â // 5 ç§’ä¿è­·è¶…æ™‚
Â Â Â Â await Promise.race([
Â Â Â Â Â Â auth.signInAnonymously(),
Â Â Â Â Â Â new Promise((_, rej)=>setTimeout(()=>rej(new Error('soft-timeout')), 5000))
Â Â Â Â ]);
Â Â Â Â return; // æˆåŠŸå°±äº¤çµ¦ onAuthStateChanged å¾ŒçºŒåˆ‡ç•«é¢
Â Â } catch(_e1) {
Â Â Â Â // ç¹¼çºŒä¸‹é¢ Hard reset
Â Â }

Â Â try {
Â Â Â Â // === Hard resetï¼ˆå¼·åˆ¶é‡é–‹ Firebase Appï¼‰===
Â Â Â Â try { if (auth.currentUser) await auth.signOut(); } catch(_){}
Â Â Â Â try { await firebase.app().delete(); } catch(_){}
Â Â Â Â // é‡æ–°åˆå§‹åŒ–
Â Â Â Â firebase.initializeApp(firebaseConfig);
Â Â Â Â window.auth = firebase.auth();
Â Â Â Â window.db Â  = firebase.database();

Â Â Â Â try {
Â Â Â Â Â Â const idbOK = await testIndexedDB();
Â Â Â Â Â Â const mode = (isStandalone && idbOK)
Â Â Â Â Â Â Â Â ? firebase.auth.Auth.Persistence.LOCAL
Â Â Â Â Â Â Â Â : firebase.auth.Auth.Persistence.NONE;
Â Â Â Â Â Â await auth.setPersistence(mode);
Â Â Â Â } catch(_){}

Â Â Â Â await Promise.race([
Â Â Â Â Â Â auth.signInAnonymously(),
Â Â Â Â Â Â new Promise((_, rej)=>setTimeout(()=>rej(new Error('hard-timeout')), 5000))
Â Â Â Â ]);
Â Â Â Â return;
Â Â } catch(_e2) {
Â Â Â Â // === æœ€çµ‚ä¿åº•ï¼šçµ¦ä½¿ç”¨è€…æ‰‹å‹•ç™»å…¥ ===
Â Â Â Â hideAutoLoginOverlay();
Â Â Â Â document.documentElement.classList.remove('show-app');
Â Â Â Â document.documentElement.classList.add('show-login');
Â Â Â Â alert('è‡ªå‹•ç™»å…¥é€¾æ™‚ï¼Œè«‹æ‰‹å‹•ç™»å…¥ä¸€æ¬¡ï¼ˆå·²è‡ªå‹•é‡è¨­é€£ç·šï¼‰ã€‚');
Â Â }
}

// ===== Section ç©ºç™½è™•ï¼šé•·æŒ‰æ–°å¢ï¼ˆä¸é˜»æ“‹æ²å‹•ï¼‰ï¼‹ è¼•é»å½ˆè·³ =====
(function enableCleanLongPressNewTask(){
Â Â const PRESS_MS = 900;Â  Â  Â  // é•·æŒ‰é–€æª»ï¼ˆå¯èª¿ 700~1000ï¼‰
Â Â const MOVE_TOL = 10; Â  Â  Â  // ä½ç§»é–€æª»ï¼ˆpxï¼‰
Â Â const PRESS_VISUAL_DELAY = 100; // è¦–è¦ºå£“ä¸‹å»¶é²ï¼Œé¿å…ä¸€æ»‘å°±ç¸®

Â Â const container = document.getElementById('section-container');
Â Â if (!container) return;

Â Â let timer = null, visualTimer = null;
Â Â let startX = 0, startY = 0;
Â Â let moved = false, longPressed = false;
Â Â let pressSection = null;

Â Â function isEligibleTarget(e){
Â Â Â Â if (isEditing) return false;
Â Â Â Â if (statusFilter === 'done') return false;
Â Â Â Â const sec = e.target.closest('.section');
Â Â Â Â if (!sec) return false;
Â Â Â Â if (e.target.closest('.task')) return false;
Â Â Â Â if (e.target.closest('.drag-handle')) return false;
Â Â Â Â return sec;
Â Â }

Â Â function clearTimers(){
Â Â Â Â if (timer){ clearTimeout(timer); timer = null; }
Â Â Â Â if (visualTimer){ clearTimeout(visualTimer); visualTimer = null; }
Â Â }

Â Â function removePressVisual(){
Â Â Â Â if (pressSection) pressSection.classList.remove('__pressed');
Â Â }

Â Â function pointerDown(e){
Â Â Â Â const sec = isEligibleTarget(e);
Â Â Â Â if (!sec) return;

Â Â Â Â // ä¸è¦ preventDefaultï¼Œè®“ç€è¦½å™¨è‡ªç„¶åˆ¤æ–·è¦ä¸è¦æ²å‹•
Â Â Â Â pressSection = sec;
Â Â Â Â longPressed = false;
Â Â Â Â moved = false;

Â Â Â Â const p = e.touches ? e.touches[0] : e;
Â Â Â Â startX = p.clientX; startY = p.clientY;

Â Â Â Â clearTimers();

Â Â Â Â // è¦–è¦ºå£“ä¸‹ï¼šå»¶é²ä¸€é»ï¼Œé¿å…ä¸€é–‹å§‹å°±ç¸®è€Œé€ æˆã€Œå¡ã€çš„éŒ¯è¦º
Â Â Â Â visualTimer = setTimeout(()=>{
Â Â Â Â Â Â pressSection && pressSection.classList.add('__pressed');
Â Â Â Â }, PRESS_VISUAL_DELAY);

Â Â Â Â // é•·æŒ‰è¨ˆæ™‚
Â Â Â Â timer = setTimeout(()=>{
Â Â Â Â Â Â longPressed = true;
Â Â Â Â Â Â removePressVisual();
Â Â Â Â Â Â clearTimers();
Â Â Â Â Â Â if (!isEditing && statusFilter !== 'done') {
Â Â Â Â Â Â Â Â try { closeFabMenu(); } catch(_){}
Â Â Â Â Â Â Â Â openModal(pressSection?.id); // â˜… æŠŠè¢«é•·æŒ‰çš„ section é é¸é€²å»
Â Â Â Â Â Â }
Â Â Â Â }, PRESS_MS);
Â Â }

Â Â function pointerMove(e){
Â Â Â Â if (!timer && !visualTimer) return;

Â Â Â Â const p = e.touches ? e.touches[0] : e;
Â Â Â Â const dx = Math.abs(p.clientX - startX);
Â Â Â Â const dy = Math.abs(p.clientY - startY);

Â Â Â Â // åªè¦ç§»å‹•è¶…éé–€æª»ï¼Œæˆ–æ˜é¡¯æ˜¯ã€Œå‚ç›´æ»‘å‹•ã€â†’ å–æ¶ˆé•·æŒ‰ï¼Œè®“æ²å‹•ç‚ºä¸»
Â Â Â Â const verticalIntent = dy > dx + 2;
Â Â Â Â if (dx > MOVE_TOL || dy > MOVE_TOL || verticalIntent){
Â Â Â Â Â Â moved = true;
Â Â Â Â Â Â clearTimers();
Â Â Â Â Â Â removePressVisual();
Â Â Â Â }
Â Â }

Â Â function pointerUpOrCancel(e){
Â Â Â Â const wasLong = longPressed;
Â Â Â Â clearTimers();
Â Â Â Â // è‹¥çŸ­æŒ‰ä¸”æ²’ç§»å‹•å¤ªå¤š â†’ å°å½ˆè·³
Â Â Â Â if (pressSection && !wasLong && !moved){
Â Â Â Â Â Â // æŒ‰åˆ°çš„é‚„æ˜¯åŒä¸€å€‹ section æ‰å›é¥‹
Â Â Â Â Â Â const stillOk = isEligibleTarget(e) === pressSection;
Â Â Â Â Â Â if (stillOk){
Â Â Â Â Â Â Â Â pressSection.classList.add('__bump');
Â Â Â Â Â Â Â Â setTimeout(()=> pressSection && pressSection.classList.remove('__bump'), 200);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â removePressVisual();
Â Â Â Â pressSection = null;
Â Â Â Â moved = false;
Â Â Â Â longPressed = false;
Â Â }

Â Â // ä¸å†æ”” contextmenuï¼›è‹¥ä½ çœŸçš„è¦å®Œå…¨é—œï¼Œå¯ä¿ç•™ä¸‹ä¸€è¡Œ
Â Â // container.addEventListener('contextmenu', e => { if (isEligibleTarget(e)) e.preventDefault(); });

Â Â // ç¶å®šï¼ˆæ»‘é¼  + è§¸æ§ï¼‰ï¼Œè§¸æ§ç›£è½æ”¹ç‚º passive:true ä»¥æå‡æ²å‹•é †æš¢
Â Â container.addEventListener('mousedown', pointerDown);
Â Â container.addEventListener('mousemove', pointerMove);
Â Â document.addEventListener('mouseup', pointerUpOrCancel);

Â Â container.addEventListener('touchstart', pointerDown, {passive:true});
Â Â container.addEventListener('touchmove',Â  pointerMove, {passive:true});
Â Â container.addEventListener('touchend', Â  pointerUpOrCancel, {passive:true});
Â Â container.addEventListener('touchcancel',pointerUpOrCancel, {passive:true});
})();
Â Â </script>

<div id="check-success">
Â Â <svg viewBox="0 0 52 52">
Â Â Â Â <circle class="circle" cx="26" cy="26" r="18" fill="none"/>
Â Â Â Â <path class="check" fill="none" d="M14 27l7 7 16-16"/>
Â Â </svg>
</div>

<div class="modal" id="confirmModal">
Â Â <div class="modal-content">
Â Â Â Â <h3 style="text-align: center;">æ˜¯å¦ç¢ºèªç§»é™¤æ­¤ä»»å‹™ï¼Ÿ</h3>
Â Â Â Â <div class="confirm-buttons">
Â Â Â Â Â Â <button class="confirm-btn" onclick="deleteTask()">ç¢ºèª</button>
Â Â Â Â Â Â <button class="cancel-btn" onclick="closeModal('confirmModal')">è¿”å›</button>
Â Â Â Â </div>
Â Â </div>
</div>

<!-- âœ… ç™»å‡ºç¢ºèª modal è¦å’Œä¸Šé¢åŒä¸€å±¤ï¼Œåƒè¬ä¸è¦æ”¾åœ¨ confirmModal è£¡ -->
<div class="modal" id="logoutModal">
Â Â <div class="modal-content">
Â Â Â Â <h3 style="text-align:center;">æ˜¯å¦ç¢ºèªç™»å‡ºï¼Ÿ</h3>
Â Â Â Â <div class="confirm-buttons">
Â Â Â Â Â Â <button class="confirm-btn" onclick="doLogout()">ç¢ºèª</button>
Â Â Â Â Â Â <button class="cancel-btn" onclick="closeModal('logoutModal')">å–æ¶ˆ</button>
Â Â Â Â </div>
Â Â </div>
</div>

<div class="modal" id="categoryModal">
Â Â <div class="modal-content">
<h3 style="text-align: center;">æ–°å¢åˆ†é¡</h3>
<input type="text" id="newCategoryName" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
Â Â Â Â <div class="confirm-buttons">
Â Â Â Â Â Â <button class="confirm-btn" onclick="addCategory()">ç¢ºèª</button>
Â Â Â Â Â Â <button class="cancel-btn" onclick="closeModal('categoryModal')">å–æ¶ˆ</button>
Â Â Â Â </div>
Â Â </div>
</div>
<!-- é‡å‘½ååˆ†é¡ Modal -->
<div class="modal" id="renameModal">
Â Â <div class="modal-content">
Â Â Â Â <button class="close-btn" onclick="closeModal('renameModal')">âœ•</button>
Â Â Â Â <h3 style="text-align:center;">é‡æ–°å‘½ååˆ†é¡</h3>
Â Â Â Â <input type="text" id="renameInput" placeholder="è«‹è¼¸å…¥æ–°çš„åˆ†é¡åç¨±" />
Â Â Â Â <div class="confirm-buttons">
Â Â Â Â Â Â <button class="confirm-btn" onclick="confirmRename()">ç¢ºèª</button>
Â Â Â Â Â Â <button class="cancel-btn" onclick="closeModal('renameModal')">å–æ¶ˆ</button>
Â Â Â Â </div>
Â Â </div>
</div>




<!-- æ›´å¤šåŠŸèƒ½ Modal -->
<div class="modal" id="moreModal">
Â Â <div class="modal-content">
Â Â Â Â <button class="close-btn" onclick="closeModal('moreModal')">âœ•</button>
Â Â Â Â <h3>ç¯©é¸å‰©é¤˜å¤©æ•¸</h3>
<div class="filter-days">
Â Â <label><input type="radio" name="daysFilter" value="1"> 1</label>
Â Â <label><input type="radio" name="daysFilter" value="3"> 3</label>
Â Â <label><input type="radio" name="daysFilter" value="5"> 5</label>
Â Â <label><input type="radio" name="daysFilter" value="3650"> ä¸é™</label>
Â Â <label><input type="radio" name="daysFilter" value="all" checked>é è¨­</label>
</div>
<h3>ä»»å‹™ç‹€æ…‹</h3>
<div class="filter-status">
Â Â <label><input type="radio" name="statusFilter" value="ongoing" checked> é€²è¡Œä¸­</label>
Â Â <label><input type="radio" name="statusFilter" value="done"> å·²å®Œæˆ</label>
</div>
<h3>å¤©æ•¸è¨­å®š</h3>
<div class="filter-mode">
Â Â <label><input type="radio" name="dayMode" value="work" checked> å·¥ä½œå¤©</label>
Â Â <label><input type="radio" name="dayMode" value="calendar"> æ—¥æ›†å¤©</label>
</div>
<hr style="margin:1rem 0;border:none;border-top:1px solid #eee;">
<button class="logout-btn" style="font-weight:bold;" onclick="openLogoutModal()">ç™»å‡º</button>

Â Â </div>
</div>

<!-- è‡ªå‹•ç™»å…¥è¼‰å…¥ä¸­ -->
<div id="autologin-overlay" aria-hidden="true">
Â Â <div class="autologin-box">
Â Â Â Â <div class="autologin-loader"></div>
Â Â Â Â <div class="autologin-text">è‡ªå‹•ç™»å…¥ä¸­â€¦</div>
Â Â </div>
</div>

</body>
</html>
